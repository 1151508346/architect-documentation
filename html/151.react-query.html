<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>珠峰架构师成长计划</title>
    <link rel="stylesheet" type="text/css" href="../static/css/main.css">
    <link rel="stylesheet" href="https://static.zhufengpeixun.com/bootstrapmin_1645176572503.css">
    <style>
        .page-toc > ul .red {
            background: #f3f3f3;
            z-index: 1;
            border-left: 3px solid #009a61;
            -webkit-transition: all .2s ease;
            transition: all .2s ease;
            color: #000
        }
    </style>
</head>
<body>
<div class="nav" style="height: 80.8px;">
    <div class="logo">
        
                    珠峰架构师成长计划
                        
                        </div>
                        <ul><li><a href="../index.html">0.api</a></li><li><a href="../html/0.Async.html">0.Async</a></li><li><a href="../html/0.module.html">0.module</a></li><li><a href="../html/1.ES2015.html">1.ES2015</a></li><li><a href="../html/2.Promise.html">2.Promise</a></li><li><a href="../html/3.Node.html">3.Node</a></li><li><a href="../html/4.NodeInstall.html">4.NodeInstall</a></li><li><a href="../html/5.REPL.html">5.REPL</a></li><li><a href="../html/6.NodeCore.html">6.NodeCore</a></li><li><a href="../html/7.module&amp;NPM.html">7.module&amp;NPM</a></li><li><a href="../html/8.Encoding.html">8.Encoding</a></li><li><a href="../html/9.Buffer.html">9.Buffer</a></li><li><a href="../html/10.fs.html">10.fs</a></li><li><a href="../html/11.Stream-1.html">11.Stream-1</a></li><li><a href="../html/11.Stream-2.html">11.Stream-2</a></li><li><a href="../html/11.Stream-3.html">11.Stream-3</a></li><li><a href="../html/11.Stream-4.html">11.Stream-4</a></li><li><a href="../html/12-Network-2.html">12-Network-2</a></li><li><a href="../html/12.NetWork-3.html">12.NetWork-3</a></li><li><a href="../html/12.Network-1.html">12.Network-1</a></li><li><a href="../html/13.tcp.html">13.tcp</a></li><li><a href="../html/14.http-1.html">14.http-1</a></li><li><a href="../html/14.http-2.html">14.http-2</a></li><li><a href="../html/15.compress.html">15.compress</a></li><li><a href="../html/16.crypto.html">16.crypto</a></li><li><a href="../html/17.process.html">17.process</a></li><li><a href="../html/18.yargs.html">18.yargs</a></li><li><a href="../html/19.cache.html">19.cache</a></li><li><a href="../html/20.action.html">20.action</a></li><li><a href="../html/21.https.html">21.https</a></li><li><a href="../html/22.cookie.html">22.cookie</a></li><li><a href="../html/23.session.html">23.session</a></li><li><a href="../html/24.express-1.html">24.express-1</a></li><li><a href="../html/24.express-2.html">24.express-2</a></li><li><a href="../html/24.express-3.html">24.express-3</a></li><li><a href="../html/24.express-4.html">24.express-4</a></li><li><a href="../html/25.koa-1.html">25.koa-1</a></li><li><a href="../html/26.webpack-1-basic.html">26.webpack-1-basic</a></li><li><a href="../html/26.webpack-2-optimize.html">26.webpack-2-optimize</a></li><li><a href="../html/26.webpack-3-file.html">26.webpack-3-file</a></li><li><a href="../html/26.webpack-4.tapable.html">26.webpack-4.tapable</a></li><li><a href="../html/26.webpack-5-AST.html">26.webpack-5-AST</a></li><li><a href="../html/26.webpack-6-sources.html">26.webpack-6-sources</a></li><li><a href="../html/26.webpack-7-loader.html">26.webpack-7-loader</a></li><li><a href="../html/26.webpack-8-plugin.html">26.webpack-8-plugin</a></li><li><a href="../html/26.webpack-9-hand.html">26.webpack-9-hand</a></li><li><a href="../html/26.webpack-10-prepare.html">26.webpack-10-prepare</a></li><li><a href="../html/28.redux.html">28.redux</a></li><li><a href="../html/28.redux-jwt-back.html">28.redux-jwt-back</a></li><li><a href="../html/28.redux-jwt-front.html">28.redux-jwt-front</a></li><li><a href="../html/29.mongodb-1.html">29.mongodb-1</a></li><li><a href="../html/29.mongodb-2.html">29.mongodb-2</a></li><li><a href="../html/29.mongodb-3.html">29.mongodb-3</a></li><li><a href="../html/29.mongodb-4.html">29.mongodb-4</a></li><li><a href="../html/29.mongodb-5.html">29.mongodb-5</a></li><li><a href="../html/29.mongodb-6.html">29.mongodb-6</a></li><li><a href="../html/30.cms-1-mysql.html">30.cms-1-mysql</a></li><li><a href="../html/30.cms-2-mysql.html">30.cms-2-mysql</a></li><li><a href="../html/30.cms-3-mysql.html">30.cms-3-mysql</a></li><li><a href="../html/30.cms-4-nunjucks.html">30.cms-4-nunjucks</a></li><li><a href="../html/30.cms-5-mock.html">30.cms-5-mock</a></li><li><a href="../html/30.cms-6-egg.html">30.cms-6-egg</a></li><li><a href="../html/30.cms-7-api.html">30.cms-7-api</a></li><li><a href="../html/30.cms-8-roadhog.html">30.cms-8-roadhog</a></li><li><a href="../html/30.cms-9-yaml.html">30.cms-9-yaml</a></li><li><a href="../html/30.cms-10-umi.html">30.cms-10-umi</a></li><li><a href="../html/30.cms-12-dva.html">30.cms-12-dva</a></li><li><a href="../html/30.cms-13-dva-ant.html">30.cms-13-dva-ant</a></li><li><a href="../html/30.cms-14-front.html">30.cms-14-front</a></li><li><a href="../html/30.cms-15-deploy.html">30.cms-15-deploy</a></li><li><a href="../html/31.dva.html">31.dva</a></li><li><a href="../html/31.cms-13-dva-antdesign.html">31.cms-13-dva-antdesign</a></li><li><a href="../html/33.redis.html">33.redis</a></li><li><a href="../html/34.unittest.html">34.unittest</a></li><li><a href="../html/35.jwt.html">35.jwt</a></li><li><a href="../html/36.websocket-1.html">36.websocket-1</a></li><li><a href="../html/36.websocket-2.html">36.websocket-2</a></li><li><a href="../html/38.chat-api-1.html">38.chat-api-1</a></li><li><a href="../html/38.chat-api-2.html">38.chat-api-2</a></li><li><a href="../html/38.chat-3.html">38.chat-3</a></li><li><a href="../html/38.chat-api-3.html">38.chat-api-3</a></li><li><a href="../html/38.chat.html">38.chat</a></li><li><a href="../html/38.chat2.html">38.chat2</a></li><li><a href="../html/38.chat2.html">38.chat2</a></li><li><a href="../html/39.crawl-0.html">39.crawl-0</a></li><li><a href="../html/39.crawl-1.html">39.crawl-1</a></li><li><a href="../html/39.crawl-2.html">39.crawl-2</a></li><li><a href="../html/40.deploy.html">40.deploy</a></li><li><a href="../html/41.safe.html">41.safe</a></li><li><a href="../html/42.test.html">42.test</a></li><li><a href="../html/43.nginx.html">43.nginx</a></li><li><a href="../html/44.enzyme.html">44.enzyme</a></li><li><a href="../html/45.docker.html">45.docker</a></li><li><a href="../html/46.elastic.html">46.elastic</a></li><li><a href="../html/47.oauth.html">47.oauth</a></li><li><a href="../html/48.wxpay.html">48.wxpay</a></li><li><a href="../html/index.html">index</a></li><li><a href="../html/52.UML.html">52.UML</a></li><li><a href="../html/53.design.html">53.design</a></li><li><a href="../html/index.html">index</a></li><li><a href="../html/54.linux.html">54.linux</a></li><li><a href="../html/57.ts.html">57.ts</a></li><li><a href="../html/56.react-ssr.html">56.react-ssr</a></li><li><a href="../html/58.ts_react.html">58.ts_react</a></li><li><a href="../html/59.ketang.html">59.ketang</a></li><li><a href="../html/59.ketang2.html">59.ketang2</a></li><li><a href="../html/61.1.devops-linux.html">61.1.devops-linux</a></li><li><a href="../html/61.2.devops-vi.html">61.2.devops-vi</a></li><li><a href="../html/61.3.devops-user.html">61.3.devops-user</a></li><li><a href="../html/61.4.devops-auth.html">61.4.devops-auth</a></li><li><a href="../html/61.5.devops-shell.html">61.5.devops-shell</a></li><li><a href="../html/61.6.devops-install.html">61.6.devops-install</a></li><li><a href="../html/61.7.devops-system.html">61.7.devops-system</a></li><li><a href="../html/61.8.devops-service.html">61.8.devops-service</a></li><li><a href="../html/61.9.devops-network.html">61.9.devops-network</a></li><li><a href="../html/61.10.devops-nginx.html">61.10.devops-nginx</a></li><li><a href="../html/61.11.devops-docker.html">61.11.devops-docker</a></li><li><a href="../html/61.12.devops-jekins.html">61.12.devops-jekins</a></li><li><a href="../html/61.13.devops-groovy.html">61.13.devops-groovy</a></li><li><a href="../html/61.14.devops-php.html">61.14.devops-php</a></li><li><a href="../html/61.15.devops-java.html">61.15.devops-java</a></li><li><a href="../html/61.16.devops-node.html">61.16.devops-node</a></li><li><a href="../html/61.17.devops-k8s.html">61.17.devops-k8s</a></li><li><a href="../html/62.1.react-basic.html">62.1.react-basic</a></li><li><a href="../html/62.2.react-state.html">62.2.react-state</a></li><li><a href="../html/62.3.react-high.html">62.3.react-high</a></li><li><a href="../html/62.4.react-optimize.html">62.4.react-optimize</a></li><li><a href="../html/62.5.react-hooks.html">62.5.react-hooks</a></li><li><a href="../html/62.6.react-immutable.html">62.6.react-immutable</a></li><li><a href="../html/62.7.react-mobx.html">62.7.react-mobx</a></li><li><a href="../html/62.8.react-source.html">62.8.react-source</a></li><li><a href="../html/63.1.redux.html">63.1.redux</a></li><li><a href="../html/63.2.redux-middleware.html">63.2.redux-middleware</a></li><li><a href="../html/63.3.redux-hooks.html">63.3.redux-hooks</a></li><li><a href="../html/63.4.redux-saga.html">63.4.redux-saga</a></li><li><a href="../html/63.5.redux-saga-hand.html">63.5.redux-saga-hand</a></li><li><a href="../html/64.1.router.html">64.1.router</a></li><li><a href="../html/64.2.router-connected.html">64.2.router-connected</a></li><li><a href="../html/65.1.typescript.html">65.1.typescript</a></li><li><a href="../html/65.2.typescript.html">65.2.typescript</a></li><li><a href="../html/65.3.typescript.html">65.3.typescript</a></li><li><a href="../html/65.4.antd.html">65.4.antd</a></li><li><a href="../html/65.4.definition.html">65.4.definition</a></li><li><a href="../html/66-1.vue-base.html">66-1.vue-base</a></li><li><a href="../html/66-2.vue-component.html">66-2.vue-component</a></li><li><a href="../html/66-3.vue-cli3.0.html">66-3.vue-cli3.0</a></li><li><a href="../html/66-4.$message组件.html">66-4.$message组件</a></li><li><a href="../html/66-5.Form组件.html">66-5.Form组件</a></li><li><a href="../html/66-6.tree.html">66-6.tree</a></li><li><a href="../html/66-7.vue-router-apply.html">66-7.vue-router-apply</a></li><li><a href="../html/66-8.axios-apply.html">66-8.axios-apply</a></li><li><a href="../html/66-9.vuex-apply.html">66-9.vuex-apply</a></li><li><a href="../html/66-10.jwt-vue.html">66-10.jwt-vue</a></li><li><a href="../html/66-11.vue-ssr.html">66-11.vue-ssr</a></li><li><a href="../html/66-12.nuxt-apply.html">66-12.nuxt-apply</a></li><li><a href="../html/66-13.pwa.html">66-13.pwa</a></li><li><a href="../html/66-14.vue单元测试.html">66-14.vue单元测试</a></li><li><a href="../html/66-15.权限校验.html">66-15.权限校验</a></li><li><a href="../html/67-1-network.html">67-1-network</a></li><li><a href="../html/68-2-wireshark.html">68-2-wireshark</a></li><li><a href="../html/7.npm2.html">7.npm2</a></li><li><a href="../html/69-hooks.html">69-hooks</a></li><li><a href="../html/70-deploy.html">70-deploy</a></li><li><a href="../html/71-hmr.html">71-hmr</a></li><li><a href="../html/72.deploy.html">72.deploy</a></li><li><a href="../html/73.import.html">73.import</a></li><li><a href="../html/74.mobile.html">74.mobile</a></li><li><a href="../html/75.webpack-1.文件分析.html">75.webpack-1.文件分析</a></li><li><a href="../html/75.webpack-2.loader.html">75.webpack-2.loader</a></li><li><a href="../html/75.webpack-3.源码流程.html">75.webpack-3.源码流程</a></li><li><a href="../html/75.webpack-4.tapable.html">75.webpack-4.tapable</a></li><li><a href="../html/75.webpack-5.prepare.html">75.webpack-5.prepare</a></li><li><a href="../html/75.webpack-6.resolve.html">75.webpack-6.resolve</a></li><li><a href="../html/75.webpack-7.loader.html">75.webpack-7.loader</a></li><li><a href="../html/75.webpack-8.module.html">75.webpack-8.module</a></li><li><a href="../html/75.webpack-9.chunk.html">75.webpack-9.chunk</a></li><li><a href="../html/75.webpack-10.asset.html">75.webpack-10.asset</a></li><li><a href="../html/75.webpack-11.实现.html">75.webpack-11.实现</a></li><li><a href="../html/76.react_optimize.html">76.react_optimize</a></li><li><a href="../html/77.ts_ketang_back.html">77.ts_ketang_back</a></li><li><a href="../html/77.ts_ketang_front.html">77.ts_ketang_front</a></li><li><a href="../html/78.vue-domdiff.html">78.vue-domdiff</a></li><li><a href="../html/79.grammar.html">79.grammar</a></li><li><a href="../html/80.tree.html">80.tree</a></li><li><a href="../html/81.axios.html">81.axios</a></li><li><a href="../html/82.1.react.html">82.1.react</a></li><li><a href="../html/82.2.react-high.html">82.2.react-high</a></li><li><a href="../html/82.3.react-router.html">82.3.react-router</a></li><li><a href="../html/82.4.redux.html">82.4.redux</a></li><li><a href="../html/82.5.redux_middleware.html">82.5.redux_middleware</a></li><li><a href="../html/82.6.connected.html">82.6.connected</a></li><li><a href="../html/82.7.saga.html">82.7.saga</a></li><li><a href="../html/82.8.dva.html">82.8.dva</a></li><li><a href="../html/82.8.dva-source.html">82.8.dva-source</a></li><li><a href="../html/82.9.roadhog.html">82.9.roadhog</a></li><li><a href="../html/82.10.umi.html">82.10.umi</a></li><li><a href="../html/82.11.antdesign.html">82.11.antdesign</a></li><li><a href="../html/82.12.ketang-front.html">82.12.ketang-front</a></li><li><a href="../html/82.12.ketang-back.html">82.12.ketang-back</a></li><li><a href="../html/83.upload.html">83.upload</a></li><li><a href="../html/84.graphql.html">84.graphql</a></li><li><a href="../html/85.antpro.html">85.antpro</a></li><li><a href="../html/86.1.uml.html">86.1.uml</a></li><li><a href="../html/86.2.design.html">86.2.design</a></li><li><a href="../html/87.postcss.html">87.postcss</a></li><li><a href="../html/88.react16-1.html">88.react16-1</a></li><li><a href="../html/89.nextjs.html">89.nextjs</a></li><li><a href="../html/90.react-test.html">90.react-test</a></li><li><a href="../html/91.react-ts.html">91.react-ts</a></li><li><a href="../html/92.rbac.html">92.rbac</a></li><li><a href="../html/93.tsnode.html">93.tsnode</a></li><li><a href="../html/94.1.JavaScript.html">94.1.JavaScript</a></li><li><a href="../html/94.2.JavaScript.html">94.2.JavaScript</a></li><li><a href="../html/94.3.MODULE.html">94.3.MODULE</a></li><li><a href="../html/94.4.EventLoop.html">94.4.EventLoop</a></li><li><a href="../html/94.5.文件上传.html">94.5.文件上传</a></li><li><a href="../html/94.6.https.html">94.6.https</a></li><li><a href="../html/94.7. nginx.html">94.7. nginx</a></li><li><a href="../html/95.1. react.html">95.1. react</a></li><li><a href="../html/95.2.react.html">95.2.react</a></li><li><a href="../html/96.1.react16.html">96.1.react16</a></li><li><a href="../html/96.2.fiber.html">96.2.fiber</a></li><li><a href="../html/96.3.fiber.html">96.3.fiber</a></li><li><a href="../html/97.serverless.html">97.serverless</a></li><li><a href="../html/98.websocket.html">98.websocket</a></li><li><a href="../html/100.1.react-basic.html">100.1.react-basic</a></li><li><a href="../html/101.1.monitor.html">101.1.monitor</a></li><li><a href="../html/101.2.monitor.html">101.2.monitor</a></li><li><a href="../html/102.java.html">102.java</a></li><li><a href="../html/103.1.webpack-usage.html">103.1.webpack-usage</a></li><li><a href="../html/103.2.webpack-bundle.html">103.2.webpack-bundle</a></li><li><a href="../html/103.3.webpack-ast.html">103.3.webpack-ast</a></li><li><a href="../html/103.4.webpack-flow.html">103.4.webpack-flow</a></li><li><a href="../html/103.5.webpack-loader.html">103.5.webpack-loader</a></li><li><a href="../html/103.6.webpack-tapable.html">103.6.webpack-tapable</a></li><li><a href="../html/103.7.webpack-plugin.html">103.7.webpack-plugin</a></li><li><a href="../html/103.8.webpack-optimize1.html">103.8.webpack-optimize1</a></li><li><a href="../html/103.9.webpack-optimize2.html">103.9.webpack-optimize2</a></li><li><a href="../html/103.10.webpack-hand.html">103.10.webpack-hand</a></li><li><a href="../html/103.11.webpack-hmr.html">103.11.webpack-hmr</a></li><li><a href="../html/103.11.webpack5.html">103.11.webpack5</a></li><li><a href="../html/103.13.splitChunks.html">103.13.splitChunks</a></li><li><a href="../html/103.14.webpack-sourcemap.html">103.14.webpack-sourcemap</a></li><li><a href="../html/103.15.webpack-compiler1.html">103.15.webpack-compiler1</a></li><li><a href="../html/103.15.webpack-compiler2.html">103.15.webpack-compiler2</a></li><li><a href="../html/103.16.rollup.1.html">103.16.rollup.1</a></li><li><a href="../html/103.16.rollup.2.html">103.16.rollup.2</a></li><li><a href="../html/103.16.rollup.3.html">103.16.rollup.3</a></li><li><a href="../html/103.16.vite.basic.html">103.16.vite.basic</a></li><li><a href="../html/103.16.vite.source.html">103.16.vite.source</a></li><li><a href="../html/103.16.vite.plugin.html">103.16.vite.plugin</a></li><li><a href="../html/103.16.vite.1.html">103.16.vite.1</a></li><li><a href="../html/103.16.vite.2.html">103.16.vite.2</a></li><li><a href="../html/103.17.polyfill.html">103.17.polyfill</a></li><li><a href="../html/104.1.binary.html">104.1.binary</a></li><li><a href="../html/104.2.binary.html">104.2.binary</a></li><li><a href="../html/105.skeleton.html">105.skeleton</a></li><li><a href="../html/106.1.react.html">106.1.react</a></li><li><a href="../html/106.2.react_hooks.html">106.2.react_hooks</a></li><li><a href="../html/106.3.react_router.html">106.3.react_router</a></li><li><a href="../html/106.4.redux.html">106.4.redux</a></li><li><a href="../html/106.5.redux_middleware.html">106.5.redux_middleware</a></li><li><a href="../html/106.6.connected-react-router.html">106.6.connected-react-router</a></li><li><a href="../html/106.6.redux-first-history.html">106.6.redux-first-history</a></li><li><a href="../html/106.7.redux-saga.html">106.7.redux-saga</a></li><li><a href="../html/106.8.dva.html">106.8.dva</a></li><li><a href="../html/106.9.umi.html">106.9.umi</a></li><li><a href="../html/106.10.ketang.html">106.10.ketang</a></li><li><a href="../html/106.11.antdesign.html">106.11.antdesign</a></li><li><a href="../html/106.12.antpro.html">106.12.antpro</a></li><li><a href="../html/106.13.router-6.html">106.13.router-6</a></li><li><a href="../html/106.14.ssr.html">106.14.ssr</a></li><li><a href="../html/106.15.nextjs.html">106.15.nextjs</a></li><li><a href="../html/106.16.1.cms.html">106.16.1.cms</a></li><li><a href="../html/106.16.2.cms.html">106.16.2.cms</a></li><li><a href="../html/106.16.3.cms.html">106.16.3.cms</a></li><li><a href="../html/106.16.4.cms.html">106.16.4.cms</a></li><li><a href="../html/106.16.mobx.html">106.16.mobx</a></li><li><a href="../html/106.17.fomily.html">106.17.fomily</a></li><li><a href="../html/107.fiber.html">107.fiber</a></li><li><a href="../html/108.http.html">108.http</a></li><li><a href="../html/109.1.webpack_usage.html">109.1.webpack_usage</a></li><li><a href="../html/109.2.webpack_source.html">109.2.webpack_source</a></li><li><a href="../html/109.3.dll.html">109.3.dll</a></li><li><a href="../html/110.nest.js.html">110.nest.js</a></li><li><a href="../html/111.xstate.html">111.xstate</a></li><li><a href="../html/112.Form.html">112.Form</a></li><li><a href="../html/113.redux-saga.html">113.redux-saga</a></li><li><a href="../html/114.react+typescript.html">114.react+typescript</a></li><li><a href="../html/115.immer.html">115.immer</a></li><li><a href="../html/116.pro5.html">116.pro5</a></li><li><a href="../html/117.css-loader.html">117.css-loader</a></li><li><a href="../html/118.1.umi-core.html">118.1.umi-core</a></li><li><a href="../html/119.2.module-federation.html">119.2.module-federation</a></li><li><a href="../html/119.1.module-federation.html">119.1.module-federation</a></li><li><a href="../html/120.create-react-app.html">120.create-react-app</a></li><li><a href="../html/121.react-scripts.html">121.react-scripts</a></li><li><a href="../html/122.react-optimize.html">122.react-optimize</a></li><li><a href="../html/123.jsx-runtime.html">123.jsx-runtime</a></li><li><a href="../html/124.next.js.html">124.next.js</a></li><li><a href="../html/125.1.linux.html">125.1.linux</a></li><li><a href="../html/125.2.linux-vi.html">125.2.linux-vi</a></li><li><a href="../html/125.3.linux-user.html">125.3.linux-user</a></li><li><a href="../html/125.4.linux-auth.html">125.4.linux-auth</a></li><li><a href="../html/125.5.linux-shell.html">125.5.linux-shell</a></li><li><a href="../html/125.6.linux-install.html">125.6.linux-install</a></li><li><a href="../html/125.7.linux-system.html">125.7.linux-system</a></li><li><a href="../html/125.8.linux-service.html">125.8.linux-service</a></li><li><a href="../html/125.9.linux-network.html">125.9.linux-network</a></li><li><a href="../html/125.10.nginx.html">125.10.nginx</a></li><li><a href="../html/125.11.docker.html">125.11.docker</a></li><li><a href="../html/125.12.ci.html">125.12.ci</a></li><li><a href="../html/125.13.k8s.html">125.13.k8s</a></li><li><a href="../html/125.14.k8s.html">125.14.k8s</a></li><li><a href="../html/125.15.k8s.html">125.15.k8s</a></li><li><a href="../html/125.16.k8s.html">125.16.k8s</a></li><li><a href="../html/126.11.react-1.html">126.11.react-1</a></li><li><a href="../html/126.12.react-2.html">126.12.react-2</a></li><li><a href="../html/126.12.react-3.html">126.12.react-3</a></li><li><a href="../html/126.12.react-4.html">126.12.react-4</a></li><li><a href="../html/126.12.react-5.html">126.12.react-5</a></li><li><a href="../html/126.12.react-6.html">126.12.react-6</a></li><li><a href="../html/126.12.react-7.html">126.12.react-7</a></li><li><a href="../html/126.12.react-8.html">126.12.react-8</a></li><li><a href="../html/127.frontend.html">127.frontend</a></li><li><a href="../html/128.rollup.html">128.rollup</a></li><li><a href="../html/129.px2rem-loader.html">129.px2rem-loader</a></li><li><a href="../html/130.health.html">130.health</a></li><li><a href="../html/131.hooks.html">131.hooks</a></li><li><a href="../html/132.keepalive.html">132.keepalive</a></li><li><a href="../html/133.vue-cli.html">133.vue-cli</a></li><li><a href="../html/134.react18.html">134.react18</a></li><li><a href="../html/134.2.react18.html">134.2.react18</a></li><li><a href="../html/134.3.react18.html">134.3.react18</a></li><li><a href="../html/135.function.html">135.function</a></li><li><a href="../html/136.toolkit.html">136.toolkit</a></li><li><a href="../html/137.lerna.html">137.lerna</a></li><li><a href="../html/138.create-vite.html">138.create-vite</a></li><li><a href="../html/139.cli.html">139.cli</a></li><li><a href="../html/140.antd.html">140.antd</a></li><li><a href="../html/141.react-dnd.html">141.react-dnd</a></li><li><a href="../html/142.1.link.html">142.1.link</a></li><li><a href="../html/143.1.gulp.html">143.1.gulp</a></li><li><a href="../html/143.2.stream.html">143.2.stream</a></li><li><a href="../html/143.3.gulp.html">143.3.gulp</a></li><li><a href="../html/144.1.closure.html">144.1.closure</a></li><li><a href="../html/144.2.v8.html">144.2.v8</a></li><li><a href="../html/144.3.gc.html">144.3.gc</a></li><li><a href="../html/145.react-router-v6.html">145.react-router-v6</a></li><li><a href="../html/146.browser.html">146.browser</a></li><li><a href="../html/147.lighthouse.html">147.lighthouse</a></li><li><a href="../html/148.1.basic.html">148.1.basic</a></li><li><a href="../html/148.2.basic .html">148.2.basic </a></li><li><a href="../html/148.3.basic.html">148.3.basic</a></li><li><a href="../html/148.4.basic.html">148.4.basic</a></li><li><a href="../html/148.5.basic.html">148.5.basic</a></li><li><a href="../html/149.1.vite.html">149.1.vite</a></li><li><a href="../html/149.2.vite.html">149.2.vite</a></li><li><a href="../html/149.3.vite.html">149.3.vite</a></li><li><a href="../html/149.4.vite.html">149.4.vite</a></li><li><a href="../html/150.react-window.html">150.react-window</a></li><li class="active"><a href="../html/151.react-query.html">151.react-query</a></li><li><a href="../html/152.useRequest.html">152.useRequest</a></li><li><a href="../html/153.transition.html">153.transition</a></li><li><a href="../html/154.emotion.html">154.emotion</a></li><li><a href="../html/155.1.formily.html">155.1.formily</a></li><li><a href="../html/155.2.formily.html">155.2.formily</a></li><li><a href="../html/155.3.formily.html">155.3.formily</a></li><li><a href="../html/155.3.1.mobx.usage.html">155.3.1.mobx.usage</a></li><li><a href="../html/155.3.2.mobx.source.html">155.3.2.mobx.source</a></li><li><a href="../html/156.vue-loader.html">156.vue-loader</a></li><li><a href="../html/103.11.mf.html">103.11.mf</a></li><li><a href="../html/157.1.react18.html">157.1.react18</a></li><li><a href="../html/158.umi4.html">158.umi4</a></li><li><a href="../html/159.rxjs.html">159.rxjs</a></li><li><a href="../html/159.rxjs2.html">159.rxjs2</a></li><li><a href="../html/160.bff.html">160.bff</a></li><li><a href="../html/161.zustand.html">161.zustand</a></li><li><a href="../html/162.vscode.html">162.vscode</a></li><li><a href="../html/163.emp.html">163.emp</a></li></ul>                        </div>

                        
  <div class="warpper">
    <div class="page-toc">
      <ul><li><a href="#t01.React Query介绍">1.React Query介绍</a></li><li><a href="#t12. 安装">2. 安装</a></li><li><a href="#t23.基本查询">3.基本查询</a><ul><li><a href="#t33.1 src\index.js">3.1 src\index.js</a></li><li><a href="#t43.2 src\App.js">3.2 src\App.js</a></li><li><a href="#t53.3 src\request.js">3.3 src\request.js</a></li><li><a href="#t63.4 api.js">3.4 api.js</a></li></ul></li><li><a href="#t74.加载状态">4.加载状态</a><ul><li><a href="#t84.1 状态">4.1 状态</a></li><li><a href="#t94.2 src\App.js">4.2 src\App.js</a></li></ul></li><li><a href="#t105.开发工具">5.开发工具</a><ul><li><a href="#t115.1 src\App.js">5.1 src\App.js</a></li></ul></li><li><a href="#t126.refetchOnWindowFocus">6.refetchOnWindowFocus</a><ul><li><a href="#t136.1 src\App.js">6.1 src\App.js</a></li></ul></li><li><a href="#t147.staleTime">7.staleTime</a><ul><li><a href="#t157.1 查询状态">7.1 查询状态</a></li><li><a href="#t167.2 src\App.js">7.2 src\App.js</a></li></ul></li><li><a href="#t178.cacheTime">8.cacheTime</a><ul><li><a href="#t188.1 src\App.js">8.1 src\App.js</a></li></ul></li><li><a href="#t199.轮询">9.轮询</a><ul><li><a href="#t209.1 App.js">9.1 App.js</a></li><li><a href="#t219.2 api.js">9.2 api.js</a></li></ul></li><li><a href="#t2210.查询键去重">10.查询键去重</a><ul><li><a href="#t2310.1 App.js">10.1 App.js</a></li></ul></li><li><a href="#t2411.自定义hooks">11.自定义hooks</a><ul><li><a href="#t2511.1 App.js">11.1 App.js</a></li></ul></li><li><a href="#t2612.QueryObserver">12.QueryObserver</a><ul><li><a href="#t2712.1 App.js">12.1 App.js</a></li></ul></li><li><a href="#t2813.组合缓存键">13.组合缓存键</a><ul><li><a href="#t2913.1 App.js">13.1 App.js</a></li><li><a href="#t3013.2 api.js">13.2 api.js</a></li></ul></li><li><a href="#t3114.enabled">14.enabled</a><ul><li><a href="#t3214.1 查询状态">14.1 查询状态</a></li><li><a href="#t3314.2 App.js">14.2 App.js</a></li></ul></li><li><a href="#t3415.retry">15.retry</a><ul><li><a href="#t3515.1 App.js">15.1 App.js</a></li><li><a href="#t3615.2 api.js">15.2 api.js</a></li></ul></li><li><a href="#t3716.取消请求">16.取消请求</a><ul><li><a href="#t3816.1 App.js">16.1 App.js</a></li><li><a href="#t3916.2 request.js">16.2 request.js</a></li><li><a href="#t4016.3 api.js">16.3 api.js</a></li></ul></li><li><a href="#t4117.依赖查询">17.依赖查询</a><ul><li><a href="#t4217.1 App.js">17.1 App.js</a></li><li><a href="#t4317.2 api.js">17.2 api.js</a></li></ul></li><li><a href="#t4418.初始化数据">18.初始化数据</a><ul><li><a href="#t4518.1 App.js">18.1 App.js</a></li></ul></li><li><a href="#t4619.并发查询">19.并发查询</a><ul><li><a href="#t4719.1 App.js">19.1 App.js</a></li><li><a href="#t4819.2 api.js">19.2 api.js</a></li></ul></li><li><a href="#t4920.列表和详情">20.列表和详情</a><ul><li><a href="#t5020.1 App.js">20.1 App.js</a></li></ul></li><li><a href="#t5121.读取查询缓存">21.读取查询缓存</a><ul><li><a href="#t5221.1 App.js">21.1 App.js</a></li></ul></li><li><a href="#t5322.预缓存">22.预缓存</a><ul><li><a href="#t5422.1 App.js">22.1 App.js</a></li></ul></li><li><a href="#t5523.副作用">23.副作用</a><ul><li><a href="#t5623.1 App.js">23.1 App.js</a></li></ul></li><li><a href="#t5723.预查询">23.预查询</a><ul><li><a href="#t5823.1 App.js">23.1 App.js</a></li></ul></li><li><a href="#t5924.变更操作">24.变更操作</a><ul><li><a href="#t6024.1 src\App.js">24.1 src\App.js</a></li><li><a href="#t6124.2 api.js">24.2 api.js</a></li></ul></li><li><a href="#t6225.乐观更新">25.乐观更新</a><ul><li><a href="#t6325.1 src\App.js">25.1 src\App.js</a></li><li><a href="#t6425.2 api.js">25.2 api.js</a></li></ul></li><li><a href="#t6526.失败回滚">26.失败回滚</a><ul><li><a href="#t6626.1 src\App.js">26.1 src\App.js</a></li></ul></li><li><a href="#t6727.分页查询">27.分页查询</a><ul><li><a href="#t6827.1 src\App.js">27.1 src\App.js</a></li><li><a href="#t6927.2 api.js">27.2 api.js</a></li></ul></li><li><a href="#t7028.无限分页">28.无限分页</a><ul><li><a href="#t7128.1 src\App.js">28.1 src\App.js</a></li></ul></li></ul>
    </div>
    <div class="content markdown-body">
      <h2 id="t01.React Query介绍">1.React Query介绍 <a href="#t01.React Query介绍"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/overview">react-query</a>基于Hooks,能够智能管理请求的一切内容，包括数据、状态、缓存，更新等</li>
<li>管理请求<ul>
<li>基本上axios等请求库封装，可以实现请求、轮询、失败重试、无限加载等功能</li>
<li>可以在网络重连、窗口获得焦点等时机等向服务器发送请求同步状态</li>
</ul>
</li>
<li>状态管理 <ul>
<li>可以把服务器端的状态缓存在客户端的内存中，从而让任意组件获取这些状态  </li>
</ul>
</li>
<li><a href="https://react-query.tanstack.com/comparison">comparison</a></li>
</ul>
<h2 id="t12. 安装">2. 安装 <a href="#t12. 安装"> # </a></h2>
<pre><code class="lang-js">npm install react-query axios --save
npm install express cors morgan --save
</code></pre>
<h2 id="t23.基本查询">3.基本查询 <a href="#t23.基本查询"> # </a></h2>
<ul>
<li><code>React Query</code>会在内存中缓存状态</li>
<li>可以通过<code>QueryClientProvider</code>把<code>QueryClient</code>实例传递给下层组件</li>
<li><a href="https://react-query.tanstack.com/reference/useQuery">useQuery</a></li>
</ul>
<h3 id="t33.1 src\index.js">3.1 src\index.js <a href="#t33.1 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> App <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;
<span class="hljs-keyword">import</span> { QueryClient, QueryClientProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-query'</span>;
<span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> QueryClient();
<span class="hljs-keyword">const</span> root = ReactDOM.createRoot(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'root'</span>));
root.render(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">QueryClientProvider</span> <span class="hljs-attr">client</span>=<span class="hljs-string">{queryClient}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">QueryClientProvider</span>&gt;</span></span>);
</code></pre>
<h3 id="t43.2 src\App.js">3.2 src\App.js <a href="#t43.2 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-query'</span>;
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'./request'</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> { data } = useQuery(<span class="hljs-string">'users'</span>, () =&gt; request.get(<span class="hljs-string">'/users'</span>))
  <span class="hljs-keyword">return</span> (
    (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {
        data?.map((user) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{user.id}</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)
      }
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>)
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> App;
</code></pre>
<h3 id="t53.3 src\request.js">3.3 src\request.js <a href="#t53.3 src\request.js"> # </a></h3>
<p>src\request.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
axios.interceptors.response.use(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.data);
axios.defaults.baseURL = <span class="hljs-string">'http://localhost:8080'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> axios;
</code></pre>
<h3 id="t63.4 api.js">3.4 api.js <a href="#t63.4 api.js"> # </a></h3>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>);
<span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>);
<span class="hljs-keyword">const</span> app = express();
app.use(express.json());
app.use(logger(<span class="hljs-string">'dev'</span>));
app.use(cors({
  <span class="hljs-attr">allowedHeaders</span>: [<span class="hljs-string">"Content-Type"</span>],
  <span class="hljs-attr">allowMethods</span>: [<span class="hljs-string">"GET"</span>, <span class="hljs-string">'POST'</span>, <span class="hljs-string">"PUT"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"OPTIONS"</span>]
}));
<span class="hljs-keyword">const</span> users=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">10</span>).fill(<span class="hljs-literal">true</span>).map(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> ({ <span class="hljs-attr">id</span>: <span class="hljs-built_in">String</span>(index + <span class="hljs-number">1</span>), <span class="hljs-attr">name</span>: <span class="hljs-string">`name<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>`</span> }))
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  setTimeout(next, <span class="hljs-number">1000</span>);
});
app.get(<span class="hljs-string">'/users'</span>, (req, res) =&gt; {
  res.json(users);
});
app.listen(<span class="hljs-number">8080</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'started on port 8080'</span>));
</code></pre>
<h2 id="t74.加载状态">4.加载状态 <a href="#t74.加载状态"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/reference/useQuery">useQuery</a></li>
</ul>
<h3 id="t84.1 状态">4.1 状态 <a href="#t84.1 状态"> # </a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">取值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">status</td>
<td style="text-align:left">状态</td>
<td style="text-align:left">loading、error、success</td>
</tr>
<tr>
<td style="text-align:left">isLoading</td>
<td style="text-align:left">是否首次加载中</td>
<td style="text-align:left">true、false</td>
</tr>
<tr>
<td style="text-align:left">isError</td>
<td style="text-align:left">是否获取失败</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">isSuccess</td>
<td style="text-align:left">是否获取成功</td>
<td style="text-align:left">true、false</td>
</tr>
</tbody>
</table>
<h3 id="t94.2 src\App.js">4.2 src\App.js <a href="#t94.2 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useQuery } from 'react-query';
import request from './request';
function App() {
<span class="hljs-addition">+  const { data, isLoading, isError } = useQuery('users', () =&gt; {</span>
<span class="hljs-addition">+   throw new Error('用户列表加载失败!');</span>
<span class="hljs-addition">+   return request.get('/users');</span>
  })
<span class="hljs-addition">+ if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;</span>
<span class="hljs-addition">+ if (isError) return &lt;div&gt;加载失败&lt;/div&gt;</span>
  return (
    (&lt;ul&gt;
      {
        data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
      }
    &lt;/ul&gt;)
  )
}
export default App;
</code></pre>
<h2 id="t105.开发工具">5.开发工具 <a href="#t105.开发工具"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/devtools">devtools</a>是<code>React Query</code>带有专用的开发工具,它们有助于可视化<code>React Query</code>的所有内部工作</li>
</ul>
<h3 id="t115.1 src\App.js">5.1 src\App.js <a href="#t115.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useQuery } from 'react-query';
<span class="hljs-addition">+import { ReactQueryDevtools } from 'react-query/devtools'</span>
import request from './request';
<span class="hljs-addition">+function Users() {</span>
<span class="hljs-addition">+  const { data, isLoading, isError } = useQuery('users', () =&gt; request.get('/users'))</span>
<span class="hljs-addition">+  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;</span>
<span class="hljs-addition">+  if (isError) return &lt;div&gt;加载失败&lt;/div&gt;</span>
<span class="hljs-addition">+  return (</span>
<span class="hljs-addition">+    (&lt;ul&gt;</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    &lt;/ul&gt;)</span>
<span class="hljs-addition">+  )</span>
<span class="hljs-addition">+}</span>
function App() {
  return (
<span class="hljs-addition">+   &lt;&gt;</span>
<span class="hljs-addition">+     &lt;Users /&gt;</span>
<span class="hljs-addition">+     &lt;ReactQueryDevtools initialIsOpen={true} /&gt;</span>
<span class="hljs-addition">+   &lt;/&gt;</span>
  )
}
export default App;
</code></pre>
<h2 id="t126.refetchOnWindowFocus">6.refetchOnWindowFocus <a href="#t126.refetchOnWindowFocus"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/reference/useQuery#_top">refetchOnWindowFocus</a></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">取值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">isFetching</td>
<td style="text-align:left">是否正在请求</td>
<td style="text-align:left">true、false</td>
</tr>
</tbody>
</table>
<h3 id="t136.1 src\App.js">6.1 src\App.js <a href="#t136.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function Users() {
<span class="hljs-addition">+ const { data, isLoading, isError, isFetching } = useQuery('users', () =&gt; request.get('/users'), {</span>
<span class="hljs-addition">+   refetchOnWindowFocus: true</span>
  })
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;加载失败&lt;/div&gt;
  return (
    (
      &lt;&gt;
        &lt;ul&gt;
          {
            data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
          }
        &lt;/ul&gt;
<span class="hljs-addition">+       {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}</span>
      &lt;/&gt;
    )
  )
}
function App() {
  return (
    &lt;&gt;
      &lt;Users /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t147.staleTime">7.staleTime <a href="#t147.staleTime"> # </a></h2>
<ul>
<li><code>staleTime</code>可以理解为数据保质期，在保质期内遇到同 <code>key</code> 的请求，不会去再次获取数据，也就是从缓存中取，瞬间切换展示，<code>isFetching</code> 也一直为 <code>false</code></li>
</ul>
<h3 id="t157.1 查询状态">7.1 查询状态 <a href="#t157.1 查询状态"> # </a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">取值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">isStale</td>
<td style="text-align:left">是否已经过期</td>
<td style="text-align:left"><code>0</code> 立刻过期,<code>Infinity</code> 永不过期</td>
</tr>
</tbody>
</table>
<h3 id="t167.2 src\App.js">7.2 src\App.js <a href="#t167.2 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function Users() {
  const { data, isLoading, isError, isFetching } = useQuery('users', () =&gt; request.get('/users'), {
    refetchOnWindowFocus: true,
<span class="hljs-addition">+   staleTime: 3000</span>
  })
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;加载失败&lt;/div&gt;
  return (
    (
      &lt;&gt;
        &lt;ul&gt;
          {
            data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
          }
        &lt;/ul&gt;
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
  return (
    &lt;&gt;
      &lt;Users /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t178.cacheTime">8.cacheTime <a href="#t178.cacheTime"> # </a></h2>
<ul>
<li><code>cacheTime</code>是指未使用/非活动缓存数据保留在内存中的时间（以毫秒为单位）</li>
<li>当查询的缓存变得未使用或不活动时，该缓存数据将在此持续时间后被垃圾收集。当指定不同的缓存时间时，将使用最长的一个</li>
</ul>
<h3 id="t188.1 src\App.js">8.1 src\App.js <a href="#t188.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useState } from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function Users() {
  const { data, isLoading, isError, isFetching } = useQuery('users', () =&gt; request.get('/users'), {
    refetchOnWindowFocus: true,
<span class="hljs-addition">+   staleTime: Infinity,</span>
<span class="hljs-addition">+   cacheTime: 5000</span>
  })
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;加载失败&lt;/div&gt;
  return (
    (
      &lt;&gt;
        &lt;ul&gt;
          {
            data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
          }
        &lt;/ul&gt;
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
<span class="hljs-addition">+ const [show, setShow] = useState(true);</span>
  return (
    &lt;&gt;
<span class="hljs-addition">+     &lt;button onClick={() =&gt; setShow(!show)}&gt;{show ? '隐藏' : '显示'}&lt;/button&gt;</span>
<span class="hljs-addition">+     {show &amp;&amp; &lt;Users /&gt;}</span>
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t199.轮询">9.轮询 <a href="#t199.轮询"> # </a></h2>
<h3 id="t209.1 App.js">9.1 App.js <a href="#t209.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useState } from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function Users() {
  const { data, isLoading, isError, isFetching } = useQuery('users', () =&gt; request.get('/users'), {
    refetchOnWindowFocus: true,
    staleTime: Infinity,
    cacheTime: 5000,
<span class="hljs-addition">+   refetchInterval: 1000</span>
  })
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;加载失败&lt;/div&gt;
  return (
    (
      &lt;&gt;
        &lt;ul&gt;
          {
            data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
          }
        &lt;/ul&gt;
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
  const [show, setShow] = useState(true);
  return (
    &lt;&gt;
      &lt;button onClick={() =&gt; setShow(!show)}&gt;{show ? '隐藏' : '显示'}&lt;/button&gt;
      {show &amp;&amp; &lt;Users /&gt;}
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h3 id="t219.2 api.js">9.2 api.js <a href="#t219.2 api.js"> # </a></h3>
<p>api.js</p>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
const users = new Array(10).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))
app.use((req, res, next) =&gt; {
  setTimeout(next, 1000);
});
app.get('/users', (req, res) =&gt; {
   res.json(users.map(user =&gt; ({ ...user, name: user.name + '#' + new Date().toLocaleString() })));
});
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t2210.查询键去重">10.查询键去重 <a href="#t2210.查询键去重"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/overview#motivation">Deduping</a></li>
</ul>
<h3 id="t2310.1 App.js">10.1 App.js <a href="#t2310.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useState } from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
<span class="hljs-addition">+function Users({ queryKey }) {</span>
<span class="hljs-addition">+ const { data, isLoading, isError, isFetching } = useQuery(queryKey, () =&gt; request.get('/users'))</span>
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;加载失败&lt;/div&gt;
  return (
    (
      &lt;&gt;
        &lt;ul&gt;
          {
            data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
          }
        &lt;/ul&gt;
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
  return (
    &lt;&gt;
<span class="hljs-addition">+     &lt;Users queryKey="users" /&gt;</span>
<span class="hljs-addition">+     &lt;Users queryKey="users" /&gt;</span>
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t2411.自定义hooks">11.自定义hooks <a href="#t2411.自定义hooks"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/overview#motivation">Deduping</a></li>
</ul>
<h3 id="t2511.1 App.js">11.1 App.js <a href="#t2511.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
<span class="hljs-addition">+function useUsers() {</span>
<span class="hljs-addition">+  return useQuery('users', () =&gt; request.get('/users'));</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function Stats() {</span>
<span class="hljs-addition">+  const { data } = useUsers();</span>
<span class="hljs-addition">+  return data &amp;&amp; &lt;h1&gt;共计{data.length}用户&lt;/h1&gt;</span>
<span class="hljs-addition">+}</span>
function Users() {
<span class="hljs-addition">+ const { data, isLoading, isError, isFetching } = useUsers();</span>
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;加载失败&lt;/div&gt;
  return (
    (
      &lt;&gt;
        &lt;ul&gt;
          {
            data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
          }
        &lt;/ul&gt;
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
  return (
    &lt;&gt;
      &lt;Users /&gt;
<span class="hljs-addition">+     &lt;Stats /&gt;</span>
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t2612.QueryObserver">12.QueryObserver <a href="#t2612.QueryObserver"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/reference/QueryObserver#_top">QueryObserver</a>可实现在任意组件中订阅状态</li>
</ul>
<h3 id="t2712.1 App.js">12.1 App.js <a href="#t2712.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useEffect, useState } from 'react';
<span class="hljs-addition">+import { useQuery, QueryObserver, useQueryClient } from 'react-query';</span>
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function Stats() {
<span class="hljs-addition">+ const [data, setData] = useState();</span>
<span class="hljs-addition">+ const queryClient = useQueryClient();</span>
<span class="hljs-addition">+ useEffect(() =&gt; {</span>
<span class="hljs-addition">+   const observer = new QueryObserver(queryClient, { queryKey: 'users' })</span>
<span class="hljs-addition">+   const unsubscribe = observer.subscribe(result =&gt; setData(result.data))</span>
<span class="hljs-addition">+   return unsubscribe;</span>
<span class="hljs-addition">+ }, []);</span>
  return data &amp;&amp; &lt;h1&gt;共计{data.length}用户&lt;/h1&gt;
}
function Users() {
<span class="hljs-addition">+ const { data, isLoading, isError, isFetching } = useQuery('users', () =&gt; request.get('/users'))</span>
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;加载失败&lt;/div&gt;
  return (
    (
      &lt;&gt;
        &lt;ul&gt;
          {
            data?.map((user) =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
          }
        &lt;/ul&gt;
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
  return (
    &lt;&gt;
      &lt;Users /&gt;
      &lt;Stats /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t2813.组合缓存键">13.组合缓存键 <a href="#t2813.组合缓存键"> # </a></h2>
<h3 id="t2913.1 App.js">13.1 App.js <a href="#t2913.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
<span class="hljs-addition">+function User({ userId }) {</span>
<span class="hljs-addition">+  const { data, isLoading, isError, error, isFetching } = useQuery(['user', userId], () =&gt; request.get('/user', {</span>
<span class="hljs-addition">+    params: {</span>
<span class="hljs-addition">+      userId</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  }))</span>
<span class="hljs-addition">+  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;</span>
<span class="hljs-addition">+  if (isError) return &lt;div&gt;{error.message}&lt;/div&gt;</span>
<span class="hljs-addition">+  return (</span>
<span class="hljs-addition">+    (</span>
<span class="hljs-addition">+      &lt;&gt;</span>
<span class="hljs-addition">+        {data.id ? &lt;p&gt;{data.id}:{data.name}&lt;/p&gt; : &lt;p&gt;{userId}对应的用户不存在&lt;/p&gt;}</span>
<span class="hljs-addition">+        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}</span>
<span class="hljs-addition">+      &lt;/&gt;</span>
<span class="hljs-addition">+    )</span>
<span class="hljs-addition">+  )</span>
<span class="hljs-addition">+}</span>
function App() {
<span class="hljs-addition">+ const [userId, setUserId] = React.useState('');</span>
  return (
    &lt;&gt;
<span class="hljs-addition">+     &lt;input value={userId} onChange={(event) =&gt; setUserId(event.target.value)} /&gt;</span>
<span class="hljs-addition">+     &lt;User userId={userId} /&gt;</span>
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h3 id="t3013.2 api.js">13.2 api.js <a href="#t3013.2 api.js"> # </a></h3>
<p>api.js</p>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
const users = new Array(10).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))
app.use((req, res, next) =&gt; {
  setTimeout(next, 1000);
});
app.get('/users', (req, res) =&gt; {
  res.json(users.map(user =&gt; ({ ...user, name: user.name + '#' + new Date().toLocaleString() })));
});
<span class="hljs-addition">+app.get('/user', (req, res) =&gt; {</span>
<span class="hljs-addition">+  const userId = req.query.userId;</span>
<span class="hljs-addition">+  const user = users.find(user =&gt; user.id === userId);</span>
<span class="hljs-addition">+  if (user)</span>
<span class="hljs-addition">+    res.json(user);</span>
<span class="hljs-addition">+  else</span>
<span class="hljs-addition">+    res.json({})</span>
<span class="hljs-addition">+});</span>
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t3114.enabled">14.enabled <a href="#t3114.enabled"> # </a></h2>
<h3 id="t3214.1 查询状态">14.1 查询状态 <a href="#t3214.1 查询状态"> # </a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">取值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">isIdle</td>
<td style="text-align:left">是否空闲</td>
<td style="text-align:left">true、false</td>
</tr>
</tbody>
</table>
<h3 id="t3314.2 App.js">14.2 App.js <a href="#t3314.2 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';

function User({ userId }) {
  const { data, isLoading, isError, error, isFetching, isIdle } = useQuery(['user', userId], () =&gt; request.get('/user', {
    params: {
      userId
    }
<span class="hljs-addition">+ }), { enabled: !!userId })</span>
  if (isIdle) return null;
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;{error.message}&lt;/div&gt;
  return (
    (
      &lt;&gt;
        {data.id ? &lt;p&gt;{data.id}:{data.name}&lt;/p&gt; : &lt;p&gt;{userId}对应的用户不存在&lt;/p&gt;}
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
  const [userId, setUserId] = React.useState('');
  return (
    &lt;&gt;
      &lt;input value={userId} onChange={(event) =&gt; setUserId(event.target.value)} /&gt;
      &lt;User userId={userId} /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t3415.retry">15.retry <a href="#t3415.retry"> # </a></h2>
<h3 id="t3515.1 App.js">15.1 App.js <a href="#t3515.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function User({ userId }) {
  const { data, isLoading, isError, error, isFetching, isIdle } = useQuery(['user', userId], () =&gt; request.get('/user', {
    params: {
      userId
    }
  }), {
    enabled: !!userId,
<span class="hljs-addition">+   retry: 1,</span>
<span class="hljs-addition">+   retryDelay: 1000,</span>
<span class="hljs-addition">+   retryDelay: attemptIndex =&gt; Math.min(1000 * 2 ** attemptIndex, 30000),</span>
  })
  if (isIdle) return null;
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;{error.message}&lt;/div&gt;
  return (
    (
      &lt;&gt;
        {data.id ? &lt;p&gt;{data.id}:{data.name}&lt;/p&gt; : &lt;p&gt;{userId}对应的用户不存在&lt;/p&gt;}
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
  const [userId, setUserId] = React.useState('');
  return (
    &lt;&gt;
      &lt;input value={userId} onChange={(event) =&gt; setUserId(event.target.value)} /&gt;
      &lt;User userId={userId} /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
`
</code></pre>
<h3 id="t3615.2 api.js">15.2 api.js <a href="#t3615.2 api.js"> # </a></h3>
<p>api.js</p>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
const users = new Array(10).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))
app.use((req, res, next) =&gt; {
  setTimeout(next, 1000);
});
app.get('/users', (req, res) =&gt; {
  res.json(users.map(user =&gt; ({ ...user, name: user.name + '#' + new Date().toLocaleString() })));
});
app.get('/user', (req, res) =&gt; {
  const userId = req.query.userId;
  const user = users.find(user =&gt; user.id <span class="hljs-comment">=== userId);</span>
  if (user)
    res.json(user);
  else
<span class="hljs-addition">+   res.sendStatus(404)</span>
});
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t3716.取消请求">16.取消请求 <a href="#t3716.取消请求"> # </a></h2>
<ul>
<li>axios发送请求时，添加<a href="http://www.axios-js.com/zh-cn/docs/#%E5%8F%96%E6%B6%88">cancelToken</a>配置项可以用于取消请求</li>
<li><code>CancelToken</code>有一个<code>source</code>静态方法，调用之后返回一个对象，该对象包含一个<code>token</code>属性，用于标记请求和一个<code>cancel</code>方法，用于取消请求</li>
<li><code>cancel</code>取消请求方法在调用取消请求的时候可以将取消原因<code>message</code>字符串传递进去，这样请求在被取消之后会被<code>catch</code>捕获，你可以在这里将取消原因打印出来或者提示给用户，比如提示用户不要频繁点击发送请求</li>
<li><code>get</code>的<code>cancelToken</code>放置在第二个参数的对象里面，<code>post</code>的<code>cancelToken</code>放置在第三个参数对象里面</li>
</ul>
<h3 id="t3816.1 App.js">16.1 App.js <a href="#t3816.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
<span class="hljs-addition">+import request, { CancelToken } from './request';</span>

function User({ userId }) {
  const { data, isLoading, isError, error, isFetching, isIdle } = useQuery(['user', userId], () =&gt; {
<span class="hljs-addition">+   const source = CancelToken.source();</span>
<span class="hljs-addition">+   const promise = request.get('/user', {</span>
<span class="hljs-addition">+     params: { userId }, cancelToken: source.token</span>
<span class="hljs-addition">+   }).catch(error =&gt; {</span>
<span class="hljs-addition">+     if (request.isCancel(error)) {</span>
<span class="hljs-addition">+       console.log(error.message);</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+   });</span>
<span class="hljs-addition">+   promise.cancel = () =&gt; source.cancel('请求被React Query取消');</span>
<span class="hljs-addition">+   return promise;</span>
  }, {
    enabled: !!userId,
    retry: 3,
    retryDelay: 1000,
    retryDelay: attemptIndex =&gt; Math.min(1000 * 2 ** attemptIndex, 30000),
  })
  if (isIdle) return null;
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;{error.message}&lt;/div&gt;
  return (
    (
      &lt;&gt;
        {data.id ? &lt;p&gt;{data.id}:{data.name}&lt;/p&gt; : &lt;p&gt;{userId}对应的用户不存在&lt;/p&gt;}
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
      &lt;/&gt;
    )
  )
}
function App() {
  const [userId, setUserId] = React.useState('');
  return (
    &lt;&gt;
      &lt;input value={userId} onChange={(event) =&gt; setUserId(event.target.value)} /&gt;
      &lt;User userId={userId} /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h3 id="t3916.2 request.js">16.2 request.js <a href="#t3916.2 request.js"> # </a></h3>
<p>src\request.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import axios, { CancelToken } from 'axios';</span>
axios.interceptors.response.use(response =&gt; response.data);
axios.defaults.baseURL = 'http://localhost:8080';
export default axios;
<span class="hljs-addition">+export { CancelToken }</span>
</code></pre>
<h3 id="t4016.3 api.js">16.3 api.js <a href="#t4016.3 api.js"> # </a></h3>
<p>api.js</p>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
const users = new Array(10).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))
app.use((req, res, next) =&gt; {
<span class="hljs-addition">+ setTimeout(next, 1000 * req.query.userId);</span>
});
app.get('/users', (req, res) =&gt; {
  res.json(users.map(user =&gt; ({ ...user, name: user.name + '#' + new Date().toLocaleString() })));
});
app.get('/user', (req, res) =&gt; {
  const userId = req.query.userId;
  const user = users.find(user =&gt; user.id <span class="hljs-comment">=== userId);</span>
  if (user)
    res.json(user);
  else
    res.sendStatus(404)
});
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t4117.依赖查询">17.依赖查询 <a href="#t4117.依赖查询"> # </a></h2>
<h3 id="t4217.1 App.js">17.1 App.js <a href="#t4217.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request, { CancelToken } from './request';

function User({ userId }) {
  const { data, isLoading, isError, error, isFetching, isIdle } = useQuery(['user', userId], () =&gt; {
    const source = CancelToken.source();
    const promise = request.get('/user', {
      params: { userId }, cancelToken: source.token
    }).catch(error =&gt; {
      if (request.isCancel(error)) {
        console.log(error.message);
      }
    });
    promise.cancel = () =&gt; source.cancel('请求被React Query取消');
    return promise;
  }, {
    enabled: !!userId,
    retry: 3,
    retryDelay: 1000,
    retryDelay: attemptIndex =&gt; Math.min(1000 * 2 ** attemptIndex, 30000),
  })
<span class="hljs-addition">+ const postsResult = useQuery(['posts', data?.id],</span>
<span class="hljs-addition">+   () =&gt; request.get(`/posts`, { params: { userId: data?.id } }),</span>
<span class="hljs-addition">+   {</span>
<span class="hljs-addition">+     enabled: !!(data?.id)</span>
<span class="hljs-addition">+   });</span>
  if (isIdle) return null;
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;{error.message}&lt;/div&gt;
  return (
    (
      &lt;&gt;
        {data.id ? &lt;p&gt;{data.id}:{data.name}&lt;/p&gt; : &lt;p&gt;{userId}对应的用户不存在&lt;/p&gt;}
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
<span class="hljs-addition">+       {postsResult.data &amp;&amp; &lt;p&gt;帖子数:{postsResult.data.length}&lt;/p&gt;}</span>
<span class="hljs-addition">+       &lt;p&gt;{postsResult.isFetching &amp;&amp; '正在更新贴子数据...'}&lt;/p&gt;</span>
      &lt;/&gt;
    )
  )
}
function App() {
  const [userId, setUserId] = React.useState('');
  return (
    &lt;&gt;
      &lt;input value={userId} onChange={(event) =&gt; setUserId(event.target.value)} /&gt;
      &lt;User userId={userId} /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h3 id="t4317.2 api.js">17.2 api.js <a href="#t4317.2 api.js"> # </a></h3>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
const users = new Array(10).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))
<span class="hljs-addition">+const posts = new Array(10).fill(true).map((user, index) =&gt; ({ id: String(index + 1), title: `title${index + 1}`, userId: String(index + 1) }))</span>
app.use((req, res, next) =&gt; {
  setTimeout(next, 1000 * req.query.userId);
});
app.get('/users', (req, res) =&gt; {
  res.json(users.map(user =&gt; ({ ...user, name: user.name + '#' + new Date().toLocaleString() })));
});
app.get('/user', (req, res) =&gt; {
  const userId = req.query.userId;
  const user = users.find(user =&gt; user.id <span class="hljs-comment">=== userId);</span>
  if (user)
    res.json(user);
  else
    res.sendStatus(404)
});
<span class="hljs-addition">+app.get('/posts', (req, res) =&gt; {</span>
<span class="hljs-addition">+  const userId = req.query.userId;</span>
<span class="hljs-addition">+  res.json(posts.filter(post =&gt; post.userId === userId));</span>
<span class="hljs-addition">+});</span>
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t4418.初始化数据">18.初始化数据 <a href="#t4418.初始化数据"> # </a></h2>
<h3 id="t4518.1 App.js">18.1 App.js <a href="#t4518.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
const initialUser = { id: "1" }
const initialPosts = [];
function User({ userId }) {
  const { data, isLoading, isError, error, isFetching, isIdle } = useQuery(['user', userId], () =&gt; request.get('/user', {
    params: { userId }
  }), {
    enabled: !!userId,
    retry: 3,
    retryDelay: 1000,
    retryDelay: attemptIndex =&gt; Math.min(1000 * 2 ** attemptIndex, 30000),
    initialData: initialUser,
    initialStale: false,
    staleTime: 5000
  })
  const postsResult = useQuery(['posts', data?.id],
    () =&gt; request.get(`/posts`, { params: { userId: data?.id } }),
    {
      enabled: !!(data?.id),
      initialData: initialPosts,
      initialStale: false,
      staleTime: 5000
    });
  if (isIdle) return null;
  if (isLoading) return &lt;div&gt;加载中.......&lt;/div&gt;
  if (isError) return &lt;div&gt;{error.message}&lt;/div&gt;
  return (
    (
      &lt;&gt;
        {data.id ? &lt;p&gt;{data.id}:{data.name}&lt;/p&gt; : &lt;p&gt;{userId}对应的用户不存在&lt;/p&gt;}
        {isFetching &amp;&amp; &lt;div&gt;更在更新数据...&lt;/div&gt;}
        {postsResult.data &amp;&amp; &lt;p&gt;帖子数:{postsResult.data.length}&lt;/p&gt;}
        &lt;p&gt;{postsResult.isFetching &amp;&amp; '正在更新贴子数据...'}&lt;/p&gt;
      &lt;/&gt;
    )
  )
}
function App() {
  const [userId, setUserId] = React.useState('');
  return (
    &lt;&gt;
      &lt;input value={userId} onChange={(event) =&gt; setUserId(event.target.value)} /&gt;
      &lt;User userId={userId} /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t4619.并发查询">19.并发查询 <a href="#t4619.并发查询"> # </a></h2>
<h3 id="t4719.1 App.js">19.1 App.js <a href="#t4719.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
<span class="hljs-addition">+import { useQuery, useQueries } from 'react-query';</span>
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function User() {
<span class="hljs-addition">+ const [usersQuery, postsQuery] = useQueries([</span>
<span class="hljs-addition">+   { queryKey: ['users'], queryFn: () =&gt; request.get('/users') },</span>
<span class="hljs-addition">+   { queryKey: ['posts'], queryFn: () =&gt; request.get(`/posts`) },</span>
<span class="hljs-addition">+ ]);</span>
  return (
    (
      &lt;&gt;
<span class="hljs-addition">+       {usersQuery.data &amp;&amp; &lt;p&gt;用户数:{usersQuery.data.length}&lt;/p&gt;}</span>
<span class="hljs-addition">+       {postsQuery.data &amp;&amp; &lt;p&gt;帖子数:{postsQuery.data.length}&lt;/p&gt;}</span>
      &lt;/&gt;
    )
  )
}
function App() {
  return (
    &lt;&gt;
      &lt;User /&gt;
      &lt;ReactQueryDevtools initialIsOpen={true} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h3 id="t4819.2 api.js">19.2 api.js <a href="#t4819.2 api.js"> # </a></h3>
<p>api.js</p>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
const users = new Array(10).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))
const posts = new Array(10).fill(true).map((user, index) =&gt; ({ id: String(index + 1), title: `title${index + 1}`, userId: String(index + 1) }))
app.use((req, res, next) =&gt; {
  setTimeout(next, 1000 * 1);
});
app.get('/users', (req, res) =&gt; {
  res.json(users.map(user =&gt; ({ ...user, name: user.name + '#' + new Date().toLocaleString() })));
});
app.get('/user', (req, res) =&gt; {
  const userId = req.query.userId;
  const user = users.find(user =&gt; user.id <span class="hljs-comment">=== userId);</span>
  if (user)
    res.json(user);
  else
    res.sendStatus(404)
});
app.get('/posts', (req, res) =&gt; {
<span class="hljs-addition">+  res.json(posts);</span>
});
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t4920.列表和详情">20.列表和详情 <a href="#t4920.列表和详情"> # </a></h2>
<h3 id="t5020.1 App.js">20.1 App.js <a href="#t5020.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
<span class="hljs-addition">+function Users({ setUserId }) {</span>
<span class="hljs-addition">+  const usersResult = useQuery('users', () =&gt; request.get('/users'), { staleTime: 5000 });</span>
<span class="hljs-addition">+  if (usersResult.isLoading) {</span>
<span class="hljs-addition">+    return '用户列表加载中......';</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  return (</span>
<span class="hljs-addition">+    &lt;&gt;</span>
<span class="hljs-addition">+      &lt;h3&gt;用户列表&lt;/h3&gt;</span>
<span class="hljs-addition">+      &lt;ul&gt;</span>
<span class="hljs-addition">+        {</span>
<span class="hljs-addition">+          usersResult.data?.map(user =&gt; &lt;li key={user.id} onClick={() =&gt; setUserId(user.id)}&gt;{user.name}&lt;/li&gt;)</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+      &lt;/ul&gt;</span>
<span class="hljs-addition">+    &lt;/&gt;</span>
<span class="hljs-addition">+  )</span>
<span class="hljs-addition">+}</span>

<span class="hljs-addition">+function User({ userId, setUserId }) {</span>
<span class="hljs-addition">+  const userResult = useQuery(['user', userId], () =&gt; request.get('/user', {</span>
<span class="hljs-addition">+    params: { userId }</span>
<span class="hljs-addition">+  }), { staleTime: 5000 });</span>
<span class="hljs-addition">+  if (userResult.isLoading) {</span>
<span class="hljs-addition">+    return '单个用户加载中......';</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  return (</span>
<span class="hljs-addition">+    &lt;div&gt;</span>
<span class="hljs-addition">+      &lt;button onClick={() =&gt; setUserId(-1)}&gt;返回&lt;/button&gt;</span>
<span class="hljs-addition">+      {userResult.data &amp;&amp; &lt;p&gt;ID:{userResult.data.id},NAME:{userResult.data.name}&lt;/p&gt;}</span>
<span class="hljs-addition">+    &lt;/div&gt;</span>
<span class="hljs-addition">+  )</span>
<span class="hljs-addition">+}</span>
function App() {
<span class="hljs-addition">+ const [userId, setUserId] = React.useState(-1);</span>
<span class="hljs-addition">+ return (</span>
<span class="hljs-addition">+   &lt;&gt;</span>
<span class="hljs-addition">+     {</span>
<span class="hljs-addition">+       userId &gt; -1 ? (</span>
<span class="hljs-addition">+         &lt;User userId={userId} setUserId={setUserId} /&gt;</span>
<span class="hljs-addition">+       ) : &lt;Users setUserId={setUserId} /&gt;</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+     &lt;ReactQueryDevtools initialIsOpen={false} /&gt;</span>
<span class="hljs-addition">+   &lt;/&gt;</span>
<span class="hljs-addition">+ )</span>
}
export default App;
</code></pre>
<h2 id="t5121.读取查询缓存">21.读取查询缓存 <a href="#t5121.读取查询缓存"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/reference/QueryCache">QueryCache</a>是 React Query 的存储机制。它存储它包含的所有数据、元信息和查询状态</li>
<li>通常，您不会直接与 <code>QueryCache</code> 交互，而是使用<code>QueryClient</code></li>
</ul>
<h3 id="t5221.1 App.js">21.1 App.js <a href="#t5221.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
<span class="hljs-addition">+import { useQuery, useQueryClient } from 'react-query';</span>
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function Users({ setUserId }) {
  const usersResult = useQuery('users', () =&gt; request.get('/users'), { staleTime: 5000 });
  if (usersResult.isLoading) {
    return '用户列表加载中......';
  }
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
        {
          usersResult.data?.map(user =&gt; &lt;li key={user.id} onClick={() =&gt; setUserId(user.id)}&gt;{user.name}&lt;/li&gt;)
        }
      &lt;/ul&gt;
    &lt;/&gt;
  )
}

function User({ userId, setUserId }) {
  const queryClient = useQueryClient();
  const userResult = useQuery(['user', userId], () =&gt; request.get('/user', {
    params: { userId }
  }), {
    staleTime: 5000,
<span class="hljs-addition">+   initialData: () =&gt; queryClient.getQueryData('users')?.find(user =&gt; user.id === userId),</span>
<span class="hljs-addition">+   initialStable: false</span>
  });
  if (userResult.isLoading) {
    return '单个用户加载中......';
  }
  return (
    &lt;div&gt;
      &lt;button onClick={() =&gt; setUserId(-1)}&gt;返回&lt;/button&gt;
      {userResult.data &amp;&amp; &lt;p&gt;ID:{userResult.data.id},NAME:{userResult.data.name}&lt;/p&gt;}
    &lt;/div&gt;
  )
}
function App() {
  const [userId, setUserId] = React.useState(-1);
  return (
    &lt;&gt;
      {
        userId &gt; -1 ? (
          &lt;User userId={userId} setUserId={setUserId} /&gt;
        ) : &lt;Users setUserId={setUserId} /&gt;
      }
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t5322.预缓存">22.预缓存 <a href="#t5322.预缓存"> # </a></h2>
<h3 id="t5422.1 App.js">22.1 App.js <a href="#t5422.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery, useQueryClient } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function Users({ setUserId }) {
<span class="hljs-addition">+  const queryClient = useQueryClient();</span>
<span class="hljs-addition">+ const usersResult = useQuery('users', async () =&gt; {</span>
<span class="hljs-addition">+   const users = await request.get('/users');</span>
<span class="hljs-addition">+   users.forEach(user =&gt; {</span>
<span class="hljs-addition">+     queryClient.setQueryData(['user', user.id], user);</span>
<span class="hljs-addition">+   });</span>
<span class="hljs-addition">+   return users;</span>
  }, { staleTime: 5000 });
  if (usersResult.isLoading) {
    return '用户列表加载中......';
  }
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
        {
          usersResult.data?.map(user =&gt; &lt;li key={user.id} onClick={() =&gt; setUserId(user.id)}&gt;{user.name}&lt;/li&gt;)
        }
      &lt;/ul&gt;
    &lt;/&gt;
  )
}

function User({ userId, setUserId }) {
<span class="hljs-deletion">- const queryClient = useQueryClient();</span>
  const userResult = useQuery(['user', userId], () =&gt; request.get('/user', {
    params: { userId }
  }), {
<span class="hljs-deletion">-    staleTime: 5000,</span>
<span class="hljs-deletion">-    initialData: () =&gt; queryClient.getQueryData('users')?.find(user =&gt; user.id === userId),</span>
<span class="hljs-deletion">-    initialStable: false</span>
  });
  if (userResult.isLoading) {
    return '单个用户加载中......';
  }
  return (
    &lt;div&gt;
      &lt;button onClick={() =&gt; setUserId(-1)}&gt;返回&lt;/button&gt;
      {userResult.data &amp;&amp; &lt;p&gt;ID:{userResult.data.id},NAME:{userResult.data.name}&lt;/p&gt;}
    &lt;/div&gt;
  )
}
function App() {
  const [userId, setUserId] = React.useState(-1);
  return (
    &lt;&gt;
      {
        userId &gt; -1 ? (
          &lt;User userId={userId} setUserId={setUserId} /&gt;
        ) : &lt;Users setUserId={setUserId} /&gt;
      }
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t5523.副作用">23.副作用 <a href="#t5523.副作用"> # </a></h2>
<h3 id="t5623.1 App.js">23.1 App.js <a href="#t5623.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery, useQueryClient } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
<span class="hljs-addition">+import { ToastContainer, toast } from 'react-toastify';</span>
<span class="hljs-addition">+import 'react-toastify/dist/ReactToastify.css';</span>
import request from './request';
function Users({ setUserId }) {
  const queryClient = useQueryClient();
  const usersResult = useQuery('users', async () =&gt; {
    const users = await request.get('/users');
    users.forEach(user =&gt; {
      queryClient.setQueryData(['user', user.id], user);
    });
    return users;
  }, {
<span class="hljs-addition">+   onSuccess(data) {</span>
<span class="hljs-addition">+     //console.log('查询成功', data);</span>
<span class="hljs-addition">+     toast("查询成功!")</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onError(error) {</span>
<span class="hljs-addition">+     //console.log('查询失败', error);</span>
<span class="hljs-addition">+     toast("查询失败!")</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onSettled(data, error) {</span>
<span class="hljs-addition">+     console.log('查询结束');</span>
<span class="hljs-addition">+   }</span>
  });
  if (usersResult.isLoading) {
    return '用户列表加载中......';
  }
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
        {
          usersResult.data?.map(user =&gt; &lt;li key={user.id} onClick={() =&gt; setUserId(user.id)}&gt;{user.name}&lt;/li&gt;)
        }
      &lt;/ul&gt;
    &lt;/&gt;
  )
}

function User({ userId, setUserId }) {
  //  const queryClient = useQueryClient();
  const userResult = useQuery(['user', userId], () =&gt; request.get('/user', {
    params: { userId }
  }));
  if (userResult.isLoading) {
    return '单个用户加载中......';
  }
  return (
    &lt;div&gt;
      &lt;button onClick={() =&gt; setUserId(-1)}&gt;返回&lt;/button&gt;
      {userResult.data &amp;&amp; &lt;p&gt;ID:{userResult.data.id},NAME:{userResult.data.name}&lt;/p&gt;}
    &lt;/div&gt;
  )
}
function App() {
  const [userId, setUserId] = React.useState(-1);
  return (
    &lt;&gt;
      {
        userId &gt; -1 ? (
          &lt;User userId={userId} setUserId={setUserId} /&gt;
        ) : &lt;Users setUserId={setUserId} /&gt;
      }
<span class="hljs-addition">+     &lt;ToastContainer /&gt;</span>
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t5723.预查询">23.预查询 <a href="#t5723.预查询"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/reference/QueryClient#queryclientprefetchquery">prefetchQuery</a>是一种异步方法，可用于在需要查询或与<code>useQuery</code>一起呈现之前预取查询</li>
</ul>
<h3 id="t5823.1 App.js">23.1 App.js <a href="#t5823.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery, useQueryClient } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import { ToastContainer, toast } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';
import request from './request';
<span class="hljs-addition">+function fetchUsers() {</span>
<span class="hljs-addition">+  return request.get('/users');</span>
<span class="hljs-addition">+}</span>
function Users({ setUserId }) {
  const usersResult = useQuery('users', fetchUsers);
  if (usersResult.isLoading) {
    return '用户列表加载中......';
  }
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
        {
          usersResult.data?.map(user =&gt; &lt;li key={user.id} onClick={() =&gt; setUserId(user.id)}&gt;{user.name}&lt;/li&gt;)
        }
      &lt;/ul&gt;
    &lt;/&gt;
  )
}

function App() {
<span class="hljs-addition">+ const queryClient = useQueryClient();</span>
<span class="hljs-addition">+ const [show, setShow] = React.useState(false);</span>
<span class="hljs-addition">+ React.useEffect(() =&gt; {</span>
<span class="hljs-addition">+   queryClient.prefetchQuery('users', fetchUsers, { staleTime: 5000 });</span>
<span class="hljs-addition">+ })</span>
  return (
    &lt;&gt;
<span class="hljs-addition">+     &lt;button onClick={() =&gt; setShow(!show)} onMouseOver={() =&gt;</span>
<span class="hljs-addition">+       queryClient.prefetchQuery('users', fetchUsers, { staleTime: 5000 })}&gt;show&lt;/button&gt;</span>
<span class="hljs-addition">+     {</span>
<span class="hljs-addition">+       show &amp;&amp; &lt;Users /&gt;</span>
<span class="hljs-addition">+     }</span>
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t5924.变更操作">24.变更操作 <a href="#t5924.变更操作"> # </a></h2>
<h3 id="t6024.1 src\App.js">24.1 src\App.js <a href="#t6024.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
<span class="hljs-addition">+import { useQuery, useQueryClient, useMutation } from 'react-query';</span>
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function fetchUsers() {
  return request.get('/users');
}
function Users({ setUserId }) {
  const usersResult = useQuery('users', fetchUsers);
  if (usersResult.isLoading) {
    return '用户列表加载中......';
  }
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
        {
          usersResult.data?.map(user =&gt; &lt;li key={user.id} onClick={() =&gt; setUserId(user.id)}&gt;{user.name}&lt;/li&gt;)
        }
      &lt;/ul&gt;
    &lt;/&gt;
  )
}

function App() {
<span class="hljs-addition">+ const nameRef = React.useRef();</span>
<span class="hljs-addition">+ const queryClient = useQueryClient();</span>
<span class="hljs-addition">+ const { mutate, isLoading, isError, isSuccess, error } = useMutation(</span>
<span class="hljs-addition">+   (values) =&gt; request.post('/users', values), {</span>
<span class="hljs-addition">+   onSuccess() {</span>
<span class="hljs-addition">+     //queryClient.invalidateQueries('users');</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onError(error) {</span>
<span class="hljs-addition">+     //alert(error.response.data.message);</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onSettled(data, error) {</span>
<span class="hljs-addition">+     queryClient.invalidateQueries('users');</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ });</span>
<span class="hljs-addition">+ const handleSubmit = (event) =&gt; {</span>
<span class="hljs-addition">+   event.preventDefault();</span>
<span class="hljs-addition">+   const name = nameRef.current.value;</span>
<span class="hljs-addition">+   const user = { name };</span>
<span class="hljs-addition">+   mutate(user);</span>
<span class="hljs-addition">+ }</span>
  return (
    &lt;&gt;
      &lt;Users /&gt;
<span class="hljs-addition">+      &lt;form onSubmit={handleSubmit}&gt;</span>
<span class="hljs-addition">+        &lt;input ref={nameRef} /&gt;</span>
<span class="hljs-addition">+        &lt;input type="submit" value={isLoading ? '保存中...' : isError ? '保存失败' : isSuccess ? "保存成功" : "保存"} /&gt;</span>
<span class="hljs-addition">+     &lt;/form&gt;</span>
<span class="hljs-addition">+     {isError &amp;&amp; &lt;pre style={{ color: 'red' }}&gt;{error.response.data.message}&lt;/pre&gt;}</span>
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h3 id="t6124.2 api.js">24.2 api.js <a href="#t6124.2 api.js"> # </a></h3>
<p>api.js</p>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
const users = new Array(10).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))
const posts = new Array(10).fill(true).map((user, index) =&gt; ({ id: String(index + 1), title: `title${index + 1}`, userId: String(index + 1) }))
app.use((req, res, next) =&gt; {
  setTimeout(next, 1000 * 1);
});
app.get('/users', (req, res) =&gt; {
  res.json(users.map(user =&gt; ({ ...user, name: user.name + '#' + new Date().toLocaleString() })));
});
app.get('/user', (req, res) =&gt; {
  const userId = req.query.userId;
  const user = users.find(user =&gt; user.id <span class="hljs-comment">=== userId);</span>
  if (user)
    res.json(user);
  else
    res.sendStatus(404)
});
<span class="hljs-addition">+app.post('/users', (req, res) =&gt; {</span>
<span class="hljs-addition">+  let user = req.body;</span>
<span class="hljs-addition">+  if (user.name) {</span>
<span class="hljs-addition">+    user.id = (users.length + 1) + '';</span>
<span class="hljs-addition">+    user.createdAt = new Date().toLocaleDateString();</span>
<span class="hljs-addition">+    users.push(user);</span>
<span class="hljs-addition">+    res.json(user);</span>
<span class="hljs-addition">+  } else {</span>
<span class="hljs-addition">+    res.status(400).send({ message: '用户名不能为空!' });</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+});</span>
app.get('/posts', (req, res) =&gt; {
  res.json(posts);
});
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t6225.乐观更新">25.乐观更新 <a href="#t6225.乐观更新"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/reference/useMutation#_top">useMutation</a></li>
<li><code>onMutate</code>函数将在突变函数被触发之前触发，并传递突变函数将接收的相同变量</li>
<li>用于对资源执行乐观更新以希望突变成功</li>
<li>如果发生突变失败，从此函数返回的值将传递给onError和onSettled函数，并且可用于回滚乐观更新</li>
</ul>
<h3 id="t6325.1 src\App.js">25.1 src\App.js <a href="#t6325.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery, useQueryClient, useMutation } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function fetchUsers() {
  return request.get('/users');
}
function Users({ setUserId }) {
  const usersResult = useQuery('users', fetchUsers);
  if (usersResult.isLoading) {
    return '用户列表加载中......';
  }
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
        {
          usersResult.data?.map(user =&gt; &lt;li key={user.id} onClick={() =&gt; setUserId(user.id)}&gt;{user.name}&lt;/li&gt;)
        }
      &lt;/ul&gt;
    &lt;/&gt;
  )
}

function App() {
  const nameRef = React.useRef();
  const queryClient = useQueryClient();
  const { mutate:saveUser, isLoading, isError, isSuccess, error } = useMutation(
    (values) =&gt; request.post('/users', values), {
<span class="hljs-addition">+   onMutate(values) {</span>
<span class="hljs-addition">+     queryClient.setQueryData('users', oldUsers =&gt; [...oldUsers, { ...values, id: String(Date.now()) }]);</span>
<span class="hljs-addition">+   },</span>
    onSuccess() {
      //queryClient.invalidateQueries('users');
    },
    onError(error) {
      //alert(error.response.data.message);
    },
    onSettled(data, error) {
      queryClient.invalidateQueries('users');
    }
  });
  const handleSubmit = (event) =&gt; {
    event.preventDefault();
    const name = nameRef.current.value;
    const user = { name };
    saveUser(user);
  }
  return (
    &lt;&gt;
      &lt;Users /&gt;
      &lt;form onSubmit={handleSubmit}&gt;
        &lt;input ref={nameRef} /&gt;
        &lt;input type="submit" value={isLoading ? '保存中...' : isError ? '保存失败' : isSuccess ? "保存成功" : "保存"} /&gt;
      &lt;/form&gt;
      {isError &amp;&amp; &lt;pre style={{ color: 'red' }}&gt;{error.response.data.message}&lt;/pre&gt;}
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h3 id="t6425.2 api.js">25.2 api.js <a href="#t6425.2 api.js"> # </a></h3>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
const users = new Array(10).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))
const posts = new Array(10).fill(true).map((user, index) =&gt; ({ id: String(index + 1), title: `title${index + 1}`, userId: String(index + 1) }))
app.use((req, res, next) =&gt; {
  setTimeout(next, 1000 * 1);
});
app.get('/users', (req, res) =&gt; {
<span class="hljs-addition">+ res.json(users);</span>
});
app.get('/user', (req, res) =&gt; {
  const userId = req.query.userId;
  const user = users.find(user =&gt; user.id <span class="hljs-comment">=== userId);</span>
  if (user)
    res.json(user);
  else
    res.sendStatus(404)
});
app.post('/users', (req, res) =&gt; {
  let user = req.body;
  if (user.name) {
    user.id = (users.length + 1) + '';
    user.createdAt = new Date().toLocaleDateString();
    users.push(user);
    res.json(user);
  } else {
    res.status(400).send({ message: '用户名不能为空!' });
  }
});
app.get('/posts', (req, res) =&gt; {
  res.json(posts);
});
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t6526.失败回滚">26.失败回滚 <a href="#t6526.失败回滚"> # </a></h2>
<h3 id="t6626.1 src\App.js">26.1 src\App.js <a href="#t6626.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery, useQueryClient, useMutation } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
function fetchUsers() {
  return request.get('/users');
}
function Users() {
  const usersResult = useQuery('users', fetchUsers);
  if (usersResult.isLoading) {
    return '用户列表加载中......';
  }
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
        {
          usersResult.data?.map(user =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)
        }
      &lt;/ul&gt;
    &lt;/&gt;
  )
}

function App() {
  const nameRef = React.useRef();
  const queryClient = useQueryClient();
<span class="hljs-addition">+ const { mutate: saveUser, reset, isLoading, isError, isSuccess, error } = useMutation(</span>
    (values) =&gt; request.post('/users', values), {
<span class="hljs-addition">+   retry: false,</span>
<span class="hljs-addition">+   onMutate(values) {</span>
<span class="hljs-addition">+     queryClient.cancelQueries('users');</span>
<span class="hljs-addition">+     const oldUsers = queryClient.getQueryData('users');</span>
<span class="hljs-addition">+     queryClient.setQueryData('users', oldUsers =&gt; [...oldUsers, { ...values, id: String(Date.now+)) }]);</span>
<span class="hljs-addition">+     //return oldUsers;</span>
<span class="hljs-addition">+     return () =&gt; queryClient.setQueryData('users', oldUsers)</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onSuccess(data) {</span>
<span class="hljs-addition">+     queryClient.setQueryData('users', oldUsers =&gt; oldUsers.map((user, index) =&gt; {</span>
<span class="hljs-addition">+       if (index === oldUsers.length - 1) {</span>
<span class="hljs-addition">+         return data;</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       return user;</span>
<span class="hljs-addition">+     }));</span>
<span class="hljs-addition">+     //queryClient.invalidateQueries('users');</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onError(error, values, rollback) {</span>
<span class="hljs-addition">+     //alert(error.response.data.message);</span>
<span class="hljs-addition">+     //queryClient.setQueryData('users', rollbackValue);</span>
<span class="hljs-addition">+     console.log(rollback);</span>
<span class="hljs-addition">+     rollback &amp;&amp; rollback();</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onSettled(data, error) {</span>
<span class="hljs-addition">+     queryClient.invalidateQueries('users');</span>
<span class="hljs-addition">+     setTimeout(() =&gt; {</span>
<span class="hljs-addition">+       nameRef.current.value = ''</span>
<span class="hljs-addition">+       reset();</span>
<span class="hljs-addition">+     }, 3000)</span>
<span class="hljs-addition">+   }</span>
  });
  const handleSubmit = (event) =&gt; {
    event.preventDefault();
    const name = nameRef.current.value;
    const user = { name };
    saveUser(user);
  }
  return (
    &lt;&gt;
      &lt;Users /&gt;
      &lt;form onSubmit={handleSubmit}&gt;
        &lt;input ref={nameRef} /&gt;
        &lt;input type="submit" value={isLoading ? '保存中...' : isError ? '保存失败' : isSuccess ? "保存成功" : "保存"} /&gt;
      &lt;/form&gt;
      {isError &amp;&amp; &lt;pre style={{ color: 'red' }}&gt;{error.response.data.message}&lt;/pre&gt;}
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h2 id="t6727.分页查询">27.分页查询 <a href="#t6727.分页查询"> # </a></h2>
<h3 id="t6827.1 src\App.js">27.1 src\App.js <a href="#t6827.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
import { useQuery, useQueryClient, useMutation } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
<span class="hljs-addition">+function fetchUsers({ queryKey: [_, { pageNumber }] }) {</span>
<span class="hljs-addition">+  return request.get('/users', {</span>
<span class="hljs-addition">+    params: {</span>
<span class="hljs-addition">+      pageNumber</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+}</span>
function Users() {
<span class="hljs-addition">+ const queryClient = useQueryClient();</span>
<span class="hljs-addition">+ const [pageNumber, setPageNumber] = React.useState(1);</span>
<span class="hljs-addition">+ const usersResult = useQuery(['users', { pageNumber }], fetchUsers, {</span>
<span class="hljs-addition">+   onSuccess() {</span>
<span class="hljs-addition">+     queryClient.prefetchQuery(['users', { pageNumber: pageNumber + 1 }], fetchUsers);</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ });</span>
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
        {
<span class="hljs-addition">+         usersResult.data?.data.map(user =&gt; &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;)</span>
        }
      &lt;/ul&gt;
<span class="hljs-addition">+      {&lt;button disabled={pageNumber &lt;= 1} onClick={() =&gt; setPageNumber(pageNumber =&gt; pageNumber - 1)}&gt;上一页&lt;/button&gt;}</span>
<span class="hljs-addition">+      &lt;span&gt;{pageNumber}&lt;/span&gt;</span>
<span class="hljs-addition">+      {&lt;button disabled={usersResult.data?.pageNumber &gt;= usersResult.data?.totalPage} onClick={() =&gt; setPageNumber(pageNumber =&gt; pageNumber + 1)}&gt;下一页&lt;/button&gt;}</span>
    &lt;/&gt;
  )
}

function App() {
  const nameRef = React.useRef();
  const queryClient = useQueryClient();
  const { mutate: saveUser, reset, isLoading, isError, isSuccess, error } = useMutation(
    (values) =&gt; request.post('/users', values), {
    retry: false,
    onMutate(values) {
      queryClient.cancelQueries('users');
      const oldUsers = queryClient.getQueryData('users');
      queryClient.setQueryData('users', oldUsers =&gt; [...oldUsers, { ...values, id: String(Date.now()) }]);
      //return oldUsers;
      return () =&gt; queryClient.setQueryData('users', oldUsers)
    },
    onSuccess(data) {
      queryClient.setQueryData('users', oldUsers =&gt; oldUsers.map((user, index) =&gt; {
        if (index <span class="hljs-comment">=== oldUsers.length - 1) {</span>
          return data;
        }
        return user;
      }));
      //queryClient.invalidateQueries('users');
    },
    onError(error, values, rollback) {
      //alert(error.response.data.message);
      //queryClient.setQueryData('users', rollbackValue);
      console.log(rollback);
      rollback &amp;&amp; rollback();
    },
    onSettled(data, error) {
      queryClient.invalidateQueries('users');
      setTimeout(() =&gt; {
        nameRef.current.value = ''
        reset();
      }, 3000)
    }
  });
  const handleSubmit = (event) =&gt; {
    event.preventDefault();
    const name = nameRef.current.value;
    const user = { name };
    saveUser(user);
  }
  return (
    &lt;&gt;
      &lt;Users /&gt;
      &lt;form onSubmit={handleSubmit}&gt;
        &lt;input ref={nameRef} /&gt;
        &lt;input type="submit" value={isLoading ? '保存中...' : isError ? '保存失败' : isSuccess ? "保存成功" : "保存"} /&gt;
      &lt;/form&gt;
      {isError &amp;&amp; &lt;pre style={{ color: 'red' }}&gt;{error.response.data.message}&lt;/pre&gt;}
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>
<h3 id="t6927.2 api.js">27.2 api.js <a href="#t6927.2 api.js"> # </a></h3>
<p>api.js</p>
<pre><code class="lang-diff">const express = require('express');
const cors = require('cors');
const logger = require('morgan');
const app = express();
app.use(express.json());
app.use(cors({
  allowedHeaders: ["Content-Type"],
  allowMethods: ["GET", 'POST', "PUT", "DELETE", "OPTIONS"]
}));
app.use(logger('dev'));
<span class="hljs-addition">+const users = new Array(30).fill(true).map((item, index) =&gt; ({ id: String(index + 1), name: `name${index + 1}` }))</span>
const posts = new Array(30).fill(true).map((user, index) =&gt; ({ id: String(index + 1), title: `title${index + 1}`, userId: String(index + 1) }))
app.use((req, res, next) =&gt; {
  setTimeout(next, 1000 * 1);
});
app.get('/users', (req, res) =&gt; {
<span class="hljs-addition">+ const pageNumber = Number(req.query.pageNumber);</span>
<span class="hljs-addition">+ const totalPage = Math.floor(users.length / 10);</span>
<span class="hljs-addition">+ const offset = (pageNumber - 1) * 10;</span>
<span class="hljs-addition">+ res.json({</span>
<span class="hljs-addition">+   data: users.slice(offset, offset + 10),</span>
<span class="hljs-addition">+   pageNumber,</span>
<span class="hljs-addition">+   totalPage</span>
<span class="hljs-addition">+ });</span>
});
app.get('/user', (req, res) =&gt; {
  const userId = req.query.userId;
  const user = users.find(user =&gt; user.id <span class="hljs-comment">=== userId);</span>
  if (user)
    res.json(user);
  else
    res.sendStatus(404)
});
app.post('/users', (req, res) =&gt; {
  let user = req.body;
  if (user.name) {
    user.id = (users.length + 1) + '';
    user.createdAt = new Date().toLocaleDateString();
    users.push(user);
    res.json(user);
  } else {
    res.status(400).send({ message: '用户名不能为空!' });
  }
});
app.get('/posts', (req, res) =&gt; {
  res.json(posts);
});
app.listen(8080, () =&gt; console.log('started on port 8080'));
</code></pre>
<h2 id="t7028.无限分页">28.无限分页 <a href="#t7028.无限分页"> # </a></h2>
<ul>
<li><a href="https://react-query.tanstack.com/reference/useInfiniteQuery#_top">useInfiniteQuery</a></li>
</ul>
<h3 id="t7128.1 src\App.js">28.1 src\App.js <a href="#t7128.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from 'react';
<span class="hljs-addition">+import { useInfiniteQuery } from 'react-query';</span>
import { ReactQueryDevtools } from 'react-query/devtools'
import request from './request';
<span class="hljs-addition">+function fetchUsers({ pageParam = 1 }) {</span>
<span class="hljs-addition">+  return request.get('/users', {</span>
<span class="hljs-addition">+    params: {</span>
<span class="hljs-addition">+      pageNumber: pageParam</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+}</span>
function Users() {
<span class="hljs-addition">+ const { data, hasNextPage, fetchNextPage } = useInfiniteQuery(['users'], fetchUsers, {</span>
<span class="hljs-addition">+   getNextPageParam: (lastPageData) =&gt; {</span>
<span class="hljs-addition">+     console.log(lastPageData);</span>
<span class="hljs-addition">+     return lastPageData.pageNumber &lt; lastPageData.totalPage ? lastPageData.pageNumber + 1 : false;</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ });</span>
  return (
    &lt;&gt;
      &lt;h3&gt;用户列表&lt;/h3&gt;
      &lt;ul&gt;
<span class="hljs-addition">+       {</span>
<span class="hljs-addition">+         data?.pages?.map((page, index) =&gt; {</span>
<span class="hljs-addition">+           return (</span>
<span class="hljs-addition">+             &lt;React.Fragment key={index}&gt;</span>
<span class="hljs-addition">+               {</span>
<span class="hljs-addition">+                 page.data?.map(user =&gt; &lt;li key={user.id}&gt;{user.id}:{user.name}&lt;/li&gt;)</span>
<span class="hljs-addition">+               }</span>
<span class="hljs-addition">+             &lt;/React.Fragment&gt;</span>
<span class="hljs-addition">+           )</span>
<span class="hljs-addition">+         })</span>
<span class="hljs-addition">+       }</span>
      &lt;/ul&gt;
<span class="hljs-addition">+     &lt;button disabled={!hasNextPage} onClick={() =&gt; fetchNextPage()}&gt;加载更多&lt;/button&gt;</span>
    &lt;/&gt;
  )
}

function App() {
  return (
    &lt;&gt;
      &lt;Users /&gt;
      &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
    &lt;/&gt;
  )
}
export default App;
</code></pre>

    </div>
  </div>
  <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
          <h4 class="modal-title" id="loginModalLabel">请登录</h4>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="username" class="control-label">姓名:</label>
              <input type="text" class="form-control" id="username" placeholder="珠峰架构VIP会员系统用户名">
            </div>
            <div class="form-group">
              <label for="password" class="control-label">密码:</label>
              <input type="text" class="form-control" id="password" placeholder="珠峰架构VIP会员系统密码">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">登录</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://static.zhufengpeixun.com/jquerymin_1645176580555.js"></script>
  <script src="https://static.zhufengpeixun.com/bootstrapmin_1645176554753.js"></script>
  <script>
  </script>
  <script>
$('.warpper .page-toc ul ul li a').on('click',function(){
  $('.warpper .page-toc ul ul li a').removeClass('my-active')
  $(this).addClass('my-active')
})
$('.logo').on('mouseenter',function(){
  $('.nav').height('450px');
})
$('.nav').on('mouseleave',function(){
  $('.nav').height('80px');
})
$('.logo').on('click',function(){
  $('.nav').css('display','none');
 $('.warpper').css('padding','0px');
})
</script><script type="text/javascript" src="../static/js/theme.js"></script>


</body></html>
