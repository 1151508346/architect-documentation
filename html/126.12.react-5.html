<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>架构师成长计划</title>
    <link rel="stylesheet" type="text/css" href="../static/css/main.css">
    <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css" >
    <style>
        .page-toc > ul .red {
            background: #f3f3f3;
            z-index: 1;
            border-left: 3px solid #009a61;
            -webkit-transition: all .2s ease;
            transition: all .2s ease;
            color: #000
        }
    </style>
</head>
<body>
<div class="nav">
  <div class="logo">架构师成长计划</div>
  <ul>
    <li><a href="../index.html">0.api</a></li>
    <li><a href="../html/0.Async.html">0.Async</a></li>
    <li><a href="../html/0.module.html">0.module</a></li>
    <li><a href="../html/1.ES2015.html">1.ES2015</a></li>
    <li><a href="../html/2.Promise.html">2.Promise</a></li>
    <li><a href="../html/3.Node.html">3.Node</a></li>
    <li><a href="../html/4.NodeInstall.html">4.NodeInstall</a></li>
    <li><a href="../html/5.REPL.html">5.REPL</a></li>
    <li><a href="../html/6.NodeCore.html">6.NodeCore</a></li>
    <li><a href="../html/7.module&NPM.html">7.module&NPM</a></li>
    <li><a href="../html/8.Encoding.html">8.Encoding</a></li>
    <li><a href="../html/9.Buffer.html">9.Buffer</a></li>
    <li><a href="../html/10.fs.html">10.fs</a></li>
    <li><a href="../html/11.Stream-1.html">11.Stream-1</a></li>
    <li><a href="../html/11.Stream-2.html">11.Stream-2</a></li>
    <li><a href="../html/11.Stream-3.html">11.Stream-3</a></li>
    <li><a href="../html/11.Stream-4.html">11.Stream-4</a></li>
    <li><a href="../html/12-Network-2.html">12-Network-2</a></li>
    <li><a href="../html/12.NetWork-3.html">12.NetWork-3</a></li>
    <li><a href="../html/12.Network-1.html">12.Network-1</a></li>
    <li><a href="../html/13.tcp.html">13.tcp</a></li>
    <li><a href="../html/14.http-1.html">14.http-1</a></li>
    <li><a href="../html/14.http-2.html">14.http-2</a></li>
    <li><a href="../html/15.compress.html">15.compress</a></li>
    <li><a href="../html/16.crypto.html">16.crypto</a></li>
    <li><a href="../html/17.process.html">17.process</a></li>
    <li><a href="../html/18.yargs.html">18.yargs</a></li>
    <li><a href="../html/19.cache.html">19.cache</a></li>
    <li><a href="../html/20.action.html">20.action</a></li>
    <li><a href="../html/21.https.html">21.https</a></li>
    <li><a href="../html/22.cookie.html">22.cookie</a></li>
    <li><a href="../html/23.session.html">23.session</a></li>
    <li><a href="../html/24.express-1.html">24.express-1</a></li>
    <li><a href="../html/24.express-2.html">24.express-2</a></li>
    <li><a href="../html/24.express-3.html">24.express-3</a></li>
    <li><a href="../html/24.express-4.html">24.express-4</a></li>
    <li><a href="../html/25.koa-1.html">25.koa-1</a></li>
    <li><a href="../html/26.webpack-1-basic.html">26.webpack-1-basic</a></li>
    <li>
      <a href="../html/26.webpack-2-optimize.html">26.webpack-2-optimize</a>
    </li>
    <li><a href="../html/26.webpack-3-file.html">26.webpack-3-file</a></li>
    <li>
      <a href="../html/26.webpack-4.tapable.html">26.webpack-4.tapable</a>
    </li>
    <li><a href="../html/26.webpack-5-AST.html">26.webpack-5-AST</a></li>
    <li>
      <a href="../html/26.webpack-6-sources.html">26.webpack-6-sources</a>
    </li>
    <li><a href="../html/26.webpack-7-loader.html">26.webpack-7-loader</a></li>
    <li><a href="../html/26.webpack-8-plugin.html">26.webpack-8-plugin</a></li>
    <li><a href="../html/26.webpack-9-hand.html">26.webpack-9-hand</a></li>
    <li>
      <a href="../html/26.webpack-10-prepare.html">26.webpack-10-prepare</a>
    </li>
    <li><a href="../html/28.redux.html">28.redux</a></li>
    <li><a href="../html/28.redux-jwt-back.html">28.redux-jwt-back</a></li>
    <li><a href="../html/28.redux-jwt-front.html">28.redux-jwt-front</a></li>
    <li><a href="../html/29.mongodb-1.html">29.mongodb-1</a></li>
    <li><a href="../html/29.mongodb-2.html">29.mongodb-2</a></li>
    <li><a href="../html/29.mongodb-3.html">29.mongodb-3</a></li>
    <li><a href="../html/29.mongodb-4.html">29.mongodb-4</a></li>
    <li><a href="../html/29.mongodb-5.html">29.mongodb-5</a></li>
    <li><a href="../html/29.mongodb-6.html">29.mongodb-6</a></li>
    <li><a href="../html/30.cms-1-mysql.html">30.cms-1-mysql</a></li>
    <li><a href="../html/30.cms-2-mysql.html">30.cms-2-mysql</a></li>
    <li><a href="../html/30.cms-3-mysql.html">30.cms-3-mysql</a></li>
    <li><a href="../html/30.cms-4-nunjucks.html">30.cms-4-nunjucks</a></li>
    <li><a href="../html/30.cms-5-mock.html">30.cms-5-mock</a></li>
    <li><a href="../html/30.cms-6-egg.html">30.cms-6-egg</a></li>
    <li><a href="../html/30.cms-7-api.html">30.cms-7-api</a></li>
    <li><a href="../html/30.cms-8-roadhog.html">30.cms-8-roadhog</a></li>
    <li><a href="../html/30.cms-9-yaml.html">30.cms-9-yaml</a></li>
    <li><a href="../html/30.cms-10-umi.html">30.cms-10-umi</a></li>
    <li><a href="../html/30.cms-12-dva.html">30.cms-12-dva</a></li>
    <li><a href="../html/30.cms-13-dva-ant.html">30.cms-13-dva-ant</a></li>
    <li><a href="../html/30.cms-14-front.html">30.cms-14-front</a></li>
    <li><a href="../html/30.cms-15-deploy.html">30.cms-15-deploy</a></li>
    <li><a href="../html/31.dva.html">31.dva</a></li>
    <li>
      <a href="../html/31.cms-13-dva-antdesign.html">31.cms-13-dva-antdesign</a>
    </li>
    <li><a href="../html/33.redis.html">33.redis</a></li>
    <li><a href="../html/34.unittest.html">34.unittest</a></li>
    <li><a href="../html/35.jwt.html">35.jwt</a></li>
    <li><a href="../html/36.websocket-1.html">36.websocket-1</a></li>
    <li><a href="../html/36.websocket-2.html">36.websocket-2</a></li>
    <li><a href="../html/38.chat-api-1.html">38.chat-api-1</a></li>
    <li><a href="../html/38.chat-api-2.html">38.chat-api-2</a></li>
    <li><a href="../html/38.chat-3.html">38.chat-3</a></li>
    <li><a href="../html/38.chat-api-3.html">38.chat-api-3</a></li>
    <li><a href="../html/38.chat.html">38.chat</a></li>
    <li><a href="../html/38.chat2.html">38.chat2</a></li>
    <li><a href="../html/38.chat2.html">38.chat2</a></li>
    <li><a href="../html/39.crawl-0.html">39.crawl-0</a></li>
    <li><a href="../html/39.crawl-1.html">39.crawl-1</a></li>
    <li><a href="../html/39.crawl-2.html">39.crawl-2</a></li>
    <li><a href="../html/40.deploy.html">40.deploy</a></li>
    <li><a href="../html/41.safe.html">41.safe</a></li>
    <li><a href="../html/42.test.html">42.test</a></li>
    <li><a href="../html/43.nginx.html">43.nginx</a></li>
    <li><a href="../html/44.enzyme.html">44.enzyme</a></li>
    <li><a href="../html/45.docker.html">45.docker</a></li>
    <li><a href="../html/46.elastic.html">46.elastic</a></li>
    <li><a href="../html/47.oauth.html">47.oauth</a></li>
    <li><a href="../html/48.wxpay.html">48.wxpay</a></li>
    <li><a href="../html/index.html">index</a></li>
    <li><a href="../html/52.UML.html">52.UML</a></li>
    <li><a href="../html/53.design.html">53.design</a></li>
    <li><a href="../html/index.html">index</a></li>
    <li><a href="../html/54.linux.html">54.linux</a></li>
    <li><a href="../html/57.ts.html">57.ts</a></li>
    <li><a href="../html/56.react-ssr.html">56.react-ssr</a></li>
    <li><a href="../html/58.ts_react.html">58.ts_react</a></li>
    <li><a href="../html/59.ketang.html">59.ketang</a></li>
    <li><a href="../html/59.ketang2.html">59.ketang2</a></li>
    <li><a href="../html/61.1.devops-linux.html">61.1.devops-linux</a></li>
    <li><a href="../html/61.2.devops-vi.html">61.2.devops-vi</a></li>
    <li><a href="../html/61.3.devops-user.html">61.3.devops-user</a></li>
    <li><a href="../html/61.4.devops-auth.html">61.4.devops-auth</a></li>
    <li><a href="../html/61.5.devops-shell.html">61.5.devops-shell</a></li>
    <li><a href="../html/61.6.devops-install.html">61.6.devops-install</a></li>
    <li><a href="../html/61.7.devops-system.html">61.7.devops-system</a></li>
    <li><a href="../html/61.8.devops-service.html">61.8.devops-service</a></li>
    <li><a href="../html/61.9.devops-network.html">61.9.devops-network</a></li>
    <li><a href="../html/61.10.devops-nginx.html">61.10.devops-nginx</a></li>
    <li><a href="../html/61.11.devops-docker.html">61.11.devops-docker</a></li>
    <li><a href="../html/61.12.devops-jekins.html">61.12.devops-jekins</a></li>
    <li><a href="../html/61.13.devops-groovy.html">61.13.devops-groovy</a></li>
    <li><a href="../html/61.14.devops-php.html">61.14.devops-php</a></li>
    <li><a href="../html/61.15.devops-java.html">61.15.devops-java</a></li>
    <li><a href="../html/61.16.devops-node.html">61.16.devops-node</a></li>
    <li><a href="../html/61.17.devops-k8s.html">61.17.devops-k8s</a></li>
    <li><a href="../html/62.1.react-basic.html">62.1.react-basic</a></li>
    <li><a href="../html/62.2.react-state.html">62.2.react-state</a></li>
    <li><a href="../html/62.3.react-high.html">62.3.react-high</a></li>
    <li><a href="../html/62.4.react-optimize.html">62.4.react-optimize</a></li>
    <li><a href="../html/62.5.react-hooks.html">62.5.react-hooks</a></li>
    <li>
      <a href="../html/62.6.react-immutable.html">62.6.react-immutable</a>
    </li>
    <li><a href="../html/62.7.react-mobx.html">62.7.react-mobx</a></li>
    <li><a href="../html/62.8.react-source.html">62.8.react-source</a></li>
    <li><a href="../html/63.1.redux.html">63.1.redux</a></li>
    <li>
      <a href="../html/63.2.redux-middleware.html">63.2.redux-middleware</a>
    </li>
    <li><a href="../html/63.3.redux-hooks.html">63.3.redux-hooks</a></li>
    <li><a href="../html/63.4.redux-saga.html">63.4.redux-saga</a></li>
    <li>
      <a href="../html/63.5.redux-saga-hand.html">63.5.redux-saga-hand</a>
    </li>
    <li><a href="../html/64.1.router.html">64.1.router</a></li>
    <li>
      <a href="../html/64.2.router-connected.html">64.2.router-connected</a>
    </li>
    <li><a href="../html/65.1.typescript.html">65.1.typescript</a></li>
    <li><a href="../html/65.2.typescript.html">65.2.typescript</a></li>
    <li><a href="../html/65.3.typescript.html">65.3.typescript</a></li>
    <li><a href="../html/65.4.antd.html">65.4.antd</a></li>
    <li><a href="../html/65.4.definition.html">65.4.definition</a></li>
    <li><a href="../html/66-1.vue-base.html">66-1.vue-base</a></li>
    <li><a href="../html/66-2.vue-component.html">66-2.vue-component</a></li>
    <li><a href="../html/66-3.vue-cli3.0.html">66-3.vue-cli3.0</a></li>
    <li><a href="../html/66-4.$message组件.html">66-4.$message组件</a></li>
    <li><a href="../html/66-5.Form组件.html">66-5.Form组件</a></li>
    <li><a href="../html/66-6.tree.html">66-6.tree</a></li>
    <li>
      <a href="../html/66-7.vue-router-apply.html">66-7.vue-router-apply</a>
    </li>
    <li><a href="../html/66-8.axios-apply.html">66-8.axios-apply</a></li>
    <li><a href="../html/66-9.vuex-apply.html">66-9.vuex-apply</a></li>
    <li><a href="../html/66-10.jwt-vue.html">66-10.jwt-vue</a></li>
    <li><a href="../html/66-11.vue-ssr.html">66-11.vue-ssr</a></li>
    <li><a href="../html/66-12.nuxt-apply.html">66-12.nuxt-apply</a></li>
    <li><a href="../html/66-13.pwa.html">66-13.pwa</a></li>
    <li><a href="../html/66-14.vue单元测试.html">66-14.vue单元测试</a></li>
    <li><a href="../html/66-15.权限校验.html">66-15.权限校验</a></li>
    <li><a href="../html/67-1-network.html">67-1-network</a></li>
    <li><a href="../html/68-2-wireshark.html">68-2-wireshark</a></li>
    <li><a href="../html/7.npm2.html">7.npm2</a></li>
    <li><a href="../html/69-hooks.html">69-hooks</a></li>
    <li><a href="../html/70-deploy.html">70-deploy</a></li>
    <li><a href="../html/71-hmr.html">71-hmr</a></li>
    <li><a href="../html/72.deploy.html">72.deploy</a></li>
    <li><a href="../html/73.import.html">73.import</a></li>
    <li><a href="../html/74.mobile.html">74.mobile</a></li>
    <li>
      <a href="../html/75.webpack-1.文件分析.html">75.webpack-1.文件分析</a>
    </li>
    <li><a href="../html/75.webpack-2.loader.html">75.webpack-2.loader</a></li>
    <li>
      <a href="../html/75.webpack-3.源码流程.html">75.webpack-3.源码流程</a>
    </li>
    <li>
      <a href="../html/75.webpack-4.tapable.html">75.webpack-4.tapable</a>
    </li>
    <li>
      <a href="../html/75.webpack-5.prepare.html">75.webpack-5.prepare</a>
    </li>
    <li>
      <a href="../html/75.webpack-6.resolve.html">75.webpack-6.resolve</a>
    </li>
    <li><a href="../html/75.webpack-7.loader.html">75.webpack-7.loader</a></li>
    <li><a href="../html/75.webpack-8.module.html">75.webpack-8.module</a></li>
    <li><a href="../html/75.webpack-9.chunk.html">75.webpack-9.chunk</a></li>
    <li><a href="../html/75.webpack-10.asset.html">75.webpack-10.asset</a></li>
    <li><a href="../html/75.webpack-11.实现.html">75.webpack-11.实现</a></li>
    <li><a href="../html/76.react_optimize.html">76.react_optimize</a></li>
    <li><a href="../html/77.ts_ketang_back.html">77.ts_ketang_back</a></li>
    <li><a href="../html/77.ts_ketang_front.html">77.ts_ketang_front</a></li>
    <li><a href="../html/78.vue-domdiff.html">78.vue-domdiff</a></li>
    <li><a href="../html/79.grammar.html">79.grammar</a></li>
    <li><a href="../html/80.tree.html">80.tree</a></li>
    <li><a href="../html/81.axios.html">81.axios</a></li>
    <li><a href="../html/82.1.react.html">82.1.react</a></li>
    <li><a href="../html/82.2.react-high.html">82.2.react-high</a></li>
    <li><a href="../html/82.3.react-router.html">82.3.react-router</a></li>
    <li><a href="../html/82.4.redux.html">82.4.redux</a></li>
    <li>
      <a href="../html/82.5.redux_middleware.html">82.5.redux_middleware</a>
    </li>
    <li><a href="../html/82.6.connected.html">82.6.connected</a></li>
    <li><a href="../html/82.7.saga.html">82.7.saga</a></li>
    <li><a href="../html/82.8.dva.html">82.8.dva</a></li>
    <li><a href="../html/82.8.dva-source.html">82.8.dva-source</a></li>
    <li><a href="../html/82.9.roadhog.html">82.9.roadhog</a></li>
    <li><a href="../html/82.10.umi.html">82.10.umi</a></li>
    <li><a href="../html/82.11.antdesign.html">82.11.antdesign</a></li>
    <li><a href="../html/82.12.ketang-front.html">82.12.ketang-front</a></li>
    <li><a href="../html/82.12.ketang-back.html">82.12.ketang-back</a></li>
    <li><a href="../html/83.upload.html">83.upload</a></li>
    <li><a href="../html/84.graphql.html">84.graphql</a></li>
    <li><a href="../html/85.antpro.html">85.antpro</a></li>
    <li><a href="../html/86.1.uml.html">86.1.uml</a></li>
    <li><a href="../html/86.2.design.html">86.2.design</a></li>
    <li><a href="../html/87.postcss.html">87.postcss</a></li>
    <li><a href="../html/88.react16-1.html">88.react16-1</a></li>
    <li><a href="../html/89.nextjs.html">89.nextjs</a></li>
    <li><a href="../html/90.react-test.html">90.react-test</a></li>
    <li><a href="../html/91.react-ts.html">91.react-ts</a></li>
    <li><a href="../html/92.rbac.html">92.rbac</a></li>
    <li><a href="../html/93.tsnode.html">93.tsnode</a></li>
    <li><a href="../html/94.1.JavaScript.html">94.1.JavaScript</a></li>
    <li><a href="../html/94.2.JavaScript.html">94.2.JavaScript</a></li>
    <li><a href="../html/94.3.MODULE.html">94.3.MODULE</a></li>
    <li><a href="../html/94.4.EventLoop.html">94.4.EventLoop</a></li>
    <li><a href="../html/94.5.文件上传.html">94.5.文件上传</a></li>
    <li><a href="../html/94.6.https.html">94.6.https</a></li>
    <li><a href="../html/94.7. nginx.html">94.7. nginx</a></li>
    <li><a href="../html/95.1. react.html">95.1. react</a></li>
    <li><a href="../html/95.2.react.html">95.2.react</a></li>
    <li><a href="../html/96.1.react16.html">96.1.react16</a></li>
    <li><a href="../html/96.2.fiber.html">96.2.fiber</a></li>
    <li><a href="../html/96.3.fiber.html">96.3.fiber</a></li>
    <li><a href="../html/97.serverless.html">97.serverless</a></li>
    <li><a href="../html/98.websocket.html">98.websocket</a></li>
    <li><a href="../html/100.1.react-basic.html">100.1.react-basic</a></li>
    <li><a href="../html/101.1.monitor.html">101.1.monitor</a></li>
    <li><a href="../html/101.2.monitor.html">101.2.monitor</a></li>
    <li><a href="../html/102.java.html">102.java</a></li>
    <li><a href="../html/103.1.webpack-usage.html">103.1.webpack-usage</a></li>
    <li>
      <a href="../html/103.2.webpack-bundle.html">103.2.webpack-bundle</a>
    </li>
    <li><a href="../html/103.3.webpack-ast.html">103.3.webpack-ast</a></li>
    <li><a href="../html/103.4.webpack-flow.html">103.4.webpack-flow</a></li>
    <li>
      <a href="../html/103.5.webpack-loader.html">103.5.webpack-loader</a>
    </li>
    <li>
      <a href="../html/103.6.webpack-tapable.html">103.6.webpack-tapable</a>
    </li>
    <li>
      <a href="../html/103.7.webpack-plugin.html">103.7.webpack-plugin</a>
    </li>
    <li>
      <a href="../html/103.8.webpack-optimize1.html">103.8.webpack-optimize1</a>
    </li>
    <li>
      <a href="../html/103.9.webpack-optimize2.html">103.9.webpack-optimize2</a>
    </li>
    <li><a href="../html/103.10.webpack-hand.html">103.10.webpack-hand</a></li>
    <li><a href="../html/103.11.webpack-hmr.html">103.11.webpack-hmr</a></li>
    <li><a href="../html/103.13.splitChunks.html">103.13.splitChunks</a></li>
    <li>
      <a href="../html/103.14.webpack-sourcemap.html"
        >103.14.webpack-sourcemap</a
      >
    </li>
    <li>
      <a href="../html/103.15.webpack-compiler1.html"
        >103.15.webpack-compiler1</a
      >
    </li>
    <li>
      <a href="../html/103.15.webpack-compiler2.html"
        >103.15.webpack-compiler2</a
      >
    </li>
    <li><a href="../html/103.16.vite.basic.html">103.16.vite.basic</a></li>
    <li><a href="../html/103.16.vite.source.html">103.16.vite.source</a></li>
    <li><a href="../html/103.17.polyfill.html">103.17.polyfill</a></li>
    <li><a href="../html/104.1.binary.html">104.1.binary</a></li>
    <li><a href="../html/104.2.binary.html">104.2.binary</a></li>
    <li><a href="../html/105.skeleton.html">105.skeleton</a></li>
    <li><a href="../html/106.1.react.html">106.1.react</a></li>
    <li><a href="../html/106.2.react_hooks.html">106.2.react_hooks</a></li>
    <li><a href="../html/106.3.react_router.html">106.3.react_router</a></li>
    <li><a href="../html/106.4.redux.html">106.4.redux</a></li>
    <li>
      <a href="../html/106.5.redux_middleware.html">106.5.redux_middleware</a>
    </li>
    <li>
      <a href="../html/106.6.connected-react-router.html"
        >106.6.connected-react-router</a
      >
    </li>
    <li>
      <a href="../html/106.6.redux-first-history.html">106.6.redux-first-history</a>
    </li>
    <li><a href="../html/106.7.redux-saga.html">106.7.redux-saga</a></li>
    <li><a href="../html/106.8.dva.html">106.8.dva</a></li>
    <li><a href="../html/106.9.umi.html">106.9.umi</a></li>
    <li><a href="../html/106.10.ketang.html">106.10.ketang</a></li>
    <li><a href="../html/106.11.antdesign.html">106.11.antdesign</a></li>
    <li><a href="../html/106.12.antpro.html">106.12.antpro</a></li>
    <li><a href="../html/106.13.router-6.html">106.13.router-6</a></li>
    <li><a href="../html/107.fiber.html">107.fiber</a></li>
    <li><a href="../html/108.http.html">108.http</a></li>
    <li><a href="../html/109.1.webpack_usage.html">109.1.webpack_usage</a></li>
    <li>
      <a href="../html/109.2.webpack_source.html">109.2.webpack_source</a>
    </li>
    <li><a href="../html/109.3.dll.html">109.3.dll</a></li>
    <li><a href="../html/110.nest.js.html">110.nest.js</a></li>
    <li><a href="../html/111.xstate.html">111.xstate</a></li>
    <li><a href="../html/112.Form.html">112.Form</a></li>
    <li><a href="../html/113.redux-saga.html">113.redux-saga</a></li>
    <li>
      <a href="../html/114.react+typescript.html">114.react+typescript</a>
    </li>
    <li><a href="../html/115.immer.html">115.immer</a></li>
    <li><a href="../html/116.pro5.html">116.pro5</a></li>
    <li><a href="../html/117.css-loader.html">117.css-loader</a></li>
    <li><a href="../html/118.1.umi-core.html">118.1.umi-core</a></li>
    <li>
      <a href="../html/119.2.module-federation.html">119.2.module-federation</a>
    </li>
    <li>
      <a href="../html/119.1.module-federation.html">119.1.module-federation</a>
    </li>
    <li>
      <a href="../html/120.create-react-app.html">120.create-react-app</a>
    </li>
    <li><a href="../html/121.react-scripts.html">121.react-scripts</a></li>
    <li><a href="../html/122.react-optimize.html">122.react-optimize</a></li>
    <li><a href="../html/123.jsx-runtime.html">123.jsx-runtime</a></li>
    <li><a href="../html/124.next.js.html">124.next.js</a></li>
    <li><a href="../html/125.1.linux.html">125.1.linux</a></li>
    <li><a href="../html/125.2.linux-vi.html">125.2.linux-vi</a></li>
    <li><a href="../html/125.3.linux-user.html">125.3.linux-user</a></li>
    <li><a href="../html/125.4.linux-auth.html">125.4.linux-auth</a></li>
    <li><a href="../html/125.5.linux-shell.html">125.5.linux-shell</a></li>
    <li><a href="../html/125.6.linux-install.html">125.6.linux-install</a></li>
    <li><a href="../html/125.7.linux-system.html">125.7.linux-system</a></li>
    <li><a href="../html/125.8.linux-service.html">125.8.linux-service</a></li>
    <li><a href="../html/125.9.linux-network.html">125.9.linux-network</a></li>
    <li><a href="../html/125.10.nginx.html">125.10.nginx</a></li>
    <li><a href="../html/125.11.docker.html">125.11.docker</a></li>
    <li><a href="../html/125.12.ci.html">125.12.ci</a></li>
    <li><a href="../html/125.13.k8s.html">125.13.k8s</a></li>
    <li><a href="../html/125.14.k8s.html">125.14.k8s</a></li>
    <li><a href="../html/125.15.k8s.html">125.15.k8s</a></li>
    <li><a href="../html/125.16.k8s.html">125.16.k8s</a></li>
    <li><a href="../html/126.11.react-1.html">126.11.react-1</a></li>
    <li><a href="../html/126.12.react-2.html">126.12.react-2</a></li>
    <li><a href="../html/126.12.react-3.html">126.12.react-3</a></li>
    <li><a href="../html/126.12.react-4.html">126.12.react-4</a></li>
    <li><a href="../html/126.12.react-5.html">126.12.react-5</a></li>
    <li><a href="../html/127.frontend.html">127.frontend</a></li>
    <li><a href="../html/128.rollup.html">128.rollup</a></li>
    <li><a href="../html/129.px2rem-loader.html">129.px2rem-loader</a></li>
    <li><a href="../html/130.health.html">130.health</a></li>
    <li><a href="../html/131.hooks.html">131.hooks</a></li>
    <li><a href="../html/132.keepalive.html">132.keepalive</a></li>
    <li><a href="../html/133.vue-cli.html">133.vue-cli</a></li>
    <li><a href="../html/134.react18.html">134.react18</a></li>
    <li><a href="../html/135.function.html">135.function</a></li>
    <li><a href="../html/136.toolkit.html">136.toolkit</a></li>
    <li><a href="../html/137.lerna.html">137.lerna</a></li>
    <li><a href="../html/138.create-vite.html">138.create-vite</a></li>
    <li><a href="../html/139.cli.html">139.cli</a></li>
    <li><a href="../html/140.antd.html">140.antd</a></li>
    <li><a href="../html/141.react-dnd.html">141.react-dnd</a></li>
    <li><a href="../html/142.1.link.html">142.1.link</a></li>
    <li><a href="../html/143.1.gulp.html">143.1.gulp</a></li>
    <li><a href="../html/143.2.stream.html">143.2.stream</a></li>
    <li><a href="../html/143.3.gulp.html">143.3.gulp</a></li>
    <li><a href="../html/144.1.closure.html">144.1.closure</a></li>
    <li><a href="../html/144.2.v8.html">144.2.v8</a></li>
    <li><a href="../html/144.3.gc.html">144.3.gc</a></li>
    <li class="active"><a href="../html/145.react-router-v6.html">145.react-router-v6</a></li>
    <li><a href="../html/145.react-router-v6.html">145.react-router-v6</a></li>
    <li><a href="../html/146.browser.html">146.browser</a></li>
    <li><a href="../html/147.lighthouse.html">147.lighthouse</a></li>
    <li><a href="../html/148.1.basic.html">148.1.basic</a></li>
    <li><a href="../html/148.2.basic .html">148.2.basic </a></li>
    <li><a href="../html/148.3.basic.html">148.3.basic</a></li>
    <li class="active"><a href="../html/148.4.basic.html">148.4.basic</a></li>
    <li><a href="../html/148.5.basic.html">148.5.basic</a></li>
    <li><a href="../html/149.1.vite.html">149.1.vite</a></li>
    <li><a href="../html/149.2.vite.html">149.2.vite</a></li>
    <li><a href="../html/149.3.vite.html">149.3.vite</a></li>
    <li><a href="../html/149.4.vite.html">149.4.vite</a></li>
    <li><a href="../html/150.react-window.html">150.react-window</a></li>
    <li><a href="../html/151.react-query.html">151.react-query</a></li>
    <li><a href="../html/152.useRequest.html">152.useRequest</a></li>
    <li><a href="../html/153.transition.html">153.transition</a></li>
    <li><a href="../html/154.emotion.html">154.emotion</a></li>
    <li><a href="../html/155.1.formily.html">155.1.formily</a></li>
    <li><a href="../html/155.2.formily.html">155.2.formily</a></li>
    <li><a href="../html/155.3.formily.html">155.3.formily</a></li>
    <li><a href="../html/155.3.1.mobx.usage.html">155.3.1.mobx.usage</a></li>
    <li><a href="../html/155.3.2.mobx.source.html">155.3.2.mobx.source</a></li>
    <li><a href="../html/156.vue-loader.html">156.vue-loader</a></li>
    <li><a href="../html/103.11.mf.html">103.11.mf</a></li>
    <li><a href="../html/157.1.react18.html">157.1.react18</a></li>
    <li><a href="../html/158.umi4.html">158.umi4</a></li>
    <li><a href="../html/159.rxjs.html">159.rxjs</a></li>
    <li><a href="../html/159.rxjs2.html">159.rxjs2</a></li>
    <li><a href="../html/160.bff.html">160.bff</a></li>
    <li><a href="../html/161.zustand.html">161.zustand</a></li>
    <li><a href="../html/162.vscode.html">162.vscode</a></li>
    <li><a href="../html/163.emp.html">163.emp</a></li>
  </ul>
</div>

 
                        
<div class="warpper">
    <div class="page-toc">
        <ul><li><a href="#t01.核心知识">1.核心知识</a><ul><li><a href="#t11.1 fiber">1.1 fiber</a><ul><li><a href="#t21.1.1 fiber数据结构">1.1.1 fiber数据结构</a></li><li><a href="#t31.1.2 构建和完成">1.1.2 构建和完成</a></li><li><a href="#t41.1.3 案例">1.1.3 案例</a></li></ul></li><li><a href="#t51.2 updateQueue">1.2 updateQueue</a></li><li><a href="#t61.3 位运算">1.3 位运算</a><ul><li><a href="#t71.3.1 按位与(&)">1.3.1 按位与(&)</a></li><li><a href="#t81.3.2 按位或(|)">1.3.2 按位或(|)</a></li></ul></li><li><a href="#t91.4 collectEffectList">1.4 collectEffectList</a></li></ul></li><li><a href="#t102.实现虚拟DOM">2.实现虚拟DOM</a><ul><li><a href="#t112.1 package.json">2.1 package.json</a></li><li><a href="#t122.2 src\index.js">2.2 src\index.js</a></li><li><a href="#t132.3 ReactSymbols.js">2.3 ReactSymbols.js</a></li><li><a href="#t142.4 react.js">2.4 react.js</a></li></ul></li><li><a href="#t153.开始WorkOnRoot">3.开始WorkOnRoot</a><ul><li><a href="#t163.1 从render到执行工作循环">3.1 从render到执行工作循环</a></li><li><a href="#t173.2 fiber结构">3.2 fiber结构</a></li><li><a href="#t183.3 src\index.js">3.3 src\index.js</a></li><li><a href="#t193.4 react-dom.js">3.4 react-dom.js</a></li><li><a href="#t203.5 ReactFiberRoot.js">3.5 ReactFiberRoot.js</a></li><li><a href="#t213.6 ReactFiber.js">3.6 ReactFiber.js</a></li><li><a href="#t223.7 ReactWorkTags.js">3.7 ReactWorkTags.js</a></li><li><a href="#t233.8 ReactUpdateQueue.js">3.8 ReactUpdateQueue.js</a></li><li><a href="#t243.9 ReactFiberReconciler.js">3.9 ReactFiberReconciler.js</a></li><li><a href="#t253.10 ReactFiberWorkLoop.js">3.10 ReactFiberWorkLoop.js</a></li></ul></li><li><a href="#t263.创建createWorkInProgress">3.创建createWorkInProgress</a><ul><li><a href="#t273.1 src\ReactFiberWorkLoop.js">3.1 src\ReactFiberWorkLoop.js</a></li><li><a href="#t283.2 src\ReactFiber.js">3.2 src\ReactFiber.js</a></li><li><a href="#t293.3 src\ReactFiberFlags.js">3.3 src\ReactFiberFlags.js</a></li></ul></li><li><a href="#t304.初次渲染">4.初次渲染</a><ul><li><a href="#t314.1 src\index.js">4.1 src\index.js</a></li><li><a href="#t324.2 ReactFiberWorkLoop.js">4.2 ReactFiberWorkLoop.js</a></li><li><a href="#t334.3 ReactWorkTags.js">4.3 ReactWorkTags.js</a></li><li><a href="#t344.4 ReactFiberBeginWork.js">4.4 ReactFiberBeginWork.js</a></li><li><a href="#t354.5 ReactFiberCompleteWork.js">4.5 ReactFiberCompleteWork.js</a></li><li><a href="#t364.6 ReactFiberFlags.js">4.6 ReactFiberFlags.js</a></li><li><a href="#t374.7 ReactDOMHostConfig.js">4.7 ReactDOMHostConfig.js</a></li><li><a href="#t384.8 src\ReactDOMComponent.js">4.8 src\ReactDOMComponent.js</a></li><li><a href="#t394.9 src\ReactChildFiber.js">4.9 src\ReactChildFiber.js</a></li><li><a href="#t404.10 ReactFiber.js">4.10 ReactFiber.js</a></li><li><a href="#t414.11 ReactFiberCommitWork.js">4.11 ReactFiberCommitWork.js</a></li></ul></li><li><a href="#t425.单节点key相同,类型相同">5.单节点key相同,类型相同</a><ul><li><a href="#t435.1 .eslintrc">5.1 .eslintrc</a></li><li><a href="#t445.2 public\index.html">5.2 public\index.html</a></li><li><a href="#t455.3 src\index.js">5.3 src\index.js</a></li><li><a href="#t465.4 src\react-dom.js">5.4 src\react-dom.js</a></li><li><a href="#t475.5 ReactFiberWorkLoop.js">5.5 ReactFiberWorkLoop.js</a></li><li><a href="#t485.6 ReactFiberFlags.js">5.6 ReactFiberFlags.js</a></li><li><a href="#t495.7 src\ReactFiberCommitWork.js">5.7 src\ReactFiberCommitWork.js</a></li><li><a href="#t505.8 src\ReactDOMComponent.js">5.8 src\ReactDOMComponent.js</a></li><li><a href="#t515.9 src\ReactChildFiber.js">5.9 src\ReactChildFiber.js</a></li><li><a href="#t525.10 ReactDOMHostConfig.js">5.10 ReactDOMHostConfig.js</a></li><li><a href="#t535.11 ReactFiberCompleteWork.js">5.11 ReactFiberCompleteWork.js</a></li></ul></li><li><a href="#t546.单节点key相同,类型相同">6.单节点key相同,类型相同</a><ul><li><a href="#t556.1 public\index.html">6.1 public\index.html</a></li><li><a href="#t566.2 src\index.js">6.2 src\index.js</a></li></ul></li><li><a href="#t577.单节点类型相同,key不同">7.单节点类型相同,key不同</a><ul><li><a href="#t587.1 public\index.html">7.1 public\index.html</a></li><li><a href="#t597.2 src\index.js">7.2 src\index.js</a></li></ul></li><li><a href="#t608.原来多个节点，现在只有一个节点">8.原来多个节点，现在只有一个节点</a><ul><li><a href="#t618.1 public\index.html">8.1 public\index.html</a></li><li><a href="#t628.2 src\index.js">8.2 src\index.js</a></li><li><a href="#t638.3 ReactChildFiber.js">8.3 ReactChildFiber.js</a></li><li><a href="#t648.4 src\ReactFiberCompleteWork.js">8.4 src\ReactFiberCompleteWork.js</a></li><li><a href="#t658.5 ReactDOMHostConfig.js">8.5 ReactDOMHostConfig.js</a></li></ul></li><li><a href="#t669.多节点DIFF">9.多节点DIFF</a></li><li><a href="#t6710.多个节点的数量和key相同，有的type不同">10.多个节点的数量和key相同，有的type不同</a><ul><li><a href="#t6810.1 public\index.html">10.1 public\index.html</a></li><li><a href="#t6910.2 src\index.js">10.2 src\index.js</a></li><li><a href="#t7010.3 src\ReactChildFiber.js">10.3 src\ReactChildFiber.js</a></li><li><a href="#t7110.4 src\ReactFiberWorkLoop.js">10.4 src\ReactFiberWorkLoop.js</a></li><li><a href="#t7210.5 ReactFiberCommitWork.js">10.5 ReactFiberCommitWork.js</a></li></ul></li><li><a href="#t7311. 多个节点的类型和key全部相同，有新增元素">11. 多个节点的类型和key全部相同，有新增元素</a><ul><li><a href="#t7411.1 public\index.html">11.1 public\index.html</a></li><li><a href="#t7511.2 src\index.js">11.2 src\index.js</a></li><li><a href="#t7611.3 src\ReactChildFiber.js">11.3 src\ReactChildFiber.js</a></li></ul></li><li><a href="#t7712. 7.多个节点的类型和key全部相同，有删除老元素">12. 7.多个节点的类型和key全部相同，有删除老元素</a><ul><li><a href="#t7812.1 public\index.html">12.1 public\index.html</a></li><li><a href="#t7912.2 src\index.js">12.2 src\index.js</a></li><li><a href="#t8012.3 ReactChildFiber.js">12.3 ReactChildFiber.js</a></li></ul></li><li><a href="#t8113. 多个节点数量不同、key不同">13. 多个节点数量不同、key不同</a><ul><li><a href="#t8213.1 public\index.html">13.1 public\index.html</a></li><li><a href="#t8313.2 src\index.js">13.2 src\index.js</a></li><li><a href="#t8413.3 src\ReactChildFiber.js">13.3 src\ReactChildFiber.js</a></li><li><a href="#t8514.4 src\ReactFiberFlags.js">14.4 src\ReactFiberFlags.js</a></li><li><a href="#t8614.5 src\ReactFiberWorkLoop.js">14.5 src\ReactFiberWorkLoop.js</a></li></ul></li></ul>
    </div>
    <div class="content markdown-body">
        <h2 id="t01.&#x6838;&#x5FC3;&#x77E5;&#x8BC6;">1.&#x6838;&#x5FC3;&#x77E5;&#x8BC6; <a href="#t01.&#x6838;&#x5FC3;&#x77E5;&#x8BC6;"> # </a></h2>
<h3 id="t11.1 fiber">1.1 fiber <a href="#t11.1 fiber"> # </a></h3>
<ul>
<li>&#x4E3A;&#x4E86;&#x8BA9;&#x6E32;&#x67D3;&#x7684;&#x8FC7;&#x7A0B;&#x53EF;&#x4EE5;&#x4E0D;&#x65AD;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;&#x6574;&#x4E2A;&#x6E32;&#x67D3;&#x4EFB;&#x52A1;&#x5206;&#x6210;&#x82E5;&#x5E72;&#x4E2A;task(&#x5DE5;&#x4F5C;&#x5355;&#x5143;),&#x6BCF;&#x4E2A;&#x5DE5;&#x4F5C;&#x5355;&#x5143;&#x5C31;&#x662F;&#x4E00;&#x4E2A;fiber</li>
<li>&#x6BCF;&#x4E2A;&#x865A;&#x62DF;DOM&#x8282;&#x70B9;&#x5185;&#x90E8;&#x8868;&#x793A;&#x4E3A;&#x4E00;&#x4E2A;fiber&#x5BF9;&#x8C61;</li>
<li>render&#x9636;&#x6BB5;&#x4F1A;&#x6839;&#x636E;&#x865A;&#x62DF;DOM&#x4EE5;&#x6DF1;&#x5EA6;&#x4F18;&#x5148;&#x7684;&#x65B9;&#x5F0F;&#x6784;&#x5EFA;Fiber&#x6811;</li>
</ul>
<h4 id="t21.1.1 fiber&#x6570;&#x636E;&#x7ED3;&#x6784;">1.1.1 fiber&#x6570;&#x636E;&#x7ED3;&#x6784; <a href="#t21.1.1 fiber&#x6570;&#x636E;&#x7ED3;&#x6784;"> # </a></h4>
<pre><code class="lang-js"><span class="hljs-keyword">let</span> element = {
    <span class="hljs-attr">type</span>: <span class="hljs-string">&apos;div&apos;</span>,
    <span class="hljs-attr">key</span>: <span class="hljs-string">&apos;A&apos;</span>,
    <span class="hljs-attr">props</span>: {
        style,
        <span class="hljs-attr">children</span>: [
            <span class="hljs-string">&apos;A&#x6587;&#x672C;&apos;</span>,
            { <span class="hljs-attr">type</span>: <span class="hljs-string">&apos;div&apos;</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">&apos;B1&apos;</span>, <span class="hljs-attr">props</span>: { style, <span class="hljs-attr">children</span>: <span class="hljs-string">&apos;B1&#x6587;&#x672C;&apos;</span> } },
            { <span class="hljs-attr">type</span>: <span class="hljs-string">&apos;div&apos;</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">&apos;B2&apos;</span>, <span class="hljs-attr">props</span>: { style, <span class="hljs-attr">children</span>: <span class="hljs-string">&apos;B2&#x6587;&#x672C;&apos;</span> } }
        ]
    }
}
</code></pre>
<p><img src="https://static.zhufengpeixun.com/fiber_shu_ju_jie_gou_1636706883352.jpg" alt></p>
<h4 id="t31.1.2 &#x6784;&#x5EFA;&#x548C;&#x5B8C;&#x6210;">1.1.2 &#x6784;&#x5EFA;&#x548C;&#x5B8C;&#x6210; <a href="#t31.1.2 &#x6784;&#x5EFA;&#x548C;&#x5B8C;&#x6210;"> # </a></h4>
<p><img src="https://static.zhufengpeixun.com/gou_jian_he_wan_cheng_fiber_shu_1_1636707293363.jpg" alt></p>
<h4 id="t41.1.3 &#x6848;&#x4F8B;">1.1.3 &#x6848;&#x4F8B; <a href="#t41.1.3 &#x6848;&#x4F8B;"> # </a></h4>
<p><img src="https://static.zhufengpeixun.com/gou_jian_he_wan_cheng_fiber_shu_an_li_1_1636710450130.jpg" alt></p>
<h3 id="t51.2 updateQueue">1.2 updateQueue <a href="#t51.2 updateQueue"> # </a></h3>
<ul>
<li><a href="https://www.processon.com/diagraming/618e3c0af346fb6e389c44ad">updateQueue</a></li>
</ul>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initializeUpdateQueue</span>(<span class="hljs-params">fiber</span>) </span>{
    <span class="hljs-keyword">const</span> queue = {
        <span class="hljs-comment">//&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x73AF;&#x72B6;&#x94FE;&#x8868;&#xFF0C;&#x5B58;&#x653E;&#x7740;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x66F4;&#x65B0;</span>
        <span class="hljs-attr">shared</span>: {
            <span class="hljs-attr">pending</span>: <span class="hljs-literal">null</span>
        }
    };
    fiber.updateQueue = queue;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createUpdate</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> {};
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enqueueUpdate</span>(<span class="hljs-params">fiber, update</span>) </span>{
    <span class="hljs-comment">//&#x53D6;&#x51FA;fiber&#x4E0A;&#x7684;&#x66F4;&#x65B0;&#x961F;&#x5217;</span>
    <span class="hljs-keyword">const</span> updateQueue = fiber.updateQueue;
    <span class="hljs-keyword">const</span> sharedQueue = updateQueue.shared;
    <span class="hljs-comment">//&#x53D6;&#x51FA;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x66F4;&#x65B0;&#x73AF;&#x72B6;&#x94FE;&#x8868;</span>
    <span class="hljs-keyword">const</span> pending = sharedQueue.pending;
    <span class="hljs-comment">//&#x5982;&#x679C;&#x73AF;&#x72B6;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;</span>
    <span class="hljs-keyword">if</span> (!pending) {
        <span class="hljs-comment">//&#x6784;&#x5EFA;&#x73AF;&#x72B6;&#x94FE;&#x8868; </span>
        update.next = update;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//&#x8BA9;&#x65B0;&#x7684;&#x66F4;&#x65B0;&#x7684;next&#x6307;&#x5411;&#x7B2C;&#x4E00;&#x4E2A;&#x66F4;&#x65B0;</span>
        update.next = pending.next;
        <span class="hljs-comment">//&#x8BA9;&#x539F;&#x6765;&#x7684;pending&#x6307;&#x5411;&#x65B0;&#x7684;&#x66F4;&#x65B0;</span>
        pending.next = update;
    }
    <span class="hljs-comment">//sharedQueue&#x7684;pending&#x6307;&#x5411;&#x65B0;&#x7684;&#x66F4;&#x65B0;</span>
    sharedQueue.pending = update;
}
<span class="hljs-keyword">let</span> fiber = { <span class="hljs-attr">baseState</span>: { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> } };
initializeUpdateQueue(fiber);
<span class="hljs-keyword">const</span> update1 = createUpdate();
update1.payload = { <span class="hljs-attr">number</span>: <span class="hljs-number">1</span> };
enqueueUpdate(fiber, update1);
<span class="hljs-keyword">const</span> update2 = createUpdate();
update2.payload = { <span class="hljs-attr">number</span>: <span class="hljs-number">2</span> };
enqueueUpdate(fiber, update2);
<span class="hljs-keyword">const</span> update3 = createUpdate();
update3.payload = { <span class="hljs-attr">number</span>: <span class="hljs-number">3</span> };
enqueueUpdate(fiber, update3);
<span class="hljs-built_in">console</span>.log(fiber.updateQueue.shared.pending);
</code></pre>
<p><img src="https://static.zhufengpeixun.com/initializeUpdateQueue1_1636711483523.jpg" alt>
<img src="https://static.zhufengpeixun.com/initializeUpdateQueue2_1636711495721.jpg" alt>
<img src="https://static.zhufengpeixun.com/initializeUpdateQueue3_1636711676019.jpg" alt>
<img src="https://static.zhufengpeixun.com/initializeUpdateQueue4_1636711685706.jpg" alt></p>
<h3 id="t61.3 &#x4F4D;&#x8FD0;&#x7B97;">1.3 &#x4F4D;&#x8FD0;&#x7B97; <a href="#t61.3 &#x4F4D;&#x8FD0;&#x7B97;"> # </a></h3>
<h4 id="t71.3.1 &#x6309;&#x4F4D;&#x4E0E;(&amp;)">1.3.1 &#x6309;&#x4F4D;&#x4E0E;(&amp;) <a href="#t71.3.1 &#x6309;&#x4F4D;&#x4E0E;(&amp;)"> # </a></h4>
<ul>
<li>&#x4E24;&#x4E2A;&#x8F93;&#x5165;&#x6570;&#x7684;&#x540C;&#x4E00;&#x4F4D;&#x90FD;&#x4E3A;1&#x624D;&#x4E3A;1</li>
</ul>
<p><img src="https://static.zhufengpeixun.com/bitand2_1636888349506.png" style="width:50%"></p>
<h4 id="t81.3.2 &#x6309;&#x4F4D;&#x6216;(|)">1.3.2 &#x6309;&#x4F4D;&#x6216;(|) <a href="#t81.3.2 &#x6309;&#x4F4D;&#x6216;(|)"> # </a></h4>
<ul>
<li>&#x4E24;&#x4E2A;&#x8F93;&#x5165;&#x6570;&#x7684;&#x540C;&#x4E00;&#x4F4D;&#x53EA;&#x8981;&#x6709;&#x4E00;&#x4E2A;&#x4E3A;1&#x5C31;&#x662F;1</li>
</ul>
<p><img src="https://static.zhufengpeixun.com/bitor2_1636888357232.png" style="width:50%"></p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> NoFlags = <span class="hljs-number">0b000000000000000000</span>;<span class="hljs-comment">//0</span>
<span class="hljs-keyword">const</span> Placement = <span class="hljs-number">0b000000000000000010</span>;<span class="hljs-comment">//2</span>
<span class="hljs-keyword">const</span> Update = <span class="hljs-number">0b000000000000000100</span>;<span class="hljs-comment">//4</span>
<span class="hljs-keyword">const</span> Deletion = <span class="hljs-number">0b000000000000001000</span>;<span class="hljs-comment">//8</span>
<span class="hljs-keyword">const</span> PlacementAndUpdate = <span class="hljs-number">0b000000000000000110</span>;
<span class="hljs-number">010</span>
<span class="hljs-number">100</span>
<span class="hljs-number">110</span>
<span class="hljs-built_in">console</span>.log((Placement | Update) === PlacementAndUpdate);
<span class="hljs-number">110</span>
<span class="hljs-number">010</span>
<span class="hljs-number">100</span>
<span class="hljs-built_in">console</span>.log((PlacementAndUpdate &amp; Placement) === Update);
</code></pre>
<h3 id="t91.4 collectEffectList">1.4 collectEffectList <a href="#t91.4 collectEffectList"> # </a></h3>
<ul>
<li>&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x904D;&#x5386;fiber&#x6811;&#x5BFB;&#x627E;&#x6709;&#x526F;&#x4F5C;&#x7528;&#x7684;fiber&#x8282;&#x70B9;&#xFF0C;&#x6240;&#x4EE5;&#x6709;&#x4E86;effectList</li>
<li>&#x5728;<code>fiber</code>&#x6811;&#x6784;&#x5EFA;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6BCF;&#x5F53;&#x4E00;&#x4E2A;<code>fiber</code>&#x8282;&#x70B9;&#x7684;<code>flags</code>&#x5B57;&#x6BB5;&#x4E0D;&#x4E3A;<code>NoFlags</code>&#x65F6;(&#x4EE3;&#x8868;&#x9700;&#x8981;&#x6267;&#x884C;&#x526F;&#x4F5C;&#x7528;),&#x5C31;&#x628A;&#x8BE5;<code>fiber</code>&#x8282;&#x70B9;&#x6DFB;&#x52A0;&#x5230;<code>effectList</code>&#x4E2D;</li>
<li><code>effectList</code>&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x5411;&#x94FE;&#x8868;&#xFF0C;<code>firstEffect</code>&#x4EE3;&#x8868;&#x94FE;&#x8868;&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;fiber&#x8282;&#x70B9;&#xFF0C;<code>lastEffect</code>&#x4EE3;&#x8868;&#x94FE;&#x8868;&#x4E2D;&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;fiber&#x8282;&#x70B9;</li>
<li>fiber&#x6811;&#x7684;&#x6784;&#x5EFA;&#x662F;<code>&#x6DF1;&#x5EA6;&#x4F18;&#x5148;</code>&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5148;&#x5411;&#x4E0B;&#x6784;&#x5EFA;&#x5B50;&#x7EA7;Fiber&#x8282;&#x70B9;&#xFF0C;&#x5B50;&#x7EA7;&#x8282;&#x70B9;&#x6784;&#x5EFA;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x518D;&#x5411;&#x4E0A;&#x6784;&#x5EFA;&#x7236;&#x7EA7;Fiber&#x8282;&#x70B9;&#xFF0C;&#x6240;&#x4EE5;EffectList&#x4E2D;&#x603B;&#x662F;&#x5B50;&#x7EA7;Fiber&#x8282;&#x70B9;&#x5728;&#x524D;&#x9762;</li>
<li>fiber&#x8282;&#x70B9;&#x6784;&#x5EFA;&#x5B8C;&#x6210;&#x7684;&#x64CD;&#x4F5C;&#x6267;&#x884C;&#x5728;<code>completeUnitOfWork</code>&#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x91CC;&#xFF0C;&#x4E0D;&#x4EC5;&#x4F1A;&#x5BF9;&#x8282;&#x70B9;&#x5B8C;&#x6210;&#x6784;&#x5EFA;&#xFF0C;&#x4E5F;&#x4F1A;&#x5C06;&#x6709;flags&#x7684;Fiber&#x8282;&#x70B9;&#x6DFB;&#x52A0;&#x5230;fffectList</li>
</ul>
<p><img src="https://static.zhufengpeixun.com/collectEffectListINIT1_1637041097456.jpg" alt="collectEffectListINIT"></p>
<p><img src="https://static.zhufengpeixun.com/collectEffectList_wan_cheng_BBB_1637041894303.jpg" alt="wan_cheng_B"></p>
<p><img src="https://static.zhufengpeixun.com/collectEffectList_wan_cheng_DD1_1637041983781.jpg" alt="wan_cheng_C"></p>
<p><img src="https://static.zhufengpeixun.com/collectEffectList_wan_cheng_A_1637042074823.jpg" alt="wan_cheng_A"></p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">collectEffectList</span>(<span class="hljs-params">returnFiber, completedWork</span>) </span>{
    <span class="hljs-keyword">if</span> (returnFiber) {
        <span class="hljs-keyword">if</span> (!returnFiber.firstEffect) {
            returnFiber.firstEffect = completedWork.firstEffect;
        }
        <span class="hljs-keyword">if</span> (completedWork.lastEffect) {
            <span class="hljs-keyword">if</span> (returnFiber.lastEffect) {
                returnFiber.lastEffect.nextEffect = completedWork.firstEffect;
            }
            returnFiber.lastEffect = completedWork.lastEffect;
        }
        <span class="hljs-comment">//&#x5982;&#x679C;&#x8FD9;&#x4E2A;fiber&#x6709;&#x526F;&#x4F5C;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x5B69;&#x5B50;&#x4EEC;&#x7684;&#x526F;&#x4F7F;&#x7528;&#x540E;&#x9762;&#x6DFB;&#x52A0;&#x5B83;&#x81EA;&#x5DF1;&#x7684;&#x526F;&#x4F5C;&#x7528;</span>
        <span class="hljs-keyword">const</span> flags = completedWork.flags;
        <span class="hljs-keyword">if</span> (flags) {
            <span class="hljs-keyword">if</span> (returnFiber.lastEffect) {
                returnFiber.lastEffect.nextEffect = completedWork;
            } <span class="hljs-keyword">else</span> {
                returnFiber.firstEffect = completedWork;
            }
            returnFiber.lastEffect = completedWork;
        }
    }
}
<span class="hljs-comment">//fiber.firstEffect = fiber.nextEffect = fiber.lastEffect = null;</span>
<span class="hljs-keyword">let</span> rootFiber = { <span class="hljs-attr">key</span>: <span class="hljs-string">&apos;root&apos;</span> };
<span class="hljs-keyword">let</span> fiberA = { <span class="hljs-attr">key</span>: <span class="hljs-string">&apos;A&apos;</span>, <span class="hljs-attr">flags</span>: <span class="hljs-string">&apos;Placement&apos;</span> };
<span class="hljs-keyword">let</span> fiberB = { <span class="hljs-attr">key</span>: <span class="hljs-string">&apos;B&apos;</span>, <span class="hljs-attr">flags</span>: <span class="hljs-string">&apos;Placement&apos;</span> };
<span class="hljs-keyword">let</span> fiberC = { <span class="hljs-attr">key</span>: <span class="hljs-string">&apos;C&apos;</span>, <span class="hljs-attr">flags</span>: <span class="hljs-string">&apos;Placement&apos;</span> };
collectEffectList(fiberA, fiberB);
collectEffectList(fiberA, fiberC);
collectEffectList(rootFiber, fiberA);
<span class="hljs-keyword">let</span> effectLists = <span class="hljs-string">&apos;&apos;</span>;
<span class="hljs-keyword">let</span> nextEffect = rootFiber.firstEffect;
<span class="hljs-keyword">while</span> (nextEffect) {
    effectLists += <span class="hljs-string">`<span class="hljs-subst">${nextEffect.key}</span>=&gt;`</span>;
    nextEffect = nextEffect.nextEffect;
}
effectLists += <span class="hljs-string">&apos;null&apos;</span>;
<span class="hljs-built_in">console</span>.log(effectLists);
</code></pre>
<h2 id="t102.&#x5B9E;&#x73B0;&#x865A;&#x62DF;DOM">2.&#x5B9E;&#x73B0;&#x865A;&#x62DF;DOM <a href="#t102.&#x5B9E;&#x73B0;&#x865A;&#x62DF;DOM"> # </a></h2>
<ul>
<li>&#x865A;&#x62DF;DOM&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x63CF;&#x8FF0;&#x771F;&#x5B9E;DOM&#x7684;&#x7EAF;JS&#x5BF9;&#x8C61;</li>
<li><a href="https://www.babeljs.cn/repl">babeljs</a></li>
</ul>
<h3 id="t112.1 package.json">2.1 package.json <a href="#t112.1 package.json"> # </a></h3>
<p>package.json</p>
<pre><code class="lang-diff">{
  &quot;scripts&quot;: {
<span class="hljs-addition">+   &quot;start&quot;: &quot;set DISABLE_NEW_JSX_TRANSFORM=true&amp;&amp;react-scripts start&quot;,</span>
<span class="hljs-addition">+   &quot;build&quot;: &quot;set DISABLE_NEW_JSX_TRANSFORM=true&amp;&amp;react-scripts build&quot;,</span>
<span class="hljs-addition">+   &quot;test&quot;: &quot;set DISABLE_NEW_JSX_TRANSFORM=true&amp;&amp;react-scripts test&quot;,</span>
<span class="hljs-addition">+   &quot;eject&quot;: &quot;set DISABLE_NEW_JSX_TRANSFORM=true&amp;&amp;react-scripts eject&quot;</span>
  }
}
</code></pre>
<h3 id="t122.2 src\index.js">2.2 src\index.js <a href="#t122.2 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-comment">//import ReactDOM from &apos;react-dom&apos;;</span>
<span class="hljs-keyword">let</span> element = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;title&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>div<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
<span class="hljs-built_in">console</span>.log(element);
<span class="hljs-comment">/*
ReactDOM.render(element,document.getElementById(&apos;root&apos;));
*/</span>
</code></pre>
<h3 id="t132.3 ReactSymbols.js">2.3 ReactSymbols.js <a href="#t132.3 ReactSymbols.js"> # </a></h3>
<p>src\ReactSymbols.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> REACT_ELEMENT_TYPE = <span class="hljs-built_in">Symbol</span>.for(<span class="hljs-string">&apos;react.element&apos;</span>);
</code></pre>
<h3 id="t142.4 react.js">2.4 react.js <a href="#t142.4 react.js"> # </a></h3>
<p>src\react.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { REACT_ELEMENT_TYPE } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactSymbols&apos;</span>;
<span class="hljs-keyword">const</span> RESERVED_PROPS = {
    <span class="hljs-attr">key</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">ref</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">__self</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">__source</span>: <span class="hljs-literal">true</span>

};
<span class="hljs-comment">/**
 * &#x521B;&#x5EFA;React&#x5143;&#x7D20;
 * @param {*} type &#x7C7B;&#x578B;
 * @param {*} config &#x914D;&#x7F6E;&#x5BF9;&#x8C61;
 * @param {*} children &#x7B2C;1&#x4E2A;&#x513F;&#x5B50;
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createElement</span>(<span class="hljs-params">type, config, children</span>) </span>{
    <span class="hljs-keyword">let</span> propName;
    <span class="hljs-comment">//&#x63D0;&#x53D6;&#x4FDD;&#x7559;&#x540D;&#x79F0;</span>
    <span class="hljs-keyword">const</span> props = {};
    <span class="hljs-keyword">let</span> key = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> ref = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (config) {
        <span class="hljs-keyword">if</span> (config.ref) {
            ref = config.ref;
        }
        <span class="hljs-keyword">if</span> (config.key) {
            key = <span class="hljs-string">&apos;&apos;</span> + config.key;
        }
        <span class="hljs-comment">// &#x5176;&#x4F59;&#x5C5E;&#x6027;&#x5C06;&#x6DFB;&#x52A0;&#x5230;&#x65B0;&#x7684;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;</span>
        <span class="hljs-keyword">for</span> (propName <span class="hljs-keyword">in</span> config) {
            <span class="hljs-keyword">if</span> (!RESERVED_PROPS.hasOwnProperty(propName)) {
                props[propName] = config[propName];
            }
        }
    }
    <span class="hljs-keyword">const</span> childrenLength = <span class="hljs-built_in">arguments</span>.length - <span class="hljs-number">2</span>;
    <span class="hljs-keyword">if</span> (childrenLength === <span class="hljs-number">1</span>) {
        props.children = children;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (childrenLength &gt; <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">const</span> childArray = <span class="hljs-built_in">Array</span>(childrenLength);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; childrenLength; i++) {
            childArray[i] = <span class="hljs-built_in">arguments</span>[i + <span class="hljs-number">2</span>];
        }
        props.children = childArray;
    }
    <span class="hljs-keyword">return</span> {
        <span class="hljs-comment">//&#x6B64;&#x6807;&#x8BB0;&#x5141;&#x8BB8;&#x6211;&#x4EEC;&#x5C06;&#x5176;&#x552F;&#x4E00;&#x6807;&#x8BC6;&#x4E3A;React&#x5143;&#x7D20;</span>
        <span class="hljs-attr">$$typeof</span>: REACT_ELEMENT_TYPE,
        <span class="hljs-comment">//&#x5C5E;&#x4E8E;&#x5143;&#x7D20;&#x7684;&#x5185;&#x7F6E;&#x5C5E;&#x6027;</span>
        type,
        ref,
        key,
        props
    }
}
<span class="hljs-keyword">const</span> React = {
    createElement
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> React;
</code></pre>
<h2 id="t153.&#x5F00;&#x59CB;WorkOnRoot">3.&#x5F00;&#x59CB;WorkOnRoot <a href="#t153.&#x5F00;&#x59CB;WorkOnRoot"> # </a></h2>
<ul>
<li><a href="https://www.processon.com/diagraming/618dec810e3e744ad43d37a9">&#x5F00;&#x59CB;WorkOnRoot</a></li>
</ul>
<h3 id="t163.1 &#x4ECE;render&#x5230;&#x6267;&#x884C;&#x5DE5;&#x4F5C;&#x5FAA;&#x73AF;">3.1 &#x4ECE;render&#x5230;&#x6267;&#x884C;&#x5DE5;&#x4F5C;&#x5FAA;&#x73AF; <a href="#t163.1 &#x4ECE;render&#x5230;&#x6267;&#x884C;&#x5DE5;&#x4F5C;&#x5FAA;&#x73AF;"> # </a></h3>
<p><img src="https://static.zhufengpeixun.com/render_dao_performSyncWorkOnRoot_1636637139987.jpg" alt="render_dao_performSyncWorkOnRoot"></p>
<h3 id="t173.2 fiber&#x7ED3;&#x6784;">3.2 fiber&#x7ED3;&#x6784; <a href="#t173.2 fiber&#x7ED3;&#x6784;"> # </a></h3>
<ul>
<li><a href="https://www.processon.com/diagraming/618d10607d9c08562ae923b9">fiber&#x7ED3;&#x6784;</a></li>
</ul>
<p><img src="https://static.zhufengpeixun.com/cong_render_dao_zhi_xing_gong_zuo_xun_huan_fiber_shu_1636640422211.jpg" alt></p>
<h3 id="t183.3 src\index.js">3.3 src\index.js <a href="#t183.3 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-keyword">let</span> element = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;title&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>div<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
<span class="hljs-built_in">console</span>.log(element);
ReactDOM.render(
  element,
  <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>)
);
</code></pre>
<h3 id="t193.4 react-dom.js">3.4 react-dom.js <a href="#t193.4 react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { createFiberRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactFiberRoot&apos;</span>;
<span class="hljs-keyword">import</span> { updateContainer } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactFiberReconciler&apos;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">element, container</span>) </span>{
    <span class="hljs-keyword">let</span> fiberRoot = createFiberRoot(container);
    updateContainer(element, fiberRoot);
}
<span class="hljs-keyword">const</span> ReactDOM = {
    render
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ReactDOM;
</code></pre>
<h3 id="t203.5 ReactFiberRoot.js">3.5 ReactFiberRoot.js <a href="#t203.5 ReactFiberRoot.js"> # </a></h3>
<p>src\ReactFiberRoot.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { createHostRootFiber } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactFiber&apos;</span>;
<span class="hljs-keyword">import</span> { initializeUpdateQueue } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactUpdateQueue&apos;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createFiberRoot</span>(<span class="hljs-params">containerInfo</span>) </span>{
    <span class="hljs-keyword">const</span> root = <span class="hljs-keyword">new</span> FiberRootNode(containerInfo);
    <span class="hljs-keyword">const</span> hostRootFiber = createHostRootFiber();
    root.current = hostRootFiber;
    hostRootFiber.stateNode = root;
    initializeUpdateQueue(hostRootFiber);
    <span class="hljs-keyword">return</span> root;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FiberRootNode</span>(<span class="hljs-params">containerInfo</span>) </span>{
    <span class="hljs-keyword">this</span>.containerInfo = containerInfo;
}
</code></pre>
<h3 id="t213.6 ReactFiber.js">3.6 ReactFiber.js <a href="#t213.6 ReactFiber.js"> # </a></h3>
<p>src\ReactFiber.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { HostRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactWorkTags&apos;</span>;
<span class="hljs-comment">/**
 * &#x521B;&#x5EFA;&#x6839;fiber
 * @returns &#x6839;fiber
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createHostRootFiber</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> createFiber(HostRoot);
}
<span class="hljs-comment">/**
 * &#x521B;&#x5EFA;fiber
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>tag fiber&#x7C7B;&#x578B;
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>pendingProps &#x65B0;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>key &#x552F;&#x4E00;&#x6807;&#x8BC6;
 * <span class="hljs-doctag">@returns </span>&#x521B;&#x5EFA;&#x7684;fiber
 */</span>
<span class="hljs-keyword">const</span> createFiber = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tag, pendingProps, key</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FiberNode(tag, pendingProps, key);
};
<span class="hljs-comment">/**
 * fiber&#x6784;&#x5EFA;&#x51FD;&#x6570;
 * @param {*} tag fiber&#x7C7B;&#x578B;
 * @param {*} pendingProps  &#x65B0;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;
 * @param {*} key &#x552F;&#x4E00;&#x6807;&#x8BC6;
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FiberNode</span>(<span class="hljs-params">tag, pendingProps, key</span>) </span>{
    <span class="hljs-keyword">this</span>.tag = tag;
    <span class="hljs-keyword">this</span>.pendingProps = pendingProps;
    <span class="hljs-keyword">this</span>.key = key;
}
</code></pre>
<h3 id="t223.7 ReactWorkTags.js">3.7 ReactWorkTags.js <a href="#t223.7 ReactWorkTags.js"> # </a></h3>
<p>src\ReactWorkTags.js</p>
<pre><code class="lang-js"><span class="hljs-comment">//&#x6839;fiber,&#x5BF9;&#x5E94;&#x7684;&#x5176;&#x5B9E;&#x662F;&#x5BB9;&#x5668;containerInfo</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> HostRoot = <span class="hljs-number">3</span>;
</code></pre>
<h3 id="t233.8 ReactUpdateQueue.js">3.8 ReactUpdateQueue.js <a href="#t233.8 ReactUpdateQueue.js"> # </a></h3>
<p>src\ReactUpdateQueue.js</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * &#x521D;&#x59CB;&#x5316;fiber&#x8282;&#x70B9;&#x4E0A;&#x7684;&#x66F4;&#x65B0;&#x961F;&#x5217; 
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>fiber 
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initializeUpdateQueue</span>(<span class="hljs-params">fiber</span>) </span>{
    <span class="hljs-keyword">const</span> queue = {
        <span class="hljs-comment">//&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x73AF;&#x72B6;&#x94FE;&#x8868;&#xFF0C;&#x5B58;&#x653E;&#x7740;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x66F4;&#x65B0;</span>
        <span class="hljs-attr">shared</span>: {
            <span class="hljs-attr">pending</span>: <span class="hljs-literal">null</span>
        }
    };
    fiber.updateQueue = queue;
}
<span class="hljs-comment">/**
 * &#x521B;&#x5EFA;&#x66F4;&#x65B0;&#x5BF9;&#x8C61;
 * <span class="hljs-doctag">@returns </span>&#x66F4;&#x65B0;&#x5BF9;&#x8C61;
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createUpdate</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> {};
}
<span class="hljs-comment">/**
 * &#x628A;&#x66F4;&#x65B0;&#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x5230;fiber&#x7684;&#x66F4;&#x65B0;&#x961F;&#x5217;&#x4E2D;
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>fiber fiber&#x8282;&#x70B9;
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>update &#x65B0;&#x7684;&#x66F4;&#x65B0;&#x5BF9;&#x8C61;
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enqueueUpdate</span>(<span class="hljs-params">fiber, update</span>) </span>{
    <span class="hljs-comment">//&#x53D6;&#x51FA;fiber&#x4E0A;&#x7684;&#x66F4;&#x65B0;&#x961F;&#x5217;</span>
    <span class="hljs-keyword">const</span> updateQueue = fiber.updateQueue;
    <span class="hljs-keyword">const</span> sharedQueue = updateQueue.shared;
    <span class="hljs-comment">//&#x53D6;&#x51FA;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x66F4;&#x65B0;&#x73AF;&#x72B6;&#x94FE;&#x8868;</span>
    <span class="hljs-keyword">const</span> pending = sharedQueue.pending;
    <span class="hljs-comment">//&#x5982;&#x679C;&#x73AF;&#x72B6;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;</span>
    <span class="hljs-keyword">if</span> (!pending) {
        <span class="hljs-comment">//&#x6784;&#x5EFA;&#x73AF;&#x72B6;&#x94FE;&#x8868; </span>
        update.next = update;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//&#x8BA9;&#x65B0;&#x7684;&#x66F4;&#x65B0;&#x7684;next&#x6307;&#x5411;&#x7B2C;&#x4E00;&#x4E2A;&#x66F4;&#x65B0;</span>
        update.next = pending.next;
        <span class="hljs-comment">//&#x8BA9;&#x539F;&#x6765;&#x7684;pending&#x6307;&#x5411;&#x65B0;&#x7684;&#x66F4;&#x65B0;</span>
        pending.next = update;
    }
    <span class="hljs-comment">//sharedQueue&#x7684;pending&#x6307;&#x5411;&#x65B0;&#x7684;&#x66F4;&#x65B0;</span>
    sharedQueue.pending = update;
}
</code></pre>
<h3 id="t243.9 ReactFiberReconciler.js">3.9 ReactFiberReconciler.js <a href="#t243.9 ReactFiberReconciler.js"> # </a></h3>
<p>src\ReactFiberReconciler.js</p>
<pre><code class="lang-js">
<span class="hljs-keyword">import</span> { createUpdate, enqueueUpdate } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactUpdateQueue&apos;</span>;
<span class="hljs-keyword">import</span> { scheduleUpdateOnFiber } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactFiberWorkLoop&apos;</span>;
<span class="hljs-comment">/**
 * &#x628A;element&#x5143;&#x7D20;&#x6E32;&#x67D3;&#x5230;&#x5BB9;&#x5668;&#x4E2D;
 * @param {*} element &#x8981;&#x6E32;&#x67D3;&#x7684;&#x865A;&#x62DF;DOM
 * @param {*} container &#x5BB9;&#x5668;
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateContainer</span>(<span class="hljs-params">element, container</span>) </span>{
    <span class="hljs-comment">//&#x83B7;&#x53D6;HostRootFiber</span>
    <span class="hljs-keyword">const</span> current = container.current;
    <span class="hljs-comment">//&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x66F4;&#x65B0;&#x5BF9;&#x8C61;</span>
    <span class="hljs-keyword">const</span> update = createUpdate();
    <span class="hljs-comment">//&#x66F4;&#x65B0;&#x5BF9;&#x8C61;&#x7684;payload&#x4E3A;{ element }</span>
    update.payload = { element };
    <span class="hljs-comment">//&#x628A;&#x66F4;&#x65B0;&#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x5230;&#x66F4;&#x65B0;&#x961F;&#x5217;&#x4E2D;</span>
    enqueueUpdate(current, update);
    <span class="hljs-comment">//&#x5F00;&#x59CB;&#x4ECE;HostRootFiber&#x8C03;&#x5EA6;&#x66F4;&#x65B0;</span>
    scheduleUpdateOnFiber(current);
}
</code></pre>
<h3 id="t253.10 ReactFiberWorkLoop.js">3.10 ReactFiberWorkLoop.js <a href="#t253.10 ReactFiberWorkLoop.js"> # </a></h3>
<p>src\ReactFiberWorkLoop.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { HostRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactWorkTags&apos;</span>;

<span class="hljs-comment">/**
 * &#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
 * @param {*} sourceFiber &#x66F4;&#x65B0;&#x6765;&#x6E90;fiber
 * @returns 
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">markUpdateLaneFromFiberToRoot</span>(<span class="hljs-params">sourceFiber</span>) </span>{
    <span class="hljs-keyword">let</span> node = sourceFiber;
    <span class="hljs-keyword">let</span> parent = node.return;
    <span class="hljs-comment">//&#x4E00;&#x76F4;&#x5411;&#x4E0A;&#x627E;&#x7236;&#x4EB2;&#xFF0C;&#x627E;&#x4E0D;&#x5230;&#x4E3A;&#x6B62;</span>
    <span class="hljs-keyword">while</span> (parent) {
        node = parent;
        parent = parent.return;
    }
    <span class="hljs-comment">//&#x5982;&#x679C;&#x627E;&#x5230;&#x7684;&#x662F;HostRoot&#x5C31;&#x8FD4;&#x56DE;FiberRootNode,&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5BB9;&#x5668;div#root</span>
    <span class="hljs-keyword">if</span> (node.tag === HostRoot) {
        <span class="hljs-keyword">return</span> node.stateNode;
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scheduleUpdateOnFiber</span>(<span class="hljs-params">fiber</span>) </span>{
    <span class="hljs-comment">//&#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;</span>
    <span class="hljs-keyword">const</span> root = markUpdateLaneFromFiberToRoot(fiber);
    <span class="hljs-comment">//&#x6267;&#x884C;HostRoot&#x4E0A;&#x7684;&#x66F4;&#x65B0;</span>
    performSyncWorkOnRoot(root);
}
<span class="hljs-comment">/**
 * &#x5F00;&#x59CB;&#x6267;&#x884C;FiberRootNode&#x4E0A;&#x7684;&#x5DE5;&#x4F5C;
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>root  FiberRootNode
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">performSyncWorkOnRoot</span>(<span class="hljs-params">root</span>) </span>{

    <span class="hljs-built_in">console</span>.log(root);
}
</code></pre>
<h2 id="t263.&#x521B;&#x5EFA;createWorkInProgress">3.&#x521B;&#x5EFA;createWorkInProgress <a href="#t263.&#x521B;&#x5EFA;createWorkInProgress"> # </a></h2>
<ul>
<li><a href="https://www.processon.com/diagraming/618e41131efad41bf2c534f6">&#x521B;&#x5EFA;createWorkInProgress</a></li>
</ul>
<p><img src="https://static.zhufengpeixun.com/cong_render_dao_zhi_xing_gong_zuo_xun_huan_de_fiber_jia_gou_21_1636712927379.jpg" alt></p>
<h3 id="t273.1 src\ReactFiberWorkLoop.js">3.1 src\ReactFiberWorkLoop.js <a href="#t273.1 src\ReactFiberWorkLoop.js"> # </a></h3>
<p>src\ReactFiberWorkLoop.js</p>
<pre><code class="lang-diff">import { HostRoot } from &apos;./ReactWorkTags&apos;;
<span class="hljs-addition">+import { createWorkInProgress } from &apos;./ReactFiber&apos;;</span>
<span class="hljs-addition">+//&#x6B63;&#x5728;&#x8C03;&#x5EA6;&#x7684;fiberRoot&#x6839;&#x8282;&#x70B9;</span>
<span class="hljs-addition">+let workInProgressRoot = null;</span>
<span class="hljs-addition">+//&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+let workInProgress = null;</span>
/**
 * &#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
 * @param {*} sourceFiber &#x66F4;&#x65B0;&#x6765;&#x6E90;fiber
 * @returns 
 */
function markUpdateLaneFromFiberToRoot(sourceFiber) {
    let node = sourceFiber;
    let parent = node.return;
    //&#x4E00;&#x76F4;&#x5411;&#x4E0A;&#x627E;&#x7236;&#x4EB2;&#xFF0C;&#x627E;&#x4E0D;&#x5230;&#x4E3A;&#x6B62;
    while (parent) {
        node = parent;
        parent = parent.return;
    }
    //&#x5982;&#x679C;&#x627E;&#x5230;&#x7684;&#x662F;HostRoot&#x5C31;&#x8FD4;&#x56DE;FiberRootNode,&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5BB9;&#x5668;div#root
    if (node.tag <span class="hljs-comment">=== HostRoot) {</span>
        return node.stateNode;
    }
}
/**
 * &#x5411;&#x4E0A;&#x67E5;&#x627E;&#x5230;&#x6839;&#x8282;&#x70B9;&#x5F00;&#x59CB;&#x8C03;&#x5EA6;&#x66F4;&#x65B0;
 * @param {*} fiber 
 */
export function scheduleUpdateOnFiber(fiber) {
    //&#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
    const root = markUpdateLaneFromFiberToRoot(fiber);
    //&#x6267;&#x884C;HostRoot&#x4E0A;&#x7684;&#x66F4;&#x65B0;
    performSyncWorkOnRoot(root);
}
/**
 * &#x5F00;&#x59CB;&#x6267;&#x884C;FiberRootNode&#x4E0A;&#x7684;&#x5DE5;&#x4F5C;
 * @param {*} root  FiberRootNode
 */
function performSyncWorkOnRoot(root) {
<span class="hljs-addition">+   //&#x5148;&#x8D4B;&#x503C;&#x7ED9;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x5DE5;&#x4F5C;&#x7684;FiberRootNode&#x6839;&#x8282;&#x70B9;</span>
<span class="hljs-addition">+   workInProgressRoot = root;</span>
<span class="hljs-addition">+   //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5904;&#x7406;&#x4E2D;&#x7684;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+   workInProgress = createWorkInProgress(workInProgressRoot.current);</span>
<span class="hljs-addition">+   console.log(workInProgress);</span>
}
</code></pre>
<h3 id="t283.2 src\ReactFiber.js">3.2 src\ReactFiber.js <a href="#t283.2 src\ReactFiber.js"> # </a></h3>
<p>src\ReactFiber.js</p>
<pre><code class="lang-diff">import { HostRoot } from &apos;./ReactWorkTags&apos;;
<span class="hljs-addition">+import { NoFlags } from &apos;./ReactFiberFlags&apos;;</span>
/**
 * &#x521B;&#x5EFA;&#x6839;fiber
 * @returns &#x6839;fiber
 */
export function createHostRootFiber() {
    return createFiber(HostRoot);
}
/**
 * &#x521B;&#x5EFA;fiber
 * @param {*} tag fiber&#x7C7B;&#x578B;
 * @param {*} pendingProps &#x65B0;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;
 * @param {*} key &#x552F;&#x4E00;&#x6807;&#x8BC6;
 * @returns &#x521B;&#x5EFA;&#x7684;fiber
 */
const createFiber = function (tag, pendingProps, key) {
    return new FiberNode(tag, pendingProps, key);
};
/**
 * fiber&#x6784;&#x5EFA;&#x51FD;&#x6570;
 * @param {*} tag fiber&#x7C7B;&#x578B;
 * @param {*} pendingProps  &#x65B0;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;
 * @param {*} key &#x552F;&#x4E00;&#x6807;&#x8BC6;
 */
function FiberNode(tag, pendingProps, key) {
    this.tag = tag;
    this.pendingProps = pendingProps;
    this.key = key;
}
<span class="hljs-addition">+/**</span>
<span class="hljs-addition">+ * &#x57FA;&#x4E8E;&#x8001;&#x7684;current&#x521B;&#x5EFA;&#x65B0;&#x7684;workInProgress</span>
<span class="hljs-addition">+ * @param {*} current &#x8001;&#x7684;fiber</span>
<span class="hljs-addition">+ * @returns </span>
<span class="hljs-addition">+ */</span>
<span class="hljs-addition">+export function createWorkInProgress(current, pendingProps) {</span>
<span class="hljs-addition">+    let workInProgress = current.alternate;</span>
<span class="hljs-addition">+    if (!workInProgress) {</span>
<span class="hljs-addition">+        workInProgress = createFiber(current.tag, pendingProps, current.key);</span>
<span class="hljs-addition">+        workInProgress.type = current.type;</span>
<span class="hljs-addition">+        workInProgress.stateNode = current.stateNode;</span>
<span class="hljs-addition">+        workInProgress.alternate = current;</span>
<span class="hljs-addition">+        current.alternate = workInProgress;</span>
<span class="hljs-addition">+    } else {</span>
<span class="hljs-addition">+        workInProgress.pendingProps = pendingProps;</span>
<span class="hljs-addition">+        workInProgress.flags = NoFlags;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    //&#x6E05;&#x7A7A;&#x539F;&#x6765;&#x7684;child</span>
<span class="hljs-addition">+    workInProgress.child = null;</span>
<span class="hljs-addition">+    //&#x6E05;&#x7A7A;&#x539F;&#x6765;&#x7684;sibling</span>
<span class="hljs-addition">+    workInProgress.sibling = null;</span>
<span class="hljs-addition">+    //&#x6E05;&#x7A7A;&#x539F;&#x6765;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;</span>
<span class="hljs-addition">+    workInProgress.firstEffect = workInProgress.nextEffect = workInProgress.lastEffect = null;</span>
<span class="hljs-addition">+    workInProgress.updateQueue = current.updateQueue;</span>
<span class="hljs-addition">+    return workInProgress;</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t293.3 src\ReactFiberFlags.js">3.3 src\ReactFiberFlags.js <a href="#t293.3 src\ReactFiberFlags.js"> # </a></h3>
<p>src\ReactFiberFlags.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> NoFlags = <span class="hljs-number">0b000000000000000000</span>;
</code></pre>
<h2 id="t304.&#x521D;&#x6B21;&#x6E32;&#x67D3;">4.&#x521D;&#x6B21;&#x6E32;&#x67D3; <a href="#t304.&#x521D;&#x6B21;&#x6E32;&#x67D3;"> # </a></h2>
<ul>
<li><a href="https://www.processon.com/diagraming/618fbad7e0b34d73f7f763d4">4.&#x521D;&#x6B21;&#x6E32;&#x67D3;</a></li>
</ul>
<p><img src="https://static.zhufengpeixun.com/cong_render_dao_zhi_xing_gong_zuo_xun_huan_de_fiber_jia_gou_3_1636810005933.jpg" alt></p>
<h3 id="t314.1 src\index.js">4.1 src\index.js <a href="#t314.1 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-keyword">let</span> element = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;title&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;title&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> &apos;<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> <span class="hljs-attr">red</span>&apos; }}&gt;</span>div<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
ReactDOM.render(
  element,
  <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>)
);
</code></pre>
<h3 id="t324.2 ReactFiberWorkLoop.js">4.2 ReactFiberWorkLoop.js <a href="#t324.2 ReactFiberWorkLoop.js"> # </a></h3>
<p>src\ReactFiberWorkLoop.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { HostRoot, HostComponent } from &apos;./ReactWorkTags&apos;;</span>
import { createWorkInProgress } from &apos;./ReactFiber&apos;;
<span class="hljs-addition">+import { beginWork } from &apos;./ReactFiberBeginWork&apos;;</span>
<span class="hljs-addition">+import { completeWork } from &apos;./ReactFiberCompleteWork&apos;;</span>
<span class="hljs-addition">+import { Placement } from &apos;./ReactFiberFlags&apos;;</span>
<span class="hljs-addition">+import { commitPlacement } from &apos;./ReactFiberCommitWork&apos;;</span>
//&#x6B63;&#x5728;&#x8C03;&#x5EA6;&#x7684;fiberRoot&#x6839;&#x8282;&#x70B9;
let workInProgressRoot = null;
//&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;fiber&#x8282;&#x70B9;
let workInProgress = null;
/**
 * &#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
 * @param {*} sourceFiber &#x66F4;&#x65B0;&#x6765;&#x6E90;fiber
 * @returns 
 */
function markUpdateLaneFromFiberToRoot(sourceFiber) {
    let node = sourceFiber;
    let parent = node.return;
    //&#x4E00;&#x76F4;&#x5411;&#x4E0A;&#x627E;&#x7236;&#x4EB2;&#xFF0C;&#x627E;&#x4E0D;&#x5230;&#x4E3A;&#x6B62;
    while (parent) {
        node = parent;
        parent = parent.return;
    }
    //&#x5982;&#x679C;&#x627E;&#x5230;&#x7684;&#x662F;HostRoot&#x5C31;&#x8FD4;&#x56DE;FiberRootNode,&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5BB9;&#x5668;div#root
    if (node.tag <span class="hljs-comment">=== HostRoot) {</span>
        return node.stateNode;
    }
}
/**
 * &#x5411;&#x4E0A;&#x67E5;&#x627E;&#x5230;&#x6839;&#x8282;&#x70B9;&#x5F00;&#x59CB;&#x8C03;&#x5EA6;&#x66F4;&#x65B0;
 * @param {*} fiber 
 */
export function scheduleUpdateOnFiber(fiber) {
    //&#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
    const root = markUpdateLaneFromFiberToRoot(fiber);
    //&#x6267;&#x884C;HostRoot&#x4E0A;&#x7684;&#x66F4;&#x65B0;
    performSyncWorkOnRoot(root);
}
/**
 * &#x5F00;&#x59CB;&#x6267;&#x884C;FiberRootNode&#x4E0A;&#x7684;&#x5DE5;&#x4F5C;
 * @param {*} root  FiberRootNode
 */
function performSyncWorkOnRoot(root) {
    //&#x5148;&#x8D4B;&#x503C;&#x7ED9;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x5DE5;&#x4F5C;&#x7684;FiberRootNode&#x6839;&#x8282;&#x70B9;
    workInProgressRoot = root;
    //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5904;&#x7406;&#x4E2D;&#x7684;fiber&#x8282;&#x70B9;
    workInProgress = createWorkInProgress(workInProgressRoot.current);
<span class="hljs-addition">+   workLoopSync();</span>
<span class="hljs-addition">+   commitRoot();</span>
}
<span class="hljs-addition">+function commitRoot(root) {</span>
<span class="hljs-addition">+    //&#x6784;&#x5EFA;&#x6210;&#x529F;&#x7684;&#x65B0;&#x7684;fiber&#x6811;</span>
<span class="hljs-addition">+    const finishedWork = workInProgressRoot.current.alternate;</span>
<span class="hljs-addition">+    //&#x5F53;&#x524D;&#x5B8C;&#x6210;&#x7684;&#x6784;&#x5EFA;&#x5DE5;&#x4F5C;&#x7B49;&#x4E8E;finishedWork</span>
<span class="hljs-addition">+    workInProgressRoot.finishedWork = finishedWork;</span>
<span class="hljs-addition">+    commitMutationEffects(workInProgressRoot);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function getFlag(flags) {</span>
<span class="hljs-addition">+    switch (flags) {</span>
<span class="hljs-addition">+        case Placement:</span>
<span class="hljs-addition">+            return &apos;&#x6DFB;&#x52A0;&apos;;</span>
<span class="hljs-addition">+        default:</span>
<span class="hljs-addition">+            break;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function commitMutationEffects(root) {</span>
<span class="hljs-addition">+    const finishedWork = root.finishedWork;</span>
<span class="hljs-addition">+    let nextEffect = finishedWork.firstEffect;</span>
<span class="hljs-addition">+    let effectList = &apos;&apos;;</span>
<span class="hljs-addition">+    while (nextEffect) {</span>
<span class="hljs-addition">+        effectList += `(${getFlag(nextEffect.flags)}#${nextEffect.type}#${nextEffect.+key})=&gt;`;</span>
<span class="hljs-addition">+        const flags = nextEffect.flags;</span>
<span class="hljs-addition">+        if (flags === Placement) {</span>
<span class="hljs-addition">+            commitPlacement(nextEffect);</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        nextEffect = nextEffect.nextEffect;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    effectList += &apos;null&apos;;</span>
<span class="hljs-addition">+    console.log(effectList);</span>
<span class="hljs-addition">+    root.current = finishedWork;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function workLoopSync() {</span>
<span class="hljs-addition">+    while (workInProgress) {</span>
<span class="hljs-addition">+        performUnitOfWork(workInProgress);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+/**</span>
<span class="hljs-addition">+ * &#x6267;&#x884C;&#x5355;&#x4E2A;&#x5DE5;&#x4F5C;&#x5355;&#x5143;</span>
<span class="hljs-addition">+ * @param {*} unitOfWork &#x5355;&#x4E2A;fiber</span>
<span class="hljs-addition">+ */</span>
<span class="hljs-addition">+function performUnitOfWork(unitOfWork) {</span>
<span class="hljs-addition">+    //&#x83B7;&#x53D6;&#x5F53;&#x524D;fiber&#x7684;alternate</span>
<span class="hljs-addition">+    const current = unitOfWork.alternate;</span>
<span class="hljs-addition">+    //&#x5F00;&#x59CB;&#x6784;&#x5EFA;&#x6B64;fiber&#x7684;&#x5B50;fiter&#x94FE;&#x8868;</span>
<span class="hljs-addition">+    let next = beginWork(current, unitOfWork);</span>
<span class="hljs-addition">+    //&#x66F4;&#x65B0;&#x5C5E;&#x6027;</span>
<span class="hljs-addition">+    unitOfWork.memoizedProps = unitOfWork.pendingProps;</span>
<span class="hljs-addition">+    //&#x5982;&#x679C;&#x6709;&#x5B50;fiber&#xFF0C;&#x5C31;&#x7EE7;&#x7EED;&#x6267;&#x884C;</span>
<span class="hljs-addition">+    if (next) {</span>
<span class="hljs-addition">+        workInProgress = next;</span>
<span class="hljs-addition">+    } else {</span>
<span class="hljs-addition">+        //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5B50;fiber&#xFF0C;&#x5C31;&#x5B8C;&#x6210;&#x5F53;&#x524D;&#x7684;fiber</span>
<span class="hljs-addition">+        completeUnitOfWork(unitOfWork);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+function completeUnitOfWork(unitOfWork) {</span>
<span class="hljs-addition">+    //&#x5C1D;&#x8BD5;&#x5B8C;&#x6210;&#x5F53;&#x524D;&#x7684;&#x5DE5;&#x4F5C;&#x5355;&#x5143;&#xFF0C;&#x7136;&#x540E;&#x79FB;&#x52A8;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x5F1F;&#x5F1F;</span>
<span class="hljs-addition">+    //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4E0B;&#x4E00;&#x4E2A;&#x5F1F;&#x5F1F;&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x7236;Fiber</span>
<span class="hljs-addition">+    let completedWork = unitOfWork;</span>
<span class="hljs-addition">+    do {</span>
<span class="hljs-addition">+        const current = completedWork.alternate;</span>
<span class="hljs-addition">+        const returnFiber = completedWork.return;</span>
<span class="hljs-addition">+        completeWork(current, completedWork);</span>
<span class="hljs-addition">+        collectEffectList(returnFiber, completedWork)</span>
<span class="hljs-addition">+        const siblingFiber = completedWork.sibling;</span>
<span class="hljs-addition">+        if (siblingFiber) {</span>
<span class="hljs-addition">+            //&#x5982;&#x679C;&#x6B64; returnFiber &#x4E2D;&#x8FD8;&#x6709;&#x66F4;&#x591A;&#x5DE5;&#x4F5C;&#x8981;&#x505A;&#xFF0C;&#x8BF7;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x6B65;</span>
<span class="hljs-addition">+            workInProgress = siblingFiber;</span>
<span class="hljs-addition">+            return;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        //&#x5426;&#x5219;&#xFF0C;&#x8FD4;&#x56DE;&#x7236;&#x7EA7;</span>
<span class="hljs-addition">+        completedWork = returnFiber;</span>
<span class="hljs-addition">+        //&#x66F4;&#x65B0;&#x6211;&#x4EEC;&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;&#x4E0B;&#x4E00;&#x4EF6;&#x4E8B;</span>
<span class="hljs-addition">+        workInProgress = completedWork;</span>
<span class="hljs-addition">+    } while (completedWork);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function collectEffectList(returnFiber, completedWork) {</span>
<span class="hljs-addition">+    if (returnFiber) {</span>
<span class="hljs-addition">+        if (!returnFiber.firstEffect) {</span>
<span class="hljs-addition">+            returnFiber.firstEffect = completedWork.firstEffect;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        if (completedWork.lastEffect) {</span>
<span class="hljs-addition">+            if (returnFiber.lastEffect) {</span>
<span class="hljs-addition">+                returnFiber.lastEffect.nextEffect = completedWork.firstEffect;</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+            returnFiber.lastEffect = completedWork.lastEffect;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        //&#x5982;&#x679C;&#x8FD9;&#x4E2A;fiber&#x6709;&#x526F;&#x4F5C;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x5B69;&#x5B50;&#x4EEC;&#x7684;&#x526F;&#x4F7F;&#x7528;&#x540E;&#x9762;&#x6DFB;&#x52A0;&#x5B83;&#x81EA;&#x5DF1;&#x7684;&#x526F;&#x4F5C;&#x7528;</span>
<span class="hljs-addition">+        const flags = completedWork.flags;</span>
<span class="hljs-addition">+        if (flags) {</span>
<span class="hljs-addition">+            if (returnFiber.lastEffect) {</span>
<span class="hljs-addition">+                returnFiber.lastEffect.nextEffect = completedWork;</span>
<span class="hljs-addition">+            } else {</span>
<span class="hljs-addition">+                returnFiber.firstEffect = completedWork;</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+            returnFiber.lastEffect = completedWork;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t334.3 ReactWorkTags.js">4.3 ReactWorkTags.js <a href="#t334.3 ReactWorkTags.js"> # </a></h3>
<p>src\ReactWorkTags.js</p>
<pre><code class="lang-diff">//&#x6839;fiber,&#x5BF9;&#x5E94;&#x7684;&#x5176;&#x5B9E;&#x662F;&#x5BB9;&#x5668;containerInfo
export const HostRoot = 3;
<span class="hljs-addition">+export const HostComponent = 5;</span>
</code></pre>
<h3 id="t344.4 ReactFiberBeginWork.js">4.4 ReactFiberBeginWork.js <a href="#t344.4 ReactFiberBeginWork.js"> # </a></h3>
<p>src\ReactFiberBeginWork.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { shouldSetTextContent } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactDOMHostConfig&apos;</span>;
<span class="hljs-keyword">import</span> { reconcileChildFibers, mountChildFibers } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactChildFiber&apos;</span>;
<span class="hljs-keyword">import</span> { HostRoot, HostComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactWorkTags&apos;</span>;
<span class="hljs-comment">/**
 * &#x5F00;&#x59CB;&#x6784;&#x5EFA;&#x5F53;&#x524D;fiber&#x7684;&#x5B50;fiber&#x7ED3;&#x6784;
 * @param {*} current 
 * @param {*} workInProgress 
 * @returns &#x8FD4;&#x56DE;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;fiber&#x8282;&#x70B9;
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">beginWork</span>(<span class="hljs-params">current, workInProgress</span>) </span>{
    <span class="hljs-keyword">switch</span> (workInProgress.tag) {
        <span class="hljs-keyword">case</span> HostRoot:
            <span class="hljs-keyword">return</span> updateHostRoot(current, workInProgress);
        <span class="hljs-keyword">case</span> HostComponent:
            <span class="hljs-keyword">return</span> updateHostComponent(current, workInProgress);
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">break</span>;
    }
}
<span class="hljs-comment">/**
 * &#x6784;&#x5EFA;hostRoot&#x7684;&#x65B0;&#x7684;&#x5B50;fiber&#x94FE;&#x8868;
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>current &#x5F53;&#x524D;fiber&#x7684;&#x8001;fiber 
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>workInProgress &#x5F53;&#x524D;&#x6B63;&#x5728;&#x6784;&#x5EFA;&#x7684;fiber
 * <span class="hljs-doctag">@returns </span>
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateHostRoot</span>(<span class="hljs-params">current, workInProgress</span>) </span>{
    <span class="hljs-keyword">const</span> updateQueue = workInProgress.updateQueue;
    <span class="hljs-keyword">const</span> nextChildren = updateQueue.shared.pending.payload.element;
    reconcileChildren(current, workInProgress, nextChildren);
    updateQueue.shared.pending = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> workInProgress.child;
}
<span class="hljs-comment">/**
 * &#x6784;&#x5EFA;&#x539F;&#x751F;fiber&#x7684;&#x65B0;&#x7684;&#x5B50;fiber&#x94FE;&#x8868;
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>current &#x5F53;&#x524D;fiber&#x7684;&#x8001;fiber
 * <span class="hljs-doctag">@param <span class="hljs-type">{*}</span> </span>workInProgress &#x5F53;&#x524D;&#x6B63;&#x5728;&#x6784;&#x5EFA;&#x7684;fiber
 * <span class="hljs-doctag">@returns</span>
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateHostComponent</span>(<span class="hljs-params">current, workInProgress</span>) </span>{
    <span class="hljs-comment">//&#x539F;&#x751F;fiber&#x7684;&#x7C7B;&#x578B;</span>
    <span class="hljs-keyword">const</span> type = workInProgress.type;
    <span class="hljs-comment">//&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x5C5E;&#x6027;</span>
    <span class="hljs-keyword">const</span> nextProps = workInProgress.pendingProps;
    <span class="hljs-comment">//&#x65B0;&#x7684;&#x5B50;&#x865A;&#x62DF;DOM</span>
    <span class="hljs-keyword">let</span> nextChildren = nextProps.children;
    <span class="hljs-comment">//&#x5224;&#x65AD;&#x662F;&#x552F;&#x4E00;&#x7684;fiber&#x5B50;&#x8282;&#x70B9;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x7684;&#x8BDD;&#x8DF3;&#x8FC7;&#x5B50;fiber&#x8282;&#x70B9;&#x7684;&#x6784;&#x5EFA;</span>
    <span class="hljs-keyword">const</span> isDirectTextChild = shouldSetTextContent(type, nextProps);
    <span class="hljs-keyword">if</span> (isDirectTextChild) {
        <span class="hljs-comment">//&#x5982;&#x679C;host&#x8282;&#x70B9;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x513F;&#x5B50;&#x8282;&#x70B9;&#x7684;&#x65F6;&#x5019;&#x662F;&#x4E2A;&#x7279;&#x4F8B;</span>
        <span class="hljs-comment">//&#x6211;&#x4EEC;&#x4E0D;&#x4F1A;&#x628A;&#x5B83;&#x5F53;&#x4F5C;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x5316;&#x7684;&#x5B69;&#x5B50;&#x6765;&#x5904;&#x7406;</span>
        <span class="hljs-comment">//&#x6211;&#x4EEC;&#x5C06;&#x5728;host&#x73AF;&#x5883;&#x5904;&#x7406;&#x5B83;&#xFF0C;&#x8FD9;&#x907F;&#x514D;&#x4E86;&#x5206;&#x914D;&#x53E6;&#x4E00;&#x4E2A; HostText Fiber&#x8282;&#x70B9;&#x5E76;&#x904D;&#x5386;&#x5B83;</span>
        nextChildren = <span class="hljs-literal">null</span>;
    }
    reconcileChildren(current, workInProgress, nextChildren);
    <span class="hljs-keyword">return</span> workInProgress.child;
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reconcileChildren</span>(<span class="hljs-params">current, workInProgress, nextChildren</span>) </span>{
    <span class="hljs-comment">//&#x5982;&#x679C;&#x8001;&#x7684;fiber&#x5B58;&#x5728;&#xFF0C;&#x8FDB;&#x884C;&#x66F4;&#x65B0;&#x903B;&#x8F91;</span>
    <span class="hljs-keyword">if</span> (current) {
        workInProgress.child = reconcileChildFibers(
            workInProgress,
            current &amp;&amp; current.child,
            nextChildren
        );
        <span class="hljs-comment">//&#x5982;&#x679C;&#x8001;&#x7684;fiber&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x8FDB;&#x884C;&#x521B;&#x5EFA;&#x903B;&#x8F91;</span>
    } <span class="hljs-keyword">else</span> {
        workInProgress.child = mountChildFibers(
            workInProgress,
            current &amp;&amp; current.child,
            nextChildren
        );
    }

}
</code></pre>
<h3 id="t354.5 ReactFiberCompleteWork.js">4.5 ReactFiberCompleteWork.js <a href="#t354.5 ReactFiberCompleteWork.js"> # </a></h3>
<p>src\ReactFiberCompleteWork.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { createInstance, finalizeInitialChildren } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactDOMHostConfig&apos;</span>;
<span class="hljs-keyword">import</span> { HostComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactWorkTags&apos;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">completeWork</span>(<span class="hljs-params">current, workInProgress</span>) </span>{
    <span class="hljs-keyword">const</span> newProps = workInProgress.pendingProps;
    <span class="hljs-keyword">switch</span> (workInProgress.tag) {
        <span class="hljs-keyword">case</span> HostComponent: {
            <span class="hljs-keyword">if</span> (current &amp;&amp; workInProgress.stateNode) {

            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">const</span> type = workInProgress.type;
                <span class="hljs-keyword">const</span> instance = createInstance(type, newProps);
                workInProgress.stateNode = instance;
                finalizeInitialChildren(instance, type, newProps);
            }
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-attr">default</span>:
            <span class="hljs-keyword">break</span>;
    }
}
</code></pre>
<h3 id="t364.6 ReactFiberFlags.js">4.6 ReactFiberFlags.js <a href="#t364.6 ReactFiberFlags.js"> # </a></h3>
<p>src\ReactFiberFlags.js</p>
<pre><code class="lang-diff">export const NoFlags = 0b000000000000000000;
<span class="hljs-addition">+export const Placement = 0b000000000000000010;</span>
</code></pre>
<h3 id="t374.7 ReactDOMHostConfig.js">4.7 ReactDOMHostConfig.js <a href="#t374.7 ReactDOMHostConfig.js"> # </a></h3>
<p>src\ReactDOMHostConfig.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { createElement, setInitialProperties } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactDOMComponent&apos;</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shouldSetTextContent</span>(<span class="hljs-params">type, props</span>) </span>{
    <span class="hljs-keyword">return</span> (
        <span class="hljs-keyword">typeof</span> props.children === <span class="hljs-string">&apos;string&apos;</span> ||
        <span class="hljs-keyword">typeof</span> props.children === <span class="hljs-string">&apos;number&apos;</span>
    );
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createInstance</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">return</span> createElement(type);
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">finalizeInitialChildren</span>(<span class="hljs-params">domElement, type, props</span>) </span>{
    setInitialProperties(domElement, type, props);
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">appendChild</span>(<span class="hljs-params">parentInstance, child</span>) </span>{
    parentInstance.appendChild(child);
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insertBefore</span>(<span class="hljs-params">parentInstance, child, beforeChild</span>) </span>{
    parentInstance.insertBefore(child, beforeChild);
}
</code></pre>
<h3 id="t384.8 src\ReactDOMComponent.js">4.8 src\ReactDOMComponent.js <a href="#t384.8 src\ReactDOMComponent.js"> # </a></h3>
<p>src\ReactDOMComponent.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createElement</span>(<span class="hljs-params">type</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.createElement(type);
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setInitialProperties</span>(<span class="hljs-params">domElement, tag, rawProps</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> propKey <span class="hljs-keyword">in</span> rawProps) {
        <span class="hljs-keyword">const</span> nextProp = rawProps[propKey];
        <span class="hljs-keyword">if</span> (propKey === children) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> nextProp === <span class="hljs-string">&apos;string&apos;</span> || <span class="hljs-keyword">typeof</span> nextProp === <span class="hljs-string">&apos;number&apos;</span>) {
                domElement.textContent = nextProp;
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (propKey === <span class="hljs-string">&apos;style&apos;</span>) {
            <span class="hljs-keyword">let</span> styleObj = rawProps[propKey];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> styleProp <span class="hljs-keyword">in</span> styleObj) {
                domElement.style[styleProp] = styleObj[styleProp];
            }
        } <span class="hljs-keyword">else</span> {
            domElement[propKey] = nextProp;
        }
    }
}
</code></pre>
<h3 id="t394.9 src\ReactChildFiber.js">4.9 src\ReactChildFiber.js <a href="#t394.9 src\ReactChildFiber.js"> # </a></h3>
<p>src\ReactChildFiber.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Placement } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactFiberFlags&apos;</span>;
<span class="hljs-keyword">import</span> { createFiberFromElement } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactFiber&apos;</span>;
<span class="hljs-keyword">import</span> { REACT_ELEMENT_TYPE } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactSymbols&apos;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ChildReconciler</span>(<span class="hljs-params">shouldTrackSideEffects</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">placeSingleChild</span>(<span class="hljs-params">newFiber</span>) </span>{
        <span class="hljs-comment">//&#x5982;&#x679C;&#x8981;&#x8DDF;&#x8E2A;&#x526F;&#x4F5C;&#x7528;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x8001;&#x7684;fiber&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x65B0;&#x5EFA;</span>
        <span class="hljs-keyword">if</span> (shouldTrackSideEffects &amp;&amp; !newFiber.alternate) {
            newFiber.flags = Placement;
        }
        <span class="hljs-keyword">return</span> newFiber;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reconcileSingleElement</span>(<span class="hljs-params">returnFiber, currentFirstChild, element</span>) </span>{
        <span class="hljs-comment">//&#x6839;&#x636E;&#x865A;&#x62DF;DOM&#x521B;&#x5EFA;fiber&#x8282;&#x70B9;</span>
        <span class="hljs-keyword">const</span> created = createFiberFromElement(element);
        <span class="hljs-comment">//&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber</span>
        created.return = returnFiber;
        <span class="hljs-keyword">return</span> created;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reconcileChildFibers</span>(<span class="hljs-params">returnFiber, currentFirstChild, newChild</span>) </span>{
        <span class="hljs-keyword">const</span> isObject = <span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">&apos;object&apos;</span> &amp;&amp; (newChild);
        <span class="hljs-keyword">if</span> (isObject) {
            <span class="hljs-keyword">switch</span> (newChild.$$<span class="hljs-keyword">typeof</span>) {
                <span class="hljs-keyword">case</span> REACT_ELEMENT_TYPE:
                    <span class="hljs-keyword">return</span> placeSingleChild(
                        reconcileSingleElement(returnFiber, currentFirstChild, newChild)
                    );
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;
            }
        }
    }
    <span class="hljs-keyword">return</span> reconcileChildFibers;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> reconcileChildFibers = ChildReconciler(<span class="hljs-literal">true</span>);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mountChildFibers = ChildReconciler(<span class="hljs-literal">false</span>);
</code></pre>
<h3 id="t404.10 ReactFiber.js">4.10 ReactFiber.js <a href="#t404.10 ReactFiber.js"> # </a></h3>
<p>src\ReactFiber.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { HostRoot, HostComponent } from &apos;./ReactWorkTags&apos;;</span>
import { NoFlags } from &apos;./ReactFiberFlags&apos;;

/**
 * &#x521B;&#x5EFA;&#x6839;fiber
 * @returns &#x6839;fiber
 */
export function createHostRootFiber() {
    return createFiber(HostRoot);
}
/**
 * &#x521B;&#x5EFA;fiber
 * @param {*} tag fiber&#x7C7B;&#x578B;
 * @param {*} pendingProps &#x65B0;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;
 * @param {*} key &#x552F;&#x4E00;&#x6807;&#x8BC6;
 * @returns &#x521B;&#x5EFA;&#x7684;fiber
 */
const createFiber = function (tag, pendingProps, key) {
    return new FiberNode(tag, pendingProps, key);
};
/**
 * fiber&#x6784;&#x5EFA;&#x51FD;&#x6570;
 * @param {*} tag fiber&#x7C7B;&#x578B;
 * @param {*} pendingProps  &#x65B0;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;
 * @param {*} key &#x552F;&#x4E00;&#x6807;&#x8BC6;
 */
function FiberNode(tag, pendingProps, key) {
    this.tag = tag;
    this.pendingProps = pendingProps;
    this.key = key;
}
/**
 * &#x57FA;&#x4E8E;&#x8001;&#x7684;current&#x521B;&#x5EFA;&#x65B0;&#x7684;workInProgress
 * @param {*} current &#x8001;&#x7684;fiber
 * @returns 
 */
export function createWorkInProgress(current, pendingProps) {
    let workInProgress = current.alternate;
    if (!workInProgress) {
        workInProgress = createFiber(current.tag, pendingProps, current.key);
        workInProgress.type = current.type;
        workInProgress.stateNode = current.stateNode;
        workInProgress.alternate = current;
        current.alternate = workInProgress;
    } else {
        workInProgress.pendingProps = pendingProps;
        workInProgress.flags = NoFlags;
    }
    //&#x6E05;&#x7A7A;&#x539F;&#x6765;&#x7684;child
    workInProgress.child = null;
    //&#x6E05;&#x7A7A;&#x539F;&#x6765;&#x7684;sibling
    workInProgress.sibling = null;
    //&#x6E05;&#x7A7A;&#x539F;&#x6765;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;
    workInProgress.firstEffect = workInProgress.nextEffect = workInProgress.lastEffect = null;
    workInProgress.updateQueue = current.updateQueue;
    return workInProgress;
}
<span class="hljs-addition">+export function createFiberFromElement(element) {</span>
<span class="hljs-addition">+    const { key, type, props } = element;</span>
<span class="hljs-addition">+    let fiberTag;</span>
<span class="hljs-addition">+    if (typeof type === &apos;string&apos;) {</span>
<span class="hljs-addition">+        fiberTag = HostComponent;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    const fiber = createFiber(fiberTag, props, key);</span>
<span class="hljs-addition">+    fiber.type = type;</span>
<span class="hljs-addition">+    return fiber;</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t414.11 ReactFiberCommitWork.js">4.11 ReactFiberCommitWork.js <a href="#t414.11 ReactFiberCommitWork.js"> # </a></h3>
<p>src\ReactFiberCommitWork.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { HostComponent, HostRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactWorkTags&apos;</span>;
<span class="hljs-keyword">import</span> { appendChild, insertBefore } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactDOMHostConfig&apos;</span>;
<span class="hljs-keyword">import</span> { Placement } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ReactFiberFlags&apos;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getParentStateNode</span>(<span class="hljs-params">fiber</span>) </span>{
    <span class="hljs-keyword">const</span> parent = fiber.return;
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">if</span> (parent.tag === HostComponent) {
            <span class="hljs-keyword">return</span> parent.stateNode;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parent.tag === HostRoot) {
            <span class="hljs-keyword">return</span> parent.stateNode.containerInfo
        }
        parent = parent.return;
    } <span class="hljs-keyword">while</span> (parent);
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitPlacement</span>(<span class="hljs-params">finishedWork</span>) </span>{
    <span class="hljs-keyword">let</span> stateNode = finishedWork.stateNode;
    <span class="hljs-keyword">let</span> parentStateNode = getParentStateNode(finishedWork);
     appendChild(parentStateNode, stateNode);
}
</code></pre>
<h2 id="t425.&#x5355;&#x8282;&#x70B9;key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C;">5.&#x5355;&#x8282;&#x70B9;key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C; <a href="#t425.&#x5355;&#x8282;&#x70B9;key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C;"> # </a></h2>
<ul>
<li>&#x5355;&#x8282;&#x70B9;key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C;&#x7684;&#x65F6;&#x5019;,&#x590D;&#x7528;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x53EA;&#x66F4;&#x65B0;&#x5C5E;&#x6027;</li>
<li><a href="https://www.processon.com/diagraming/618fbda40e3e744ad4402b1c">fiber&#x7ED3;&#x6784;</a></li>
<li><a href="https://www.processon.com/diagraming/6185f0781efad40ab186a60a">&#x5355;&#x8282;&#x70B9;DIFF&#x6D41;&#x7A0B;</a></li>
</ul>
<p><img src="https://static.zhufengpeixun.com/cong_render_dao_zhi_xing_gong_zuo_xun_huan_de_fiber_jia_gou_4_1636817909854.jpg" alt></p>
<p><img src="https://static.zhufengpeixun.com/dan_jie_dian_diff_1636818669377.jpg" alt></p>
<h3 id="t435.1 .eslintrc">5.1 .eslintrc <a href="#t435.1 .eslintrc"> # </a></h3>
<p>.eslintrc</p>
<pre><code class="lang-json">{
  <span class="hljs-attr">&quot;rules&quot;</span>: {
    <span class="hljs-attr">&quot;react-hooks/rules-of-hooks&quot;</span>: <span class="hljs-string">&quot;off&quot;</span>
  }
}
</code></pre>
<h3 id="t445.2 public\index.html">5.2 public\index.html <a href="#t445.2 public\index.html"> # </a></h3>
<p>public\index.html</p>
<pre><code class="lang-diff">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
    &lt;meta name=&quot;theme-color&quot; content=&quot;#000000&quot; /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
    &lt;div&gt;
      &lt;button id=&quot;single1&quot;&gt;1.key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C;&lt;/button&gt;&lt;br/&gt;
      &amp;lt;div key=&amp;quot;title&amp;quot; id=&amp;quot;title&amp;quot;&amp;gt;&lt;br/&gt;
        &amp;nbsp;&amp;nbsp;div&lt;br/&gt;
      &amp;lt;/div&amp;gt;&lt;br/&gt;
      &lt;button id=&quot;single1Update&quot;&gt;&#x590D;&#x7528;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x53EA;&#x66F4;&#x65B0;&#x5C5E;&#x6027;&lt;/button&gt;&lt;br/&gt;
      &amp;lt;div key=&amp;quot;title&amp;quot; id=&amp;quot;title2&amp;quot;&amp;gt;&lt;br/&gt;
        &amp;nbsp;&amp;nbsp;div2&lt;br/&gt;
      &amp;lt;/div&amp;gt;
    &lt;/div&gt;
    &lt;hr/&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="t455.3 src\index.js">5.3 src\index.js <a href="#t455.3 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-diff">import React from &apos;./react&apos;;
import ReactDOM from &apos;./react-dom&apos;;
//1. key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C;,&#x590D;&#x7528;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x53EA;&#x66F4;&#x65B0;&#x5C5E;&#x6027;
single1.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;div key=&quot;title&quot; id=&quot;title&quot;&gt;title&lt;/div&gt;
  );
  ReactDOM.render(element, root);
});
single1Update.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;div key=&quot;title&quot; id=&quot;title2&quot;&gt;title2&lt;/div&gt;
  );
  ReactDOM.render(element, root);
});
</code></pre>
<h3 id="t465.4 src\react-dom.js">5.4 src\react-dom.js <a href="#t465.4 src\react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-diff">import { createFiberRoot } from &apos;./ReactFiberRoot&apos;;
import { updateContainer } from &apos;./ReactFiberReconciler&apos;;
function render(element, container) {
<span class="hljs-addition">+   let fiberRoot = container._reactRootContainer;</span>
<span class="hljs-addition">+   if (!fiberRoot) {</span>
<span class="hljs-addition">+       fiberRoot = container._reactRootContainer = createFiberRoot(container);</span>
<span class="hljs-addition">+   }</span>
    updateContainer(element, fiberRoot);
}
const ReactDOM = {
    render
}
export default ReactDOM;
</code></pre>
<h3 id="t475.5 ReactFiberWorkLoop.js">5.5 ReactFiberWorkLoop.js <a href="#t475.5 ReactFiberWorkLoop.js"> # </a></h3>
<p>src\ReactFiberWorkLoop.js</p>
<pre><code class="lang-diff">import { HostRoot, HostComponent } from &apos;./ReactWorkTags&apos;;
import { createWorkInProgress } from &apos;./ReactFiber&apos;;
import { beginWork } from &apos;./ReactFiberBeginWork&apos;;
import { completeWork } from &apos;./ReactFiberCompleteWork&apos;;
<span class="hljs-addition">+import { Placement, Update, Deletion } from &apos;./ReactFiberFlags&apos;;</span>
<span class="hljs-addition">+import { commitPlacement,commitWork,commitDeletion } from &apos;./ReactFiberCommitWork&apos;;</span>
//&#x6B63;&#x5728;&#x8C03;&#x5EA6;&#x7684;fiberRoot&#x6839;&#x8282;&#x70B9;
let workInProgressRoot = null;
//&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;fiber&#x8282;&#x70B9;
let workInProgress = null;
<span class="hljs-addition">+//&#x6700;&#x5927;&#x66F4;&#x65B0;&#x6DF1;&#x5EA6;</span>
<span class="hljs-addition">+const NESTED_UPDATE_LIMIT = 50;</span>
<span class="hljs-addition">+let nestedUpdateCount = 0;</span>
/**
 * &#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
 * @param {*} sourceFiber &#x66F4;&#x65B0;&#x6765;&#x6E90;fiber
 * @returns 
 */
function markUpdateLaneFromFiberToRoot(sourceFiber) {
    let node = sourceFiber;
    let parent = node.return;
    //&#x4E00;&#x76F4;&#x5411;&#x4E0A;&#x627E;&#x7236;&#x4EB2;&#xFF0C;&#x627E;&#x4E0D;&#x5230;&#x4E3A;&#x6B62;
    while (parent) {
        node = parent;
        parent = parent.return;
    }
    //&#x5982;&#x679C;&#x627E;&#x5230;&#x7684;&#x662F;HostRoot&#x5C31;&#x8FD4;&#x56DE;FiberRootNode,&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5BB9;&#x5668;div#root
    if (node.tag <span class="hljs-comment">=== HostRoot) {</span>
        return node.stateNode;
    }
}
/**
 * &#x5411;&#x4E0A;&#x67E5;&#x627E;&#x5230;&#x6839;&#x8282;&#x70B9;&#x5F00;&#x59CB;&#x8C03;&#x5EA6;&#x66F4;&#x65B0;
 * @param {*} fiber 
 */
export function scheduleUpdateOnFiber(fiber) {
    checkForNestedUpdates();
    //&#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
    const root = markUpdateLaneFromFiberToRoot(fiber);
    //&#x6267;&#x884C;HostRoot&#x4E0A;&#x7684;&#x66F4;&#x65B0;
    performSyncWorkOnRoot(root);
}
<span class="hljs-addition">+function checkForNestedUpdates() {</span>
<span class="hljs-addition">+    if (++nestedUpdateCount &gt; NESTED_UPDATE_LIMIT) {</span>
<span class="hljs-addition">+        throw new Error(&apos;Maximum update depth exceeded&apos;);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
/**
 * &#x5F00;&#x59CB;&#x6267;&#x884C;FiberRootNode&#x4E0A;&#x7684;&#x5DE5;&#x4F5C;
 * @param {*} root  FiberRootNode
 */
function performSyncWorkOnRoot(root) {
    //&#x5148;&#x8D4B;&#x503C;&#x7ED9;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x5DE5;&#x4F5C;&#x7684;FiberRootNode&#x6839;&#x8282;&#x70B9;
    workInProgressRoot = root;
    //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5904;&#x7406;&#x4E2D;&#x7684;fiber&#x8282;&#x70B9;
    workInProgress = createWorkInProgress(workInProgressRoot.current);
    workLoopSync();
    commitRoot();
}
function commitRoot(root) {
    //&#x6784;&#x5EFA;&#x6210;&#x529F;&#x7684;&#x65B0;&#x7684;fiber&#x6811;
    const finishedWork = workInProgressRoot.current.alternate;
    //&#x5F53;&#x524D;&#x5B8C;&#x6210;&#x7684;&#x6784;&#x5EFA;&#x5DE5;&#x4F5C;&#x7B49;&#x4E8E;finishedWork
    workInProgressRoot.finishedWork = finishedWork;
    commitMutationEffects(workInProgressRoot);
<span class="hljs-addition">+   nestedUpdateCount--;</span>
}
function getFlag(flags) {
    switch (flags) {
        case Placement:
            return &apos;&#x6DFB;&#x52A0;&apos;;
<span class="hljs-addition">+       case Update:</span>
<span class="hljs-addition">+           return &apos;&#x66F4;&#x65B0;&apos;;</span>
<span class="hljs-addition">+       case Deletion:</span>
<span class="hljs-addition">+           return &apos;&#x5220;&#x9664;&apos;;</span>
    }
}
function commitMutationEffects(root) {
    const finishedWork = root.finishedWork;
    let nextEffect = finishedWork.firstEffect;
    let effectList = &apos;&apos;;
    while (nextEffect) {
        effectList += `(${getFlag(nextEffect.flags)}#${nextEffect.type}#${nextEffect.key})=&gt;`;
        const flags = nextEffect.flags;
<span class="hljs-addition">+       const current = nextEffect.alternate;</span>
        if (flags <span class="hljs-comment">=== Placement) {</span>
            commitPlacement(nextEffect);
<span class="hljs-addition">+       } else if (flags === Update) {</span>
<span class="hljs-addition">+           commitWork(current, nextEffect);</span>
<span class="hljs-addition">+       } else if (flags === Deletion) {</span>
<span class="hljs-addition">+           commitDeletion(nextEffect);</span>
<span class="hljs-addition">+       }</span>
        nextEffect = nextEffect.nextEffect;
    }
    effectList += &apos;null&apos;;
    console.log(effectList);
    root.current = finishedWork;
}

function commitPlacement(nextEffect) {
    let stateNode = fiber.stateNode;
    let parentStateNode = getParentStateNode(nextEffect);
    parentStateNode.appendChild(stateNode);
}
function getParentStateNode(fiber) {
    const parent = fiber.return;
    do {
        if (parent.tag <span class="hljs-comment">=== HostComponent) {</span>
            return parent.stateNode;
        } else if (parent.tag <span class="hljs-comment">=== HostRoot) {</span>
            return parent.stateNode.containerInfo
        }
        parent = parent.return;
    } while (parent);
}
function workLoopSync() {
    while (workInProgress) {
        performUnitOfWork(workInProgress);
    }
}
/**
 * &#x6267;&#x884C;&#x5355;&#x4E2A;&#x5DE5;&#x4F5C;&#x5355;&#x5143;
 * @param {*} unitOfWork &#x5355;&#x4E2A;fiber
 */
function performUnitOfWork(unitOfWork) {
    //&#x83B7;&#x53D6;&#x5F53;&#x524D;fiber&#x7684;alternate
    const current = unitOfWork.alternate;
    //&#x5F00;&#x59CB;&#x6784;&#x5EFA;&#x6B64;fiber&#x7684;&#x5B50;fiter&#x94FE;&#x8868;
    let next = beginWork(current, unitOfWork);
    //&#x66F4;&#x65B0;&#x5C5E;&#x6027;
    unitOfWork.memoizedProps = unitOfWork.pendingProps;
    //&#x5982;&#x679C;&#x6709;&#x5B50;fiber&#xFF0C;&#x5C31;&#x7EE7;&#x7EED;&#x6267;&#x884C;
    if (next) {
        workInProgress = next;
    } else {
        //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5B50;fiber&#xFF0C;&#x5C31;&#x5B8C;&#x6210;&#x5F53;&#x524D;&#x7684;fiber
        completeUnitOfWork(unitOfWork);
    }
}

function completeUnitOfWork(unitOfWork) {
    //&#x5C1D;&#x8BD5;&#x5B8C;&#x6210;&#x5F53;&#x524D;&#x7684;&#x5DE5;&#x4F5C;&#x5355;&#x5143;&#xFF0C;&#x7136;&#x540E;&#x79FB;&#x52A8;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x5F1F;&#x5F1F;
    //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4E0B;&#x4E00;&#x4E2A;&#x5F1F;&#x5F1F;&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x7236;Fiber
    let completedWork = unitOfWork;
    do {
        const current = completedWork.alternate;
        const returnFiber = completedWork.return;
        completeWork(current, completedWork);
        collectEffectList(returnFiber, completedWork)
        const siblingFiber = completedWork.sibling;
        if (siblingFiber) {
            //&#x5982;&#x679C;&#x6B64; returnFiber &#x4E2D;&#x8FD8;&#x6709;&#x66F4;&#x591A;&#x5DE5;&#x4F5C;&#x8981;&#x505A;&#xFF0C;&#x8BF7;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x6B65;
            workInProgress = siblingFiber;
            return;
        }
        //&#x5426;&#x5219;&#xFF0C;&#x8FD4;&#x56DE;&#x7236;&#x7EA7;
        completedWork = returnFiber;
        //&#x66F4;&#x65B0;&#x6211;&#x4EEC;&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;&#x4E0B;&#x4E00;&#x4EF6;&#x4E8B;
        workInProgress = completedWork;
    } while (completedWork);
}
function collectEffectList(returnFiber, completedWork) {
    if (returnFiber) {
        if (!returnFiber.firstEffect) {
            returnFiber.firstEffect = completedWork.firstEffect;
        }
        if (completedWork.lastEffect) {
            if (returnFiber.lastEffect) {
                returnFiber.lastEffect.nextEffect = completedWork.firstEffect;
            }
            returnFiber.lastEffect = completedWork.lastEffect;
        }
        //&#x5982;&#x679C;&#x8FD9;&#x4E2A;fiber&#x6709;&#x526F;&#x4F5C;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x5B69;&#x5B50;&#x4EEC;&#x7684;&#x526F;&#x4F7F;&#x7528;&#x540E;&#x9762;&#x6DFB;&#x52A0;&#x5B83;&#x81EA;&#x5DF1;&#x7684;&#x526F;&#x4F5C;&#x7528;
        const flags = completedWork.flags;
        if (flags) {
            if (returnFiber.lastEffect) {
                returnFiber.lastEffect.nextEffect = completedWork;
            } else {
                returnFiber.firstEffect = completedWork;
            }
            returnFiber.lastEffect = completedWork;
        }
    }
}
</code></pre>
<h3 id="t485.6 ReactFiberFlags.js">5.6 ReactFiberFlags.js <a href="#t485.6 ReactFiberFlags.js"> # </a></h3>
<p>src\ReactFiberFlags.js</p>
<pre><code class="lang-diff">export const NoFlags = 0b000000000000000000;//0
export const Placement = 0b000000000000000010;//2
<span class="hljs-addition">+export const Update = 0b000000000000000100;//4</span>
<span class="hljs-addition">+export const Deletion = 0b000000000000001000;//8</span>
</code></pre>
<h3 id="t495.7 src\ReactFiberCommitWork.js">5.7 src\ReactFiberCommitWork.js <a href="#t495.7 src\ReactFiberCommitWork.js"> # </a></h3>
<p>src\ReactFiberCommitWork.js</p>
<pre><code class="lang-diff">import { updateProperties } from &apos;./ReactDOMComponent&apos;;
import { HostComponent } from &apos;./ReactWorkTags&apos;;
import {appendChild,removeChild} from &apos;./ReactFiberHostConfig&apos;;
<span class="hljs-addition">+/**</span>
<span class="hljs-addition">+ * &#x66F4;&#x65B0;DOM&#x8282;&#x70B9;&#x7684;&#x5C5E;&#x6027;</span>
<span class="hljs-addition">+ * @param {*} current </span>
<span class="hljs-addition">+ * @param {*} finishedWork </span>
<span class="hljs-addition">+ */</span>
<span class="hljs-addition">+export function commitWork(current, finishedWork) {</span>
<span class="hljs-addition">+    switch (finishedWork.tag) {</span>
<span class="hljs-addition">+        case HostComponent: {</span>
<span class="hljs-addition">+            const updatePayload = finishedWork.updateQueue;</span>
<span class="hljs-addition">+            finishedWork.updateQueue = null;</span>
<span class="hljs-addition">+            if (updatePayload) {</span>
<span class="hljs-addition">+                updateProperties(finishedWork.stateNode, updatePayload);</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        default:</span>
<span class="hljs-addition">+            break;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function commitDeletion(fiber) {</span>
<span class="hljs-addition">+    if (!fiber) {</span>
<span class="hljs-addition">+        return;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    let parentStateNode = getParentStateNode(fiber);</span>
<span class="hljs-addition">+    removeChild(parentStateNode, fiber.stateNode);</span>
<span class="hljs-addition">+}</span>
function getParentStateNode(fiber) {
    const parent = fiber.return;
    do {
        if (parent.tag <span class="hljs-comment">=== HostComponent) {</span>
            return parent.stateNode;
        } else if (parent.tag <span class="hljs-comment">=== HostRoot) {</span>
            return parent.stateNode.containerInfo
        }
        parent = parent.return;
    } while (parent);
}
export function commitPlacement(finishedWork) {
    let stateNode = finishedWork.stateNode;
    let parentStateNode = getParentStateNode(finishedWork);
     appendChild(parentStateNode, stateNode);
}
</code></pre>
<h3 id="t505.8 src\ReactDOMComponent.js">5.8 src\ReactDOMComponent.js <a href="#t505.8 src\ReactDOMComponent.js"> # </a></h3>
<p>src\ReactDOMComponent.js</p>
<pre><code class="lang-diff">export function createElement(type) {
    return document.createElement(type);
}
/**
 * &#x8BBE;&#x7F6E;&#x521D;&#x59CB;&#x5316;&#x5C5E;&#x6027;
 * @param {*} domElement DOM&#x8282;&#x70B9;
 * @param {*} tag &#x6807;&#x7B7E;
 * @param {*} rawProps &#x5C5E;&#x6027;&#x5BF9;&#x8C61;
 */
export function setInitialProperties(domElement, tag, rawProps) {
    for (const propKey in rawProps) {
        const nextProp = rawProps[propKey];
        if (propKey <span class="hljs-comment">=== &quot;children&quot;) {</span>
            if (typeof nextProp <span class="hljs-comment">=== &apos;string&apos; || typeof nextProp === &apos;number&apos;) {</span>
                domElement.textContent = nextProp;
            }
        } else if (propKey <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = rawProps[propKey];
            for (let styleProp in styleObj) {
                domElement.style[styleProp] = styleObj[styleProp];
            }
        } else {
            domElement[propKey] = nextProp;
        }
    }
}
<span class="hljs-addition">+/**</span>
<span class="hljs-addition">+ * &#x6BD4;&#x8F83;&#x5C5E;&#x6027;&#x7684;&#x5DEE;&#x5F02;</span>
<span class="hljs-addition">+ * @param {*} domElement DOM&#x8282;&#x70B9;</span>
<span class="hljs-addition">+ * @param {*} tag &#x6807;&#x7B7E;</span>
<span class="hljs-addition">+ * @param {*} lastProps &#x8001;&#x5C5E;&#x6027; </span>
<span class="hljs-addition">+ * @param {*} nextProps &#x65B0;&#x5C5E;&#x6027;</span>
<span class="hljs-addition">+ * @returns </span>
<span class="hljs-addition">+ */</span>
<span class="hljs-addition">+export function diffProperties(domElement, tag, lastProps = {}, nextProps = {}) {</span>
<span class="hljs-addition">+    let updatePayload = null;</span>
<span class="hljs-addition">+    let propKey;</span>
<span class="hljs-addition">+    for (propKey in lastProps) {</span>
<span class="hljs-addition">+        //&#x8001;&#x6709;&#x65B0;&#x6CA1;&#x6709;</span>
<span class="hljs-addition">+        if (lastProps.hasOwnProperty(propKey) &amp;&amp; (!nextProps.hasOwnProperty(propKey))) {</span>
<span class="hljs-addition">+            // &#x5BF9;&#x4E8E;&#x6240;&#x6709;&#x5176;&#x4ED6;&#x5DF2;&#x5220;&#x9664;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5176;&#x6DFB;&#x52A0;&#x5230;&#x961F;&#x5217;&#x4E2D;&#x3002;</span>
<span class="hljs-addition">+            // &#x6211;&#x4EEC;&#x7528;&#x6539;&#x4E3A;&#x63D0;&#x4EA4;&#x9636;&#x6BB5;&#x4E2D;&#x5141;&#x8BB8;&#x7684;&#x5C5E;&#x6027;&#x5217;&#x8868;</span>
<span class="hljs-addition">+            (updatePayload = updatePayload || []).push(propKey, null);</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    for (propKey in nextProps) {</span>
<span class="hljs-addition">+        const nextProp = nextProps[propKey];</span>
<span class="hljs-addition">+        if (propKey === &quot;children&quot;) {</span>
<span class="hljs-addition">+            if (typeof nextProp === &apos;string&apos; || typeof nextProp === &apos;number&apos;) {</span>
<span class="hljs-addition">+                if (nextProp !== lastProps[propKey]) {</span>
<span class="hljs-addition">+                    (updatePayload = updatePayload || []).push(propKey, &apos;&apos; + nextProp);</span>
<span class="hljs-addition">+                }</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+        } else {</span>
<span class="hljs-addition">+            let oldProp = lastProps[propKey];</span>
<span class="hljs-addition">+            if (oldProp !== nextProp) {</span>
<span class="hljs-addition">+                (updatePayload = updatePayload || []).push(propKey, nextProp);</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    return updatePayload;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+/**</span>
<span class="hljs-addition">+ * &#x66F4;&#x65B0;DOM&#x8282;&#x70B9;&#x7684;&#x5C5E;&#x6027;</span>
<span class="hljs-addition">+ * @param {*} domElement DOM&#x8282;&#x70B9;</span>
<span class="hljs-addition">+ * @param {*} updatePayload &#x8981;&#x66F4;&#x65B0;&#x7684;&#x5C5E;&#x6027;</span>
<span class="hljs-addition">+ */</span>
<span class="hljs-addition">+export function updateProperties(domElement, updatePayload) {</span>
<span class="hljs-addition">+    for (let i = 0; i &lt; updatePayload.length; i += 2) {</span>
<span class="hljs-addition">+        const propKey = updatePayload[i];</span>
<span class="hljs-addition">+        const propValue = updatePayload[i + 1];</span>
<span class="hljs-addition">+        if (propKey === &quot;children&quot;) {</span>
<span class="hljs-addition">+            domElement.textContent = propValue;</span>
<span class="hljs-addition">+        } else {</span>
<span class="hljs-addition">+            domElement.setAttribute(propKey, propValue);</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t515.9 src\ReactChildFiber.js">5.9 src\ReactChildFiber.js <a href="#t515.9 src\ReactChildFiber.js"> # </a></h3>
<p>src\ReactChildFiber.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { Placement, Deletion } from &apos;./ReactFiberFlags&apos;;</span>
<span class="hljs-addition">+import { createFiberFromElement, createWorkInProgress } from &apos;./ReactFiber&apos;;</span>
import { REACT_ELEMENT_TYPE } from &apos;./ReactSymbols&apos;;
function ChildReconciler(shouldTrackSideEffects) {
    function placeSingleChild(newFiber) {
        //&#x5982;&#x679C;&#x8981;&#x8DDF;&#x8E2A;&#x526F;&#x4F5C;&#x7528;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x8001;&#x7684;fiber&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x65B0;&#x5EFA;
        if (shouldTrackSideEffects &amp;&amp; !newFiber.alternate) {
            newFiber.flags = Placement;
        }
        return newFiber;
    }
<span class="hljs-addition">+   function deleteChild(returnFiber, childToDelete) {</span>
<span class="hljs-addition">+       if (!shouldTrackSideEffects) {</span>
<span class="hljs-addition">+           return;</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       //&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x7236;&#x4EB2;&#x5F85;&#x5220;&#x9664;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E2D;</span>
<span class="hljs-addition">+       const last = returnFiber.lastEffect;</span>
<span class="hljs-addition">+       if (last) {//&#x5982;&#x679C;&#x7236;&#x4EB2;&#x6709;&#x5C3E;&#x90E8;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x5C3E;&#x90E8;&#x7684;nextEffect&#x4E0A;</span>
<span class="hljs-addition">+           last.nextEffect = childToDelete;</span>
<span class="hljs-addition">+           //&#x7136;&#x540E;&#x8BA9;&#x7236;&#x4EB2;&#x7684;&#x5C3E;&#x90E8;&#x7B49;&#x4E8E;&#x81EA;&#x5DF1;</span>
<span class="hljs-addition">+           returnFiber.lastEffect = childToDelete;</span>
<span class="hljs-addition">+       } else {</span>
<span class="hljs-addition">+           //&#x5982;&#x679C;&#x7236;&#x4EB2;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;&#xFF0C;&#x5934;&#x548C;&#x5C3E;&#x5411;childToDelete</span>
<span class="hljs-addition">+           returnFiber.firstEffect = returnFiber.lastEffect = childToDelete;</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       //&#x6E05;&#x7A7A;&#x5B83;&#x7684;nextEffect</span>
<span class="hljs-addition">+       childToDelete.nextEffect = null;</span>
<span class="hljs-addition">+       //&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;</span>
<span class="hljs-addition">+       childToDelete.flags = Deletion;</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   function deleteRemainingChildren(returnFiber, currentFirstChild) {</span>
<span class="hljs-addition">+       let childToDelete = currentFirstChild;</span>
<span class="hljs-addition">+       while (childToDelete) {</span>
<span class="hljs-addition">+           deleteChild(returnFiber, childToDelete);</span>
<span class="hljs-addition">+           childToDelete = childToDelete.sibling;</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       return null;</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   /**</span>
<span class="hljs-addition">+ * &#x590D;&#x7528;&#x8001;&#x7684;fiber</span>
<span class="hljs-addition">+ * @param {*} fiber &#x8001;fiber</span>
<span class="hljs-addition">+ * @param {*} pendingProps &#x65B0;&#x5C5E;&#x6027;</span>
<span class="hljs-addition">+ * @returns </span>
<span class="hljs-addition">+ */</span>
<span class="hljs-addition">+   function useFiber(fiber, pendingProps) {</span>
<span class="hljs-addition">+       //&#x6839;&#x636E;&#x8001;&#x7684;fiber&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber</span>
<span class="hljs-addition">+       return createWorkInProgress(fiber, pendingProps);</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   function reconcileSingleElement(returnFiber, currentFirstChild, element) {</span>
<span class="hljs-addition">+       //&#x65B0;jsx&#x5143;&#x7D20;&#x7684;key</span>
<span class="hljs-addition">+       const key = element.key;</span>
<span class="hljs-addition">+       //&#x7B2C;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+       let child = currentFirstChild;</span>
<span class="hljs-addition">+       //&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;&#x8001;&#x7684;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+       while (child) {</span>
<span class="hljs-addition">+           //&#x5148;&#x5224;&#x65AD;&#x4E24;&#x8005;&#x7684;key&#x662F;&#x76F8;&#x540C;</span>
<span class="hljs-addition">+           if (child.key === key) {</span>
<span class="hljs-addition">+               //&#x518D;&#x5224;&#x65AD;&#x7C7B;&#x578B;&#x662F;&#x5426;&#x76F8;&#x540C;,&#x5982;&#x679C;&#x76F8;&#x540C;</span>
<span class="hljs-addition">+               if (child.type === element.type) {</span>
<span class="hljs-addition">+                   //&#x5220;&#x9664;&#x5269;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x7684;&#x8001;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+                   deleteRemainingChildren(returnFiber, child.sibling);</span>
<span class="hljs-addition">+                   //&#x590D;&#x7528;&#x8FD9;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;,&#x5E76;&#x4F20;&#x9012;&#x65B0;&#x7684;&#x5C5E;&#x6027;</span>
<span class="hljs-addition">+                   const existing = useFiber(child, element.props);</span>
<span class="hljs-addition">+                   //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber</span>
<span class="hljs-addition">+                   existing.return = returnFiber;</span>
<span class="hljs-addition">+                   //&#x8FD4;&#x56DE;&#x590D;&#x7528;&#x7684;fiber</span>
<span class="hljs-addition">+                   return existing;</span>
<span class="hljs-addition">+               }else{</span>
<span class="hljs-addition">+                   //&#x5982;&#x679C;key&#x76F8;&#x540C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4E0D;&#x518D;&#x8FDB;&#x884C;&#x540E;&#x7EED;&#x5339;&#x914D;&#xFF0C;&#x8001;fiber&#x5168;&#x90E8;&#x5168;&#x90E8;&#x5220;&#x9664;</span>
<span class="hljs-addition">+                   deleteRemainingChildren(returnFiber, child);</span>
<span class="hljs-addition">+                   break;</span>
<span class="hljs-addition">+               }</span>
<span class="hljs-addition">+           } else {</span>
<span class="hljs-addition">+               //&#x5982;&#x679C;key&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5219;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;&#xFF0C;&#x7EE7;&#x7EED;&#x5339;&#x914D;&#x5F1F;&#x5F1F;</span>
<span class="hljs-addition">+               deleteChild(returnFiber, child);</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+           //&#x627E;&#x5F1F;&#x5F1F;&#x7EE7;&#x7EED;&#x5339;&#x914D;</span>
<span class="hljs-addition">+           child = child.sibling;</span>
<span class="hljs-addition">+       }</span>
        //&#x6839;&#x636E;&#x865A;&#x62DF;DOM&#x521B;&#x5EFA;fiber&#x8282;&#x70B9;
        const created = createFiberFromElement(element);
        //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
        created.return = returnFiber;
        return created;
    }
    function reconcileChildFibers(returnFiber, currentFirstChild, newChild) {
        const isObject = typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; (newChild);</span>
        if (isObject) {
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE:
                    return placeSingleChild(
                        reconcileSingleElement(returnFiber, currentFirstChild, newChild)
                    );
                default:
                    break;
            }
        }
    }
    return reconcileChildFibers;
}

export const reconcileChildFibers = ChildReconciler(true);
export const mountChildFibers = ChildReconciler(false);
</code></pre>
<h3 id="t525.10 ReactDOMHostConfig.js">5.10 ReactDOMHostConfig.js <a href="#t525.10 ReactDOMHostConfig.js"> # </a></h3>
<p>src\ReactDOMHostConfig.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { createElement, setInitialProperties, diffProperties } from &apos;./ReactDOMComponent&apos;</span>
export function shouldSetTextContent(type, props) {
    return (
        typeof props.children <span class="hljs-comment">=== &apos;string&apos; ||</span>
        typeof props.children <span class="hljs-comment">=== &apos;number&apos;</span>
    );
}
export function createInstance(type) {
    return createElement(type);
}
export function finalizeInitialChildren(domElement, type, props) {
    setInitialProperties(domElement, type, props);
}
<span class="hljs-addition">+export function prepareUpdate(domElement, type, oldProps, newProps) {</span>
<span class="hljs-addition">+    return diffProperties(</span>
<span class="hljs-addition">+        domElement,</span>
<span class="hljs-addition">+        type,</span>
<span class="hljs-addition">+        oldProps,</span>
<span class="hljs-addition">+        newProps</span>
<span class="hljs-addition">+    );</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+export function removeChild(parentInstance, child) {</span>
<span class="hljs-addition">+  parentInstance.removeChild(child);</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t535.11 ReactFiberCompleteWork.js">5.11 ReactFiberCompleteWork.js <a href="#t535.11 ReactFiberCompleteWork.js"> # </a></h3>
<p>src\ReactFiberCompleteWork.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { createInstance, finalizeInitialChildren, prepareUpdate } from &apos;./ReactDOMHostConfig&apos;;</span>
import { HostComponent } from &apos;./ReactWorkTags&apos;;
<span class="hljs-addition">+import { Update } from &apos;./ReactFiberFlags&apos;;</span>
export function completeWork(current, workInProgress) {
    const newProps = workInProgress.pendingProps;
    switch (workInProgress.tag) {
        case HostComponent: {
            if (current &amp;&amp; workInProgress.stateNode) {
<span class="hljs-addition">+               updateHostComponent(current, workInProgress, workInProgress.tag, newProps);</span>
            } else {
                const type = workInProgress.type;
                const instance = createInstance(type, newProps);
                workInProgress.stateNode = instance;
                finalizeInitialChildren(instance, type, newProps);
            }
            break;
        }
        default:
            break;
    }
}
<span class="hljs-addition">+/**</span>
<span class="hljs-addition">+ * &#x66F4;&#x65B0;&#x539F;&#x751F;DOM&#x7EC4;&#x4EF6;</span>
<span class="hljs-addition">+ * @param {*} current &#x8001;fiber</span>
<span class="hljs-addition">+ * @param {*} workInProgress &#x65B0;fiber</span>
<span class="hljs-addition">+ * @param {*} type &#x7C7B;&#x578B;</span>
<span class="hljs-addition">+ * @param {*} newProps  &#x65B0;&#x5C5E;&#x6027;</span>
<span class="hljs-addition">+ */</span>
<span class="hljs-addition">+function updateHostComponent(current, workInProgress, type, newProps) {</span>
<span class="hljs-addition">+    //&#x5982;&#x679C;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x4E2A;&#x66FF;&#x4EE3;&#x65B9;&#x6848;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x66F4;&#x65B0;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B89;&#x6392;&#x4E00;&#x4E2A;&#x526F;&#x4F5C;&#x7528;&#x6765;&#x8FDB;&#x884C;&#x66F4;&#x65B0;</span>
<span class="hljs-addition">+    const oldProps = current.memoizedProps;</span>
<span class="hljs-addition">+    const instance = workInProgress.stateNode;</span>
<span class="hljs-addition">+    //&#x5982;&#x679C;&#x6211;&#x4EEC;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x4E00;&#x4E2A;&#x5B69;&#x5B50;&#x66F4;&#x65B0;&#x800C;&#x5F97;&#x5230;&#x66F4;&#x65B0;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x4F1A;&#x6709; newProps &#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x91CD;&#x7528;&#x5B83;&#x4EEC;&#x3002;</span>
<span class="hljs-addition">+    const updatePayload = prepareUpdate(instance, type, oldProps, newProps);</span>
<span class="hljs-addition">+    workInProgress.updateQueue = updatePayload;</span>
<span class="hljs-addition">+    if (updatePayload) {</span>
<span class="hljs-addition">+        markUpdate(workInProgress);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function markUpdate(workInProgress) {</span>
<span class="hljs-addition">+    //&#x7528;&#x66F4;&#x65B0;&#x6548;&#x679C;&#x6807;&#x8BB0;fiber&#x3002; &#x8FD9;&#x4F1A;&#x5C06; Placement &#x8F6C;&#x6362;&#x4E3A; PlacementAndUpdate&#x3002;</span>
<span class="hljs-addition">+    workInProgress.flags |= Update;</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h2 id="t546.&#x5355;&#x8282;&#x70B9;key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C;">6.&#x5355;&#x8282;&#x70B9;key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C; <a href="#t546.&#x5355;&#x8282;&#x70B9;key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C;"> # </a></h2>
<ul>
<li>&#x5355;&#x8282;&#x70B9;key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x76F8;&#x540C;&#xFF0C;&#x5220;&#x9664;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x6DFB;&#x52A0;&#x65B0;&#x8282;&#x70B9;</li>
</ul>
<h3 id="t556.1 public\index.html">6.1 public\index.html <a href="#t556.1 public\index.html"> # </a></h3>
<p>public\index.html</p>
<pre><code class="lang-diff">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
    &lt;meta name=&quot;theme-color&quot; content=&quot;#000000&quot; /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
   &lt;div&gt;
     &lt;button id=&quot;single2&quot;&gt;2.key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x4E0D;&#x540C;&lt;/button&gt;&lt;br/&gt;
     &amp;lt;div key=&amp;quot;title&amp;quot; id=&amp;quot;title&amp;quot;&amp;gt;&lt;br/&gt;
        &amp;nbsp;&amp;nbsp;div&lt;br/&gt;
     &amp;lt;/div&amp;gt;&lt;br/&gt;
     &lt;button id=&quot;single2Update&quot;&gt;&#x5220;&#x9664;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x6DFB;&#x52A0;&#x65B0;&#x8282;&#x70B9;&lt;/button&gt;&lt;br/&gt;
     &amp;lt;p key=&amp;quot;title&amp;quot; id=&amp;quot;title&amp;quot;&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;p&lt;br/&gt;
     &amp;lt;/p&amp;gt;&lt;br/&gt;
   &lt;/div&gt;
   &lt;hr/&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="t566.2 src\index.js">6.2 src\index.js <a href="#t566.2 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-diff">import React from &apos;./react&apos;;
import ReactDOM from &apos;./react-dom&apos;;
//2.key&#x76F8;&#x540C;,&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x5220;&#x9664;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x6DFB;&#x52A0;&#x65B0;&#x8282;&#x70B9;
single2.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;div key=&quot;title&quot; id=&quot;title&quot;&gt;title&lt;/div&gt;
  );
  ReactDOM.render(element, root);
});
single2Update.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;p key=&quot;title&quot; id=&quot;title&quot;&gt;title&lt;/p&gt;
  );
  ReactDOM.render(element, root);
});
</code></pre>
<h2 id="t577.&#x5355;&#x8282;&#x70B9;&#x7C7B;&#x578B;&#x76F8;&#x540C;,key&#x4E0D;&#x540C;">7.&#x5355;&#x8282;&#x70B9;&#x7C7B;&#x578B;&#x76F8;&#x540C;,key&#x4E0D;&#x540C; <a href="#t577.&#x5355;&#x8282;&#x70B9;&#x7C7B;&#x578B;&#x76F8;&#x540C;,key&#x4E0D;&#x540C;"> # </a></h2>
<ul>
<li>3.&#x7C7B;&#x578B;&#x76F8;&#x540C;,key&#x4E0D;&#x540C;,&#x5220;&#x9664;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x6DFB;&#x52A0;&#x65B0;&#x8282;&#x70B9;</li>
</ul>
<h3 id="t587.1 public\index.html">7.1 public\index.html <a href="#t587.1 public\index.html"> # </a></h3>
<pre><code class="lang-diff">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
    &lt;meta name=&quot;theme-color&quot; content=&quot;#000000&quot; /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
   &lt;div&gt;
     &lt;button id=&quot;single3&quot;&gt;3.&#x7C7B;&#x578B;&#x76F8;&#x540C;,key&#x4E0D;&#x540C;&lt;/button&gt;&lt;br/&gt;
     &amp;lt;div key=&amp;quot;title1&amp;quot; id=&amp;quot;title&amp;quot;&amp;gt;&lt;br/&gt;
      &amp;nbsp;&amp;nbsp;title&lt;br/&gt;
     &amp;lt;/div&amp;gt;&lt;br/&gt;
     &lt;button id=&quot;single3Update&quot;&gt;&#x5220;&#x9664;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x6DFB;&#x52A0;&#x65B0;&#x8282;&#x70B9;&lt;/button&gt;&lt;br/&gt;
     &amp;lt;div key=&amp;quot;title2&amp;quot; id=&amp;quot;title&amp;quot;&amp;gt;&lt;br/&gt;
      &amp;nbsp;&amp;nbsp;title&lt;br/&gt;
     &amp;lt;/div&amp;gt;&lt;br/&gt;
   &lt;/div&gt;
   &lt;hr/&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="t597.2 src\index.js">7.2 src\index.js <a href="#t597.2 src\index.js"> # </a></h3>
<pre><code class="lang-diff">import React from &apos;./react&apos;;
import ReactDOM from &apos;./react-dom&apos;;
//3.&#x7C7B;&#x578B;&#x76F8;&#x540C;,key&#x4E0D;&#x540C;,&#x5220;&#x9664;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x6DFB;&#x52A0;&#x65B0;&#x8282;&#x70B9;
single3.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;div key=&quot;title1&quot; id=&quot;title&quot;&gt;title&lt;/div&gt;
  );
  ReactDOM.render(element, root);
});
single3Update.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;div key=&quot;title2&quot; id=&quot;title&quot;&gt;title&lt;/div&gt;
  );
  ReactDOM.render(element, root);
});
</code></pre>
<h2 id="t608.&#x539F;&#x6765;&#x591A;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x73B0;&#x5728;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x8282;&#x70B9;">8.&#x539F;&#x6765;&#x591A;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x73B0;&#x5728;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x8282;&#x70B9; <a href="#t608.&#x539F;&#x6765;&#x591A;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x73B0;&#x5728;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x8282;&#x70B9;"> # </a></h2>
<ul>
<li>&#x539F;&#x6765;&#x591A;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x73B0;&#x5728;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x8282;&#x70B9;,&#x5220;&#x9664;&#x591A;&#x4F59;&#x8282;&#x70B9;</li>
<li><a href="https://www.processon.com/diagraming/618fe7621e0853689b0d6159">fiber&#x7ED3;&#x6784;</a></li>
</ul>
<p><img src="https://static.zhufengpeixun.com/cong_render_dao_zhi_xing_gong_zuo_xun_huan_de_fiber_jia_gou_6_1636821326045.jpg" alt></p>
<h3 id="t618.1 public\index.html">8.1 public\index.html <a href="#t618.1 public\index.html"> # </a></h3>
<pre><code class="lang-diff">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
    &lt;meta name=&quot;theme-color&quot; content=&quot;#000000&quot; /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
   &lt;div&gt;
     &lt;button id=&quot;single4&quot;&gt;4.&#x539F;&#x6765;&#x591A;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x73B0;&#x5728;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&lt;/button&gt;&lt;br/&gt;
     &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;B&amp;quot;&amp;gt;B&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;C&amp;quot;&amp;gt;C&amp;lt;/li&amp;gt;&lt;br/&gt;
      &amp;lt;/ul&amp;gt;&lt;br/&gt;
     &lt;button id=&quot;single4Update&quot;&gt;&#x4FDD;&#x7559;&#x5E76;&#x66F4;&#x65B0;&#x8FD9;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x5220;&#x9664;&#x5176;&#x5B83;&#x8282;&#x70B9;&lt;/button&gt;&lt;br/&gt;
     &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;B2&amp;quot;&amp;gt;B2&amp;lt;/li&amp;gt;&lt;br/&gt;
     &amp;lt;/ul&amp;gt;&lt;br/&gt;
    &lt;/div&gt;
    &lt;hr/&gt;
    &lt;hr /&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="t628.2 src\index.js">8.2 src\index.js <a href="#t628.2 src\index.js"> # </a></h3>
<pre><code class="lang-diff">import React from &apos;./react&apos;;
import ReactDOM from &apos;./react-dom&apos;;
//4.&#x539F;&#x6765;&#x591A;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x73B0;&#x5728;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x8282;&#x70B9;,&#x5220;&#x9664;&#x591A;&#x4F59;&#x8282;&#x70B9;
single4.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;li key=&quot;B&quot; id=&quot;B&quot;&gt;B&lt;/li&gt;
      &lt;li key=&quot;C&quot;&gt;C&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
single4Update.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;B&quot; id=&quot;B2&quot;&gt;B2&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
</code></pre>
<h3 id="t638.3 ReactChildFiber.js">8.3 ReactChildFiber.js <a href="#t638.3 ReactChildFiber.js"> # </a></h3>
<p>src\ReactChildFiber.js</p>
<pre><code class="lang-diff">import { Placement, Deletion } from &apos;./ReactFiberFlags&apos;;
import { createFiberFromElement, createWorkInProgress } from &apos;./ReactFiber&apos;;
import { REACT_ELEMENT_TYPE } from &apos;./ReactSymbols&apos;;
function ChildReconciler(shouldTrackSideEffects) {
    function placeSingleChild(newFiber) {
        //&#x5982;&#x679C;&#x8981;&#x8DDF;&#x8E2A;&#x526F;&#x4F5C;&#x7528;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x8001;&#x7684;fiber&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x65B0;&#x5EFA;
        if (shouldTrackSideEffects &amp;&amp; !newFiber.alternate) {
            newFiber.flags = Placement;
        }
        return newFiber;
    }
    function deleteChild(returnFiber, childToDelete) {
        if (!shouldTrackSideEffects) {
            return;
        }
        //&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x7236;&#x4EB2;&#x5F85;&#x5220;&#x9664;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E2D;
        const last = returnFiber.lastEffect;
        if (last) {//&#x5982;&#x679C;&#x7236;&#x4EB2;&#x6709;&#x5C3E;&#x90E8;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x5C3E;&#x90E8;&#x7684;nextEffect&#x4E0A;
            last.nextEffect = childToDelete;
            //&#x7136;&#x540E;&#x8BA9;&#x7236;&#x4EB2;&#x7684;&#x5C3E;&#x90E8;&#x7B49;&#x4E8E;&#x81EA;&#x5DF1;
            returnFiber.lastEffect = childToDelete;
        } else {
            //&#x5982;&#x679C;&#x7236;&#x4EB2;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;&#xFF0C;&#x5934;&#x548C;&#x5C3E;&#x5411;childToDelete
            returnFiber.firstEffect = returnFiber.lastEffect = childToDelete;
        }
        //&#x6E05;&#x7A7A;&#x5B83;&#x7684;nextEffect
        childToDelete.nextEffect = null;
        //&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;
        childToDelete.flags = Deletion;
    }
    function deleteRemainingChildren(returnFiber, currentFirstChild) {
        let childToDelete = currentFirstChild;
        while (childToDelete) {
            deleteChild(returnFiber, childToDelete);
            childToDelete = childToDelete.sibling;
        }
        return null;
    }
    /**
  * &#x590D;&#x7528;&#x8001;&#x7684;fiber
  * @param {*} fiber &#x8001;fiber
  * @param {*} pendingProps &#x65B0;&#x5C5E;&#x6027;
  * @returns 
  */
    function useFiber(fiber, pendingProps) {
        //&#x6839;&#x636E;&#x8001;&#x7684;fiber&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber
        return createWorkInProgress(fiber, pendingProps);
    }
    /**
     * &#x5355;&#x8282;&#x70B9;DIFF
     * @param {*} returnFiber &#x5F53;&#x524D;&#x7236;&#x4EB2;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;&#x8282;fiber
     * @param {*} element JSX&#x865A;&#x62DF;DOM
     * @returns 
     */
    function reconcileSingleElement(returnFiber, currentFirstChild, element) {
        //&#x65B0;jsx&#x5143;&#x7D20;&#x7684;key
        const key = element.key;
        //&#x7B2C;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        let child = currentFirstChild;
        //&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        while (child) {
            //&#x5148;&#x5224;&#x65AD;&#x4E24;&#x8005;&#x7684;key&#x662F;&#x76F8;&#x540C;
            if (child.key <span class="hljs-comment">=== key) {</span>
                //&#x518D;&#x5224;&#x65AD;&#x7C7B;&#x578B;&#x662F;&#x5426;&#x76F8;&#x540C;,&#x5982;&#x679C;&#x76F8;&#x540C;
                if (child.type <span class="hljs-comment">=== element.type) {</span>
                    //&#x5220;&#x9664;&#x5269;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x7684;&#x8001;fiber&#x8282;&#x70B9;
                    deleteRemainingChildren(returnFiber, child.sibling);
                    //&#x590D;&#x7528;&#x8FD9;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;,&#x5E76;&#x4F20;&#x9012;&#x65B0;&#x7684;&#x5C5E;&#x6027;
                    const existing = useFiber(child, element.props);
                    //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
                    existing.return = returnFiber;
                    //&#x8FD4;&#x56DE;&#x590D;&#x7528;&#x7684;fiber
                    return existing;
                } else {
                    //&#x5982;&#x679C;key&#x76F8;&#x540C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4E0D;&#x518D;&#x8FDB;&#x884C;&#x540E;&#x7EED;&#x5339;&#x914D;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x5168;&#x90E8;&#x5220;&#x9664;
                    deleteRemainingChildren(returnFiber, child);
                    break;
                }
            } else {
                //&#x5982;&#x679C;key&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5219;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;&#xFF0C;&#x7EE7;&#x7EED;&#x5339;&#x914D;&#x5F1F;&#x5F1F;
                deleteChild(returnFiber, child);
            }
            //&#x627E;&#x5F1F;&#x5F1F;&#x7EE7;&#x7EED;&#x5339;&#x914D;
            child = child.sibling;
        }
        //&#x6839;&#x636E;&#x865A;&#x62DF;DOM&#x521B;&#x5EFA;fiber&#x8282;&#x70B9;
        const created = createFiberFromElement(element);
        //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
        created.return = returnFiber;
        return created;
    }
<span class="hljs-addition">+   function createChild(returnFiber, newChild) {</span>
<span class="hljs-addition">+       if (typeof newChild === &apos;object&apos; &amp;&amp; newChild) {</span>
<span class="hljs-addition">+           switch (newChild.$$typeof) {</span>
<span class="hljs-addition">+               case REACT_ELEMENT_TYPE: {</span>
<span class="hljs-addition">+                   const created = createFiberFromElement(newChild);</span>
<span class="hljs-addition">+                   created.return = returnFiber;</span>
<span class="hljs-addition">+                   return created;</span>
<span class="hljs-addition">+               }</span>
<span class="hljs-addition">+               default:</span>
<span class="hljs-addition">+                   break;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   /**</span>
<span class="hljs-addition">+    * &#x534F;&#x8C03;&#x5B50;&#x8282;&#x70B9;</span>
<span class="hljs-addition">+    * @param {*} returnFiber &#x7236;fiber</span>
<span class="hljs-addition">+    * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;fiber</span>
<span class="hljs-addition">+    * @param {*} newChildren JSX&#x5BF9;&#x8C61;</span>
<span class="hljs-addition">+    * @returns </span>
<span class="hljs-addition">+    */</span>
<span class="hljs-addition">+   function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren) {</span>
<span class="hljs-addition">+       //&#x8BE5;&#x7B97;&#x6CD5;&#x65E0;&#x6CD5;&#x901A;&#x8FC7;&#x4E24;&#x7AEF;&#x641C;&#x7D22;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x56E0;&#x4E3A;fiber&#x4E0A;&#x6CA1;&#x6709;&#x53CD;&#x5411;&#x6307;&#x9488;</span>
<span class="hljs-addition">+       //&#x6211;&#x5728;&#x8BD5;&#x7740;&#x770B;&#x770B;&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x8FD9;&#x4E2A;&#x6A21;&#x578B;&#x8D70;&#x591A;&#x8FDC;&#x3002;&#x5982;&#x679C;&#x5B83;&#x6700;&#x7EC8;&#x4E0D;&#x503C;&#x5F97;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7A0D;&#x540E;&#x6DFB;&#x52A0;&#x5B83;</span>
<span class="hljs-addition">+       //&#x8FD4;&#x56DE;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;fiber&#x5B50;&#x8282;&#x70B9;</span>
<span class="hljs-addition">+       let resultingFirstChild = null;</span>
<span class="hljs-addition">+       //&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;&#x7684;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+       let previousNewFiber = null;</span>
<span class="hljs-addition">+       //&#x6BD4;&#x8F83;&#x4E2D;&#x7684;&#x65E7;&#x7684;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+       let oldFiber = currentFirstChild;</span>
<span class="hljs-addition">+       //&#x65B0;&#x7684;&#x7D22;&#x5F15;</span>
<span class="hljs-addition">+       let newIdx = 0;</span>
<span class="hljs-addition">+       //&#x5982;&#x679C;&#x8001;fiber&#x5B8C;&#x6210;&#xFF0C;&#x65B0;&#x7684;JSX&#x6CA1;&#x6709;&#x5B8C;&#x6210;</span>
<span class="hljs-addition">+       if (!oldFiber) {</span>
<span class="hljs-addition">+           for (; newIdx &lt; newChildren.length; newIdx++) {</span>
<span class="hljs-addition">+               const newFiber = createChild(returnFiber, newChildren[newIdx]);</span>
<span class="hljs-addition">+               if (!previousNewFiber) {</span>
<span class="hljs-addition">+                   resultingFirstChild = newFiber;</span>
<span class="hljs-addition">+               } else {</span>
<span class="hljs-addition">+                   previousNewFiber.sibling = newFiber;</span>
<span class="hljs-addition">+               }</span>
<span class="hljs-addition">+               previousNewFiber = newFiber;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+           return resultingFirstChild;</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       return resultingFirstChild;</span>
<span class="hljs-addition">+   }</span>
    function reconcileChildFibers(returnFiber, currentFirstChild, newChild) {
        const isObject = typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; (newChild);</span>
        if (isObject) {
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE:
                    return placeSingleChild(
                        reconcileSingleElement(returnFiber, currentFirstChild, newChild)
                    );
                default:
                    break;
            }
        }
<span class="hljs-addition">+       if (Array.isArray(newChild)) {</span>
<span class="hljs-addition">+           return reconcileChildrenArray(returnFiber, currentFirstChild, newChild);</span>
<span class="hljs-addition">+       }</span>
    }
    return reconcileChildFibers;
}

export const reconcileChildFibers = ChildReconciler(true);
export const mountChildFibers = ChildReconciler(false);
</code></pre>
<h3 id="t648.4 src\ReactFiberCompleteWork.js">8.4 src\ReactFiberCompleteWork.js <a href="#t648.4 src\ReactFiberCompleteWork.js"> # </a></h3>
<p>src\ReactFiberCompleteWork.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { createInstance, finalizeInitialChildren, prepareUpdate, appendInitialChild } from &apos;./ReactDOMHostConfig&apos;;</span>
import { HostComponent } from &apos;./ReactWorkTags&apos;;
import { Update } from &apos;./ReactFiberFlags&apos;;
export function completeWork(current, workInProgress) {
    const newProps = workInProgress.pendingProps;
    switch (workInProgress.tag) {
        case HostComponent: {
            if (current &amp;&amp; workInProgress.stateNode) {
                updateHostComponent(current, workInProgress, workInProgress.tag, newProps);
            } else {
                const type = workInProgress.type;
                const instance = createInstance(type, newProps);
<span class="hljs-addition">+               appendAllChildren(instance, workInProgress);</span>
                workInProgress.stateNode = instance;
                finalizeInitialChildren(instance, type, newProps);
            }
            break;
        }
        default:
            break;
    }
}
/**
 * &#x66F4;&#x65B0;&#x539F;&#x751F;DOM&#x7EC4;&#x4EF6;
 * @param {*} current &#x8001;fiber
 * @param {*} workInProgress &#x65B0;fiber
 * @param {*} type &#x7C7B;&#x578B;
 * @param {*} newProps  &#x65B0;&#x5C5E;&#x6027;
 */
function updateHostComponent(current, workInProgress, type, newProps) {
    //&#x5982;&#x679C;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x4E2A;&#x66FF;&#x4EE3;&#x65B9;&#x6848;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x66F4;&#x65B0;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B89;&#x6392;&#x4E00;&#x4E2A;&#x526F;&#x4F5C;&#x7528;&#x6765;&#x8FDB;&#x884C;&#x66F4;&#x65B0;
    const oldProps = current.memoizedProps;
    const instance = workInProgress.stateNode;
    //&#x5982;&#x679C;&#x6211;&#x4EEC;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x4E00;&#x4E2A;&#x5B69;&#x5B50;&#x66F4;&#x65B0;&#x800C;&#x5F97;&#x5230;&#x66F4;&#x65B0;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x4F1A;&#x6709; newProps &#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x91CD;&#x7528;&#x5B83;&#x4EEC;&#x3002;
    const updatePayload = prepareUpdate(instance, type, oldProps, newProps);
    workInProgress.updateQueue = updatePayload;
    if (updatePayload) {
        markUpdate(workInProgress);
    }
}
function markUpdate(workInProgress) {
    //&#x7528;&#x66F4;&#x65B0;&#x6548;&#x679C;&#x6807;&#x8BB0;fiber&#x3002; &#x8FD9;&#x4F1A;&#x5C06; Placement &#x8F6C;&#x6362;&#x4E3A; PlacementAndUpdate&#x3002;
    workInProgress.flags |= Update;
}
<span class="hljs-addition">+function appendAllChildren(parent, workInProgress) {</span>
<span class="hljs-addition">+    let node = workInProgress.child;</span>
<span class="hljs-addition">+    //&#x6211;&#x4EEC;&#x53EA;&#x6709;&#x521B;&#x5EFA;&#x7684;&#x9876;&#x5C42; Fiber&#xFF0C;&#x4F46;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5411;&#x4E0B;&#x9012;&#x5F52;&#x5B83;&#x7684;&#x5B50;&#x8282;&#x70B9;&#x4EE5;&#x627E;&#x5230;&#x6240;&#x6709;&#x7EC8;&#x7AEF;&#x8282;&#x70B9;&#x3002;</span>
<span class="hljs-addition">+    while (node) {</span>
<span class="hljs-addition">+        if (node.tag === HostComponent) {</span>
<span class="hljs-addition">+            let instance = node.stateNode;</span>
<span class="hljs-addition">+            appendInitialChild(parent, instance);</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        if (node === workInProgress) {</span>
<span class="hljs-addition">+            return;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        while (!(node.sibling)) {</span>
<span class="hljs-addition">+            if (!(node.return) || node.return === workInProgress) {</span>
<span class="hljs-addition">+                return;</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+            node = node.return;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        node = node.sibling;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t658.5 ReactDOMHostConfig.js">8.5 ReactDOMHostConfig.js <a href="#t658.5 ReactDOMHostConfig.js"> # </a></h3>
<p>src\ReactDOMHostConfig.js</p>
<pre><code class="lang-diff">import { createElement, setInitialProperties, diffProperties } from &apos;./ReactDOMComponent&apos;
export function shouldSetTextContent(type, props) {
    return (
        typeof props.children <span class="hljs-comment">=== &apos;string&apos; ||</span>
        typeof props.children <span class="hljs-comment">=== &apos;number&apos;</span>
    );
}
export function createInstance(type) {
    return createElement(type);
}
export function finalizeInitialChildren(domElement, type, props) {
    setInitialProperties(domElement, type, props);
}
export function prepareUpdate(domElement, type, oldProps, newProps) {
    return diffProperties(
        domElement,
        type,
        oldProps,
        newProps
    );
}
export function appendChild(parentInstance, child) {
    parentInstance.appendChild(child);
}
export function insertBefore(parentInstance, child, beforeChild) {
    parentInstance.insertBefore(child, beforeChild);
}
<span class="hljs-addition">+export function appendInitialChild(parentInstance, child) {</span>
<span class="hljs-addition">+    parentInstance.appendChild(child);</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h2 id="t669.&#x591A;&#x8282;&#x70B9;DIFF">9.&#x591A;&#x8282;&#x70B9;DIFF <a href="#t669.&#x591A;&#x8282;&#x70B9;DIFF"> # </a></h2>
<ul>
<li>DOM DIFF&#x7684;&#x4E09;&#x4E2A;&#x89C4;&#x5219;<ul>
<li>&#x53EA;&#x5BF9;&#x540C;&#x7EA7;&#x5143;&#x7D20;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#xFF0C;&#x4E0D;&#x540C;&#x5C42;&#x7EA7;&#x4E0D;&#x5BF9;&#x6BD4;</li>
<li>&#x4E0D;&#x540C;&#x7684;&#x7C7B;&#x578B;&#x5BF9;&#x5E94;&#x4E0D;&#x540C;&#x7684;&#x5143;&#x7D20;</li>
<li>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;key&#x6765;&#x6807;&#x8BC6;&#x540C;&#x4E00;&#x4E2A;&#x8282;&#x70B9;</li>
</ul>
</li>
<li>&#x7B2C;1&#x8F6E;&#x904D;&#x5386;<ul>
<li>&#x5982;&#x679C;key&#x4E0D;&#x540C;&#x5219;&#x76F4;&#x63A5;&#x7ED3;&#x675F;&#x672C;&#x8F6E;&#x5FAA;&#x73AF;</li>
<li>newChildren&#x6216;oldFiber&#x904D;&#x5386;&#x5B8C;&#xFF0C;&#x7ED3;&#x675F;&#x672C;&#x8F6E;&#x5FAA;&#x73AF;</li>
<li>key&#x76F8;&#x540C;&#x800C;type&#x4E0D;&#x540C;&#xFF0C;&#x6807;&#x8BB0;&#x8001;&#x7684;oldFiber&#x4E3A;&#x5220;&#x9664;&#xFF0C;&#x7EE7;&#x7EED;&#x5FAA;&#x73AF;</li>
<li>key&#x76F8;&#x540C;&#x800C;type&#x4E5F;&#x76F8;&#x540C;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#x8001;&#x8282;oldFiber&#x8282;&#x70B9;&#xFF0C;&#x7EE7;&#x7EED;&#x5FAA;&#x73AF;</li>
</ul>
</li>
<li>&#x7B2C;2&#x8F6E;&#x904D;&#x5386;  <ul>
<li>newChildren&#x904D;&#x5386;&#x5B8C;&#x800C;oldFiber&#x8FD8;&#x6709;&#xFF0C;&#x904D;&#x5386;&#x5269;&#x4E0B;&#x6240;&#x6709;&#x7684;oldFiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;&#xFF0C;DIFF&#x7ED3;&#x675F;     </li>
<li>oldFiber&#x904D;&#x5386;&#x5B8C;&#x4E86;&#xFF0C;&#x800C;newChildren&#x8FD8;&#x6709;&#xFF0C;&#x5C06;&#x5269;&#x4E0B;&#x7684;newChildren&#x6807;&#x8BB0;&#x4E3A;&#x63D2;&#x5165;&#xFF0C;DIFF&#x7ED3;&#x675F;    </li>
<li>newChildren&#x548C;oldFiber&#x90FD;&#x540C;&#x65F6;&#x904D;&#x5386;&#x5B8C;&#x6210;&#xFF0C;diff&#x7ED3;&#x675F;</li>
<li>newChildren&#x548C;oldFiber&#x90FD;&#x6CA1;&#x6709;&#x5B8C;&#x6210;&#xFF0C;&#x5219;&#x8FDB;&#x884C;<code>&#x8282;&#x70B9;&#x79FB;&#x52A8;</code>&#x7684;&#x903B;&#x8F91;</li>
</ul>
</li>
<li>&#x7B2C;3&#x8F6E;&#x904D;&#x5386;  <ul>
<li>&#x5904;&#x7406;&#x8282;&#x70B9;&#x79FB;&#x52A8;&#x7684;&#x60C5;&#x51B5;</li>
</ul>
</li>
</ul>
<h2 id="t6710.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x6570;&#x91CF;&#x548C;key&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x7684;type&#x4E0D;&#x540C;">10.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x6570;&#x91CF;&#x548C;key&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x7684;type&#x4E0D;&#x540C; <a href="#t6710.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x6570;&#x91CF;&#x548C;key&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x7684;type&#x4E0D;&#x540C;"> # </a></h2>
<ul>
<li>&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x6570;&#x91CF;&#x548C;key&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x7684;type&#x4E0D;&#x540C;&#xFF0C;&#x5219;&#x66F4;&#x65B0;&#x5C5E;&#x6027;&#xFF0C;type&#x4E0D;&#x540C;&#x7684;&#x5220;&#x9664;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x5220;&#x9664;&#x65B0;&#x8282;&#x70B9;</li>
<li><a href="https://www.processon.com/diagraming/6190e63d5653bb36b39d05bf">fiber&#x56FE;</a></li>
<li><a href="https://www.processon.com/diagraming/619612845653bb30803edb4f">&#x6D41;&#x7A0B;&#x56FE;</a></li>
</ul>
<p><img src="https://static.zhufengpeixun.com/duo_jie_dian_diff_1637227736096.jpg" alt></p>
<p><img src="https://static.zhufengpeixun.com/cong_render_dao_zhi_xing_gong_zuo_xun_huan_de_fiber_jia_gou_7_1636886355938.png" alt></p>
<h3 id="t6810.1 public\index.html">10.1 public\index.html <a href="#t6810.1 public\index.html"> # </a></h3>
<p>public\index.html</p>
<pre><code class="lang-diff">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
    &lt;meta name=&quot;theme-color&quot; content=&quot;#000000&quot; /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
    &lt;div&gt;
      &lt;button id=&quot;multi1&quot;&gt;5.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x6570;&#x91CF;&#x548C;key&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x7684;type&#x4E0D;&#x540C;&lt;/button&gt;&lt;br/&gt;
       &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;B&amp;quot;&amp;gt;B&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;C&amp;quot;id=&amp;quot;C&amp;quot;&amp;gt;C&amp;lt;/li&amp;gt;&lt;br/&gt;
        &amp;lt;/ul&amp;gt;&lt;br/&gt;
      &lt;button id=&quot;multi1Update&quot;&gt;&#x66F4;&#x65B0;&#x5C5E;&#x6027;&#xFF0C;type&#x4E0D;&#x540C;&#x7684;&#x5220;&#x9664;&#x8001;&#x8282;&#x70B9;&#xFF0C;&#x5220;&#x9664;&#x65B0;&#x8282;&#x70B9;&lt;/button&gt;&lt;br/&gt;
       &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;p key=&amp;quot;B&amp;quot; id=&amp;quot;B2&amp;quot;&amp;gt;B2&amp;lt;/p&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;C&amp;quot; id=&amp;quot;C2&amp;quot; &amp;gt;C2&amp;lt;/li&amp;gt;&lt;br/&gt;
        &amp;lt;/ul&amp;gt;&lt;br/&gt;
    &lt;/div&gt;
     &lt;hr/&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="t6910.2 src\index.js">10.2 src\index.js <a href="#t6910.2 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-diff">import React from &apos;./react&apos;;
import ReactDOM from &apos;./react-dom&apos;;
//&#x591A;&#x8282;&#x70B9;diff
//5.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x6570;&#x91CF;&#x3001;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x53EA;&#x66F4;&#x65B0;&#x5C5E;&#x6027;
multi1.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;li key=&quot;B&quot; id=&quot;B&quot;&gt;B&lt;/li&gt;
      &lt;li key=&quot;C&quot; id=&quot;C&quot;&gt;C&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
multi1Update.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;p key=&quot;B&quot; id=&quot;B2&quot;&gt;B2&lt;/p&gt;
      &lt;li key=&quot;C&quot; id=&quot;C2&quot;&gt;C2&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
</code></pre>
<h3 id="t7010.3 src\ReactChildFiber.js">10.3 src\ReactChildFiber.js <a href="#t7010.3 src\ReactChildFiber.js"> # </a></h3>
<p>src\ReactChildFiber.js</p>
<pre><code class="lang-diff">import { Placement, Deletion } from &apos;./ReactFiberFlags&apos;;
import { createFiberFromElement, createWorkInProgress } from &apos;./ReactFiber&apos;;
import { REACT_ELEMENT_TYPE } from &apos;./ReactSymbols&apos;;
function ChildReconciler(shouldTrackSideEffects) {
    function placeSingleChild(newFiber) {
        //&#x5982;&#x679C;&#x8981;&#x8DDF;&#x8E2A;&#x526F;&#x4F5C;&#x7528;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x8001;&#x7684;fiber&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x65B0;&#x5EFA;
        if (shouldTrackSideEffects &amp;&amp; !newFiber.alternate) {
            newFiber.flags = Placement;
        }
        return newFiber;
    }
    function deleteChild(returnFiber, childToDelete) {
        if (!shouldTrackSideEffects) {
            return;
        }
        //&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x7236;&#x4EB2;&#x5F85;&#x5220;&#x9664;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E2D;
        const last = returnFiber.lastEffect;
        if (last) {//&#x5982;&#x679C;&#x7236;&#x4EB2;&#x6709;&#x5C3E;&#x90E8;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x5C3E;&#x90E8;&#x7684;nextEffect&#x4E0A;
            last.nextEffect = childToDelete;
            //&#x7136;&#x540E;&#x8BA9;&#x7236;&#x4EB2;&#x7684;&#x5C3E;&#x90E8;&#x7B49;&#x4E8E;&#x81EA;&#x5DF1;
            returnFiber.lastEffect = childToDelete;
        } else {
            //&#x5982;&#x679C;&#x7236;&#x4EB2;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;&#xFF0C;&#x5934;&#x548C;&#x5C3E;&#x5411;childToDelete
            returnFiber.firstEffect = returnFiber.lastEffect = childToDelete;
        }
        //&#x6E05;&#x7A7A;&#x5B83;&#x7684;nextEffect
        childToDelete.nextEffect = null;
        //&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;
        childToDelete.flags = Deletion;
    }
    function deleteRemainingChildren(returnFiber, currentFirstChild) {
        let childToDelete = currentFirstChild;
        while (childToDelete) {
            deleteChild(returnFiber, childToDelete);
            childToDelete = childToDelete.sibling;
        }
        return null;
    }
    /**
  * &#x590D;&#x7528;&#x8001;&#x7684;fiber
  * @param {*} fiber &#x8001;fiber
  * @param {*} pendingProps &#x65B0;&#x5C5E;&#x6027;
  * @returns 
  */
    function useFiber(fiber, pendingProps) {
        //&#x6839;&#x636E;&#x8001;&#x7684;fiber&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber
        return createWorkInProgress(fiber, pendingProps);
    }
    /**
     * &#x5355;&#x8282;&#x70B9;DIFF
     * @param {*} returnFiber &#x5F53;&#x524D;&#x7236;&#x4EB2;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;&#x8282;fiber
     * @param {*} element JSX&#x865A;&#x62DF;DOM
     * @returns 
     */
    function reconcileSingleElement(returnFiber, currentFirstChild, element) {
        //&#x65B0;jsx&#x5143;&#x7D20;&#x7684;key
        const key = element.key;
        //&#x7B2C;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        let child = currentFirstChild;
        //&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        while (child) {
            //&#x5148;&#x5224;&#x65AD;&#x4E24;&#x8005;&#x7684;key&#x662F;&#x76F8;&#x540C;
            if (child.key <span class="hljs-comment">=== key) {</span>
                //&#x518D;&#x5224;&#x65AD;&#x7C7B;&#x578B;&#x662F;&#x5426;&#x76F8;&#x540C;,&#x5982;&#x679C;&#x76F8;&#x540C;
                if (child.type <span class="hljs-comment">=== element.type) {</span>
                    //&#x5220;&#x9664;&#x5269;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x7684;&#x8001;fiber&#x8282;&#x70B9;
                    deleteRemainingChildren(returnFiber, child.sibling);
                    //&#x590D;&#x7528;&#x8FD9;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;,&#x5E76;&#x4F20;&#x9012;&#x65B0;&#x7684;&#x5C5E;&#x6027;
                    const existing = useFiber(child, element.props);
                    //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
                    existing.return = returnFiber;
                    //&#x8FD4;&#x56DE;&#x590D;&#x7528;&#x7684;fiber
                    return existing;
                } else {
                    //&#x5982;&#x679C;key&#x76F8;&#x540C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4E0D;&#x518D;&#x8FDB;&#x884C;&#x540E;&#x7EED;&#x5339;&#x914D;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x5168;&#x90E8;&#x5220;&#x9664;
                    deleteRemainingChildren(returnFiber, child);
                    break;
                }
            } else {
                //&#x5982;&#x679C;key&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5219;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;&#xFF0C;&#x7EE7;&#x7EED;&#x5339;&#x914D;&#x5F1F;&#x5F1F;
                deleteChild(returnFiber, child);
            }
            //&#x627E;&#x5F1F;&#x5F1F;&#x7EE7;&#x7EED;&#x5339;&#x914D;
            child = child.sibling;
        }
        //&#x6839;&#x636E;&#x865A;&#x62DF;DOM&#x521B;&#x5EFA;fiber&#x8282;&#x70B9;
        const created = createFiberFromElement(element);
        //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
        created.return = returnFiber;
        return created;
    }
    function createChild(returnFiber, newChild) {
        if (typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; newChild) {</span>
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE: {
                    const created = createFiberFromElement(newChild);
                    created.return = returnFiber;
                    return created;
                }
                default:
                    break;
            }
        }
    }
<span class="hljs-addition">+   /**</span>
<span class="hljs-addition">+    * &#x66F4;&#x65B0;&#x5143;&#x7D20;</span>
<span class="hljs-addition">+    * @param {*} returnFiber &#x7236;fiber</span>
<span class="hljs-addition">+    * @param {*} current &#x8001;&#x7684;&#x7684;&#x5B50;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+    * @param {*} element &#x65B0;&#x7684;JSX&#x8282;&#x70B9;</span>
<span class="hljs-addition">+    * @returns </span>
<span class="hljs-addition">+    */</span>
<span class="hljs-addition">+   function updateElement(returnFiber, current, element) {</span>
<span class="hljs-addition">+       //&#x5982;&#x679C;&#x8001;fiber&#x5B58;&#x5728;</span>
<span class="hljs-addition">+       if (current) {</span>
<span class="hljs-addition">+           //&#x800C;&#x4E14;&#x65B0;&#x8001;type&#x7C7B;&#x578B;&#x4E5F;&#x4E00;&#x6837;</span>
<span class="hljs-addition">+           if (current.type === element.type) {</span>
<span class="hljs-addition">+               //&#x590D;&#x7528;&#x8001;&#x7684;fiber</span>
<span class="hljs-addition">+               const existing = useFiber(current, element.props);</span>
<span class="hljs-addition">+               existing.return = returnFiber;</span>
<span class="hljs-addition">+               return existing;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       //&#x5982;&#x679C;&#x8001;fiber&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber</span>
<span class="hljs-addition">+       const created = createFiberFromElement(element);</span>
<span class="hljs-addition">+       created.return = returnFiber;</span>
<span class="hljs-addition">+       return created;</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   function updateSlot(returnFiber, oldFiber, newChild) {</span>
<span class="hljs-addition">+       //&#x83B7;&#x53D6;&#x8001;fiber&#x8282;&#x70B9;&#x7684;key</span>
<span class="hljs-addition">+       const key = oldFiber ? oldFiber.key : null;</span>
<span class="hljs-addition">+       //&#x5982;&#x679C;&#x65B0;&#x7684;JSX&#x5B50;&#x8282;&#x70B9;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;</span>
<span class="hljs-addition">+       if (typeof newChild === &apos;object&apos; &amp;&amp; newChild) {</span>
<span class="hljs-addition">+           //&#x5982;&#x679C;&#x65B0;&#x8001;key&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x5219;&#x8868;&#x793A;&#x627E;&#x5230;&#x4E86;&#x53EF;&#x590D;&#x7528;&#x7684;&#x8282;&#x70B9;</span>
<span class="hljs-addition">+           if (newChild.key === key) {</span>
<span class="hljs-addition">+               return updateElement(returnFiber, oldFiber, newChild);</span>
<span class="hljs-addition">+           } else {</span>
<span class="hljs-addition">+               //key&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x4E0D;&#x80FD;&#x590D;&#x7528;</span>
<span class="hljs-addition">+               return null;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+    function placeChild(newFiber, newIndex) {</span>
<span class="hljs-addition">+        newFiber.index = newIndex;</span>
<span class="hljs-addition">+        if (!shouldTrackSideEffects) {</span>
<span class="hljs-addition">+            return;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        const current = newFiber.alternate;</span>
<span class="hljs-addition">+        if (current) {</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        } else {</span>
<span class="hljs-addition">+            newFiber.flags = Placement;</span>
<span class="hljs-addition">+            return;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    }</span>
    /**
     * &#x534F;&#x8C03;&#x5B50;&#x8282;&#x70B9;
     * @param {*} returnFiber &#x7236;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;fiber
     * @param {*} newChildren JSX&#x5BF9;&#x8C61;
     * @returns 
     */
    function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren) {
        //&#x8BE5;&#x7B97;&#x6CD5;&#x65E0;&#x6CD5;&#x901A;&#x8FC7;&#x4E24;&#x7AEF;&#x641C;&#x7D22;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x56E0;&#x4E3A;fiber&#x4E0A;&#x6CA1;&#x6709;&#x53CD;&#x5411;&#x6307;&#x9488;
        //&#x6211;&#x5728;&#x8BD5;&#x7740;&#x770B;&#x770B;&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x8FD9;&#x4E2A;&#x6A21;&#x578B;&#x8D70;&#x591A;&#x8FDC;&#x3002;&#x5982;&#x679C;&#x5B83;&#x6700;&#x7EC8;&#x4E0D;&#x503C;&#x5F97;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7A0D;&#x540E;&#x6DFB;&#x52A0;&#x5B83;
        //&#x8FD4;&#x56DE;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;fiber&#x5B50;&#x8282;&#x70B9;
        let resultingFirstChild = null;
        //&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;&#x7684;fiber&#x8282;&#x70B9;
        let previousNewFiber = null;
        //&#x6BD4;&#x8F83;&#x4E2D;&#x7684;&#x65E7;&#x7684;fiber&#x8282;&#x70B9;
        let oldFiber = currentFirstChild;
<span class="hljs-addition">+       //&#x4E0B;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber</span>
<span class="hljs-addition">+       let nextOldFiber = null;</span>
        //&#x65B0;&#x7684;&#x7D22;&#x5F15;
        let newIdx = 0;
<span class="hljs-addition">+       //&#x5148;&#x5904;&#x7406;&#x8282;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x60C5;&#x51B5;</span>
<span class="hljs-addition">+       for (; oldFiber &amp;&amp; newIdx &lt; newChildren.length; newIdx++) {</span>
<span class="hljs-addition">+           //&#x5148;&#x7F13;&#x5B58;&#x4E0B;&#x4E0B;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;</span>
<span class="hljs-addition">+           nextOldFiber = oldFiber.sibling;</span>
<span class="hljs-addition">+           //&#x66F4;&#x65B0;&#x590D;&#x7528;&#x7684;&#x65B0;fiber</span>
<span class="hljs-addition">+           //&#x5224;&#x65AD;key&#x548C;type&#x662F;&#x5426;&#x76F8;&#x540C;&#xFF0C;&#x5982;&#x679C;&#x76F8;&#x540C;&#x8868;&#x793A;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF0C;newIdx++&#x540E;&#x548C;&#x4E0B;&#x4E00;&#x4E2A;oldFiber&#x6BD4;&#x8F83;</span>
<span class="hljs-addition">+           const newFiber = updateSlot(returnFiber, oldFiber, newChildren[newIdx]);</span>
<span class="hljs-addition">+           if (!newFiber) {</span>
<span class="hljs-addition">+               break;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+           //&#x5982;&#x679C;&#x7C7B;&#x578B;&#x76F8;&#x540C;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x91CD;&#x7528;&#x73B0;&#x6709;fiber&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x5220;&#x9664;&#x73B0;&#x6709;&#x5B50;&#x7EA7;fiber</span>
<span class="hljs-addition">+           if (oldFiber &amp;&amp; !(newFiber.alternate)) {</span>
<span class="hljs-addition">+               deleteChild(returnFiber, oldFiber);</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+           //&#x653E;&#x7F6E;&#x6B64;newFiber&#x5230;newIdx&#xFF0C;&#x5C31;&#x662F;&#x8BBE;&#x7F6E;newFiber&#x7684;index&#x7D22;&#x5F15;</span>
<span class="hljs-addition">+           placeChild(newFiber, newIdx);</span>
<span class="hljs-addition">+           //&#x5982;&#x679C;previousNewFiber&#x4E0D;&#x5B58;&#x5728;&#x8868;&#x793A;&#x8FD9;&#x662F;&#x7B2C;&#x4E00;&#x4E2A;fiber</span>
<span class="hljs-addition">+           if (!previousNewFiber) {</span>
<span class="hljs-addition">+               resultingFirstChild = newFiber;</span>
<span class="hljs-addition">+           } else {</span>
<span class="hljs-addition">+               //&#x5426;&#x5219;&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;fiber&#x7684;sibling&#x7B49;&#x4E8E;&#x8FD9;&#x4E2A;newFiber</span>
<span class="hljs-addition">+               previousNewFiber.sibling = newFiber;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+           //&#x8BA9;&#x5F53;&#x524D;&#x7684;newFiber&#x7B49;&#x4E8E;previousNewFiber</span>
<span class="hljs-addition">+           previousNewFiber = newFiber;</span>
<span class="hljs-addition">+           //&#x4E0B;&#x4E00;&#x4E2A;&#x8001;fiber</span>
<span class="hljs-addition">+           oldFiber = nextOldFiber;</span>
<span class="hljs-addition">+       }</span>
        //&#x5982;&#x679C;&#x8001;fiber&#x5B8C;&#x6210;&#xFF0C;&#x65B0;&#x7684;JSX&#x6CA1;&#x6709;&#x5B8C;&#x6210;
        if (!oldFiber) {
            for (; newIdx &lt; newChildren.length; newIdx++) {
                const newFiber = createChild(returnFiber, newChildren[newIdx]);
                if (!previousNewFiber) {
                    resultingFirstChild = newFiber;
                } else {
                    previousNewFiber.sibling = newFiber;
                }
                previousNewFiber = newFiber;
            }
            return resultingFirstChild;
        }
        return resultingFirstChild;
    }
    function reconcileChildFibers(returnFiber, currentFirstChild, newChild) {
        const isObject = typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; (newChild);</span>
        if (isObject) {
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE:
                    return placeSingleChild(
                        reconcileSingleElement(returnFiber, currentFirstChild, newChild)
                    );
                default:
                    break;
            }
        }
        if (Array.isArray(newChild)) {
            return reconcileChildrenArray(returnFiber, currentFirstChild, newChild);
        }
    }
    return reconcileChildFibers;
}

export const reconcileChildFibers = ChildReconciler(true);
export const mountChildFibers = ChildReconciler(false);
</code></pre>
<h3 id="t7110.4 src\ReactFiberWorkLoop.js">10.4 src\ReactFiberWorkLoop.js <a href="#t7110.4 src\ReactFiberWorkLoop.js"> # </a></h3>
<p>src\ReactFiberWorkLoop.js</p>
<pre><code class="lang-diff">import { HostRoot, HostComponent } from &apos;./ReactWorkTags&apos;;
import { createWorkInProgress } from &apos;./ReactFiber&apos;;
import { beginWork } from &apos;./ReactFiberBeginWork&apos;;
import { completeWork } from &apos;./ReactFiberCompleteWork&apos;;
import { Placement, Update, Deletion } from &apos;./ReactFiberFlags&apos;;
import { commitWork } from &apos;./ReactFiberCommitWork&apos;;
//&#x6B63;&#x5728;&#x8C03;&#x5EA6;&#x7684;fiberRoot&#x6839;&#x8282;&#x70B9;
let workInProgressRoot = null;
//&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;fiber&#x8282;&#x70B9;
let workInProgress = null;
//&#x6700;&#x5927;&#x66F4;&#x65B0;&#x6DF1;&#x5EA6;
const NESTED_UPDATE_LIMIT = 50;
let nestedUpdateCount = 0;
/**
 * &#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
 * @param {*} sourceFiber &#x66F4;&#x65B0;&#x6765;&#x6E90;fiber
 * @returns 
 */
function markUpdateLaneFromFiberToRoot(sourceFiber) {
    let node = sourceFiber;
    let parent = node.return;
    //&#x4E00;&#x76F4;&#x5411;&#x4E0A;&#x627E;&#x7236;&#x4EB2;&#xFF0C;&#x627E;&#x4E0D;&#x5230;&#x4E3A;&#x6B62;
    while (parent) {
        node = parent;
        parent = parent.return;
    }
    //&#x5982;&#x679C;&#x627E;&#x5230;&#x7684;&#x662F;HostRoot&#x5C31;&#x8FD4;&#x56DE;FiberRootNode,&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5BB9;&#x5668;div#root
    if (node.tag <span class="hljs-comment">=== HostRoot) {</span>
        return node.stateNode;
    }
}
/**
 * &#x5411;&#x4E0A;&#x67E5;&#x627E;&#x5230;&#x6839;&#x8282;&#x70B9;&#x5F00;&#x59CB;&#x8C03;&#x5EA6;&#x66F4;&#x65B0;
 * @param {*} fiber 
 */
export function scheduleUpdateOnFiber(fiber) {
    checkForNestedUpdates();
    //&#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
    const root = markUpdateLaneFromFiberToRoot(fiber);
    //&#x6267;&#x884C;HostRoot&#x4E0A;&#x7684;&#x66F4;&#x65B0;
    performSyncWorkOnRoot(root);
}
function checkForNestedUpdates() {
    if (++nestedUpdateCount &gt; NESTED_UPDATE_LIMIT) {
        throw new Error(&apos;Maximum update depth exceeded&apos;);
    }
}
/**
 * &#x5F00;&#x59CB;&#x6267;&#x884C;FiberRootNode&#x4E0A;&#x7684;&#x5DE5;&#x4F5C;
 * @param {*} root  FiberRootNode
 */
function performSyncWorkOnRoot(root) {
    //&#x5148;&#x8D4B;&#x503C;&#x7ED9;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x5DE5;&#x4F5C;&#x7684;FiberRootNode&#x6839;&#x8282;&#x70B9;
    workInProgressRoot = root;
    //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5904;&#x7406;&#x4E2D;&#x7684;fiber&#x8282;&#x70B9;
    workInProgress = createWorkInProgress(workInProgressRoot.current);
    workLoopSync();
    commitRoot();
}
function commitRoot(root) {
    //&#x6784;&#x5EFA;&#x6210;&#x529F;&#x7684;&#x65B0;&#x7684;fiber&#x6811;
    const finishedWork = workInProgressRoot.current.alternate;
    //&#x5F53;&#x524D;&#x5B8C;&#x6210;&#x7684;&#x6784;&#x5EFA;&#x5DE5;&#x4F5C;&#x7B49;&#x4E8E;finishedWork
    workInProgressRoot.finishedWork = finishedWork;
    commitMutationEffects(workInProgressRoot);
    nestedUpdateCount--;
}
function getFlag(flags) {
    switch (flags) {
        case Placement:
            return &apos;&#x6DFB;&#x52A0;&apos;;
        case Update:
            return &apos;&#x66F4;&#x65B0;&apos;;
        case Deletion:
            return &apos;&#x5220;&#x9664;&apos;;
    }
}
function commitMutationEffects(root) {
    const finishedWork = root.finishedWork;
    let nextEffect = finishedWork.firstEffect;
    let effectList = &apos;&apos;;
    while (nextEffect) {
        effectList += `(${getFlag(nextEffect.flags)}#${nextEffect.type}#${nextEffect.key})=&gt;`;
        const flags = nextEffect.flags;
        const current = nextEffect.alternate;
        if (flags <span class="hljs-comment">=== Placement) {</span>
            commitPlacement(nextEffect);
        } else if (flags <span class="hljs-comment">=== Update) {</span>
            commitWork(current, nextEffect);
        } else if (flags <span class="hljs-comment">=== Deletion) {</span>
            commitDeletion(nextEffect);
        }
        nextEffect = nextEffect.nextEffect;
    }
    effectList += &apos;null&apos;;
    console.log(effectList);
    root.current = finishedWork;
}
function commitDeletion(fiber) {
    if (!fiber) {
        return;
    }
    let parentStateNode = getParentStateNode(fiber);
    parentStateNode.removeChild(fiber.stateNode);
}
function workLoopSync() {
    while (workInProgress) {
        performUnitOfWork(workInProgress);
    }
}
/**
 * &#x6267;&#x884C;&#x5355;&#x4E2A;&#x5DE5;&#x4F5C;&#x5355;&#x5143;
 * @param {*} unitOfWork &#x5355;&#x4E2A;fiber
 */
function performUnitOfWork(unitOfWork) {
    //&#x83B7;&#x53D6;&#x5F53;&#x524D;fiber&#x7684;alternate
    const current = unitOfWork.alternate;
    //&#x5F00;&#x59CB;&#x6784;&#x5EFA;&#x6B64;fiber&#x7684;&#x5B50;fiter&#x94FE;&#x8868;
    let next = beginWork(current, unitOfWork);
    //&#x66F4;&#x65B0;&#x5C5E;&#x6027;
    unitOfWork.memoizedProps = unitOfWork.pendingProps;
    //&#x5982;&#x679C;&#x6709;&#x5B50;fiber&#xFF0C;&#x5C31;&#x7EE7;&#x7EED;&#x6267;&#x884C;
    if (next) {
        workInProgress = next;
    } else {
        //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5B50;fiber&#xFF0C;&#x5C31;&#x5B8C;&#x6210;&#x5F53;&#x524D;&#x7684;fiber
        completeUnitOfWork(unitOfWork);
    }
}

function completeUnitOfWork(unitOfWork) {
    //&#x5C1D;&#x8BD5;&#x5B8C;&#x6210;&#x5F53;&#x524D;&#x7684;&#x5DE5;&#x4F5C;&#x5355;&#x5143;&#xFF0C;&#x7136;&#x540E;&#x79FB;&#x52A8;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x5F1F;&#x5F1F;
    //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4E0B;&#x4E00;&#x4E2A;&#x5F1F;&#x5F1F;&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x7236;Fiber
    let completedWork = unitOfWork;
    do {
        const current = completedWork.alternate;
        const returnFiber = completedWork.return;
        completeWork(current, completedWork);
        collectEffectList(returnFiber, completedWork)
        const siblingFiber = completedWork.sibling;
        if (siblingFiber) {
            //&#x5982;&#x679C;&#x6B64; returnFiber &#x4E2D;&#x8FD8;&#x6709;&#x66F4;&#x591A;&#x5DE5;&#x4F5C;&#x8981;&#x505A;&#xFF0C;&#x8BF7;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x6B65;
            workInProgress = siblingFiber;
            return;
        }
        //&#x5426;&#x5219;&#xFF0C;&#x8FD4;&#x56DE;&#x7236;&#x7EA7;
        completedWork = returnFiber;
        //&#x66F4;&#x65B0;&#x6211;&#x4EEC;&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;&#x4E0B;&#x4E00;&#x4EF6;&#x4E8B;
        workInProgress = completedWork;
    } while (completedWork);
}
function collectEffectList(returnFiber, completedWork) {
    if (returnFiber) {
        if (!returnFiber.firstEffect) {
            returnFiber.firstEffect = completedWork.firstEffect;
        }
        if (completedWork.lastEffect) {
            if (returnFiber.lastEffect) {
                returnFiber.lastEffect.nextEffect = completedWork.firstEffect;
            }
            returnFiber.lastEffect = completedWork.lastEffect;
        }
        //&#x5982;&#x679C;&#x8FD9;&#x4E2A;fiber&#x6709;&#x526F;&#x4F5C;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x5B69;&#x5B50;&#x4EEC;&#x7684;&#x526F;&#x4F7F;&#x7528;&#x540E;&#x9762;&#x6DFB;&#x52A0;&#x5B83;&#x81EA;&#x5DF1;&#x7684;&#x526F;&#x4F5C;&#x7528;
        const flags = completedWork.flags;
        if (flags) {
            if (returnFiber.lastEffect) {
                returnFiber.lastEffect.nextEffect = completedWork;
            } else {
                returnFiber.firstEffect = completedWork;
            }
            returnFiber.lastEffect = completedWork;
        }
    }
}
</code></pre>
<h3 id="t7210.5 ReactFiberCommitWork.js">10.5 ReactFiberCommitWork.js <a href="#t7210.5 ReactFiberCommitWork.js"> # </a></h3>
<p>src\ReactFiberCommitWork.js</p>
<pre><code class="lang-diff">import { updateProperties } from &apos;./ReactDOMComponent&apos;;
import { HostComponent, HostRoot } from &apos;./ReactWorkTags&apos;;
import { appendChild, insertBefore } from &apos;./ReactDOMHostConfig&apos;;
import { Placement } from &apos;./ReactFiberFlags&apos;;
/**
 * &#x66F4;&#x65B0;DOM&#x8282;&#x70B9;&#x7684;&#x5C5E;&#x6027;
 * @param {*} current 
 * @param {*} finishedWork 
 */
export function commitWork(current, finishedWork) {
    switch (finishedWork.tag) {
        case HostComponent: {
            const updatePayload = finishedWork.updateQueue;
            finishedWork.updateQueue = null;
            if (updatePayload) {
                updateProperties(finishedWork.stateNode, updatePayload);
            }
        }
        default:
            break;
    }
}
function getParentStateNode(fiber) {
    const parent = fiber.return;
    do {
        if (parent.tag <span class="hljs-comment">=== HostComponent) {</span>
            return parent.stateNode;
        } else if (parent.tag <span class="hljs-comment">=== HostRoot) {</span>
            return parent.stateNode.containerInfo
        }
        parent = parent.return;
    } while (parent);
}
<span class="hljs-addition">+function getHostSibling(fiber) {</span>
<span class="hljs-addition">+    let node = fiber.sibling;</span>
<span class="hljs-addition">+    while (node) {</span>
<span class="hljs-addition">+        if (!(node.flags &amp; Placement)) {</span>
<span class="hljs-addition">+            return node.stateNode;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+        node = node.sibling;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    return null;</span>
<span class="hljs-addition">+}</span>
export function commitPlacement(finishedWork) {
    let stateNode = finishedWork.stateNode;
    let parentStateNode = getParentStateNode(finishedWork);
<span class="hljs-addition">+   let before = getHostSibling(finishedWork);</span>
<span class="hljs-addition">+   if (before) {</span>
<span class="hljs-addition">+       insertBefore(parentStateNode, stateNode, before);</span>
<span class="hljs-addition">+   } else {</span>
<span class="hljs-addition">+       appendChild(parentStateNode, stateNode);</span>
<span class="hljs-addition">+   }</span>
}
</code></pre>
<h2 id="t7311. &#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x65B0;&#x589E;&#x5143;&#x7D20;">11. &#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x65B0;&#x589E;&#x5143;&#x7D20; <a href="#t7311. &#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x65B0;&#x589E;&#x5143;&#x7D20;"> # </a></h2>
<h3 id="t7411.1 public\index.html">11.1 public\index.html <a href="#t7411.1 public\index.html"> # </a></h3>
<pre><code class="lang-diff">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
    &lt;meta name=&quot;theme-color&quot; content=&quot;#000000&quot; /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
    &lt;div&gt;
     &lt;button id=&quot;multi2&quot;&gt;6.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x65B0;&#x589E;&#x5143;&#x7D20;&lt;/button&gt;&lt;br/&gt;
       &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;B&amp;quot;&amp;gt;B&amp;lt;/li&amp;gt;&lt;br/&gt;
         &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;C&amp;quot;&amp;gt;C&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;lt;/ul&amp;gt;&lt;br/&gt;
     &lt;button id=&quot;multi2Update&quot;&gt;&#x589E;&#x52A0;&#x65B0;&#x5143;&#x7D20;&#x5E76;&#x66F4;&#x65B0;&#x8001;&#x5143;&#x7D20;&lt;/button&gt;&lt;br/&gt;
     &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;B2&amp;quot;&amp;gt;B2&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;C&amp;quot;&amp;gt;C&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;D&amp;quot;&amp;gt;D&amp;lt;/li&amp;gt;&lt;br/&gt;
     &amp;lt;/ul&amp;gt;&lt;br/&gt;  
   &lt;/div&gt;
   &lt;hr/&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="t7511.2 src\index.js">11.2 src\index.js <a href="#t7511.2 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-diff">import React from &apos;./react&apos;;
import ReactDOM from &apos;./react-dom&apos;;
//6.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x65B0;&#x589E;&#x5143;&#x7D20;
multi2.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;li key=&quot;B&quot; id=&quot;B&quot;&gt;B&lt;/li&gt;
      &lt;li key=&quot;C&quot;&gt;C&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
//&#x589E;&#x52A0;&#x65B0;&#x5143;&#x7D20;&#x5E76;&#x66F4;&#x65B0;&#x8001;&#x5143;&#x7D20;
multi2Update.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;li key=&quot;B&quot; id=&quot;B2&quot;&gt;B2&lt;/li&gt;
      &lt;li key=&quot;C&quot;&gt;C&lt;/li&gt;
      &lt;li key=&quot;D&quot;&gt;D&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
</code></pre>
<h3 id="t7611.3 src\ReactChildFiber.js">11.3 src\ReactChildFiber.js <a href="#t7611.3 src\ReactChildFiber.js"> # </a></h3>
<p>src\ReactChildFiber.js</p>
<pre><code class="lang-diff">import { Placement, Deletion } from &apos;./ReactFiberFlags&apos;;
import { createFiberFromElement, createWorkInProgress } from &apos;./ReactFiber&apos;;
import { REACT_ELEMENT_TYPE } from &apos;./ReactSymbols&apos;;
function ChildReconciler(shouldTrackSideEffects) {
    function placeSingleChild(newFiber) {
        //&#x5982;&#x679C;&#x8981;&#x8DDF;&#x8E2A;&#x526F;&#x4F5C;&#x7528;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x8001;&#x7684;fiber&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x65B0;&#x5EFA;
        if (shouldTrackSideEffects &amp;&amp; !newFiber.alternate) {
            newFiber.flags = Placement;
        }
        return newFiber;
    }
    function deleteChild(returnFiber, childToDelete) {
        if (!shouldTrackSideEffects) {
            return;
        }
        //&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x7236;&#x4EB2;&#x5F85;&#x5220;&#x9664;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E2D;
        const last = returnFiber.lastEffect;
        if (last) {//&#x5982;&#x679C;&#x7236;&#x4EB2;&#x6709;&#x5C3E;&#x90E8;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x5C3E;&#x90E8;&#x7684;nextEffect&#x4E0A;
            last.nextEffect = childToDelete;
            //&#x7136;&#x540E;&#x8BA9;&#x7236;&#x4EB2;&#x7684;&#x5C3E;&#x90E8;&#x7B49;&#x4E8E;&#x81EA;&#x5DF1;
            returnFiber.lastEffect = childToDelete;
        } else {
            //&#x5982;&#x679C;&#x7236;&#x4EB2;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;&#xFF0C;&#x5934;&#x548C;&#x5C3E;&#x5411;childToDelete
            returnFiber.firstEffect = returnFiber.lastEffect = childToDelete;
        }
        //&#x6E05;&#x7A7A;&#x5B83;&#x7684;nextEffect
        childToDelete.nextEffect = null;
        //&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;
        childToDelete.flags = Deletion;
    }
    function deleteRemainingChildren(returnFiber, currentFirstChild) {
        let childToDelete = currentFirstChild;
        while (childToDelete) {
            deleteChild(returnFiber, childToDelete);
            childToDelete = childToDelete.sibling;
        }
        return null;
    }
    /**
  * &#x590D;&#x7528;&#x8001;&#x7684;fiber
  * @param {*} fiber &#x8001;fiber
  * @param {*} pendingProps &#x65B0;&#x5C5E;&#x6027;
  * @returns 
  */
    function useFiber(fiber, pendingProps) {
        //&#x6839;&#x636E;&#x8001;&#x7684;fiber&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber
        return createWorkInProgress(fiber, pendingProps);
    }
    /**
     * &#x5355;&#x8282;&#x70B9;DIFF
     * @param {*} returnFiber &#x5F53;&#x524D;&#x7236;&#x4EB2;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;&#x8282;fiber
     * @param {*} element JSX&#x865A;&#x62DF;DOM
     * @returns 
     */
    function reconcileSingleElement(returnFiber, currentFirstChild, element) {
        //&#x65B0;jsx&#x5143;&#x7D20;&#x7684;key
        const key = element.key;
        //&#x7B2C;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        let child = currentFirstChild;
        //&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        while (child) {
            //&#x5148;&#x5224;&#x65AD;&#x4E24;&#x8005;&#x7684;key&#x662F;&#x76F8;&#x540C;
            if (child.key <span class="hljs-comment">=== key) {</span>
                //&#x518D;&#x5224;&#x65AD;&#x7C7B;&#x578B;&#x662F;&#x5426;&#x76F8;&#x540C;,&#x5982;&#x679C;&#x76F8;&#x540C;
                if (child.type <span class="hljs-comment">=== element.type) {</span>
                    //&#x5220;&#x9664;&#x5269;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x7684;&#x8001;fiber&#x8282;&#x70B9;
                    deleteRemainingChildren(returnFiber, child.sibling);
                    //&#x590D;&#x7528;&#x8FD9;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;,&#x5E76;&#x4F20;&#x9012;&#x65B0;&#x7684;&#x5C5E;&#x6027;
                    const existing = useFiber(child, element.props);
                    //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
                    existing.return = returnFiber;
                    //&#x8FD4;&#x56DE;&#x590D;&#x7528;&#x7684;fiber
                    return existing;
                } else {
                    //&#x5982;&#x679C;key&#x76F8;&#x540C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4E0D;&#x518D;&#x8FDB;&#x884C;&#x540E;&#x7EED;&#x5339;&#x914D;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x5168;&#x90E8;&#x5220;&#x9664;
                    deleteRemainingChildren(returnFiber, child);
                    break;
                }
            } else {
                //&#x5982;&#x679C;key&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5219;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;&#xFF0C;&#x7EE7;&#x7EED;&#x5339;&#x914D;&#x5F1F;&#x5F1F;
                deleteChild(returnFiber, child);
            }
            //&#x627E;&#x5F1F;&#x5F1F;&#x7EE7;&#x7EED;&#x5339;&#x914D;
            child = child.sibling;
        }
        //&#x6839;&#x636E;&#x865A;&#x62DF;DOM&#x521B;&#x5EFA;fiber&#x8282;&#x70B9;
        const created = createFiberFromElement(element);
        //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
        created.return = returnFiber;
        return created;
    }
    function createChild(returnFiber, newChild) {
        if (typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; newChild) {</span>
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE: {
                    const created = createFiberFromElement(newChild);
                    created.return = returnFiber;
                    return created;
                }
                default:
                    break;
            }
        }
    }
    /**
     * &#x66F4;&#x65B0;&#x5143;&#x7D20;
     * @param {*} returnFiber &#x7236;fiber
     * @param {*} current &#x8001;&#x7684;&#x7684;&#x5B50;fiber&#x8282;&#x70B9;
     * @param {*} element &#x65B0;&#x7684;JSX&#x8282;&#x70B9;
     * @returns 
     */
    function updateElement(returnFiber, current, element) {
        //&#x5982;&#x679C;&#x8001;fiber&#x5B58;&#x5728;
        if (current) {
            //&#x800C;&#x4E14;&#x65B0;&#x8001;type&#x7C7B;&#x578B;&#x4E5F;&#x4E00;&#x6837;
            if (current.type <span class="hljs-comment">=== element.type) {</span>
                //&#x590D;&#x7528;&#x8001;&#x7684;fiber
                const existing = useFiber(current, element.props);
                existing.return = returnFiber;
                return existing;
            }
        }
        //&#x5982;&#x679C;&#x8001;fiber&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber
        const created = createFiberFromElement(element);
        created.return = returnFiber;
        return created;
    }
    function updateSlot(returnFiber, oldFiber, newChild) {
        //&#x83B7;&#x53D6;&#x8001;fiber&#x8282;&#x70B9;&#x7684;key
        const key = oldFiber ? oldFiber.key : null;
        //&#x5982;&#x679C;&#x65B0;&#x7684;JSX&#x5B50;&#x8282;&#x70B9;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;
        if (typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; newChild) {</span>
            //&#x5982;&#x679C;&#x65B0;&#x8001;key&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x5219;&#x8868;&#x793A;&#x627E;&#x5230;&#x4E86;&#x53EF;&#x590D;&#x7528;&#x7684;&#x8282;&#x70B9;
            if (newChild.key <span class="hljs-comment">=== key) {</span>
                return updateElement(returnFiber, oldFiber, newChild);
            } else {
                //key&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x4E0D;&#x80FD;&#x590D;&#x7528;
                return null;
            }
        }
    }
    function placeChild(newFiber, newIndex) {
        newFiber.index = newIndex;
        if (!shouldTrackSideEffects) {
            return;
        }
        const current = newFiber.alternate;
        if (current) {

        } else {
            newFiber.flags = Placement;
            return;
        }
    }
    /**
     * &#x534F;&#x8C03;&#x5B50;&#x8282;&#x70B9;
     * @param {*} returnFiber &#x7236;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;fiber
     * @param {*} newChildren JSX&#x5BF9;&#x8C61;
     * @returns 
     */
    function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren) {
        //&#x8BE5;&#x7B97;&#x6CD5;&#x65E0;&#x6CD5;&#x901A;&#x8FC7;&#x4E24;&#x7AEF;&#x641C;&#x7D22;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x56E0;&#x4E3A;fiber&#x4E0A;&#x6CA1;&#x6709;&#x53CD;&#x5411;&#x6307;&#x9488;
        //&#x6211;&#x5728;&#x8BD5;&#x7740;&#x770B;&#x770B;&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x8FD9;&#x4E2A;&#x6A21;&#x578B;&#x8D70;&#x591A;&#x8FDC;&#x3002;&#x5982;&#x679C;&#x5B83;&#x6700;&#x7EC8;&#x4E0D;&#x503C;&#x5F97;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7A0D;&#x540E;&#x6DFB;&#x52A0;&#x5B83;
        //&#x8FD4;&#x56DE;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;fiber&#x5B50;&#x8282;&#x70B9;
        let resultingFirstChild = null;
        //&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;&#x7684;fiber&#x8282;&#x70B9;
        let previousNewFiber = null;
        //&#x6BD4;&#x8F83;&#x4E2D;&#x7684;&#x65E7;&#x7684;fiber&#x8282;&#x70B9;
        let oldFiber = currentFirstChild;
        //&#x4E0B;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber
        let nextOldFiber = null;
        //&#x65B0;&#x7684;&#x7D22;&#x5F15;
        let newIdx = 0;
        //&#x5148;&#x5904;&#x7406;&#x8282;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x60C5;&#x51B5;
        for (; oldFiber &amp;&amp; newIdx &lt; newChildren.length; newIdx++) {
            //&#x5148;&#x7F13;&#x5B58;&#x4E0B;&#x4E0B;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
            nextOldFiber = oldFiber.sibling;
            //&#x66F4;&#x65B0;&#x590D;&#x7528;&#x7684;&#x65B0;fiber
            //&#x5224;&#x65AD;key&#x548C;type&#x662F;&#x5426;&#x76F8;&#x540C;&#xFF0C;&#x5982;&#x679C;&#x76F8;&#x540C;&#x8868;&#x793A;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF0C;newIdx++&#x540E;&#x548C;&#x4E0B;&#x4E00;&#x4E2A;oldFiber&#x6BD4;&#x8F83;
            const newFiber = updateSlot(returnFiber, oldFiber, newChildren[newIdx]);
            if (!newFiber) {
                break;
            }
            //&#x5982;&#x679C;&#x7C7B;&#x578B;&#x76F8;&#x540C;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x91CD;&#x7528;&#x73B0;&#x6709;fiber&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x5220;&#x9664;&#x73B0;&#x6709;&#x5B50;&#x7EA7;fiber
            if (oldFiber &amp;&amp; !(newFiber.alternate)) {
                deleteChild(returnFiber, oldFiber);
            }
            //&#x653E;&#x7F6E;&#x6B64;newFiber&#x5230;newIdx&#xFF0C;&#x5C31;&#x662F;&#x8BBE;&#x7F6E;newFiber&#x7684;index&#x7D22;&#x5F15;
            placeChild(newFiber, newIdx);
            //&#x5982;&#x679C;previousNewFiber&#x4E0D;&#x5B58;&#x5728;&#x8868;&#x793A;&#x8FD9;&#x662F;&#x7B2C;&#x4E00;&#x4E2A;fiber
            if (!previousNewFiber) {
                resultingFirstChild = newFiber;
            } else {
                //&#x5426;&#x5219;&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;fiber&#x7684;sibling&#x7B49;&#x4E8E;&#x8FD9;&#x4E2A;newFiber
                previousNewFiber.sibling = newFiber;
            }
            //&#x8BA9;&#x5F53;&#x524D;&#x7684;newFiber&#x7B49;&#x4E8E;previousNewFiber
            previousNewFiber = newFiber;
            //&#x4E0B;&#x4E00;&#x4E2A;&#x8001;fiber
            oldFiber = nextOldFiber;
        }
        //&#x5982;&#x679C;&#x8001;fiber&#x5B8C;&#x6210;&#xFF0C;&#x65B0;&#x7684;JSX&#x6CA1;&#x6709;&#x5B8C;&#x6210;
        if (!oldFiber) {
            for (; newIdx &lt; newChildren.length; newIdx++) {
                const newFiber = createChild(returnFiber, newChildren[newIdx]);
<span class="hljs-addition">+               placeChild(newFiber, newIdx);</span>
                if (!previousNewFiber) {
                    resultingFirstChild = newFiber;
                } else {
                    previousNewFiber.sibling = newFiber;
                }
                previousNewFiber = newFiber;
            }
            return resultingFirstChild;
        }
        return resultingFirstChild;
    }
    function reconcileChildFibers(returnFiber, currentFirstChild, newChild) {
        const isObject = typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; (newChild);</span>
        if (isObject) {
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE:
                    return placeSingleChild(
                        reconcileSingleElement(returnFiber, currentFirstChild, newChild)
                    );
                default:
                    break;
            }
        }
        if (Array.isArray(newChild)) {
            return reconcileChildrenArray(returnFiber, currentFirstChild, newChild);
        }
    }
    return reconcileChildFibers;
}

export const reconcileChildFibers = ChildReconciler(true);
export const mountChildFibers = ChildReconciler(false);
</code></pre>
<h2 id="t7712. 7.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x5220;&#x9664;&#x8001;&#x5143;&#x7D20;">12. 7.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x5220;&#x9664;&#x8001;&#x5143;&#x7D20; <a href="#t7712. 7.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x5220;&#x9664;&#x8001;&#x5143;&#x7D20;"> # </a></h2>
<ul>
<li>&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x5220;&#x9664;&#x8001;&#x5143;&#x7D20;&#xFF0C;&#x5220;&#x9664;&#x8001;&#x5143;&#x7D20;&#x5E76;&#x66F4;&#x65B0;&#x8001;&#x5143;&#x7D20;</li>
</ul>
<h3 id="t7812.1 public\index.html">12.1 public\index.html <a href="#t7812.1 public\index.html"> # </a></h3>
<p>public\index.html</p>
<pre><code class="lang-diff">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
    &lt;meta name=&quot;theme-color&quot; content=&quot;#000000&quot; /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
    &lt;div&gt;
      &lt;button id=&quot;multi3&quot;&gt;7.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x5220;&#x9664;&#x8001;&#x5143;&#x7D20;&lt;/button&gt;&lt;br/&gt;
      &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
        &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
        &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;B&amp;quot;&amp;gt;B&amp;lt;/li&amp;gt;&lt;br/&gt;
        &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;C&amp;quot;&amp;gt;C&amp;lt;/li&amp;gt;&lt;br/&gt;
      &amp;lt;/ul&amp;gt;&lt;br/&gt;
      &lt;button id=&quot;multi3Update&quot;&gt;&#x5220;&#x9664;&#x8001;&#x5143;&#x7D20;&#x5E76;&#x66F4;&#x65B0;&#x8001;&#x5143;&#x7D20;&lt;/button&gt;&lt;br/&gt;
      &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
        &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
        &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;B2&amp;quot;&amp;gt;B2&amp;lt;/li&amp;gt;&lt;br/&gt;
      &amp;lt;/ul&amp;gt;&lt;br/&gt;
    &lt;/div&gt;
    &lt;hr/&gt;
  &lt;/body&gt;
&lt;/html&gt;

</code></pre>
<h3 id="t7912.2 src\index.js">12.2 src\index.js <a href="#t7912.2 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-diff">import React from &apos;./react&apos;;
import ReactDOM from &apos;./react-dom&apos;;
//7.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x7C7B;&#x578B;&#x548C;key&#x5168;&#x90E8;&#x76F8;&#x540C;&#xFF0C;&#x6709;&#x5220;&#x9664;&#x8001;&#x5143;&#x7D20;
multi3.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;li key=&quot;B&quot; id=&quot;B&quot;&gt;B&lt;/li&gt;
      &lt;li key=&quot;C&quot;&gt;C&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
multi3Update.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;li key=&quot;B&quot; id=&quot;B2&quot;&gt;B2&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
</code></pre>
<h3 id="t8012.3 ReactChildFiber.js">12.3 ReactChildFiber.js <a href="#t8012.3 ReactChildFiber.js"> # </a></h3>
<p>src\ReactChildFiber.js</p>
<pre><code class="lang-diff">import { Placement, Deletion } from &apos;./ReactFiberFlags&apos;;
import { createFiberFromElement, createWorkInProgress } from &apos;./ReactFiber&apos;;
import { REACT_ELEMENT_TYPE } from &apos;./ReactSymbols&apos;;
function ChildReconciler(shouldTrackSideEffects) {
    function placeSingleChild(newFiber) {
        //&#x5982;&#x679C;&#x8981;&#x8DDF;&#x8E2A;&#x526F;&#x4F5C;&#x7528;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x8001;&#x7684;fiber&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x65B0;&#x5EFA;
        if (shouldTrackSideEffects &amp;&amp; !newFiber.alternate) {
            newFiber.flags = Placement;
        }
        return newFiber;
    }
    function deleteChild(returnFiber, childToDelete) {
        if (!shouldTrackSideEffects) {
            return;
        }
        //&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x7236;&#x4EB2;&#x5F85;&#x5220;&#x9664;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E2D;
        const last = returnFiber.lastEffect;
        if (last) {//&#x5982;&#x679C;&#x7236;&#x4EB2;&#x6709;&#x5C3E;&#x90E8;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x5C3E;&#x90E8;&#x7684;nextEffect&#x4E0A;
            last.nextEffect = childToDelete;
            //&#x7136;&#x540E;&#x8BA9;&#x7236;&#x4EB2;&#x7684;&#x5C3E;&#x90E8;&#x7B49;&#x4E8E;&#x81EA;&#x5DF1;
            returnFiber.lastEffect = childToDelete;
        } else {
            //&#x5982;&#x679C;&#x7236;&#x4EB2;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;&#xFF0C;&#x5934;&#x548C;&#x5C3E;&#x5411;childToDelete
            returnFiber.firstEffect = returnFiber.lastEffect = childToDelete;
        }
        //&#x6E05;&#x7A7A;&#x5B83;&#x7684;nextEffect
        childToDelete.nextEffect = null;
        //&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;
        childToDelete.flags = Deletion;
    }
    function deleteRemainingChildren(returnFiber, currentFirstChild) {
        let childToDelete = currentFirstChild;
        while (childToDelete) {
            deleteChild(returnFiber, childToDelete);
            childToDelete = childToDelete.sibling;
        }
        return null;
    }
    /**
  * &#x590D;&#x7528;&#x8001;&#x7684;fiber
  * @param {*} fiber &#x8001;fiber
  * @param {*} pendingProps &#x65B0;&#x5C5E;&#x6027;
  * @returns 
  */
    function useFiber(fiber, pendingProps) {
        //&#x6839;&#x636E;&#x8001;&#x7684;fiber&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber
        return createWorkInProgress(fiber, pendingProps);
    }
    /**
     * &#x5355;&#x8282;&#x70B9;DIFF
     * @param {*} returnFiber &#x5F53;&#x524D;&#x7236;&#x4EB2;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;&#x8282;fiber
     * @param {*} element JSX&#x865A;&#x62DF;DOM
     * @returns 
     */
    function reconcileSingleElement(returnFiber, currentFirstChild, element) {
        //&#x65B0;jsx&#x5143;&#x7D20;&#x7684;key
        const key = element.key;
        //&#x7B2C;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        let child = currentFirstChild;
        //&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        while (child) {
            //&#x5148;&#x5224;&#x65AD;&#x4E24;&#x8005;&#x7684;key&#x662F;&#x76F8;&#x540C;
            if (child.key <span class="hljs-comment">=== key) {</span>
                //&#x518D;&#x5224;&#x65AD;&#x7C7B;&#x578B;&#x662F;&#x5426;&#x76F8;&#x540C;,&#x5982;&#x679C;&#x76F8;&#x540C;
                if (child.type <span class="hljs-comment">=== element.type) {</span>
                    //&#x5220;&#x9664;&#x5269;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x7684;&#x8001;fiber&#x8282;&#x70B9;
                    deleteRemainingChildren(returnFiber, child.sibling);
                    //&#x590D;&#x7528;&#x8FD9;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;,&#x5E76;&#x4F20;&#x9012;&#x65B0;&#x7684;&#x5C5E;&#x6027;
                    const existing = useFiber(child, element.props);
                    //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
                    existing.return = returnFiber;
                    //&#x8FD4;&#x56DE;&#x590D;&#x7528;&#x7684;fiber
                    return existing;
                } else {
                    //&#x5982;&#x679C;key&#x76F8;&#x540C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4E0D;&#x518D;&#x8FDB;&#x884C;&#x540E;&#x7EED;&#x5339;&#x914D;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x5168;&#x90E8;&#x5220;&#x9664;
                    deleteRemainingChildren(returnFiber, child);
                    break;
                }
            } else {
                //&#x5982;&#x679C;key&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5219;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;&#xFF0C;&#x7EE7;&#x7EED;&#x5339;&#x914D;&#x5F1F;&#x5F1F;
                deleteChild(returnFiber, child);
            }
            //&#x627E;&#x5F1F;&#x5F1F;&#x7EE7;&#x7EED;&#x5339;&#x914D;
            child = child.sibling;
        }
        //&#x6839;&#x636E;&#x865A;&#x62DF;DOM&#x521B;&#x5EFA;fiber&#x8282;&#x70B9;
        const created = createFiberFromElement(element);
        //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
        created.return = returnFiber;
        return created;
    }
    function createChild(returnFiber, newChild) {
        if (typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; newChild) {</span>
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE: {
                    const created = createFiberFromElement(newChild);
                    created.return = returnFiber;
                    return created;
                }
                default:
                    break;
            }
        }
    }
    /**
     * &#x66F4;&#x65B0;&#x5143;&#x7D20;
     * @param {*} returnFiber &#x7236;fiber
     * @param {*} current &#x8001;&#x7684;&#x7684;&#x5B50;fiber&#x8282;&#x70B9;
     * @param {*} element &#x65B0;&#x7684;JSX&#x8282;&#x70B9;
     * @returns 
     */
    function updateElement(returnFiber, current, element) {
        //&#x5982;&#x679C;&#x8001;fiber&#x5B58;&#x5728;
        if (current) {
            //&#x800C;&#x4E14;&#x65B0;&#x8001;type&#x7C7B;&#x578B;&#x4E5F;&#x4E00;&#x6837;
            if (current.type <span class="hljs-comment">=== element.type) {</span>
                //&#x590D;&#x7528;&#x8001;&#x7684;fiber
                const existing = useFiber(current, element.props);
                existing.return = returnFiber;
                return existing;
            }
        }
        //&#x5982;&#x679C;&#x8001;fiber&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber
        const created = createFiberFromElement(element);
        created.return = returnFiber;
        return created;
    }
    function updateSlot(returnFiber, oldFiber, newChild) {
        //&#x83B7;&#x53D6;&#x8001;fiber&#x8282;&#x70B9;&#x7684;key
        const key = oldFiber ? oldFiber.key : null;
        //&#x5982;&#x679C;&#x65B0;&#x7684;JSX&#x5B50;&#x8282;&#x70B9;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;
        if (typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; newChild) {</span>
            //&#x5982;&#x679C;&#x65B0;&#x8001;key&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x5219;&#x8868;&#x793A;&#x627E;&#x5230;&#x4E86;&#x53EF;&#x590D;&#x7528;&#x7684;&#x8282;&#x70B9;
            if (newChild.key <span class="hljs-comment">=== key) {</span>
                return updateElement(returnFiber, oldFiber, newChild);
            } else {
                //key&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x4E0D;&#x80FD;&#x590D;&#x7528;
                return null;
            }
        }
    }
    function placeChild(newFiber, newIndex) {
        newFiber.index = newIndex;
        if (!shouldTrackSideEffects) {
            return;
        }
        const current = newFiber.alternate;
        if (current) {

        } else {
            newFiber.flags = Placement;
            return;
        }
    }
    /**
     * &#x534F;&#x8C03;&#x5B50;&#x8282;&#x70B9;
     * @param {*} returnFiber &#x7236;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;fiber
     * @param {*} newChildren JSX&#x5BF9;&#x8C61;
     * @returns 
     */
    function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren) {
        //&#x8BE5;&#x7B97;&#x6CD5;&#x65E0;&#x6CD5;&#x901A;&#x8FC7;&#x4E24;&#x7AEF;&#x641C;&#x7D22;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x56E0;&#x4E3A;fiber&#x4E0A;&#x6CA1;&#x6709;&#x53CD;&#x5411;&#x6307;&#x9488;
        //&#x6211;&#x5728;&#x8BD5;&#x7740;&#x770B;&#x770B;&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x8FD9;&#x4E2A;&#x6A21;&#x578B;&#x8D70;&#x591A;&#x8FDC;&#x3002;&#x5982;&#x679C;&#x5B83;&#x6700;&#x7EC8;&#x4E0D;&#x503C;&#x5F97;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7A0D;&#x540E;&#x6DFB;&#x52A0;&#x5B83;
        //&#x8FD4;&#x56DE;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;fiber&#x5B50;&#x8282;&#x70B9;
        let resultingFirstChild = null;
        //&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;&#x7684;fiber&#x8282;&#x70B9;
        let previousNewFiber = null;
        //&#x6BD4;&#x8F83;&#x4E2D;&#x7684;&#x65E7;&#x7684;fiber&#x8282;&#x70B9;
        let oldFiber = currentFirstChild;
        //&#x4E0B;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber
        let nextOldFiber = null;
        //&#x65B0;&#x7684;&#x7D22;&#x5F15;
        let newIdx = 0;
        //&#x5148;&#x5904;&#x7406;&#x8282;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x60C5;&#x51B5;
        for (; oldFiber &amp;&amp; newIdx &lt; newChildren.length; newIdx++) {
            //&#x5148;&#x7F13;&#x5B58;&#x4E0B;&#x4E0B;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
            nextOldFiber = oldFiber.sibling;
            //&#x66F4;&#x65B0;&#x590D;&#x7528;&#x7684;&#x65B0;fiber
            //&#x5224;&#x65AD;key&#x548C;type&#x662F;&#x5426;&#x76F8;&#x540C;&#xFF0C;&#x5982;&#x679C;&#x76F8;&#x540C;&#x8868;&#x793A;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF0C;newIdx++&#x540E;&#x548C;&#x4E0B;&#x4E00;&#x4E2A;oldFiber&#x6BD4;&#x8F83;
            const newFiber = updateSlot(returnFiber, oldFiber, newChildren[newIdx]);
            if (!newFiber) {
                break;
            }
            //&#x5982;&#x679C;&#x7C7B;&#x578B;&#x76F8;&#x540C;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x91CD;&#x7528;&#x73B0;&#x6709;fiber&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x5220;&#x9664;&#x73B0;&#x6709;&#x5B50;&#x7EA7;fiber
            if (oldFiber &amp;&amp; !(newFiber.alternate)) {
                deleteChild(returnFiber, oldFiber);
            }
            //&#x653E;&#x7F6E;&#x6B64;newFiber&#x5230;newIdx&#xFF0C;&#x5C31;&#x662F;&#x8BBE;&#x7F6E;newFiber&#x7684;index&#x7D22;&#x5F15;
            placeChild(newFiber, newIdx);
            //&#x5982;&#x679C;previousNewFiber&#x4E0D;&#x5B58;&#x5728;&#x8868;&#x793A;&#x8FD9;&#x662F;&#x7B2C;&#x4E00;&#x4E2A;fiber
            if (!previousNewFiber) {
                resultingFirstChild = newFiber;
            } else {
                //&#x5426;&#x5219;&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;fiber&#x7684;sibling&#x7B49;&#x4E8E;&#x8FD9;&#x4E2A;newFiber
                previousNewFiber.sibling = newFiber;
            }
            //&#x8BA9;&#x5F53;&#x524D;&#x7684;newFiber&#x7B49;&#x4E8E;previousNewFiber
            previousNewFiber = newFiber;
            //&#x4E0B;&#x4E00;&#x4E2A;&#x8001;fiber
            oldFiber = nextOldFiber;
        }
<span class="hljs-addition">+       //&#x5982;&#x679C;&#x65B0;&#x7684;&#x904D;&#x5386;&#x5B8C;&#x4E86;&#xFF0C;&#x5220;&#x9664;&#x6389;&#x6240;&#x6709;&#x8001;&#x7684;&#x5269;&#x4E0B;&#x7684;fiber&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;resultingFirstChild</span>
<span class="hljs-addition">+       if (newIdx === newChildren.length) {</span>
<span class="hljs-addition">+           deleteRemainingChildren(returnFiber, oldFiber);</span>
<span class="hljs-addition">+           return resultingFirstChild;</span>
<span class="hljs-addition">+       }</span>
        //&#x5982;&#x679C;&#x8001;fiber&#x5B8C;&#x6210;&#xFF0C;&#x65B0;&#x7684;JSX&#x6CA1;&#x6709;&#x5B8C;&#x6210;
        if (!oldFiber) {
            for (; newIdx &lt; newChildren.length; newIdx++) {
                const newFiber = createChild(returnFiber, newChildren[newIdx]);
                placeChild(newFiber, newIdx);
                if (!previousNewFiber) {
                    resultingFirstChild = newFiber;
                } else {
                    previousNewFiber.sibling = newFiber;
                }
                previousNewFiber = newFiber;
            }
            return resultingFirstChild;
        }
        return resultingFirstChild;
    }
    function reconcileChildFibers(returnFiber, currentFirstChild, newChild) {
        const isObject = typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; (newChild);</span>
        if (isObject) {
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE:
                    return placeSingleChild(
                        reconcileSingleElement(returnFiber, currentFirstChild, newChild)
                    );
                default:
                    break;
            }
        }
        if (Array.isArray(newChild)) {
            return reconcileChildrenArray(returnFiber, currentFirstChild, newChild);
        }
    }
    return reconcileChildFibers;
}

export const reconcileChildFibers = ChildReconciler(true);
export const mountChildFibers = ChildReconciler(false);
</code></pre>
<h2 id="t8113. &#x591A;&#x4E2A;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x4E0D;&#x540C;&#x3001;key&#x4E0D;&#x540C;">13. &#x591A;&#x4E2A;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x4E0D;&#x540C;&#x3001;key&#x4E0D;&#x540C; <a href="#t8113. &#x591A;&#x4E2A;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x4E0D;&#x540C;&#x3001;key&#x4E0D;&#x540C;"> # </a></h2>
<ul>
<li><a href="https://www.processon.com/diagraming/6193773ef346fb6e38a56734">&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x4E0D;&#x540C;&#x3001;key&#x4E0D;&#x540C;</a></li>
<li>&#x7B2C;&#x4E00;&#x8F6E;&#x6BD4;&#x8F83;A&#x548C;A&#xFF0C;&#x76F8;&#x540C;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF0C;&#x66F4;&#x65B0;&#xFF0C;&#x7136;&#x540E;&#x6BD4;&#x8F83;B&#x548C;C&#xFF0C;key&#x4E0D;&#x540C;&#x76F4;&#x63A5;&#x8DF3;&#x51FA;&#x7B2C;&#x4E00;&#x4E2A;&#x5FAA;&#x73AF;</li>
<li>&#x628A;&#x5269;&#x4E0B;oldFiber&#x7684;&#x653E;&#x5165;existingChildren&#x8FD9;&#x4E2A;map&#x4E2D;</li>
<li>&#x7136;&#x540E;&#x58F0;&#x660E;&#x4E00;&#x4E2A;<code>lastPlacedIndex</code>&#x53D8;&#x91CF;&#xFF0C;&#x8868;&#x793A;&#x4E0D;&#x9700;&#x8981;&#x79FB;&#x52A8;&#x7684;&#x8001;&#x8282;&#x70B9;&#x7684;&#x7D22;&#x5F15;</li>
<li>&#x7EE7;&#x7EED;&#x5FAA;&#x73AF;&#x5269;&#x4E0B;&#x7684;&#x865A;&#x62DF;DOM&#x8282;&#x70B9;</li>
<li>&#x5982;&#x679C;&#x80FD;&#x5728;map&#x4E2D;&#x627E;&#x5230;&#x76F8;&#x540C;key&#x76F8;&#x540C;type&#x7684;&#x8282;&#x70B9;&#x5219;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#x8001;fiber,&#x5E76;&#x628A;&#x6B64;&#x8001;fiber&#x4ECE;map&#x4E2D;&#x5220;&#x9664;</li>
<li>&#x5982;&#x679C;&#x80FD;&#x5728;map&#x4E2D;&#x627E;&#x4E0D;&#x5230;&#x76F8;&#x540C;key&#x76F8;&#x540C;type&#x7684;&#x8282;&#x70B9;&#x5219;&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber</li>
<li>&#x5982;&#x679C;&#x662F;&#x590D;&#x7528;&#x8001;&#x7684;fiber,&#x5219;&#x5224;&#x65AD;&#x8001;fiber&#x7684;&#x7D22;&#x5F15;&#x662F;&#x5426;&#x5C0F;&#x4E8E;lastPlacedIndex&#xFF0C;&#x5982;&#x679C;&#x662F;&#x8981;&#x79FB;&#x52A8;&#x8001;fiber&#xFF0C;&#x4E0D;&#x53D8;</li>
<li>&#x5982;&#x679C;&#x662F;&#x590D;&#x7528;&#x8001;&#x7684;fiber,&#x5219;&#x5224;&#x65AD;&#x8001;fiber&#x7684;&#x7D22;&#x5F15;&#x662F;&#x5426;&#x5C0F;&#x4E8E;lastPlacedIndex&#xFF0C;&#x5982;&#x679C;&#x5426;&#x5219;&#x66F4;&#x65B0;lastPlacedIndex&#x4E3A;&#x8001;fiber&#x7684;index</li>
<li>&#x628A;&#x6240;&#x6709;&#x7684;map&#x4E2D;&#x5269;&#x4E0B;&#x7684;fiber&#x5168;&#x90E8;&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;</li>
<li>(&#x5220;&#x9664;#li#F)=&gt;(&#x6DFB;&#x52A0;#li#B)=&gt;(&#x6DFB;&#x52A0;#li#G)=&gt;(&#x6DFB;&#x52A0;#li#D)=&gt;null</li>
</ul>
<p><img src="https://static.zhufengpeixun.com/duo_ge_jie_dian_shu_liang_bu_tong_key_bu_tong_1_1637057627706.jpg" alt></p>
<h3 id="t8213.1 public\index.html">13.1 public\index.html <a href="#t8213.1 public\index.html"> # </a></h3>
<p>public\index.html</p>
<pre><code class="lang-diff">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
    &lt;meta name=&quot;theme-color&quot; content=&quot;#000000&quot; /&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
   &lt;div&gt;
    &lt;button id=&quot;multi5&quot;&gt;9.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x4E0D;&#x540C;&#x3001;key&#x4E0D;&#x540C;&lt;/button&gt;&lt;br/&gt;
      &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;b&amp;quot;&amp;gt;B&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;C&amp;quot;&amp;gt;C&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;D&amp;quot;&amp;gt;D&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;E&amp;quot;&amp;gt;E&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;F&amp;quot;&amp;gt;F&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;lt;/ul&amp;gt;&lt;br/&gt;
     &lt;button id=&quot;multi5Update&quot;&gt;&#x5904;&#x7406;&#x8282;&#x70B9;&#x79FB;&#x52A8;&#x7684;&#x60C5;&#x51B5;&lt;/button&gt;&lt;br/&gt;
       &amp;lt;ul key=&amp;quot;ul&amp;quot;&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;A&amp;quot;&amp;gt;A&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;C&amp;quot;&amp;gt;C&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;E&amp;quot;&amp;gt;E&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;B&amp;quot; id=&amp;quot;b2&amp;quot;&amp;gt;B2&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;G&amp;quot;&amp;gt;G&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;nbsp;&amp;nbsp;&amp;lt;li key=&amp;quot;D&amp;quot;&amp;gt;D&amp;lt;/li&amp;gt;&lt;br/&gt;
       &amp;lt;/ul&amp;gt;&lt;br/&gt;
   &lt;/div&gt;
   &lt;hr/&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="t8313.2 src\index.js">13.2 src\index.js <a href="#t8313.2 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-diff">import React from &apos;./react&apos;;
import ReactDOM from &apos;./react-dom&apos;;
//9.&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x4E0D;&#x540C;&#x3001;key&#x4E0D;&#x540C;
multi5.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;li key=&quot;B&quot; id=&quot;b&quot;&gt;B&lt;/li&gt;
      &lt;li key=&quot;C&quot;&gt;C&lt;/li&gt;
      &lt;li key=&quot;D&quot;&gt;D&lt;/li&gt;
      &lt;li key=&quot;E&quot;&gt;E&lt;/li&gt;
      &lt;li key=&quot;F&quot;&gt;F&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
multi5Update.addEventListener(&apos;click&apos;, () =&gt; {
  let element = (
    &lt;ul key=&quot;ul&quot;&gt;
      &lt;li key=&quot;A&quot;&gt;A&lt;/li&gt;
      &lt;li key=&quot;C&quot;&gt;C&lt;/li&gt;
      &lt;li key=&quot;E&quot;&gt;E&lt;/li&gt;
      &lt;li key=&quot;B&quot; id=&quot;b2&quot;&gt;B2&lt;/li&gt;
      &lt;li key=&quot;G&quot;&gt;G&lt;/li&gt;
      &lt;li key=&quot;D&quot;&gt;D&lt;/li&gt;
    &lt;/ul&gt;
  );
  ReactDOM.render(element, root);
});
</code></pre>
<h3 id="t8413.3 src\ReactChildFiber.js">13.3 src\ReactChildFiber.js <a href="#t8413.3 src\ReactChildFiber.js"> # </a></h3>
<p>src\ReactChildFiber.js</p>
<pre><code class="lang-diff">import { Placement, Deletion } from &apos;./ReactFiberFlags&apos;;
import { createFiberFromElement, createWorkInProgress } from &apos;./ReactFiber&apos;;
import { REACT_ELEMENT_TYPE } from &apos;./ReactSymbols&apos;;
function ChildReconciler(shouldTrackSideEffects) {
    function placeSingleChild(newFiber) {
        //&#x5982;&#x679C;&#x8981;&#x8DDF;&#x8E2A;&#x526F;&#x4F5C;&#x7528;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x8001;&#x7684;fiber&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x65B0;&#x5EFA;
        if (shouldTrackSideEffects &amp;&amp; !newFiber.alternate) {
            newFiber.flags = Placement;
        }
        return newFiber;
    }
    function deleteChild(returnFiber, childToDelete) {
        if (!shouldTrackSideEffects) {
            return;
        }
        //&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x7236;&#x4EB2;&#x5F85;&#x5220;&#x9664;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E2D;
        const last = returnFiber.lastEffect;
        if (last) {//&#x5982;&#x679C;&#x7236;&#x4EB2;&#x6709;&#x5C3E;&#x90E8;&#xFF0C;&#x5C31;&#x628A;&#x6B64;fiber&#x6DFB;&#x52A0;&#x5230;&#x5C3E;&#x90E8;&#x7684;nextEffect&#x4E0A;
            last.nextEffect = childToDelete;
            //&#x7136;&#x540E;&#x8BA9;&#x7236;&#x4EB2;&#x7684;&#x5C3E;&#x90E8;&#x7B49;&#x4E8E;&#x81EA;&#x5DF1;
            returnFiber.lastEffect = childToDelete;
        } else {
            //&#x5982;&#x679C;&#x7236;&#x4EB2;&#x7684;&#x526F;&#x4F5C;&#x7528;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;&#xFF0C;&#x5934;&#x548C;&#x5C3E;&#x5411;childToDelete
            returnFiber.firstEffect = returnFiber.lastEffect = childToDelete;
        }
        //&#x6E05;&#x7A7A;&#x5B83;&#x7684;nextEffect
        childToDelete.nextEffect = null;
        //&#x628A;&#x6B64;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;
        childToDelete.flags = Deletion;
    }
    function deleteRemainingChildren(returnFiber, currentFirstChild) {
        let childToDelete = currentFirstChild;
        while (childToDelete) {
            deleteChild(returnFiber, childToDelete);
            childToDelete = childToDelete.sibling;
        }
        return null;
    }
    /**
  * &#x590D;&#x7528;&#x8001;&#x7684;fiber
  * @param {*} fiber &#x8001;fiber
  * @param {*} pendingProps &#x65B0;&#x5C5E;&#x6027;
  * @returns 
  */
    function useFiber(fiber, pendingProps) {
        //&#x6839;&#x636E;&#x8001;&#x7684;fiber&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber
        return createWorkInProgress(fiber, pendingProps);
    }
    /**
     * &#x5355;&#x8282;&#x70B9;DIFF
     * @param {*} returnFiber &#x5F53;&#x524D;&#x7236;&#x4EB2;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;&#x8282;fiber
     * @param {*} element JSX&#x865A;&#x62DF;DOM
     * @returns 
     */
    function reconcileSingleElement(returnFiber, currentFirstChild, element) {
        //&#x65B0;jsx&#x5143;&#x7D20;&#x7684;key
        const key = element.key;
        //&#x7B2C;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        let child = currentFirstChild;
        //&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
        while (child) {
            //&#x5148;&#x5224;&#x65AD;&#x4E24;&#x8005;&#x7684;key&#x662F;&#x76F8;&#x540C;
            if (child.key <span class="hljs-comment">=== key) {</span>
                //&#x518D;&#x5224;&#x65AD;&#x7C7B;&#x578B;&#x662F;&#x5426;&#x76F8;&#x540C;,&#x5982;&#x679C;&#x76F8;&#x540C;
                if (child.type <span class="hljs-comment">=== element.type) {</span>
                    //&#x5220;&#x9664;&#x5269;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x7684;&#x8001;fiber&#x8282;&#x70B9;
                    deleteRemainingChildren(returnFiber, child.sibling);
                    //&#x590D;&#x7528;&#x8FD9;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;,&#x5E76;&#x4F20;&#x9012;&#x65B0;&#x7684;&#x5C5E;&#x6027;
                    const existing = useFiber(child, element.props);
                    //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
                    existing.return = returnFiber;
                    //&#x8FD4;&#x56DE;&#x590D;&#x7528;&#x7684;fiber
                    return existing;
                } else {
                    //&#x5982;&#x679C;key&#x76F8;&#x540C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4E0D;&#x518D;&#x8FDB;&#x884C;&#x540E;&#x7EED;&#x5339;&#x914D;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x5168;&#x90E8;&#x5220;&#x9664;
                    deleteRemainingChildren(returnFiber, child);
                    break;
                }
            } else {
                //&#x5982;&#x679C;key&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5219;&#x628A;&#x5F53;&#x524D;&#x7684;&#x8001;fiber&#x6807;&#x8BB0;&#x4E3A;&#x5220;&#x9664;&#xFF0C;&#x7EE7;&#x7EED;&#x5339;&#x914D;&#x5F1F;&#x5F1F;
                deleteChild(returnFiber, child);
            }
            //&#x627E;&#x5F1F;&#x5F1F;&#x7EE7;&#x7EED;&#x5339;&#x914D;
            child = child.sibling;
        }
        //&#x6839;&#x636E;&#x865A;&#x62DF;DOM&#x521B;&#x5EFA;fiber&#x8282;&#x70B9;
        const created = createFiberFromElement(element);
        //&#x8BA9;&#x65B0;&#x7684;fiber&#x7684;return&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;&#x7236;fiber
        created.return = returnFiber;
        return created;
    }
    function createChild(returnFiber, newChild) {
        if (typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; newChild) {</span>
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE: {
                    const created = createFiberFromElement(newChild);
                    created.return = returnFiber;
                    return created;
                }
                default:
                    break;
            }
        }
    }
    /**
     * &#x66F4;&#x65B0;&#x5143;&#x7D20;
     * @param {*} returnFiber &#x7236;fiber
     * @param {*} current &#x8001;&#x7684;&#x7684;&#x5B50;fiber&#x8282;&#x70B9;
     * @param {*} element &#x65B0;&#x7684;JSX&#x8282;&#x70B9;
     * @returns 
     */
    function updateElement(returnFiber, current, element) {
        //&#x5982;&#x679C;&#x8001;fiber&#x5B58;&#x5728;
        if (current) {
            //&#x800C;&#x4E14;&#x65B0;&#x8001;type&#x7C7B;&#x578B;&#x4E5F;&#x4E00;&#x6837;
            if (current.type <span class="hljs-comment">=== element.type) {</span>
                //&#x590D;&#x7528;&#x8001;&#x7684;fiber
                const existing = useFiber(current, element.props);
                existing.return = returnFiber;
                return existing;
            }
        }
        //&#x5982;&#x679C;&#x8001;fiber&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x65B0;&#x7684;fiber
        const created = createFiberFromElement(element);
        created.return = returnFiber;
        return created;
    }
    function updateSlot(returnFiber, oldFiber, newChild) {
        //&#x83B7;&#x53D6;&#x8001;fiber&#x8282;&#x70B9;&#x7684;key
        const key = oldFiber ? oldFiber.key : null;
        //&#x5982;&#x679C;&#x65B0;&#x7684;JSX&#x5B50;&#x8282;&#x70B9;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;
        if (typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; newChild) {</span>
            //&#x5982;&#x679C;&#x65B0;&#x8001;key&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x5219;&#x8868;&#x793A;&#x627E;&#x5230;&#x4E86;&#x53EF;&#x590D;&#x7528;&#x7684;&#x8282;&#x70B9;
            if (newChild.key <span class="hljs-comment">=== key) {</span>
                return updateElement(returnFiber, oldFiber, newChild);
            } else {
                //key&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x4E0D;&#x80FD;&#x590D;&#x7528;
                return null;
            }
        }
    }
<span class="hljs-addition">+   function placeChild(newFiber, lastPlacedIndex, newIndex) {</span>
        newFiber.index = newIndex;
        if (!shouldTrackSideEffects) {
<span class="hljs-addition">+           return lastPlacedIndex;</span>
        }
        const current = newFiber.alternate;
        if (current) {
<span class="hljs-addition">+           const oldIndex = current.index;</span>
<span class="hljs-addition">+           if (oldIndex &lt; lastPlacedIndex) {</span>
<span class="hljs-addition">+               //&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x79FB;&#x52A8;&#x64CD;&#x4F5C;</span>
<span class="hljs-addition">+               newFiber.flags = Placement;</span>
<span class="hljs-addition">+               return lastPlacedIndex;</span>
<span class="hljs-addition">+           } else {</span>
<span class="hljs-addition">+               //&#x8FD9;&#x4E2A;&#x9879;&#x76EE;&#x53EF;&#x4EE5;&#x4FDD;&#x7559;&#x5728;&#x539F;&#x5730;</span>
<span class="hljs-addition">+               return oldIndex;</span>
<span class="hljs-addition">+           }</span>
        } else {
            newFiber.flags = Placement;
<span class="hljs-addition">+           return lastPlacedIndex;</span>
        }
    }
<span class="hljs-addition">+   function updateFromMap(existingChildren, returnFiber, newIdx, newChild) {</span>
<span class="hljs-addition">+       if (typeof newChild === &apos;object&apos; &amp;&amp; newChild) {</span>
<span class="hljs-addition">+           switch (newChild.$$typeof) {</span>
<span class="hljs-addition">+               case REACT_ELEMENT_TYPE: {</span>
<span class="hljs-addition">+                   const matchedFiber =</span>
<span class="hljs-addition">+                       existingChildren.get(newChild.key || newIdx) || null;</span>
<span class="hljs-addition">+                   return updateElement(returnFiber, matchedFiber, newChild);</span>
<span class="hljs-addition">+               }</span>
<span class="hljs-addition">+               default:</span>
<span class="hljs-addition">+                   break;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       return null;</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   function mapRemainingChildren(returnFiber, currentFirstChild,) {</span>
<span class="hljs-addition">+       //&#x5C06;&#x5269;&#x4F59;&#x7684;&#x5B50;&#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x5230;&#x4E34;&#x65F6;map&#x4E2D;&#x4EE5;&#x4FBF;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;key&#x5FEB;&#x901F;&#x627E;&#x5230;&#x5B83;&#x4EEC;</span>
<span class="hljs-addition">+       //&#x9690;&#x5F0F;&#x7684;key&#x503C;&#x4E3A;null&#x7684;&#x8BDD;&#x4F1A;&#x4F7F;&#x7528;&#x7D22;&#x5F15;&#x4F5C;</span>
<span class="hljs-addition">+       const existingChildren = new Map();</span>
<span class="hljs-addition">+       let existingChild = currentFirstChild;</span>
<span class="hljs-addition">+       while (existingChild) {</span>
<span class="hljs-addition">+           if (existingChild.key) {</span>
<span class="hljs-addition">+               existingChildren.set(existingChild.key, existingChild);</span>
<span class="hljs-addition">+           } else {</span>
<span class="hljs-addition">+               existingChildren.set(existingChild.index, existingChild);</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+           existingChild = existingChild.sibling;</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       return existingChildren;</span>
<span class="hljs-addition">+   }</span>
    /**
     * &#x534F;&#x8C03;&#x5B50;&#x8282;&#x70B9;
     * @param {*} returnFiber &#x7236;fiber
     * @param {*} currentFirstChild &#x5F53;&#x524D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5B50;fiber
     * @param {*} newChildren JSX&#x5BF9;&#x8C61;
     * @returns 
     */
    function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren) {
        //&#x8BE5;&#x7B97;&#x6CD5;&#x65E0;&#x6CD5;&#x901A;&#x8FC7;&#x4E24;&#x7AEF;&#x641C;&#x7D22;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x56E0;&#x4E3A;fiber&#x4E0A;&#x6CA1;&#x6709;&#x53CD;&#x5411;&#x6307;&#x9488;
        //&#x6211;&#x5728;&#x8BD5;&#x7740;&#x770B;&#x770B;&#x6211;&#x4EEC;&#x80FD;&#x7528;&#x8FD9;&#x4E2A;&#x6A21;&#x578B;&#x8D70;&#x591A;&#x8FDC;&#x3002;&#x5982;&#x679C;&#x5B83;&#x6700;&#x7EC8;&#x4E0D;&#x503C;&#x5F97;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7A0D;&#x540E;&#x6DFB;&#x52A0;&#x5B83;
        //&#x8FD4;&#x56DE;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;fiber&#x5B50;&#x8282;&#x70B9;
        let resultingFirstChild = null;
        //&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;&#x7684;fiber&#x8282;&#x70B9;
        let previousNewFiber = null;
        //&#x6BD4;&#x8F83;&#x4E2D;&#x7684;&#x65E7;&#x7684;fiber&#x8282;&#x70B9;
        let oldFiber = currentFirstChild;
<span class="hljs-addition">+       //&#x4E0A;&#x6B21;&#x4E0D;&#x9700;&#x8981;&#x79FB;&#x52A8;&#x7684;&#x653E;&#x7F6E;&#x7D22;&#x5F15;</span>
<span class="hljs-addition">+       let lastPlacedIndex = 0;</span>
        //&#x4E0B;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber
        let nextOldFiber = null;
        //&#x65B0;&#x7684;&#x7D22;&#x5F15;
        let newIdx = 0;
        //&#x5148;&#x5904;&#x7406;&#x8282;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x60C5;&#x51B5;
        for (; oldFiber &amp;&amp; newIdx &lt; newChildren.length; newIdx++) {
            //&#x5148;&#x7F13;&#x5B58;&#x4E0B;&#x4E0B;&#x4E00;&#x4E2A;&#x8001;&#x7684;fiber&#x8282;&#x70B9;
            nextOldFiber = oldFiber.sibling;
            //&#x66F4;&#x65B0;&#x590D;&#x7528;&#x7684;&#x65B0;fiber
            //&#x5224;&#x65AD;key&#x548C;type&#x662F;&#x5426;&#x76F8;&#x540C;&#xFF0C;&#x5982;&#x679C;&#x76F8;&#x540C;&#x8868;&#x793A;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF0C;newIdx++&#x540E;&#x548C;&#x4E0B;&#x4E00;&#x4E2A;oldFiber&#x6BD4;&#x8F83;
            const newFiber = updateSlot(returnFiber, oldFiber, newChildren[newIdx]);
            if (!newFiber) {
                break;
            }
            //&#x5982;&#x679C;&#x7C7B;&#x578B;&#x76F8;&#x540C;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x91CD;&#x7528;&#x73B0;&#x6709;fiber&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x5220;&#x9664;&#x73B0;&#x6709;&#x5B50;&#x7EA7;fiber
            if (oldFiber &amp;&amp; !(newFiber.alternate)) {
                deleteChild(returnFiber, oldFiber);
            }
            //&#x653E;&#x7F6E;&#x6B64;newFiber&#x5230;newIdx&#xFF0C;&#x5C31;&#x662F;&#x8BBE;&#x7F6E;newFiber&#x7684;index&#x7D22;&#x5F15;
<span class="hljs-addition">+           lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span>
            //&#x5982;&#x679C;previousNewFiber&#x4E0D;&#x5B58;&#x5728;&#x8868;&#x793A;&#x8FD9;&#x662F;&#x7B2C;&#x4E00;&#x4E2A;fiber
            if (!previousNewFiber) {
                resultingFirstChild = newFiber;
            } else {
                //&#x5426;&#x5219;&#x4E0A;&#x4E00;&#x4E2A;&#x65B0;fiber&#x7684;sibling&#x7B49;&#x4E8E;&#x8FD9;&#x4E2A;newFiber
                previousNewFiber.sibling = newFiber;
            }
            //&#x8BA9;&#x5F53;&#x524D;&#x7684;newFiber&#x7B49;&#x4E8E;previousNewFiber
            previousNewFiber = newFiber;
            //&#x4E0B;&#x4E00;&#x4E2A;&#x8001;fiber
            oldFiber = nextOldFiber;
        }
        //&#x5982;&#x679C;&#x65B0;&#x7684;&#x904D;&#x5386;&#x5B8C;&#x4E86;&#xFF0C;&#x5220;&#x9664;&#x6389;&#x6240;&#x6709;&#x8001;&#x7684;&#x5269;&#x4E0B;&#x7684;fiber&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;resultingFirstChild
        if (newIdx <span class="hljs-comment">=== newChildren.length) {</span>
            deleteRemainingChildren(returnFiber, oldFiber);
            return resultingFirstChild;
        }
        //&#x5982;&#x679C;&#x8001;fiber&#x5B8C;&#x6210;&#xFF0C;&#x65B0;&#x7684;JSX&#x6CA1;&#x6709;&#x5B8C;&#x6210;
        if (!oldFiber) {
            for (; newIdx &lt; newChildren.length; newIdx++) {
                debugger
                const newFiber = createChild(returnFiber, newChildren[newIdx]);
<span class="hljs-addition">+               lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span>
                if (!previousNewFiber) {
                    resultingFirstChild = newFiber;
                } else {
                    previousNewFiber.sibling = newFiber;
                }
                previousNewFiber = newFiber;
            }
            return resultingFirstChild;
        }
<span class="hljs-addition">+       //&#x5C06;&#x6240;&#x6709;&#x513F;&#x5B50;&#x6DFB;&#x52A0;&#x5230;key map&#x4EE5;&#x8FDB;&#x884C;&#x5FEB;&#x901F;&#x67E5;&#x627E;&#x3002;</span>
<span class="hljs-addition">+       const existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span>
<span class="hljs-addition">+       // Keep scanning and use the map to restore deleted items as moves.</span>
<span class="hljs-addition">+       //&#x7EE7;&#x7EED;&#x626B;&#x63CF;&#x5E76;&#x4F7F;&#x7528;map&#x5728;&#x79FB;&#x52A8;&#x65F6;&#x8FD8;&#x539F;&#x5DF2;&#x5220;&#x9664;&#x7684;&#x9879;&#x76EE;&#x3002;</span>
<span class="hljs-addition">+       for (; newIdx &lt; newChildren.length; newIdx++) {</span>
<span class="hljs-addition">+           const newFiber = updateFromMap(existingChildren, returnFiber, newIdx, newChildren[newIdx]);</span>
<span class="hljs-addition">+           if (newFiber) {</span>
<span class="hljs-addition">+               if (newFiber.alternate) {</span>
<span class="hljs-addition">+                   //&#x65B0;fiber&#x6B63;&#x5728;&#x5904;&#x7406;&#x4E2D;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x5B58;&#x5728;current</span>
<span class="hljs-addition">+                   //&#x8FD9;&#x610F;&#x5473;&#x7740;&#x6211;&#x4EEC;&#x91CD;&#x7528;&#x4E86;fiber&#x3002;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5220;&#x9664;&#x5B83;&#x4ECE;&#x5B50;&#x5217;&#x8868;&#x4E2D;&#x5220;&#x9664;</span>
<span class="hljs-addition">+                   //&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x4E0D;&#x4F1A;&#x5C06;&#x5176;&#x6DFB;&#x52A0;&#x5230;&#x5220;&#x9664;&#x5217;&#x8868;&#x4E2D;</span>
<span class="hljs-addition">+                   existingChildren.delete(newFiber.key || newIdx);</span>
<span class="hljs-addition">+               }</span>
<span class="hljs-addition">+               lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span>
<span class="hljs-addition">+               if (!previousNewFiber) {</span>
<span class="hljs-addition">+                   resultingFirstChild = newFiber;</span>
<span class="hljs-addition">+               } else {</span>
<span class="hljs-addition">+                   previousNewFiber.sibling = newFiber;</span>
<span class="hljs-addition">+               }</span>
<span class="hljs-addition">+               previousNewFiber = newFiber;</span>
<span class="hljs-addition">+           }</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       //&#x5DF2;&#x5220;&#x9664;&#x4E0A;&#x9762;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x6240;&#x6709;&#x73B0;&#x6709;&#x5B50;&#x9879;</span>
<span class="hljs-addition">+       //&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5C06;&#x5B83;&#x4EEC;&#x6DFB;&#x52A0;&#x5230;&#x5220;&#x9664;&#x5217;&#x8868;&#x4E2D;</span>
<span class="hljs-addition">+       existingChildren.forEach(child =&gt; deleteChild(returnFiber, child));</span>
        return resultingFirstChild;
    }
    function reconcileChildFibers(returnFiber, currentFirstChild, newChild) {
        const isObject = typeof newChild <span class="hljs-comment">=== &apos;object&apos; &amp;&amp; (newChild);</span>
        if (isObject) {
            switch (newChild.$$typeof) {
                case REACT_ELEMENT_TYPE:
                    return placeSingleChild(
                        reconcileSingleElement(returnFiber, currentFirstChild, newChild)
                    );
                default:
                    break;
            }
        }
        if (Array.isArray(newChild)) {
            return reconcileChildrenArray(returnFiber, currentFirstChild, newChild);
        }
    }
    return reconcileChildFibers;
}

export const reconcileChildFibers = ChildReconciler(true);
export const mountChildFibers = ChildReconciler(false);
</code></pre>
<h3 id="t8514.4 src\ReactFiberFlags.js">14.4 src\ReactFiberFlags.js <a href="#t8514.4 src\ReactFiberFlags.js"> # </a></h3>
<p>src\ReactFiberFlags.js</p>
<pre><code class="lang-diff">export const NoFlags = 0b000000000000000000;//0
export const Placement = 0b000000000000000010;//2
export const Update = 0b000000000000000100;//4
<span class="hljs-addition">+export const PlacementAndUpdate = 0b000000000000000110;</span>
export const Deletion = 0b000000000000001000;//8
</code></pre>
<h3 id="t8614.5 src\ReactFiberWorkLoop.js">14.5 src\ReactFiberWorkLoop.js <a href="#t8614.5 src\ReactFiberWorkLoop.js"> # </a></h3>
<p>src\ReactFiberWorkLoop.js</p>
<pre><code class="lang-diff">import { HostRoot, HostComponent } from &apos;./ReactWorkTags&apos;;
import { createWorkInProgress } from &apos;./ReactFiber&apos;;
import { beginWork } from &apos;./ReactFiberBeginWork&apos;;
import { completeWork } from &apos;./ReactFiberCompleteWork&apos;;
<span class="hljs-addition">+import { Placement, Update, Deletion, PlacementAndUpdate } from &apos;./ReactFiberFlags&apos;;</span>
import { commitWork } from &apos;./ReactFiberCommitWork&apos;;
//&#x6B63;&#x5728;&#x8C03;&#x5EA6;&#x7684;fiberRoot&#x6839;&#x8282;&#x70B9;
let workInProgressRoot = null;
//&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;fiber&#x8282;&#x70B9;
let workInProgress = null;
//&#x6700;&#x5927;&#x66F4;&#x65B0;&#x6DF1;&#x5EA6;
const NESTED_UPDATE_LIMIT = 50;
let nestedUpdateCount = 0;
/**
 * &#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
 * @param {*} sourceFiber &#x66F4;&#x65B0;&#x6765;&#x6E90;fiber
 * @returns 
 */
function markUpdateLaneFromFiberToRoot(sourceFiber) {
    let node = sourceFiber;
    let parent = node.return;
    //&#x4E00;&#x76F4;&#x5411;&#x4E0A;&#x627E;&#x7236;&#x4EB2;&#xFF0C;&#x627E;&#x4E0D;&#x5230;&#x4E3A;&#x6B62;
    while (parent) {
        node = parent;
        parent = parent.return;
    }
    //&#x5982;&#x679C;&#x627E;&#x5230;&#x7684;&#x662F;HostRoot&#x5C31;&#x8FD4;&#x56DE;FiberRootNode,&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5BB9;&#x5668;div#root
    if (node.tag <span class="hljs-comment">=== HostRoot) {</span>
        return node.stateNode;
    }
}
/**
 * &#x5411;&#x4E0A;&#x67E5;&#x627E;&#x5230;&#x6839;&#x8282;&#x70B9;&#x5F00;&#x59CB;&#x8C03;&#x5EA6;&#x66F4;&#x65B0;
 * @param {*} fiber 
 */
export function scheduleUpdateOnFiber(fiber) {
    checkForNestedUpdates();
    //&#x5411;&#x4E0A;&#x83B7;&#x53D6;HostRoot&#x8282;&#x70B9;
    const root = markUpdateLaneFromFiberToRoot(fiber);
    //&#x6267;&#x884C;HostRoot&#x4E0A;&#x7684;&#x66F4;&#x65B0;
    performSyncWorkOnRoot(root);
}
function checkForNestedUpdates() {
    if (++nestedUpdateCount &gt; NESTED_UPDATE_LIMIT) {
        throw new Error(&apos;Maximum update depth exceeded&apos;);
    }
}
/**
 * &#x5F00;&#x59CB;&#x6267;&#x884C;FiberRootNode&#x4E0A;&#x7684;&#x5DE5;&#x4F5C;
 * @param {*} root  FiberRootNode
 */
function performSyncWorkOnRoot(root) {
    //&#x5148;&#x8D4B;&#x503C;&#x7ED9;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x5DE5;&#x4F5C;&#x7684;FiberRootNode&#x6839;&#x8282;&#x70B9;
    workInProgressRoot = root;
    //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5904;&#x7406;&#x4E2D;&#x7684;fiber&#x8282;&#x70B9;
    workInProgress = createWorkInProgress(workInProgressRoot.current);
    workLoopSync();
    commitRoot();
}
function commitRoot(root) {
    //&#x6784;&#x5EFA;&#x6210;&#x529F;&#x7684;&#x65B0;&#x7684;fiber&#x6811;
    const finishedWork = workInProgressRoot.current.alternate;
    //&#x5F53;&#x524D;&#x5B8C;&#x6210;&#x7684;&#x6784;&#x5EFA;&#x5DE5;&#x4F5C;&#x7B49;&#x4E8E;finishedWork
    workInProgressRoot.finishedWork = finishedWork;
    commitMutationEffects(workInProgressRoot);
    nestedUpdateCount--;
}
function getFlag(flags) {
    switch (flags) {
        case Placement:
            return &apos;&#x6DFB;&#x52A0;&apos;;
        case Update:
            return &apos;&#x66F4;&#x65B0;&apos;;
<span class="hljs-addition">+       case PlacementAndUpdate:</span>
<span class="hljs-addition">+           return &apos;&#x79FB;&#x52A8;&#x66F4;&#x65B0;&apos;;</span>
        case Deletion:
            return &apos;&#x5220;&#x9664;&apos;;
    }
}
function commitMutationEffects(root) {
    const finishedWork = root.finishedWork;
    let nextEffect = finishedWork.firstEffect;
    let effectList = &apos;&apos;;
    while (nextEffect) {
        effectList += `(${getFlag(nextEffect.flags)}#${nextEffect.type}#${nextEffect.key})=&gt;`;
        const flags = nextEffect.flags;
        const current = nextEffect.alternate;
        if (flags <span class="hljs-comment">=== Placement) {</span>
            commitPlacement(nextEffect);
<span class="hljs-addition">+       } else if (flags === PlacementAndUpdate) {</span>
<span class="hljs-addition">+           commitPlacement(nextEffect);</span>
<span class="hljs-addition">+           nextEffect.flags &amp;= ~Placement;</span>
<span class="hljs-addition">+           commitWork(current, nextEffect);</span>
<span class="hljs-addition">+       } else if (flags === Update) {</span>
            commitWork(current, nextEffect);
        } else if (flags <span class="hljs-comment">=== Deletion) {</span>
            commitDeletion(nextEffect);
        }
        nextEffect = nextEffect.nextEffect;
    }
    effectList += &apos;null&apos;;
    console.log(effectList);
    root.current = finishedWork;
}
function commitDeletion(fiber) {
    if (!fiber) {
        return;
    }
    let parentStateNode = getParentStateNode(fiber);
    parentStateNode.removeChild(fiber.stateNode);
}
function commitPlacement(nextEffect) {
    let stateNode = nextEffect.stateNode;
    let parentStateNode = getParentStateNode(nextEffect);
    let before = getHostSibling(nextEffect);
    if (before) {
        parentStateNode.insertBefore(stateNode, before);
    } else {
        parentStateNode.appendChild(stateNode);
    }
}
function getHostSibling(fiber) {
    let node = fiber.sibling;
    while (node) {
        if (!(node.flags &amp; Placement)) {
            return node.stateNode;
        }
        node = node.sibling;
    }
    return null;
}
function getParentStateNode(fiber) {
    const parent = fiber.return;
    do {
        if (parent.tag <span class="hljs-comment">=== HostComponent) {</span>
            return parent.stateNode;
        } else if (parent.tag <span class="hljs-comment">=== HostRoot) {</span>
            return parent.stateNode.containerInfo
        }
        parent = parent.return;
    } while (parent);
}
function workLoopSync() {
    while (workInProgress) {
        performUnitOfWork(workInProgress);
    }
}
/**
 * &#x6267;&#x884C;&#x5355;&#x4E2A;&#x5DE5;&#x4F5C;&#x5355;&#x5143;
 * @param {*} unitOfWork &#x5355;&#x4E2A;fiber
 */
function performUnitOfWork(unitOfWork) {
    //&#x83B7;&#x53D6;&#x5F53;&#x524D;fiber&#x7684;alternate
    const current = unitOfWork.alternate;
    //&#x5F00;&#x59CB;&#x6784;&#x5EFA;&#x6B64;fiber&#x7684;&#x5B50;fiter&#x94FE;&#x8868;
    let next = beginWork(current, unitOfWork);
    //&#x66F4;&#x65B0;&#x5C5E;&#x6027;
    unitOfWork.memoizedProps = unitOfWork.pendingProps;
    //&#x5982;&#x679C;&#x6709;&#x5B50;fiber&#xFF0C;&#x5C31;&#x7EE7;&#x7EED;&#x6267;&#x884C;
    if (next) {
        workInProgress = next;
    } else {
        //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5B50;fiber&#xFF0C;&#x5C31;&#x5B8C;&#x6210;&#x5F53;&#x524D;&#x7684;fiber
        completeUnitOfWork(unitOfWork);
    }
}

function completeUnitOfWork(unitOfWork) {
    //&#x5C1D;&#x8BD5;&#x5B8C;&#x6210;&#x5F53;&#x524D;&#x7684;&#x5DE5;&#x4F5C;&#x5355;&#x5143;&#xFF0C;&#x7136;&#x540E;&#x79FB;&#x52A8;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x5F1F;&#x5F1F;
    //&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4E0B;&#x4E00;&#x4E2A;&#x5F1F;&#x5F1F;&#xFF0C;&#x8FD4;&#x56DE;&#x5230;&#x7236;Fiber
    let completedWork = unitOfWork;
    do {
        const current = completedWork.alternate;
        const returnFiber = completedWork.return;
        completeWork(current, completedWork);
        collectEffectList(returnFiber, completedWork)
        const siblingFiber = completedWork.sibling;
        if (siblingFiber) {
            //&#x5982;&#x679C;&#x6B64; returnFiber &#x4E2D;&#x8FD8;&#x6709;&#x66F4;&#x591A;&#x5DE5;&#x4F5C;&#x8981;&#x505A;&#xFF0C;&#x8BF7;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x6B65;
            workInProgress = siblingFiber;
            return;
        }
        //&#x5426;&#x5219;&#xFF0C;&#x8FD4;&#x56DE;&#x7236;&#x7EA7;
        completedWork = returnFiber;
        //&#x66F4;&#x65B0;&#x6211;&#x4EEC;&#x6B63;&#x5728;&#x5904;&#x7406;&#x7684;&#x4E0B;&#x4E00;&#x4EF6;&#x4E8B;
        workInProgress = completedWork;
    } while (completedWork);
}
function collectEffectList(returnFiber, completedWork) {
    if (returnFiber) {
        if (!returnFiber.firstEffect) {
            returnFiber.firstEffect = completedWork.firstEffect;
        }
        if (completedWork.lastEffect) {
            if (returnFiber.lastEffect) {
                returnFiber.lastEffect.nextEffect = completedWork.firstEffect;
            }
            returnFiber.lastEffect = completedWork.lastEffect;
        }
        //&#x5982;&#x679C;&#x8FD9;&#x4E2A;fiber&#x6709;&#x526F;&#x4F5C;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5728;&#x5B69;&#x5B50;&#x4EEC;&#x7684;&#x526F;&#x4F7F;&#x7528;&#x540E;&#x9762;&#x6DFB;&#x52A0;&#x5B83;&#x81EA;&#x5DF1;&#x7684;&#x526F;&#x4F5C;&#x7528;
        const flags = completedWork.flags;
        if (flags) {
            if (returnFiber.lastEffect) {
                returnFiber.lastEffect.nextEffect = completedWork;
            } else {
                returnFiber.firstEffect = completedWork;
            }
            returnFiber.lastEffect = completedWork;
        }
    }
}
</code></pre>

    </div>
</div>
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog"
    aria-labelledby="loginModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                    aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="loginModalLabel">请登录</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="username" class="control-label">姓名:</label>
                        <input type="text" class="form-control" id="username" placeholder="珠峰架构VIP会员系统用户名">
                    </div>
                    <div class="form-group">
                        <label for="password" class="control-label">密码:</label>
                        <input type="text" class="form-control" id="password" placeholder="珠峰架构VIP会员系统密码">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                    data-dismiss="modal">登录</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>
$('.warpper .page-toc ul ul li a').on('click',function(){
  $('.warpper .page-toc ul ul li a').removeClass('my-active')
  $(this).addClass('my-active')
})
$('.logo').on('mouseenter',function(){
  $('.nav').height('450px');
})
$('.nav').on('mouseleave',function(){
  $('.nav').height('80px');
})
$('.logo').on('click',function(){
  // $(".nav").css("display", "none");
 $('.warpper').css('padding','0px');
})
</script><script type="text/javascript" src="../static/js/theme.js"></script>
</body>
</html>
