<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>架构师成长计划</title>
    <link rel="stylesheet" type="text/css" href="../static/css/main.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" >
    <style>
        .page-toc > ul .red {
            background: #f3f3f3;
            z-index: 1;
            border-left: 3px solid #009a61;
            -webkit-transition: all .2s ease;
            transition: all .2s ease;
            color: #000
        }
    </style>
</head>
<body>
<div class="nav">
  <div class="logo">架构师成长计划</div>
  <ul>
    <li><a href="../index.html">0.api</a></li>
    <li><a href="../html/0.Async.html">0.Async</a></li>
    <li><a href="../html/0.module.html">0.module</a></li>
    <li><a href="../html/1.ES2015.html">1.ES2015</a></li>
    <li><a href="../html/2.Promise.html">2.Promise</a></li>
    <li><a href="../html/3.Node.html">3.Node</a></li>
    <li><a href="../html/4.NodeInstall.html">4.NodeInstall</a></li>
    <li><a href="../html/5.REPL.html">5.REPL</a></li>
    <li><a href="../html/6.NodeCore.html">6.NodeCore</a></li>
    <li><a href="../html/7.module&NPM.html">7.module&NPM</a></li>
    <li><a href="../html/8.Encoding.html">8.Encoding</a></li>
    <li><a href="../html/9.Buffer.html">9.Buffer</a></li>
    <li><a href="../html/10.fs.html">10.fs</a></li>
    <li><a href="../html/11.Stream-1.html">11.Stream-1</a></li>
    <li><a href="../html/11.Stream-2.html">11.Stream-2</a></li>
    <li><a href="../html/11.Stream-3.html">11.Stream-3</a></li>
    <li><a href="../html/11.Stream-4.html">11.Stream-4</a></li>
    <li><a href="../html/12-Network-2.html">12-Network-2</a></li>
    <li><a href="../html/12.NetWork-3.html">12.NetWork-3</a></li>
    <li><a href="../html/12.Network-1.html">12.Network-1</a></li>
    <li><a href="../html/13.tcp.html">13.tcp</a></li>
    <li><a href="../html/14.http-1.html">14.http-1</a></li>
    <li><a href="../html/14.http-2.html">14.http-2</a></li>
    <li><a href="../html/15.compress.html">15.compress</a></li>
    <li><a href="../html/16.crypto.html">16.crypto</a></li>
    <li><a href="../html/17.process.html">17.process</a></li>
    <li><a href="../html/18.yargs.html">18.yargs</a></li>
    <li><a href="../html/19.cache.html">19.cache</a></li>
    <li><a href="../html/20.action.html">20.action</a></li>
    <li><a href="../html/21.https.html">21.https</a></li>
    <li><a href="../html/22.cookie.html">22.cookie</a></li>
    <li><a href="../html/23.session.html">23.session</a></li>
    <li><a href="../html/24.express-1.html">24.express-1</a></li>
    <li><a href="../html/24.express-2.html">24.express-2</a></li>
    <li><a href="../html/24.express-3.html">24.express-3</a></li>
    <li><a href="../html/24.express-4.html">24.express-4</a></li>
    <li><a href="../html/25.koa-1.html">25.koa-1</a></li>
    <li><a href="../html/26.webpack-1-basic.html">26.webpack-1-basic</a></li>
    <li>
      <a href="../html/26.webpack-2-optimize.html">26.webpack-2-optimize</a>
    </li>
    <li><a href="../html/26.webpack-3-file.html">26.webpack-3-file</a></li>
    <li>
      <a href="../html/26.webpack-4.tapable.html">26.webpack-4.tapable</a>
    </li>
    <li><a href="../html/26.webpack-5-AST.html">26.webpack-5-AST</a></li>
    <li>
      <a href="../html/26.webpack-6-sources.html">26.webpack-6-sources</a>
    </li>
    <li><a href="../html/26.webpack-7-loader.html">26.webpack-7-loader</a></li>
    <li><a href="../html/26.webpack-8-plugin.html">26.webpack-8-plugin</a></li>
    <li><a href="../html/26.webpack-9-hand.html">26.webpack-9-hand</a></li>
    <li>
      <a href="../html/26.webpack-10-prepare.html">26.webpack-10-prepare</a>
    </li>
    <li><a href="../html/28.redux.html">28.redux</a></li>
    <li><a href="../html/28.redux-jwt-back.html">28.redux-jwt-back</a></li>
    <li><a href="../html/28.redux-jwt-front.html">28.redux-jwt-front</a></li>
    <li><a href="../html/29.mongodb-1.html">29.mongodb-1</a></li>
    <li><a href="../html/29.mongodb-2.html">29.mongodb-2</a></li>
    <li><a href="../html/29.mongodb-3.html">29.mongodb-3</a></li>
    <li><a href="../html/29.mongodb-4.html">29.mongodb-4</a></li>
    <li><a href="../html/29.mongodb-5.html">29.mongodb-5</a></li>
    <li><a href="../html/29.mongodb-6.html">29.mongodb-6</a></li>
    <li><a href="../html/30.cms-1-mysql.html">30.cms-1-mysql</a></li>
    <li><a href="../html/30.cms-2-mysql.html">30.cms-2-mysql</a></li>
    <li><a href="../html/30.cms-3-mysql.html">30.cms-3-mysql</a></li>
    <li><a href="../html/30.cms-4-nunjucks.html">30.cms-4-nunjucks</a></li>
    <li><a href="../html/30.cms-5-mock.html">30.cms-5-mock</a></li>
    <li><a href="../html/30.cms-6-egg.html">30.cms-6-egg</a></li>
    <li><a href="../html/30.cms-7-api.html">30.cms-7-api</a></li>
    <li><a href="../html/30.cms-8-roadhog.html">30.cms-8-roadhog</a></li>
    <li><a href="../html/30.cms-9-yaml.html">30.cms-9-yaml</a></li>
    <li><a href="../html/30.cms-10-umi.html">30.cms-10-umi</a></li>
    <li><a href="../html/30.cms-12-dva.html">30.cms-12-dva</a></li>
    <li><a href="../html/30.cms-13-dva-ant.html">30.cms-13-dva-ant</a></li>
    <li><a href="../html/30.cms-14-front.html">30.cms-14-front</a></li>
    <li><a href="../html/30.cms-15-deploy.html">30.cms-15-deploy</a></li>
    <li><a href="../html/31.dva.html">31.dva</a></li>
    <li>
      <a href="../html/31.cms-13-dva-antdesign.html">31.cms-13-dva-antdesign</a>
    </li>
    <li><a href="../html/33.redis.html">33.redis</a></li>
    <li><a href="../html/34.unittest.html">34.unittest</a></li>
    <li><a href="../html/35.jwt.html">35.jwt</a></li>
    <li><a href="../html/36.websocket-1.html">36.websocket-1</a></li>
    <li><a href="../html/36.websocket-2.html">36.websocket-2</a></li>
    <li><a href="../html/38.chat-api-1.html">38.chat-api-1</a></li>
    <li><a href="../html/38.chat-api-2.html">38.chat-api-2</a></li>
    <li><a href="../html/38.chat-3.html">38.chat-3</a></li>
    <li><a href="../html/38.chat-api-3.html">38.chat-api-3</a></li>
    <li><a href="../html/38.chat.html">38.chat</a></li>
    <li><a href="../html/38.chat2.html">38.chat2</a></li>
    <li><a href="../html/38.chat2.html">38.chat2</a></li>
    <li><a href="../html/39.crawl-0.html">39.crawl-0</a></li>
    <li><a href="../html/39.crawl-1.html">39.crawl-1</a></li>
    <li><a href="../html/39.crawl-2.html">39.crawl-2</a></li>
    <li><a href="../html/40.deploy.html">40.deploy</a></li>
    <li><a href="../html/41.safe.html">41.safe</a></li>
    <li><a href="../html/42.test.html">42.test</a></li>
    <li><a href="../html/43.nginx.html">43.nginx</a></li>
    <li><a href="../html/44.enzyme.html">44.enzyme</a></li>
    <li><a href="../html/45.docker.html">45.docker</a></li>
    <li><a href="../html/46.elastic.html">46.elastic</a></li>
    <li><a href="../html/47.oauth.html">47.oauth</a></li>
    <li><a href="../html/48.wxpay.html">48.wxpay</a></li>
    <li><a href="../html/index.html">index</a></li>
    <li><a href="../html/52.UML.html">52.UML</a></li>
    <li><a href="../html/53.design.html">53.design</a></li>
    <li><a href="../html/index.html">index</a></li>
    <li><a href="../html/54.linux.html">54.linux</a></li>
    <li><a href="../html/57.ts.html">57.ts</a></li>
    <li><a href="../html/56.react-ssr.html">56.react-ssr</a></li>
    <li><a href="../html/58.ts_react.html">58.ts_react</a></li>
    <li><a href="../html/59.ketang.html">59.ketang</a></li>
    <li><a href="../html/59.ketang2.html">59.ketang2</a></li>
    <li><a href="../html/61.1.devops-linux.html">61.1.devops-linux</a></li>
    <li><a href="../html/61.2.devops-vi.html">61.2.devops-vi</a></li>
    <li><a href="../html/61.3.devops-user.html">61.3.devops-user</a></li>
    <li><a href="../html/61.4.devops-auth.html">61.4.devops-auth</a></li>
    <li><a href="../html/61.5.devops-shell.html">61.5.devops-shell</a></li>
    <li><a href="../html/61.6.devops-install.html">61.6.devops-install</a></li>
    <li><a href="../html/61.7.devops-system.html">61.7.devops-system</a></li>
    <li><a href="../html/61.8.devops-service.html">61.8.devops-service</a></li>
    <li><a href="../html/61.9.devops-network.html">61.9.devops-network</a></li>
    <li><a href="../html/61.10.devops-nginx.html">61.10.devops-nginx</a></li>
    <li><a href="../html/61.11.devops-docker.html">61.11.devops-docker</a></li>
    <li><a href="../html/61.12.devops-jekins.html">61.12.devops-jekins</a></li>
    <li><a href="../html/61.13.devops-groovy.html">61.13.devops-groovy</a></li>
    <li><a href="../html/61.14.devops-php.html">61.14.devops-php</a></li>
    <li><a href="../html/61.15.devops-java.html">61.15.devops-java</a></li>
    <li><a href="../html/61.16.devops-node.html">61.16.devops-node</a></li>
    <li><a href="../html/61.17.devops-k8s.html">61.17.devops-k8s</a></li>
    <li><a href="../html/62.1.react-basic.html">62.1.react-basic</a></li>
    <li><a href="../html/62.2.react-state.html">62.2.react-state</a></li>
    <li><a href="../html/62.3.react-high.html">62.3.react-high</a></li>
    <li><a href="../html/62.4.react-optimize.html">62.4.react-optimize</a></li>
    <li><a href="../html/62.5.react-hooks.html">62.5.react-hooks</a></li>
    <li>
      <a href="../html/62.6.react-immutable.html">62.6.react-immutable</a>
    </li>
    <li><a href="../html/62.7.react-mobx.html">62.7.react-mobx</a></li>
    <li><a href="../html/62.8.react-source.html">62.8.react-source</a></li>
    <li><a href="../html/63.1.redux.html">63.1.redux</a></li>
    <li>
      <a href="../html/63.2.redux-middleware.html">63.2.redux-middleware</a>
    </li>
    <li><a href="../html/63.3.redux-hooks.html">63.3.redux-hooks</a></li>
    <li><a href="../html/63.4.redux-saga.html">63.4.redux-saga</a></li>
    <li>
      <a href="../html/63.5.redux-saga-hand.html">63.5.redux-saga-hand</a>
    </li>
    <li><a href="../html/64.1.router.html">64.1.router</a></li>
    <li>
      <a href="../html/64.2.router-connected.html">64.2.router-connected</a>
    </li>
    <li><a href="../html/65.1.typescript.html">65.1.typescript</a></li>
    <li><a href="../html/65.2.typescript.html">65.2.typescript</a></li>
    <li><a href="../html/65.3.typescript.html">65.3.typescript</a></li>
    <li><a href="../html/65.4.antd.html">65.4.antd</a></li>
    <li><a href="../html/65.4.definition.html">65.4.definition</a></li>
    <li><a href="../html/66-1.vue-base.html">66-1.vue-base</a></li>
    <li><a href="../html/66-2.vue-component.html">66-2.vue-component</a></li>
    <li><a href="../html/66-3.vue-cli3.0.html">66-3.vue-cli3.0</a></li>
    <li><a href="../html/66-4.$message组件.html">66-4.$message组件</a></li>
    <li><a href="../html/66-5.Form组件.html">66-5.Form组件</a></li>
    <li><a href="../html/66-6.tree.html">66-6.tree</a></li>
    <li>
      <a href="../html/66-7.vue-router-apply.html">66-7.vue-router-apply</a>
    </li>
    <li><a href="../html/66-8.axios-apply.html">66-8.axios-apply</a></li>
    <li><a href="../html/66-9.vuex-apply.html">66-9.vuex-apply</a></li>
    <li><a href="../html/66-10.jwt-vue.html">66-10.jwt-vue</a></li>
    <li><a href="../html/66-11.vue-ssr.html">66-11.vue-ssr</a></li>
    <li><a href="../html/66-12.nuxt-apply.html">66-12.nuxt-apply</a></li>
    <li><a href="../html/66-13.pwa.html">66-13.pwa</a></li>
    <li><a href="../html/66-14.vue单元测试.html">66-14.vue单元测试</a></li>
    <li><a href="../html/66-15.权限校验.html">66-15.权限校验</a></li>
    <li><a href="../html/67-1-network.html">67-1-network</a></li>
    <li><a href="../html/68-2-wireshark.html">68-2-wireshark</a></li>
    <li><a href="../html/7.npm2.html">7.npm2</a></li>
    <li><a href="../html/69-hooks.html">69-hooks</a></li>
    <li><a href="../html/70-deploy.html">70-deploy</a></li>
    <li><a href="../html/71-hmr.html">71-hmr</a></li>
    <li><a href="../html/72.deploy.html">72.deploy</a></li>
    <li><a href="../html/73.import.html">73.import</a></li>
    <li><a href="../html/74.mobile.html">74.mobile</a></li>
    <li>
      <a href="../html/75.webpack-1.文件分析.html">75.webpack-1.文件分析</a>
    </li>
    <li><a href="../html/75.webpack-2.loader.html">75.webpack-2.loader</a></li>
    <li>
      <a href="../html/75.webpack-3.源码流程.html">75.webpack-3.源码流程</a>
    </li>
    <li>
      <a href="../html/75.webpack-4.tapable.html">75.webpack-4.tapable</a>
    </li>
    <li>
      <a href="../html/75.webpack-5.prepare.html">75.webpack-5.prepare</a>
    </li>
    <li>
      <a href="../html/75.webpack-6.resolve.html">75.webpack-6.resolve</a>
    </li>
    <li><a href="../html/75.webpack-7.loader.html">75.webpack-7.loader</a></li>
    <li><a href="../html/75.webpack-8.module.html">75.webpack-8.module</a></li>
    <li><a href="../html/75.webpack-9.chunk.html">75.webpack-9.chunk</a></li>
    <li><a href="../html/75.webpack-10.asset.html">75.webpack-10.asset</a></li>
    <li><a href="../html/75.webpack-11.实现.html">75.webpack-11.实现</a></li>
    <li><a href="../html/76.react_optimize.html">76.react_optimize</a></li>
    <li><a href="../html/77.ts_ketang_back.html">77.ts_ketang_back</a></li>
    <li><a href="../html/77.ts_ketang_front.html">77.ts_ketang_front</a></li>
    <li><a href="../html/78.vue-domdiff.html">78.vue-domdiff</a></li>
    <li><a href="../html/79.grammar.html">79.grammar</a></li>
    <li><a href="../html/80.tree.html">80.tree</a></li>
    <li><a href="../html/81.axios.html">81.axios</a></li>
    <li><a href="../html/82.1.react.html">82.1.react</a></li>
    <li><a href="../html/82.2.react-high.html">82.2.react-high</a></li>
    <li><a href="../html/82.3.react-router.html">82.3.react-router</a></li>
    <li><a href="../html/82.4.redux.html">82.4.redux</a></li>
    <li>
      <a href="../html/82.5.redux_middleware.html">82.5.redux_middleware</a>
    </li>
    <li><a href="../html/82.6.connected.html">82.6.connected</a></li>
    <li><a href="../html/82.7.saga.html">82.7.saga</a></li>
    <li><a href="../html/82.8.dva.html">82.8.dva</a></li>
    <li><a href="../html/82.8.dva-source.html">82.8.dva-source</a></li>
    <li><a href="../html/82.9.roadhog.html">82.9.roadhog</a></li>
    <li><a href="../html/82.10.umi.html">82.10.umi</a></li>
    <li><a href="../html/82.11.antdesign.html">82.11.antdesign</a></li>
    <li><a href="../html/82.12.ketang-front.html">82.12.ketang-front</a></li>
    <li><a href="../html/82.12.ketang-back.html">82.12.ketang-back</a></li>
    <li><a href="../html/83.upload.html">83.upload</a></li>
    <li><a href="../html/84.graphql.html">84.graphql</a></li>
    <li><a href="../html/85.antpro.html">85.antpro</a></li>
    <li><a href="../html/86.1.uml.html">86.1.uml</a></li>
    <li><a href="../html/86.2.design.html">86.2.design</a></li>
    <li><a href="../html/87.postcss.html">87.postcss</a></li>
    <li><a href="../html/88.react16-1.html">88.react16-1</a></li>
    <li><a href="../html/89.nextjs.html">89.nextjs</a></li>
    <li><a href="../html/90.react-test.html">90.react-test</a></li>
    <li><a href="../html/91.react-ts.html">91.react-ts</a></li>
    <li><a href="../html/92.rbac.html">92.rbac</a></li>
    <li><a href="../html/93.tsnode.html">93.tsnode</a></li>
    <li><a href="../html/94.1.JavaScript.html">94.1.JavaScript</a></li>
    <li><a href="../html/94.2.JavaScript.html">94.2.JavaScript</a></li>
    <li><a href="../html/94.3.MODULE.html">94.3.MODULE</a></li>
    <li><a href="../html/94.4.EventLoop.html">94.4.EventLoop</a></li>
    <li><a href="../html/94.5.文件上传.html">94.5.文件上传</a></li>
    <li><a href="../html/94.6.https.html">94.6.https</a></li>
    <li><a href="../html/94.7. nginx.html">94.7. nginx</a></li>
    <li><a href="../html/95.1. react.html">95.1. react</a></li>
    <li><a href="../html/95.2.react.html">95.2.react</a></li>
    <li><a href="../html/96.1.react16.html">96.1.react16</a></li>
    <li><a href="../html/96.2.fiber.html">96.2.fiber</a></li>
    <li><a href="../html/96.3.fiber.html">96.3.fiber</a></li>
    <li><a href="../html/97.serverless.html">97.serverless</a></li>
    <li><a href="../html/98.websocket.html">98.websocket</a></li>
    <li><a href="../html/100.1.react-basic.html">100.1.react-basic</a></li>
    <li><a href="../html/101.1.monitor.html">101.1.monitor</a></li>
    <li><a href="../html/101.2.monitor.html">101.2.monitor</a></li>
    <li><a href="../html/102.java.html">102.java</a></li>
    <li><a href="../html/103.1.webpack-usage.html">103.1.webpack-usage</a></li>
    <li>
      <a href="../html/103.2.webpack-bundle.html">103.2.webpack-bundle</a>
    </li>
    <li><a href="../html/103.3.webpack-ast.html">103.3.webpack-ast</a></li>
    <li><a href="../html/103.4.webpack-flow.html">103.4.webpack-flow</a></li>
    <li>
      <a href="../html/103.5.webpack-loader.html">103.5.webpack-loader</a>
    </li>
    <li>
      <a href="../html/103.6.webpack-tapable.html">103.6.webpack-tapable</a>
    </li>
    <li>
      <a href="../html/103.7.webpack-plugin.html">103.7.webpack-plugin</a>
    </li>
    <li>
      <a href="../html/103.8.webpack-optimize1.html">103.8.webpack-optimize1</a>
    </li>
    <li>
      <a href="../html/103.9.webpack-optimize2.html">103.9.webpack-optimize2</a>
    </li>
    <li><a href="../html/103.10.webpack-hand.html">103.10.webpack-hand</a></li>
    <li><a href="../html/103.11.webpack-hmr.html">103.11.webpack-hmr</a></li>
    <li><a href="../html/103.13.splitChunks.html">103.13.splitChunks</a></li>
    <li>
      <a href="../html/103.14.webpack-sourcemap.html"
        >103.14.webpack-sourcemap</a
      >
    </li>
    <li>
      <a href="../html/103.15.webpack-compiler1.html"
        >103.15.webpack-compiler1</a
      >
    </li>
    <li>
      <a href="../html/103.15.webpack-compiler2.html"
        >103.15.webpack-compiler2</a
      >
    </li>
    <li><a href="../html/103.16.vite.basic.html">103.16.vite.basic</a></li>
    <li><a href="../html/103.16.vite.source.html">103.16.vite.source</a></li>
    <li><a href="../html/103.17.polyfill.html">103.17.polyfill</a></li>
    <li><a href="../html/104.1.binary.html">104.1.binary</a></li>
    <li><a href="../html/104.2.binary.html">104.2.binary</a></li>
    <li><a href="../html/105.skeleton.html">105.skeleton</a></li>
    <li><a href="../html/106.1.react.html">106.1.react</a></li>
    <li><a href="../html/106.2.react_hooks.html">106.2.react_hooks</a></li>
    <li><a href="../html/106.3.react_router.html">106.3.react_router</a></li>
    <li><a href="../html/106.4.redux.html">106.4.redux</a></li>
    <li>
      <a href="../html/106.5.redux_middleware.html">106.5.redux_middleware</a>
    </li>
    <li>
      <a href="../html/106.6.connected-react-router.html"
        >106.6.connected-react-router</a
      >
    </li>
    <li>
      <a href="../html/106.6.redux-first-history.html">106.6.redux-first-history</a>
    </li>
    <li><a href="../html/106.7.redux-saga.html">106.7.redux-saga</a></li>
    <li><a href="../html/106.8.dva.html">106.8.dva</a></li>
    <li><a href="../html/106.9.umi.html">106.9.umi</a></li>
    <li><a href="../html/106.10.ketang.html">106.10.ketang</a></li>
    <li><a href="../html/106.11.antdesign.html">106.11.antdesign</a></li>
    <li><a href="../html/106.12.antpro.html">106.12.antpro</a></li>
    <li><a href="../html/106.13.router-6.html">106.13.router-6</a></li>
    <li><a href="../html/107.fiber.html">107.fiber</a></li>
    <li><a href="../html/108.http.html">108.http</a></li>
    <li><a href="../html/109.1.webpack_usage.html">109.1.webpack_usage</a></li>
    <li>
      <a href="../html/109.2.webpack_source.html">109.2.webpack_source</a>
    </li>
    <li><a href="../html/109.3.dll.html">109.3.dll</a></li>
    <li><a href="../html/110.nest.js.html">110.nest.js</a></li>
    <li><a href="../html/111.xstate.html">111.xstate</a></li>
    <li><a href="../html/112.Form.html">112.Form</a></li>
    <li><a href="../html/113.redux-saga.html">113.redux-saga</a></li>
    <li>
      <a href="../html/114.react+typescript.html">114.react+typescript</a>
    </li>
    <li><a href="../html/115.immer.html">115.immer</a></li>
    <li><a href="../html/116.pro5.html">116.pro5</a></li>
    <li><a href="../html/117.css-loader.html">117.css-loader</a></li>
    <li><a href="../html/118.1.umi-core.html">118.1.umi-core</a></li>
    <li>
      <a href="../html/119.2.module-federation.html">119.2.module-federation</a>
    </li>
    <li>
      <a href="../html/119.1.module-federation.html">119.1.module-federation</a>
    </li>
    <li>
      <a href="../html/120.create-react-app.html">120.create-react-app</a>
    </li>
    <li><a href="../html/121.react-scripts.html">121.react-scripts</a></li>
    <li><a href="../html/122.react-optimize.html">122.react-optimize</a></li>
    <li><a href="../html/123.jsx-runtime.html">123.jsx-runtime</a></li>
    <li><a href="../html/124.next.js.html">124.next.js</a></li>
    <li><a href="../html/125.1.linux.html">125.1.linux</a></li>
    <li><a href="../html/125.2.linux-vi.html">125.2.linux-vi</a></li>
    <li><a href="../html/125.3.linux-user.html">125.3.linux-user</a></li>
    <li><a href="../html/125.4.linux-auth.html">125.4.linux-auth</a></li>
    <li><a href="../html/125.5.linux-shell.html">125.5.linux-shell</a></li>
    <li><a href="../html/125.6.linux-install.html">125.6.linux-install</a></li>
    <li><a href="../html/125.7.linux-system.html">125.7.linux-system</a></li>
    <li><a href="../html/125.8.linux-service.html">125.8.linux-service</a></li>
    <li><a href="../html/125.9.linux-network.html">125.9.linux-network</a></li>
    <li><a href="../html/125.10.nginx.html">125.10.nginx</a></li>
    <li><a href="../html/125.11.docker.html">125.11.docker</a></li>
    <li><a href="../html/125.12.ci.html">125.12.ci</a></li>
    <li><a href="../html/125.13.k8s.html">125.13.k8s</a></li>
    <li><a href="../html/125.14.k8s.html">125.14.k8s</a></li>
    <li><a href="../html/125.15.k8s.html">125.15.k8s</a></li>
    <li><a href="../html/125.16.k8s.html">125.16.k8s</a></li>
    <li><a href="../html/126.11.react-1.html">126.11.react-1</a></li>
    <li><a href="../html/126.12.react-2.html">126.12.react-2</a></li>
    <li><a href="../html/126.12.react-3.html">126.12.react-3</a></li>
    <li><a href="../html/126.12.react-4.html">126.12.react-4</a></li>
    <li><a href="../html/126.12.react-5.html">126.12.react-5</a></li>
    <li><a href="../html/127.frontend.html">127.frontend</a></li>
    <li><a href="../html/128.rollup.html">128.rollup</a></li>
    <li><a href="../html/129.px2rem-loader.html">129.px2rem-loader</a></li>
    <li><a href="../html/130.health.html">130.health</a></li>
    <li><a href="../html/131.hooks.html">131.hooks</a></li>
    <li><a href="../html/132.keepalive.html">132.keepalive</a></li>
    <li><a href="../html/133.vue-cli.html">133.vue-cli</a></li>
    <li><a href="../html/134.react18.html">134.react18</a></li>
    <li><a href="../html/135.function.html">135.function</a></li>
    <li><a href="../html/136.toolkit.html">136.toolkit</a></li>
    <li><a href="../html/137.lerna.html">137.lerna</a></li>
    <li><a href="../html/138.create-vite.html">138.create-vite</a></li>
    <li><a href="../html/139.cli.html">139.cli</a></li>
    <li><a href="../html/140.antd.html">140.antd</a></li>
    <li><a href="../html/141.react-dnd.html">141.react-dnd</a></li>
    <li><a href="../html/142.1.link.html">142.1.link</a></li>
    <li><a href="../html/143.1.gulp.html">143.1.gulp</a></li>
    <li><a href="../html/143.2.stream.html">143.2.stream</a></li>
    <li><a href="../html/143.3.gulp.html">143.3.gulp</a></li>
    <li><a href="../html/144.1.closure.html">144.1.closure</a></li>
    <li><a href="../html/144.2.v8.html">144.2.v8</a></li>
    <li><a href="../html/144.3.gc.html">144.3.gc</a></li>
    <li class="active"><a href="../html/145.react-router-v6.html">145.react-router-v6</a></li>
  </ul>
</div>

   
                     

                        
<div class="warpper">
    <div class="page-toc">
        <ul><li><a href="#t01. 什么是React">1. 什么是React</a></li><li><a href="#t12.创建项目">2.创建项目</a></li><li><a href="#t23.JSX渲染">3.JSX渲染</a><ul><li><a href="#t33.1 什么是JSX">3.1 什么是JSX</a></li><li><a href="#t43.2 什么是元素">3.2 什么是元素</a></li><li><a href="#t53.3 JSX实现">3.3 JSX实现</a></li><li><a href="#t63.3.1 package.json">3.3.1 package.json</a></li><li><a href="#t73.2 src\index.js">3.2 src\index.js</a></li><li><a href="#t83.3 constants.js">3.3 constants.js</a></li><li><a href="#t93.4 src\utils.js">3.4 src\utils.js</a></li><li><a href="#t103.5 react.js">3.5 react.js</a></li><li><a href="#t113.6 react-dom.js">3.6 react-dom.js</a></li></ul></li><li><a href="#t124.组件">4.组件</a><ul><li><a href="#t134.1 函数(定义的)组件">4.1 函数(定义的)组件</a></li><li><a href="#t144.2 实现">4.2 实现</a><ul><li><a href="#t154.2.1 src\index.js">4.2.1 src\index.js</a></li><li><a href="#t164.2.2 src\react-dom.js">4.2.2 src\react-dom.js</a></li></ul></li><li><a href="#t174.2 类(定义的)组件">4.2 类(定义的)组件</a><ul><li><a href="#t184.2.1 src\index.js">4.2.1 src\index.js</a></li><li><a href="#t194.2.2 src\Component.js">4.2.2 src\Component.js</a></li><li><a href="#t204.2.3 src\react.js">4.2.3 src\react.js</a></li><li><a href="#t214.2.4 src\react-dom.js">4.2.4 src\react-dom.js</a></li></ul></li></ul></li><li><a href="#t225.类组件的更新">5.类组件的更新</a><ul><li><a href="#t235.1 组件状态">5.1 组件状态</a></li><li><a href="#t245.3 更新组新实现">5.3 更新组新实现</a><ul><li><a href="#t255.3.1 src\index.js">5.3.1 src\index.js</a></li><li><a href="#t265.3.2 src\Component.js">5.3.2 src\Component.js</a></li><li><a href="#t275.3.3 react-dom.js">5.3.3 react-dom.js</a></li></ul></li></ul></li><li><a href="#t286.合成事件和批量更新">6.合成事件和批量更新</a><ul><li><a href="#t296.1 src\index.js">6.1 src\index.js</a></li><li><a href="#t306.2 src\utils.js">6.2 src\utils.js</a></li><li><a href="#t316.3 src\Component.js">6.3 src\Component.js</a></li><li><a href="#t326.4 src\event.js">6.4 src\event.js</a></li><li><a href="#t336.5 src\react-dom.js">6.5 src\react-dom.js</a></li></ul></li><li><a href="#t347.ref">7.ref</a><ul><li><a href="#t357.1 为 DOM 元素添加 ref">7.1 为 DOM 元素添加 ref</a></li><li><a href="#t367.2 为 class 组件添加 Ref">7.2 为 class 组件添加 Ref</a></li><li><a href="#t377.3 Ref转发">7.3 Ref转发</a></li><li><a href="#t387.4 ref实现">7.4 ref实现</a><ul><li><a href="#t397.4.1 src\constants.js">7.4.1 src\constants.js</a></li><li><a href="#t407.4.2 src\react.js">7.4.2 src\react.js</a></li><li><a href="#t417.4.3 react-dom.js">7.4.3 react-dom.js</a></li></ul></li></ul></li><li><a href="#t428.基本生命周期">8.基本生命周期</a><ul><li><a href="#t438.1 src\index.js">8.1 src\index.js</a></li><li><a href="#t448.2 src\Component.js">8.2 src\Component.js</a></li><li><a href="#t458.3 src\react-dom.js">8.3 src\react-dom.js</a></li></ul></li><li><a href="#t469.子组件生命周期">9.子组件生命周期</a><ul><li><a href="#t479.1 src\index.js">9.1 src\index.js</a></li><li><a href="#t489.2 src\react-dom.js">9.2 src\react-dom.js</a></li></ul></li><li><a href="#t4910.DOM-DIFF算法">10.DOM-DIFF算法</a><ul><li><a href="#t5010.1 src\index.js">10.1 src\index.js</a></li><li><a href="#t5110.2 src\constants.js">10.2 src\constants.js</a></li><li><a href="#t5210.3 src\react.js">10.3 src\react.js</a></li><li><a href="#t5310.4 src\react-dom.js">10.4 src\react-dom.js</a></li></ul></li><li><a href="#t5411.新的生命周期">11.新的生命周期</a><ul><li><a href="#t5511.1 getDerivedStateFromProps">11.1 getDerivedStateFromProps</a></li><li><a href="#t5611.2 getSnapshotBeforeUpdate">11.2 getSnapshotBeforeUpdate</a></li><li><a href="#t5711.3 实现">11.3 实现</a><ul><li><a href="#t5811.3.1  src\Component.js">11.3.1  src\Component.js</a></li></ul></li></ul></li><li><a href="#t5912. Context(上下文)">12. Context(上下文)</a><ul><li><a href="#t6012.1 src\index.js">12.1 src\index.js</a></li><li><a href="#t6112.2 src\constants.js">12.2 src\constants.js</a></li><li><a href="#t6212.3 src\Component.js">12.3 src\Component.js</a></li><li><a href="#t6312.4 src\react.js">12.4 src\react.js</a></li><li><a href="#t6412.5 src\react-dom.js">12.5 src\react-dom.js</a></li></ul></li><li><a href="#t6513. 高阶组件">13. 高阶组件</a><ul><li><a href="#t6613.1 cra支持装饰器">13.1 cra支持装饰器</a><ul><li><a href="#t6713.1.1 安装">13.1.1 安装</a></li><li><a href="#t6813.1.2 修改package.json">13.1.2 修改package.json</a></li><li><a href="#t6913.1.3 config-overrides.js">13.1.3 config-overrides.js</a></li><li><a href="#t7013.1.4 jsconfig.json">13.1.4 jsconfig.json</a></li></ul></li><li><a href="#t7113.2 属性代理">13.2 属性代理</a></li><li><a href="#t7213.3 反向继承">13.3 反向继承</a></li></ul></li><li><a href="#t7314. render props">14. render props</a><ul><li><a href="#t7414.1 原生实现">14.1 原生实现</a></li><li><a href="#t7514.2  children">14.2  children</a></li><li><a href="#t7614.3 render属性">14.3 render属性</a></li><li><a href="#t7714.4 HOC">14.4 HOC</a></li></ul></li><li><a href="#t7815.性能优化">15.性能优化</a><ul><li><a href="#t7915.1 src\index.js">15.1 src\index.js</a></li><li><a href="#t8015.2 src\constants.js">15.2 src\constants.js</a></li><li><a href="#t8115.3 src\utils.js">15.3 src\utils.js</a></li><li><a href="#t8215.4 src\react.js">15.4 src\react.js</a></li><li><a href="#t8315.5 src\react-dom.js">15.5 src\react-dom.js</a></li></ul></li><li><a href="#t8416.Portal">16.Portal</a><ul><li><a href="#t8516.1 src\index.js">16.1 src\index.js</a></li><li><a href="#t8616.2 src\react-dom.js">16.2 src\react-dom.js</a></li></ul></li></ul>
    </div>
    <div class="content markdown-body">
        <h2 id="t01. &#x4EC0;&#x4E48;&#x662F;React">1. &#x4EC0;&#x4E48;&#x662F;React <a href="#t01. &#x4EC0;&#x4E48;&#x662F;React"> # </a></h2>
<ul>
<li>React &#x662F;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x6784;&#x5EFA;&#x7528;&#x6237;&#x754C;&#x9762;&#x7684;JavaScript&#x5E93; &#x6838;&#x5FC3;&#x4E13;&#x6CE8;&#x4E8E;&#x89C6;&#x56FE;,&#x76EE;&#x7684;&#x5B9E;&#x73B0;&#x7EC4;&#x4EF6;&#x5316;&#x5F00;&#x53D1;</li>
</ul>
<h2 id="t12.&#x521B;&#x5EFA;&#x9879;&#x76EE;">2.&#x521B;&#x5EFA;&#x9879;&#x76EE; <a href="#t12.&#x521B;&#x5EFA;&#x9879;&#x76EE;"> # </a></h2>
<pre><code class="lang-js">create-react-app zhufengreact
cd zhufengreact
yarn add cross-env
</code></pre>
<h2 id="t23.JSX&#x6E32;&#x67D3;">3.JSX&#x6E32;&#x67D3; <a href="#t23.JSX&#x6E32;&#x67D3;"> # </a></h2>
<h3 id="t33.1 &#x4EC0;&#x4E48;&#x662F;JSX">3.1 &#x4EC0;&#x4E48;&#x662F;JSX <a href="#t33.1 &#x4EC0;&#x4E48;&#x662F;JSX"> # </a></h3>
<ul>
<li>&#x662F;&#x4E00;&#x79CD;JS&#x548C;HTML&#x6DF7;&#x5408;&#x7684;&#x8BED;&#x6CD5;,&#x5C06;&#x7EC4;&#x4EF6;&#x7684;&#x7ED3;&#x6784;&#x3001;&#x6570;&#x636E;&#x751A;&#x81F3;&#x6837;&#x5F0F;&#x90FD;&#x805A;&#x5408;&#x5728;&#x4E00;&#x8D77;&#x7684;&#x5199;&#x6CD5;</li>
</ul>
<h3 id="t43.2 &#x4EC0;&#x4E48;&#x662F;&#x5143;&#x7D20;">3.2 &#x4EC0;&#x4E48;&#x662F;&#x5143;&#x7D20; <a href="#t43.2 &#x4EC0;&#x4E48;&#x662F;&#x5143;&#x7D20;"> # </a></h3>
<ul>
<li>JSX&#x5176;&#x5B9E;&#x53EA;&#x662F;&#x4E00;&#x79CD;&#x8BED;&#x6CD5;&#x7CD6;,&#x6700;&#x7EC8;&#x4F1A;&#x901A;&#x8FC7;<a href="https://www.babeljs.cn/repl">babeljs</a>&#x8F6C;&#x8BD1;&#x6210;<code>React.createElement</code>&#x8BED;&#x6CD5;</li>
<li><code>React.createElement</code>&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;React&#x5143;&#x7D20;</li>
<li>React&#x5143;&#x7D20;&#x4E8B;&#x5B9E;&#x4E0A;&#x662F;&#x666E;&#x901A;&#x7684;JS&#x5BF9;&#x8C61;&#xFF0C;&#x7528;&#x6765;&#x63CF;&#x8FF0;&#x4F60;&#x5728;&#x5C4F;&#x5E55;&#x4E0A;&#x770B;&#x5230;&#x7684;&#x5185;&#x5BB9;</li>
<li><code>ReactDOM</code>&#x6765;&#x786E;&#x4FDD;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;&#x771F;&#x5B9E;DOM&#x6570;&#x636E;&#x548C;React&#x5143;&#x7D20;&#x4FDD;&#x6301;&#x4E00;&#x81F4;</li>
</ul>
<p>JSX</p>
<pre><code class="lang-js">&lt;h1 className=&quot;title&quot; style={{color:&apos;red&apos;}}&gt;hello&lt;/h1&gt;
</code></pre>
<p>&#x8F6C;&#x8BD1;&#x540E;&#x7684;&#x4EE3;&#x7801;</p>
<pre><code class="lang-js">React.createElement(<span class="hljs-string">&quot;h1&quot;</span>, {
  <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;title&quot;</span>,
  <span class="hljs-attr">style</span>: {
    <span class="hljs-attr">color</span>: <span class="hljs-string">&apos;red&apos;</span>
  }
}, <span class="hljs-string">&quot;hello&quot;</span>);
</code></pre>
<p>&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;</p>
<pre><code class="lang-js">{
  <span class="hljs-attr">type</span>:<span class="hljs-string">&apos;h1&apos;</span>,
  <span class="hljs-attr">props</span>:{
    <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;title&quot;</span>,
    <span class="hljs-attr">style</span>: {
      <span class="hljs-attr">color</span>: <span class="hljs-string">&apos;red&apos;</span>
    }
  },
  <span class="hljs-attr">children</span>:<span class="hljs-string">&quot;hello&quot;</span>
}
</code></pre>
<h3 id="t53.3 JSX&#x5B9E;&#x73B0;">3.3 JSX&#x5B9E;&#x73B0; <a href="#t53.3 JSX&#x5B9E;&#x73B0;"> # </a></h3>
<h3 id="t63.3.1 package.json">3.3.1 package.json <a href="#t63.3.1 package.json"> # </a></h3>
<pre><code class="lang-diff">{
  &quot;name&quot;: &quot;zhufengreact&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;scripts&quot;: {
<span class="hljs-addition">+   &quot;start&quot;: &quot;cross-env DISABLE_NEW_JSX_TRANSFORM=true react-scripts start&quot;,</span>
<span class="hljs-addition">+   &quot;build&quot;: &quot;cross-env DISABLE_NEW_JSX_TRANSFORM=true react-scripts build&quot;,</span>
<span class="hljs-addition">+   &quot;test&quot;: &quot;cross-env DISABLE_NEW_JSX_TRANSFORM=true react-scripts test&quot;,</span>
<span class="hljs-addition">+   &quot;eject&quot;: &quot;cross-env DISABLE_NEW_JSX_TRANSFORM=true react-scripts eject&quot;</span>
  },
}
</code></pre>
<h3 id="t73.2 src\index.js">3.2 src\index.js <a href="#t73.2 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./react&quot;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./react-dom&quot;</span>;
<span class="hljs-keyword">let</span> element1 = (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;title&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> &quot;<span class="hljs-attr">red</span>&quot; }}&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>hello<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>world
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">JSON</span>.stringify(element1, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
ReactDOM.render(element1, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;root&quot;</span>));
</code></pre>
<h3 id="t83.3 constants.js">3.3 constants.js <a href="#t83.3 constants.js"> # </a></h3>
<p>src\constants.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> REACT_TEXT = <span class="hljs-built_in">Symbol</span>(<span class="hljs-string">&apos;REACT_TEXT&apos;</span>);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> REACT_ELEMENT = <span class="hljs-built_in">Symbol</span>(<span class="hljs-string">&apos;react.element&apos;</span>);
</code></pre>
<h3 id="t93.4 src\utils.js">3.4 src\utils.js <a href="#t93.4 src\utils.js"> # </a></h3>
<p>src\utils.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { REACT_TEXT } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./constants&quot;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrapToVdom</span>(<span class="hljs-params">element</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> element === <span class="hljs-string">&quot;string&quot;</span> || <span class="hljs-keyword">typeof</span> element === <span class="hljs-string">&quot;number&quot;</span>
    ? { <span class="hljs-attr">type</span>: REACT_TEXT, <span class="hljs-attr">props</span>: { <span class="hljs-attr">content</span>: element } }
    : element;
}
</code></pre>
<h3 id="t103.5 react.js">3.5 react.js <a href="#t103.5 react.js"> # </a></h3>
<p>src\react.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { wrapToVdom } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./utils&quot;</span>;
<span class="hljs-keyword">import</span> { REACT_ELEMENT } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./constants&quot;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createElement</span>(<span class="hljs-params">type, config, children</span>) </span>{
  <span class="hljs-keyword">let</span> ref;
  <span class="hljs-keyword">let</span> key;
  <span class="hljs-keyword">if</span> (config) {
    <span class="hljs-keyword">delete</span> config.__source;
    <span class="hljs-keyword">delete</span> config.__self;
    ref = config.ref;
    <span class="hljs-keyword">delete</span> config.ref;
    key = config.key;
    <span class="hljs-keyword">delete</span> config.key;
  }
  <span class="hljs-keyword">let</span> props = { ...config };
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">3</span>) {
    props.children = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>).map(wrapToVdom);
  } <span class="hljs-keyword">else</span> {
    props.children = wrapToVdom(children);
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">$$typeof</span>: REACT_ELEMENT,
    type,
    ref,
    key,
    props,
  };
}
<span class="hljs-keyword">const</span> React = {
  createElement,
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> React;
</code></pre>
<h3 id="t113.6 react-dom.js">3.6 react-dom.js <a href="#t113.6 react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { REACT_TEXT } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./constants&quot;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">vdom, container</span>) </span>{
  mount(vdom, container);
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mount</span>(<span class="hljs-params">vdom, container</span>) </span>{
  <span class="hljs-keyword">let</span> newDOM = createDOM(vdom);
  container.appendChild(newDOM);
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createDOM</span>(<span class="hljs-params">vdom</span>) </span>{
  <span class="hljs-keyword">let</span> { type, props } = vdom;
  <span class="hljs-keyword">let</span> dom;
  <span class="hljs-keyword">if</span> (type === REACT_TEXT) {
    dom = <span class="hljs-built_in">document</span>.createTextNode(props.content);
  } <span class="hljs-keyword">else</span> {
    dom = <span class="hljs-built_in">document</span>.createElement(type);
  }
  <span class="hljs-keyword">if</span> (props) {
    updateProps(dom, {}, props);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> props.children == <span class="hljs-string">&quot;object&quot;</span> &amp;&amp; props.children.type) {
      mount(props.children, dom);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  <span class="hljs-keyword">return</span> dom;
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateProps</span>(<span class="hljs-params">dom, oldProps={}, newProps={}</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> newProps) {
        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&apos;children&apos;</span>) {
            <span class="hljs-keyword">continue</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&apos;style&apos;</span>) {
            <span class="hljs-keyword">let</span> styleObj = newProps[key];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> attr <span class="hljs-keyword">in</span> styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        }<span class="hljs-keyword">else</span> {
            dom[key] = newProps[key];
        }
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> oldProps){
        <span class="hljs-keyword">if</span>(!newProps.hasOwnProperty(key)){
            dom[key] = <span class="hljs-literal">null</span>;
        }
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reconcileChildren</span>(<span class="hljs-params">childrenVdom, parentDOM</span>) </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; childrenVdom.length; i++) {
    <span class="hljs-keyword">let</span> childVdom = childrenVdom[i];
    mount(childVdom, parentDOM);
  }
}
<span class="hljs-keyword">const</span> ReactDOM = {
  render,
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ReactDOM;
</code></pre>
<h2 id="t124.&#x7EC4;&#x4EF6;">4.&#x7EC4;&#x4EF6; <a href="#t124.&#x7EC4;&#x4EF6;"> # </a></h2>
<ul>
<li>&#x53EF;&#x4EE5;&#x5C06;UI&#x5207;&#x5206;&#x6210;&#x4E00;&#x4E9B;&#x72EC;&#x7ACB;&#x7684;&#x3001;&#x53EF;&#x590D;&#x7528;&#x7684;&#x7EC4;&#x4EF6;&#xFF0C;&#x8FD9;&#x6837;&#x4F60;&#x5C31;&#x53EA;&#x9700;&#x4E13;&#x6CE8;&#x4E8E;&#x6784;&#x5EFA;&#x6BCF;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x90E8;&#x4EF6;</li>
<li>&#x7EC4;&#x4EF6;&#x4ECE;&#x6982;&#x5FF5;&#x4E0A;&#x7C7B;&#x4F3C;&#x4E8E; <code>JavaScript</code> &#x51FD;&#x6570;&#x3002;&#x5B83;&#x63A5;&#x53D7;&#x4EFB;&#x610F;&#x7684;&#x5165;&#x53C2;(props&#x5C5E;&#x6027;)&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x7528;&#x4E8E;&#x63CF;&#x8FF0;&#x9875;&#x9762;&#x5C55;&#x793A;&#x5185;&#x5BB9;&#x7684; React &#x5143;&#x7D20;</li>
</ul>
<h3 id="t134.1 &#x51FD;&#x6570;(&#x5B9A;&#x4E49;&#x7684;)&#x7EC4;&#x4EF6;">4.1 &#x51FD;&#x6570;(&#x5B9A;&#x4E49;&#x7684;)&#x7EC4;&#x4EF6; <a href="#t134.1 &#x51FD;&#x6570;(&#x5B9A;&#x4E49;&#x7684;)&#x7EC4;&#x4EF6;"> # </a></h3>
<ul>
<li>&#x51FD;&#x6570;&#x7EC4;&#x4EF6;&#x63A5;&#x6536;&#x4E00;&#x4E2A;&#x5355;&#x4E00;&#x7684;props&#x5BF9;&#x8C61;&#x5E76;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;React&#x5143;&#x7D20;</li>
<li>&#x7EC4;&#x4EF6;&#x540D;&#x79F0;&#x5FC5;&#x987B;&#x4EE5;&#x5927;&#x5199;&#x5B57;&#x6BCD;&#x5F00;&#x5934;</li>
<li>&#x7EC4;&#x4EF6;&#x5FC5;&#x987B;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x65F6;&#x5019;&#x5B9A;&#x4E49;&#x6216;&#x5F15;&#x7528;&#x5B83;</li>
<li>&#x7EC4;&#x4EF6;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;&#x6839;&#x5143;&#x7D20;</li>
<li>React&#x5143;&#x7D20;&#x4E0D;&#x4F46;&#x53EF;&#x4EE5;&#x662F;DOM&#x6807;&#x7B7E;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x662F;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x7EC4;&#x4EF6;</li>
<li>&#x5F53; React &#x5143;&#x7D20;&#x4E3A;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x7EC4;&#x4EF6;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x5C06; JSX &#x6240;&#x63A5;&#x6536;&#x7684;&#x5C5E;&#x6027;&#xFF08;attributes&#xFF09;&#x8F6C;&#x6362;&#x4E3A;&#x5355;&#x4E2A;&#x5BF9;&#x8C61;&#x4F20;&#x9012;&#x7ED9;&#x7EC4;&#x4EF6;&#xFF0C;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x88AB;&#x79F0;&#x4E4B;&#x4E3A;<code>props</code></li>
</ul>
<p><img src="https://upload-markdown-images.oss-cn-beijing.aliyuncs.com/xuan_ran_han_shu_zu_jian_1626351799850.jpg" alt="xuan_ran_han_shu_zu_jian_1626351799850"></p>
<h3 id="t144.2 &#x5B9E;&#x73B0;">4.2 &#x5B9E;&#x73B0; <a href="#t144.2 &#x5B9E;&#x73B0;"> # </a></h3>
<h4 id="t154.2.1 src\index.js">4.2.1 src\index.js <a href="#t154.2.1 src\index.js"> # </a></h4>
<pre><code class="lang-diff">import React from &quot;./react&quot;;
import ReactDOM from &quot;./react-dom&quot;;
<span class="hljs-addition">+function FunctionComponent(props){</span>
<span class="hljs-addition">+  return &lt;div className=&quot;title&quot; style={{ color: &apos;red&apos; }}&gt;&lt;span&gt;{props.name}&lt;/span&gt;{props.children}&lt;/div&gt;;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+let element = &lt;FunctionComponent name=&quot;hello&quot;&gt;world&lt;/FunctionComponent&gt;;</span>
ReactDOM.render(element, document.getElementById(&quot;root&quot;));
</code></pre>
<h4 id="t164.2.2 src\react-dom.js">4.2.2 src\react-dom.js <a href="#t164.2.2 src\react-dom.js"> # </a></h4>
<p>src\react-dom.js</p>
<pre><code class="lang-diff">import { REACT_TEXT } from &quot;./constants&quot;;
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
    }
}
export function createDOM(vdom) {
  let { type, props } = vdom;
  let dom;
  if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
<span class="hljs-addition">+ } else if (typeof type === &quot;function&quot;) {</span>
<span class="hljs-addition">+   return mountFunctionComponent(vdom);</span>
<span class="hljs-addition">+ } else {</span>
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  return dom;
}
<span class="hljs-addition">+function mountFunctionComponent(vdom){</span>
<span class="hljs-addition">+    let {type,props}= vdom;</span>
<span class="hljs-addition">+    let renderVdom = type(props);</span>
<span class="hljs-addition">+    vdom.oldRenderVdom = renderVdom;</span>
<span class="hljs-addition">+    return createDOM(renderVdom);</span>
<span class="hljs-addition">+}</span>
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;
</code></pre>
<h3 id="t174.2 &#x7C7B;(&#x5B9A;&#x4E49;&#x7684;)&#x7EC4;&#x4EF6;">4.2 &#x7C7B;(&#x5B9A;&#x4E49;&#x7684;)&#x7EC4;&#x4EF6; <a href="#t174.2 &#x7C7B;(&#x5B9A;&#x4E49;&#x7684;)&#x7EC4;&#x4EF6;"> # </a></h3>
<ul>
<li>&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7C7B;&#x5B9A;&#x4E49;&#x7EC4;&#x4EF6;</li>
<li>&#x7C7B;&#x7EC4;&#x4EF6;&#x7684;&#x6E32;&#x67D3;&#x662F;&#x6839;&#x636E;&#x5C5E;&#x6027;&#x521B;&#x5EFA;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x5E76;&#x8C03;&#x7528;&#x5B9E;&#x4F8B;&#x7684;render&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;React&#x5143;&#x7D20;</li>
</ul>
<p><img src="https://upload-markdown-images.oss-cn-beijing.aliyuncs.com/lei_zu_jian_xuan_ran_1626352042061.jpg" alt="lei_zu_jian_xuan_ran_1626352042061"></p>
<h4 id="t184.2.1 src\index.js">4.2.1 src\index.js <a href="#t184.2.1 src\index.js"> # </a></h4>
<p>src\index.js</p>
<pre><code class="lang-diff">import React from &quot;./react&quot;;
import ReactDOM from &quot;./react-dom&quot;;
<span class="hljs-addition">+class ClassComponent extends React.Component{</span>
<span class="hljs-addition">+    render(){</span>
<span class="hljs-addition">+        return &lt;div className=&quot;title&quot; style={{ color: &apos;red&apos; }}&gt;&lt;span&gt;{this.props.name}&lt;/span&gt;{this.props.children}&lt;/div&gt;;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+let element = &lt;ClassComponent name=&quot;hello&quot;&gt;world&lt;/ClassComponent&gt;;</span>
ReactDOM.render(element, document.getElementById(&quot;root&quot;));
</code></pre>
<h4 id="t194.2.2 src\Component.js">4.2.2 src\Component.js <a href="#t194.2.2 src\Component.js"> # </a></h4>
<p>src\Component.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Component</span></span>{
    <span class="hljs-keyword">static</span> isReactComponent=<span class="hljs-literal">true</span>
    <span class="hljs-keyword">constructor</span>(props){
        <span class="hljs-keyword">this</span>.props = props;
    }
}
</code></pre>
<h4 id="t204.2.3 src\react.js">4.2.3 src\react.js <a href="#t204.2.3 src\react.js"> # </a></h4>
<p>src\react.js</p>
<pre><code class="lang-diff">import { wrapToVdom } from &quot;./utils&quot;;
<span class="hljs-addition">+import {Component} from &apos;./Component&apos;;</span>
function createElement(type, config, children) {
  let ref;
  let key;
  if (config) {
    delete config.__source;
    delete config.__self;
    ref = config.ref;
    delete config.ref;
    key = config.key;
    delete config.key;
  }
  let props = { ...config };
  if (arguments.length &gt; 3) {
    props.children = Array.prototype.slice.call(arguments, 2).map(wrapToVdom);
  } else {
    props.children = wrapToVdom(children);
  }
  return {
    type,
    ref,
    key,
    props,
  };
}
const React = {
  createElement,
<span class="hljs-addition">+  Component</span>
};
export default React;
</code></pre>
<h4 id="t214.2.4 src\react-dom.js">4.2.4 src\react-dom.js <a href="#t214.2.4 src\react-dom.js"> # </a></h4>
<p>src\react-dom.js</p>
<pre><code class="lang-diff">import { REACT_TEXT } from &quot;./constants&quot;;
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
    }
}
export function createDOM(vdom) {
  let { type, props } = vdom;
  let dom;
  if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
<span class="hljs-addition">+    if (type.isReactComponent) {</span>
<span class="hljs-addition">+      return mountClassComponent(vdom);</span>
<span class="hljs-addition">+    } else {</span>
      return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  return dom;
}
<span class="hljs-addition">+function mountClassComponent(vdom){</span>
<span class="hljs-addition">+    let {type,props}= vdom;</span>
<span class="hljs-addition">+    let classInstance = new type(props);</span>
<span class="hljs-addition">+    let renderVdom = classInstance.render();</span>
<span class="hljs-addition">+    let dom =  createDOM(renderVdom);</span>
<span class="hljs-addition">+    return dom;</span>
<span class="hljs-addition">+}</span>
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;
</code></pre>
<h2 id="t225.&#x7C7B;&#x7EC4;&#x4EF6;&#x7684;&#x66F4;&#x65B0;">5.&#x7C7B;&#x7EC4;&#x4EF6;&#x7684;&#x66F4;&#x65B0; <a href="#t225.&#x7C7B;&#x7EC4;&#x4EF6;&#x7684;&#x66F4;&#x65B0;"> # </a></h2>
<h3 id="t235.1 &#x7EC4;&#x4EF6;&#x72B6;&#x6001;">5.1 &#x7EC4;&#x4EF6;&#x72B6;&#x6001; <a href="#t235.1 &#x7EC4;&#x4EF6;&#x72B6;&#x6001;"> # </a></h3>
<ul>
<li>&#x7EC4;&#x4EF6;&#x7684;&#x6570;&#x636E;&#x6765;&#x6E90;&#x6709;&#x4E24;&#x4E2A;&#x5730;&#x65B9;&#xFF0C;&#x5206;&#x522B;&#x662F;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;&#x548C;&#x72B6;&#x6001;&#x5BF9;&#x8C61;</li>
<li>&#x5C5E;&#x6027;&#x662F;&#x7236;&#x7EC4;&#x4EF6;&#x4F20;&#x9012;&#x8FC7;&#x6765;&#x7684;</li>
<li>&#x72B6;&#x6001;&#x662F;&#x81EA;&#x5DF1;&#x5185;&#x90E8;&#x7684;,&#x6539;&#x53D8;&#x72B6;&#x6001;&#x552F;&#x4E00;&#x7684;&#x65B9;&#x5F0F;&#x5C31;&#x662F;<code>setState</code></li>
<li>&#x5C5E;&#x6027;&#x548C;&#x72B6;&#x6001;&#x7684;&#x53D8;&#x5316;&#x90FD;&#x4F1A;&#x5F71;&#x54CD;&#x89C6;&#x56FE;&#x66F4;&#x65B0;</li>
<li>&#x4E0D;&#x8981;&#x76F4;&#x63A5;&#x4FEE;&#x6539; State&#xFF0C;&#x6784;&#x9020;&#x51FD;&#x6570;&#x662F;&#x552F;&#x4E00;&#x53EF;&#x4EE5;&#x7ED9; this.state &#x8D4B;&#x503C;&#x7684;&#x5730;&#x65B9;</li>
</ul>
<h3 id="t245.3 &#x66F4;&#x65B0;&#x7EC4;&#x65B0;&#x5B9E;&#x73B0;">5.3 &#x66F4;&#x65B0;&#x7EC4;&#x65B0;&#x5B9E;&#x73B0; <a href="#t245.3 &#x66F4;&#x65B0;&#x7EC4;&#x65B0;&#x5B9E;&#x73B0;"> # </a></h3>
<h4 id="t255.3.1 src\index.js">5.3.1 src\index.js <a href="#t255.3.1 src\index.js"> # </a></h4>
<pre><code class="lang-diff">import React from &quot;./react&quot;;
import ReactDOM from &quot;./react-dom&quot;;
class Counter extends React.Component {
    constructor(props) {
        super(props);
        this.state = { number: 0 };
    }
    handleClick = () =&gt; {
        this.setState({ number: this.state.number + 1 });
        console.log(this.state);

    }
    render() {
        return (
            &lt;div&gt;
                &lt;p&gt;{this.props.title}&lt;/p&gt;
                &lt;p&gt;number:{this.state.number}&lt;/p&gt;
                &lt;button onClick={this.handleClick}&gt;+&lt;/button&gt;
            &lt;/div&gt;
        )
    }
}
ReactDOM.render(&lt;Counter title=&quot;&#x8BA1;&#x6570;&#x5668;&quot; /&gt;, document.getElementById(&quot;root&quot;));
</code></pre>
<h4 id="t265.3.2 src\Component.js">5.3.2 src\Component.js <a href="#t265.3.2 src\Component.js"> # </a></h4>
<p>src\Component.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { findDOM, compareTwoVdom } from &apos;./react-dom&apos;;</span>
<span class="hljs-addition">+class Updater {</span>
<span class="hljs-addition">+    constructor(classInstance) {</span>
<span class="hljs-addition">+        this.classInstance = classInstance;</span>
<span class="hljs-addition">+        this.pendingStates = [];</span>
<span class="hljs-addition">+        this.callbacks = [];</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    addState(partialState, callback) {</span>
<span class="hljs-addition">+        this.pendingStates.push(partialState);///&#x7B49;&#x5F85;&#x66F4;&#x65B0;&#x7684;&#x6216;&#x8005;&#x8BF4;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x72B6;&#x6001;</span>
<span class="hljs-addition">+        if (typeof callback === &apos;function&apos;)</span>
<span class="hljs-addition">+            this.callbacks.push(callback);//&#x72B6;&#x6001;&#x66F4;&#x65B0;&#x540E;&#x7684;&#x56DE;&#x8C03;</span>
<span class="hljs-addition">+        this.emitUpdate();</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    emitUpdate() {</span>
<span class="hljs-addition">+        this.updateComponent();</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    updateComponent() {</span>
<span class="hljs-addition">+        let { classInstance, pendingStates } = this;</span>
<span class="hljs-addition">+        if (pendingStates.length &gt; 0) {</span>
<span class="hljs-addition">+            shouldUpdate(classInstance, this.getState());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    getState() {</span>
<span class="hljs-addition">+        let { classInstance, pendingStates } = this;</span>
<span class="hljs-addition">+        let { state } = classInstance;</span>
<span class="hljs-addition">+        pendingStates.forEach((nextState) =&gt; {</span>
<span class="hljs-addition">+            if (typeof nextState === &apos;function&apos;) {</span>
<span class="hljs-addition">+                nextState = nextState(state);</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+            state = { ...state, ...nextState };</span>
<span class="hljs-addition">+        });</span>
<span class="hljs-addition">+        pendingStates.length = 0;</span>
<span class="hljs-addition">+        return state;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function shouldUpdate(classInstance, nextState) {</span>
<span class="hljs-addition">+    classInstance.state = nextState;</span>
<span class="hljs-addition">+    classInstance.forceUpdate();</span>
<span class="hljs-addition">+}</span>
export class Component {
    static isReactComponent = true;
    constructor(props) {
        this.props = props;
<span class="hljs-addition">+        this.state = {};</span>
<span class="hljs-addition">+        this.updater = new Updater(this);</span>
    }
<span class="hljs-addition">+    setState(partialState, callback) {</span>
<span class="hljs-addition">+        this.updater.addState(partialState, callback);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    forceUpdate() {</span>
<span class="hljs-addition">+        let oldRenderVdom = this.oldRenderVdom;</span>
<span class="hljs-addition">+        let oldDOM = findDOM(oldRenderVdom);</span>
<span class="hljs-addition">+        let newRenderVdom = this.render();</span>
<span class="hljs-addition">+        compareTwoVdom(oldDOM.parentNode, oldRenderVdom, newRenderVdom);</span>
<span class="hljs-addition">+        this.oldRenderVdom = newRenderVdom;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h4 id="t275.3.3 react-dom.js">5.3.3 react-dom.js <a href="#t275.3.3 react-dom.js"> # </a></h4>
<p>src\react-dom.js</p>
<pre><code class="lang-diff">import { REACT_TEXT } from &quot;./constants&quot;;
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
    }
}
export function createDOM(vdom) {
  let { type, props } = vdom;
  let dom;
  if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
      return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  return dom;
}
function mountClassComponent(vdom) {
  let { type, props } = vdom;
  let classInstance = new type(props);
  let renderVdom = classInstance.render();
<span class="hljs-addition">+ classInstance.oldRenderVdom = renderVdom;</span>
  let dom = createDOM(renderVdom);
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
<span class="hljs-addition">+export function findDOM(vdom){</span>
<span class="hljs-addition">+    let {type}= vdom;</span>
<span class="hljs-addition">+    let dom;</span>
<span class="hljs-addition">+    if(typeof type === &apos;function&apos;){</span>
<span class="hljs-addition">+        dom=findDOM(vdom.oldRenderVdom);</span>
<span class="hljs-addition">+    }else{</span>
<span class="hljs-addition">+        dom=vdom.dom;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    return dom;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+export function compareTwoVdom(parentDOM, oldVdom, newVdom) {</span>
<span class="hljs-addition">+    let oldDOM = findDOM(oldVdom);</span>
<span class="hljs-addition">+    let newDOM = createDOM(newVdom);</span>
<span class="hljs-addition">+    parentDOM.replaceChild(newDOM, oldDOM);</span>
<span class="hljs-addition">+}</span>
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;
</code></pre>
<h2 id="t286.&#x5408;&#x6210;&#x4E8B;&#x4EF6;&#x548C;&#x6279;&#x91CF;&#x66F4;&#x65B0;">6.&#x5408;&#x6210;&#x4E8B;&#x4EF6;&#x548C;&#x6279;&#x91CF;&#x66F4;&#x65B0; <a href="#t286.&#x5408;&#x6210;&#x4E8B;&#x4EF6;&#x548C;&#x6279;&#x91CF;&#x66F4;&#x65B0;"> # </a></h2>
<ul>
<li>State &#x7684;&#x66F4;&#x65B0;&#x4F1A;&#x88AB;&#x5408;&#x5E76; &#x5F53;&#x4F60;&#x8C03;&#x7528; setState() &#x7684;&#x65F6;&#x5019;&#xFF0C;React &#x4F1A;&#x628A;&#x4F60;&#x63D0;&#x4F9B;&#x7684;&#x5BF9;&#x8C61;&#x5408;&#x5E76;&#x5230;&#x5F53;&#x524D;&#x7684; state</li>
<li>State &#x7684;&#x66F4;&#x65B0;&#x53EF;&#x80FD;&#x662F;&#x5F02;&#x6B65;&#x7684;<ul>
<li>&#x51FA;&#x4E8E;&#x6027;&#x80FD;&#x8003;&#x8651;&#xFF0C;React &#x53EF;&#x80FD;&#x4F1A;&#x628A;&#x591A;&#x4E2A; setState() &#x8C03;&#x7528;&#x5408;&#x5E76;&#x6210;&#x4E00;&#x4E2A;&#x8C03;&#x7528;</li>
<li>&#x56E0;&#x4E3A; this.props &#x548C; this.state &#x53EF;&#x80FD;&#x4F1A;&#x5F02;&#x6B65;&#x66F4;&#x65B0;&#xFF0C;&#x6240;&#x4EE5;&#x4F60;&#x4E0D;&#x8981;&#x4F9D;&#x8D56;&#x4ED6;&#x4EEC;&#x7684;&#x503C;&#x6765;&#x66F4;&#x65B0;&#x4E0B;&#x4E00;&#x4E2A;&#x72B6;&#x6001;</li>
<li>&#x53EF;&#x4EE5;&#x8BA9; setState() &#x63A5;&#x6536;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x800C;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x3002;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7528;&#x4E0A;&#x4E00;&#x4E2A; state &#x4F5C;&#x4E3A;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;</li>
</ul>
</li>
<li>&#x4E8B;&#x4EF6;&#x5904;&#x7406;<ul>
<li>React &#x4E8B;&#x4EF6;&#x7684;&#x547D;&#x540D;&#x91C7;&#x7528;&#x5C0F;&#x9A7C;&#x5CF0;&#x5F0F;(camelCase),&#x800C;&#x4E0D;&#x662F;&#x7EAF;&#x5C0F;&#x5199;</li>
<li>&#x4F7F;&#x7528; JSX &#x8BED;&#x6CD5;&#x65F6;&#x4F60;&#x9700;&#x8981;&#x4F20;&#x5165;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4F5C;&#x4E3A;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;</li>
<li>&#x4F60;&#x4E0D;&#x80FD;&#x901A;&#x8FC7;&#x8FD4;&#x56DE; <code>false</code> &#x7684;&#x65B9;&#x5F0F;&#x963B;&#x6B62;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#x3002;&#x4F60;&#x5FC5;&#x987B;&#x663E;&#x5F0F;&#x7684;&#x4F7F;&#x7528;<code>preventDefault</code></li>
</ul>
</li>
</ul>
<h3 id="t296.1 src\index.js">6.1 src\index.js <a href="#t296.1 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-diff">import React from &quot;./react&quot;;
import ReactDOM from &quot;./react-dom&quot;;
class Counter extends React.Component {
    constructor(props) {
        super(props);
        this.state = { number: 0 };
    }
    handleClick = () =&gt; {
<span class="hljs-addition">+       this.setState({ number: this.state.number + 1 });</span>
<span class="hljs-addition">+       console.log(this.state);</span>
<span class="hljs-addition">+       this.setState({ number: this.state.number + 1 });</span>
<span class="hljs-addition">+       console.log(this.state);</span>
<span class="hljs-addition">+       setTimeout(()=&gt;{</span>
<span class="hljs-addition">+           this.setState({ number: this.state.number + 1 });</span>
<span class="hljs-addition">+           console.log(this.state);</span>
<span class="hljs-addition">+           this.setState({ number: this.state.number + 1 });</span>
<span class="hljs-addition">+           console.log(this.state);</span>
<span class="hljs-addition">+       });</span>
    }
    render() {
        return (
            &lt;div&gt;
                &lt;p&gt;{this.props.title}&lt;/p&gt;
                &lt;p&gt;number:{this.state.number}&lt;/p&gt;
                &lt;button onClick={this.handleClick}&gt;+&lt;/button&gt;
            &lt;/div&gt;
        )
    }
}
ReactDOM.render(&lt;Counter title=&quot;&#x8BA1;&#x6570;&#x5668;&quot; /&gt;, document.getElementById(&quot;root&quot;));
</code></pre>
<h3 id="t306.2 src\utils.js">6.2 src\utils.js <a href="#t306.2 src\utils.js"> # </a></h3>
<p>src\utils.js</p>
<pre><code class="lang-diff">import { REACT_TEXT } from &quot;./constants&quot;;
export function wrapToVdom(element) {
  return typeof element <span class="hljs-comment">=== &quot;string&quot; || typeof element === &quot;number&quot;</span>
    ? { type: REACT_TEXT, props: { content: element } }
    : element;
}

<span class="hljs-addition">+export function isFunction(obj) {</span>
<span class="hljs-addition">+    return typeof obj === &apos;function&apos;;</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t316.3 src\Component.js">6.3 src\Component.js <a href="#t316.3 src\Component.js"> # </a></h3>
<p>src\Component.js</p>
<pre><code class="lang-diff">import { findDOM, compareTwoVdom } from &apos;./react-dom&apos;;
<span class="hljs-addition">+export let updateQueue = {</span>
<span class="hljs-addition">+    isBatchingUpdate:false,</span>
<span class="hljs-addition">+    updaters:[],</span>
<span class="hljs-addition">+    batchUpdate(){//&#x6279;&#x91CF;&#x66F4;&#x65B0;</span>
<span class="hljs-addition">+      for(let updater of updateQueue.updaters){</span>
<span class="hljs-addition">+        updater.updateComponent();</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      updateQueue.isBatchingUpdate = false;</span>
<span class="hljs-addition">+      updateQueue.updaters.length=0;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
class Updater {
    constructor(classInstance) {
        this.classInstance = classInstance;
        this.pendingStates = [];
        this.callbacks = [];
    }
    addState(partialState, callback) {
        this.pendingStates.push(partialState);///&#x7B49;&#x5F85;&#x66F4;&#x65B0;&#x7684;&#x6216;&#x8005;&#x8BF4;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x72B6;&#x6001;
        if (typeof callback <span class="hljs-comment">=== &apos;function&apos;)</span>
            this.callbacks.push(callback);//&#x72B6;&#x6001;&#x66F4;&#x65B0;&#x540E;&#x7684;&#x56DE;&#x8C03;
        this.emitUpdate();
    }
<span class="hljs-addition">+   emitUpdate(nextProps) {</span>
<span class="hljs-addition">+       this.nextProps = nextProps;</span>
<span class="hljs-addition">+       if(updateQueue.isBatchingUpdate){</span>
<span class="hljs-addition">+           updateQueue.updaters.push(this);</span>
<span class="hljs-addition">+       }else{</span>
<span class="hljs-addition">+           this.updateComponent();</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+   }</span>
    updateComponent() {
        let { classInstance, pendingStates } = this;
<span class="hljs-addition">+       if (this.nextProps || pendingStates.length &gt; 0) {</span>
<span class="hljs-addition">+           shouldUpdate(classInstance,this.nextProps, this.getState());</span>
<span class="hljs-addition">+       }</span>
    }
    getState() {
        let { classInstance, pendingStates } = this;
        let { state } = classInstance;
        pendingStates.forEach((nextState) =&gt; {
            if (typeof nextState <span class="hljs-comment">=== &apos;function&apos;) {</span>
                nextState = nextState(state);
            }
            state = { ...state, ...nextState };
        });
        pendingStates.length = 0;
        return state;
    }
}
<span class="hljs-addition">+function shouldUpdate(classInstance,nextProps, nextState) {</span>
<span class="hljs-addition">+   if(nextProps) classInstance.props = nextProps;</span>
    classInstance.state = nextState;
    classInstance.forceUpdate();
}
export class Component {
    static isReactComponent = true;
    constructor(props) {
        this.props = props;
        this.state = {};
        this.updater = new Updater(this);
    }
    setState(partialState, callback) {
        this.updater.addState(partialState, callback);
    }
    forceUpdate() {
        let oldRenderVdom = this.oldRenderVdom;
        let oldDOM = findDOM(oldRenderVdom);
        let newRenderVdom = this.render();
        compareTwoVdom(oldDOM.parentNode, oldRenderVdom, newRenderVdom);
        this.oldRenderVdom = newRenderVdom;
    }
}
</code></pre>
<h3 id="t326.4 src\event.js">6.4 src\event.js <a href="#t326.4 src\event.js"> # </a></h3>
<p>src\event.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { updateQueue } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./Component&apos;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addEvent</span>(<span class="hljs-params">dom, eventType, handleClick</span>) </span>{
    <span class="hljs-keyword">let</span> store;
    <span class="hljs-keyword">if</span> (dom.store) {
        store = dom.store;
    } <span class="hljs-keyword">else</span> {
        dom.store = {};
        store = dom.store;
    }
    store[eventType] = handleClick;
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">document</span>[eventType]) {
        <span class="hljs-built_in">document</span>[eventType] = dispatchEvent;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchEvent</span>(<span class="hljs-params">event</span>) </span>{
    <span class="hljs-keyword">let</span> { target, type } = event;
    <span class="hljs-keyword">let</span> eventType = <span class="hljs-string">`on<span class="hljs-subst">${type}</span>`</span>;
    updateQueue.isBatchingUpdate = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">let</span> syntheticEvent = createSyntheticEvent(event);
    <span class="hljs-keyword">while</span> (target) {
        <span class="hljs-keyword">let</span> { store } = target;
        <span class="hljs-keyword">let</span> handleClick = store &amp;&amp; store[eventType];
        handleClick &amp;&amp; handleClick.call(target, syntheticEvent);
        target = target.parentNode;
    }
    updateQueue.isBatchingUpdate = <span class="hljs-literal">false</span>;
    updateQueue.batchUpdate();
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createSyntheticEvent</span>(<span class="hljs-params">nativeEvent</span>) </span>{
    <span class="hljs-keyword">let</span> syntheticEvent = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> nativeEvent) {
        syntheticEvent[key] = nativeEvent[key];
    }
    <span class="hljs-keyword">return</span> syntheticEvent;
}
</code></pre>
<h3 id="t336.5 src\react-dom.js">6.5 src\react-dom.js <a href="#t336.5 src\react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-diff">import { REACT_TEXT } from &quot;./constants&quot;;
<span class="hljs-addition">+import { addEvent } from &apos;./event&apos;;</span>
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
    }
}
export function createDOM(vdom) {
  let { type, props } = vdom;
  let dom;
  if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
      return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  return dom;
}
function mountClassComponent(vdom) {
  let { type, props } = vdom;
  let classInstance = new type(props);
  let renderVdom = classInstance.render();
  classInstance.oldRenderVdom = renderVdom;
  let dom = createDOM(renderVdom);
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
<span class="hljs-addition">+        } else if (key.startsWith(&apos;on&apos;)) {</span>
<span class="hljs-addition">+            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);</span>
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
export function findDOM(vdom){
    let {type}= vdom;
    let dom;
    if(typeof type <span class="hljs-comment">=== &apos;function&apos;){</span>
        dom=findDOM(vdom.oldRenderVdom);
    }else{
        dom=vdom.dom;
    }
    return dom;
}
export function compareTwoVdom(parentDOM, oldVdom, newVdom) {
    let oldDOM = findDOM(oldVdom);
    let newDOM = createDOM(newVdom);
    parentDOM.replaceChild(newDOM, oldDOM);
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;
</code></pre>
<h2 id="t347.ref">7.ref <a href="#t347.ref"> # </a></h2>
<ul>
<li>Refs &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x5141;&#x8BB8;&#x6211;&#x4EEC;&#x8BBF;&#x95EE; DOM &#x8282;&#x70B9;&#x6216;&#x5728; render &#x65B9;&#x6CD5;&#x4E2D;&#x521B;&#x5EFA;&#x7684; React &#x5143;&#x7D20;</li>
</ul>
<h3 id="t357.1 &#x4E3A; DOM &#x5143;&#x7D20;&#x6DFB;&#x52A0; ref">7.1 &#x4E3A; DOM &#x5143;&#x7D20;&#x6DFB;&#x52A0; ref <a href="#t357.1 &#x4E3A; DOM &#x5143;&#x7D20;&#x6DFB;&#x52A0; ref"> # </a></h3>
<ul>
<li>&#x53EF;&#x4EE5;&#x4F7F;&#x7528; ref &#x53BB;&#x5B58;&#x50A8; DOM &#x8282;&#x70B9;&#x7684;&#x5F15;&#x7528;</li>
<li>&#x5F53; ref &#x5C5E;&#x6027;&#x7528;&#x4E8E; HTML &#x5143;&#x7D20;&#x65F6;&#xFF0C;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E2D;&#x4F7F;&#x7528; React.createRef() &#x521B;&#x5EFA;&#x7684; ref &#x63A5;&#x6536;&#x5E95;&#x5C42; DOM &#x5143;&#x7D20;&#x4F5C;&#x4E3A;&#x5176; current &#x5C5E;&#x6027;</li>
</ul>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Sum</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    a
    b
    result
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.a = React.createRef();
        <span class="hljs-keyword">this</span>.b = React.createRef();
        <span class="hljs-keyword">this</span>.result = React.createRef();
    }
    handleAdd = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">this</span>.a.current.value;
        <span class="hljs-keyword">let</span> b = <span class="hljs-keyword">this</span>.b.current.value;
        <span class="hljs-keyword">this</span>.result.current.value = a + b;
    }
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.a}</span> /&gt;</span>+<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.b}</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleAdd}</span>&gt;</span>=<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.result}</span> /&gt;</span>
            <span class="hljs-tag">&lt;/&gt;</span></span>
        );
    }
}
ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Sum</span> /&gt;</span></span>,
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>)
);
</code></pre>
<h3 id="t367.2 &#x4E3A; class &#x7EC4;&#x4EF6;&#x6DFB;&#x52A0; Ref">7.2 &#x4E3A; class &#x7EC4;&#x4EF6;&#x6DFB;&#x52A0; Ref <a href="#t367.2 &#x4E3A; class &#x7EC4;&#x4EF6;&#x6DFB;&#x52A0; Ref"> # </a></h3>
<ul>
<li>&#x5F53; ref &#x5C5E;&#x6027;&#x7528;&#x4E8E;&#x81EA;&#x5B9A;&#x4E49; class &#x7EC4;&#x4EF6;&#x65F6;&#xFF0C;ref &#x5BF9;&#x8C61;&#x63A5;&#x6536;&#x7EC4;&#x4EF6;&#x7684;&#x6302;&#x8F7D;&#x5B9E;&#x4F8B;&#x4F5C;&#x4E3A;&#x5176; current &#x5C5E;&#x6027;</li>
</ul>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Form</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    input
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.input = React.createRef();
    }
    getFocus = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">this</span>.input.current.getFocus();
    }
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TextInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.input}</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.getFocus}</span>&gt;</span>&#x83B7;&#x5F97;&#x7126;&#x70B9;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/&gt;</span></span>
        );
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TextInput</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    input
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.input = React.createRef();
    }
    getFocus = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">this</span>.input.current.focus();
    }
    render() {
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.input}</span> /&gt;</span></span>
    }
}
ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form</span> /&gt;</span></span>,
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>)
);
</code></pre>
<h3 id="t377.3 Ref&#x8F6C;&#x53D1;">7.3 Ref&#x8F6C;&#x53D1; <a href="#t377.3 Ref&#x8F6C;&#x53D1;"> # </a></h3>
<ul>
<li>&#x4F60;&#x4E0D;&#x80FD;&#x5728;&#x51FD;&#x6570;&#x7EC4;&#x4EF6;&#x4E0A;&#x4F7F;&#x7528; ref &#x5C5E;&#x6027;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x4EEC;&#x6CA1;&#x6709;&#x5B9E;&#x4F8B;</li>
<li>Ref &#x8F6C;&#x53D1;&#x662F;&#x4E00;&#x9879;&#x5C06; ref &#x81EA;&#x52A8;&#x5730;&#x901A;&#x8FC7;&#x7EC4;&#x4EF6;&#x4F20;&#x9012;&#x5230;&#x5176;&#x4E00;&#x5B50;&#x7EC4;&#x4EF6;&#x7684;&#x6280;&#x5DE7;</li>
<li>Ref &#x8F6C;&#x53D1;&#x5141;&#x8BB8;&#x67D0;&#x4E9B;&#x7EC4;&#x4EF6;&#x63A5;&#x6536; ref&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x5411;&#x4E0B;&#x4F20;&#x9012;&#x7ED9;&#x5B50;&#x7EC4;&#x4EF6;</li>
</ul>
<p>src/index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
interface InputProps { }
<span class="hljs-keyword">const</span> TextInput = React.forwardRef(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> /&gt;</span></span>
));
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Form</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    input
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.input = React.createRef();
    }
    getFocus = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.input.current);

        <span class="hljs-keyword">this</span>.input.current.focus();
    }
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TextInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.input}</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.getFocus}</span>&gt;</span>&#x83B7;&#x5F97;&#x7126;&#x70B9;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/&gt;</span></span>
        );
    }
}

ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form</span> /&gt;</span></span>,
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>)
);
</code></pre>
<h3 id="t387.4 ref&#x5B9E;&#x73B0;">7.4 ref&#x5B9E;&#x73B0; <a href="#t387.4 ref&#x5B9E;&#x73B0;"> # </a></h3>
<h4 id="t397.4.1 src\constants.js">7.4.1 src\constants.js <a href="#t397.4.1 src\constants.js"> # </a></h4>
<pre><code class="lang-diff">export const REACT_TEXT = Symbol(&apos;REACT_TEXT&apos;);
<span class="hljs-addition">+export const REACT_FORWARD_REF_TYPE = Symbol(&apos;react.forward_ref&apos;);</span>
</code></pre>
<h4 id="t407.4.2 src\react.js">7.4.2 src\react.js <a href="#t407.4.2 src\react.js"> # </a></h4>
<p>src\react.js</p>
<pre><code class="lang-diff">import { wrapToVdom } from &quot;./utils&quot;;
import {Component} from &apos;./Component&apos;;
function createElement(type, config, children) {
  let ref;
  let key;
  if (config) {
    delete config.__source;
    delete config.__self;
    ref = config.ref;
    delete config.ref;
    key = config.key;
    delete config.key;
  }
  let props = { ...config };
  if (arguments.length &gt; 3) {
    props.children = Array.prototype.slice.call(arguments, 2).map(wrapToVdom);
  } else {
    props.children = wrapToVdom(children);
  }
  return {
    type,
    ref,
    key,
    props,
  };
}
<span class="hljs-addition">+function createRef(){</span>
<span class="hljs-addition">+    return {current:null};</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function forwardRef(render) {  </span>
<span class="hljs-addition">+  var elementType = {</span>
<span class="hljs-addition">+    $$typeof: REACT_FORWARD_REF_TYPE,</span>
<span class="hljs-addition">+    render: render</span>
<span class="hljs-addition">+  };</span>
<span class="hljs-addition">+  return elementType;</span>
<span class="hljs-addition">+}</span>
const React = {
  createElement,
  Component,
<span class="hljs-addition">+ createRef</span>
};
export default React;
</code></pre>
<h4 id="t417.4.3 react-dom.js">7.4.3 react-dom.js <a href="#t417.4.3 react-dom.js"> # </a></h4>
<p>src\react-dom.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import {REACT_TEXT,REACT_FORWARD_REF_TYPE} from &apos;./constants&apos;;</span>
import { addEvent } from &apos;./event&apos;;
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
    }
}
export function createDOM(vdom) {
<span class="hljs-addition">+ let { type, props,ref } = vdom;</span>
  let dom;
<span class="hljs-addition">+ if(type&amp;&amp;type.$$typeof===REACT_FORWARD_REF_TYPE){</span>
<span class="hljs-addition">+   return mountForwardComponent(vdom);</span>
  }else if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
      return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
<span class="hljs-addition">+ if(ref) ref.current = dom;</span>
  return dom;
}
<span class="hljs-addition">+function mountForwardComponent(vdom){</span>
<span class="hljs-addition">+    let {type,props,ref} = vdom;</span>
<span class="hljs-addition">+    let renderVdom = type.render(props,ref);</span>
<span class="hljs-addition">+    vdom.oldRenderVdom = renderVdom;</span>
<span class="hljs-addition">+    return createDOM(renderVdom);</span>
<span class="hljs-addition">+}</span>
function mountClassComponent(vdom) {
<span class="hljs-addition">+ let { type, props,ref } = vdom;</span>
  let classInstance = new type(props);
<span class="hljs-addition">+ if(ref) ref.current = classInstance;</span>
  let renderVdom = classInstance.render();
  classInstance.oldRenderVdom = renderVdom;
  let dom = createDOM(renderVdom);
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
export function findDOM(vdom){
    let {type}= vdom;
    let dom;
    if(typeof type <span class="hljs-comment">=== &apos;function&apos;){</span>
        dom=findDOM(vdom.oldRenderVdom);
    }else{
        dom=vdom.dom;
    }
    return dom;
}
export function compareTwoVdom(parentDOM, oldVdom, newVdom) {
    let oldDOM = findDOM(oldVdom);
    let newDOM = createDOM(newVdom);
    parentDOM.replaceChild(newDOM, oldDOM);
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;
</code></pre>
<h2 id="t428.&#x57FA;&#x672C;&#x751F;&#x547D;&#x5468;&#x671F;">8.&#x57FA;&#x672C;&#x751F;&#x547D;&#x5468;&#x671F; <a href="#t428.&#x57FA;&#x672C;&#x751F;&#x547D;&#x5468;&#x671F;"> # </a></h2>
<p><img src="https://upload-markdown-images.oss-cn-beijing.aliyuncs.com/react15_1626405471667.jpg" alt="react15_1626405471667.jpg"></p>
<h3 id="t438.1 src\index.js">8.1 src\index.js <a href="#t438.1 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span></span>{ <span class="hljs-comment">// &#x4ED6;&#x4F1A;&#x6BD4;&#x8F83;&#x4E24;&#x4E2A;&#x72B6;&#x6001;&#x76F8;&#x7B49;&#x5C31;&#x4E0D;&#x4F1A;&#x5237;&#x65B0;&#x89C6;&#x56FE; PureComponent&#x662F;&#x6D45;&#x6BD4;&#x8F83;</span>
    <span class="hljs-keyword">static</span> defaultProps = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">&apos;&#x73E0;&#x5CF0;&#x67B6;&#x6784;&apos;</span>
    };
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> }
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 1.constructor&apos;</span>)
    }
    componentWillMount() { <span class="hljs-comment">// &#x53D6;&#x672C;&#x5730;&#x7684;&#x6570;&#x636E; &#x540C;&#x6B65;&#x7684;&#x65B9;&#x5F0F;&#xFF1A;&#x91C7;&#x7528;&#x6E32;&#x67D3;&#x4E4B;&#x524D;&#x83B7;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x53EA;&#x6E32;&#x67D3;&#x4E00;&#x6B21;</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 2.componentWillMount&apos;</span>);
    }
    componentDidMount() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 4.componentDidMount&apos;</span>);
    }
    handleClick = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">this</span>.setState({ <span class="hljs-attr">number</span>: <span class="hljs-keyword">this</span>.state.number + <span class="hljs-number">1</span> });
    };
    <span class="hljs-comment">// react&#x53EF;&#x4EE5;shouldComponentUpdate&#x65B9;&#x6CD5;&#x4E2D;&#x4F18;&#x5316; PureComponent &#x53EF;&#x4EE5;&#x5E2E;&#x6211;&#x4EEC;&#x505A;&#x8FD9;&#x4EF6;&#x4E8B;</span>
    shouldComponentUpdate(nextProps, nextState) { <span class="hljs-comment">// &#x4EE3;&#x8868;&#x7684;&#x662F;&#x4E0B;&#x4E00;&#x6B21;&#x7684;&#x5C5E;&#x6027; &#x548C; &#x4E0B;&#x4E00;&#x6B21;&#x7684;&#x72B6;&#x6001;</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 5.shouldComponentUpdate&apos;</span>);
        <span class="hljs-keyword">return</span> nextState.number % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>;
        <span class="hljs-comment">// return nextState.number!==this.state.number; //&#x5982;&#x679C;&#x6B64;&#x51FD;&#x6570;&#x79CD;&#x8FD4;&#x56DE;&#x4E86;false &#x5C31;&#x4E0D;&#x4F1A;&#x8C03;&#x7528;render&#x65B9;&#x6CD5;&#x4E86;</span>
    } <span class="hljs-comment">//&#x4E0D;&#x8981;&#x968F;&#x4FBF;&#x7528;setState &#x53EF;&#x80FD;&#x4F1A;&#x6B7B;&#x5FAA;&#x73AF;</span>
    componentWillUpdate() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 6.componentWillUpdate&apos;</span>);
    }
    componentDidUpdate() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 7.componentDidUpdate&apos;</span>);
    }
    render() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 3.render&apos;</span>);
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{this.state.number}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleClick}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
    }
}
ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));

<span class="hljs-comment">/**
Counter 1.constructor
Counter 2.componentWillMount
Counter 3.render
Counter 4.componentDidMount
2 Counter 5.shouldComponentUpdate
Counter 6.componentWillUpdate
Counter 3.render
Counter 7.componentDidUpdate
2 Counter 5.shouldComponentUpdate
Counter 6.componentWillUpdate
Counter 3.render
Counter 7.componentDidUpdate
*/</span>
</code></pre>
<h3 id="t448.2 src\Component.js">8.2 src\Component.js <a href="#t448.2 src\Component.js"> # </a></h3>
<p>src\Component.js</p>
<pre><code class="lang-diff">import { findDOM, compareTwoVdom } from &apos;./react-dom&apos;;
export let updateQueue = {
    isBatchingUpdate:false,
    updaters:[],
    batchUpdate(){//&#x6279;&#x91CF;&#x66F4;&#x65B0;
      for(let updater of updateQueue.updaters){
        updater.updateComponent();
      }
      updateQueue.isBatchingUpdate = false;
      updateQueue.updaters.length=0;
    }
}
class Updater {
    constructor(classInstance) {
        this.classInstance = classInstance;
        this.pendingStates = [];
        this.callbacks = [];
    }
    addState(partialState, callback) {
        this.pendingStates.push(partialState);///&#x7B49;&#x5F85;&#x66F4;&#x65B0;&#x7684;&#x6216;&#x8005;&#x8BF4;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x72B6;&#x6001;
        if (typeof callback <span class="hljs-comment">=== &apos;function&apos;)</span>
            this.callbacks.push(callback);//&#x72B6;&#x6001;&#x66F4;&#x65B0;&#x540E;&#x7684;&#x56DE;&#x8C03;
        this.emitUpdate();
    }
    emitUpdate(nextProps) {
        this.nextProps = nextProps;
        if(updateQueue.isBatchingUpdate){
            updateQueue.updaters.push(this);
        }else{
            this.updateComponent();
        }
    }
    updateComponent() {
        let { classInstance, pendingStates } = this;
        if (this.nextProps || pendingStates.length &gt; 0) {
            shouldUpdate(classInstance,this.nextProps, this.getState());
        }
    }
    getState() {
        let { classInstance, pendingStates } = this;
        let { state } = classInstance;
        pendingStates.forEach((nextState) =&gt; {
            if (typeof nextState <span class="hljs-comment">=== &apos;function&apos;) {</span>
                nextState = nextState(state);
            }
            state = { ...state, ...nextState };
        });
        pendingStates.length = 0;
        return state;
    }
}
function shouldUpdate(classInstance,nextProps, nextState) {
<span class="hljs-addition">+    let willUpdate = true;</span>
<span class="hljs-addition">+    if(classInstance.shouldComponentUpdate</span>
<span class="hljs-addition">+        &amp;&amp;!classInstance.shouldComponentUpdate(nextProps,nextState)){</span>
<span class="hljs-addition">+            willUpdate = false;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    if(willUpdate &amp;&amp; classInstance.componentWillUpdate){</span>
<span class="hljs-addition">+        classInstance.componentWillUpdate();</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    if(nextProps){</span>
<span class="hljs-addition">+        classInstance.props = nextProps;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    classInstance.state = nextState;</span>
<span class="hljs-addition">+    if(willUpdate) classInstance.forceUpdate();</span>
}
export class Component {
    static isReactComponent = true;
    constructor(props) {
        this.props = props;
        this.state = {};
        this.updater = new Updater(this);
    }
    setState(partialState, callback) {
        this.updater.addState(partialState, callback);
    }
    forceUpdate() {
        let oldRenderVdom = this.oldRenderVdom;
        let oldDOM = findDOM(oldRenderVdom);
        let newRenderVdom = this.render();
        compareTwoVdom(oldDOM.parentNode, oldRenderVdom, newRenderVdom);
        this.oldRenderVdom = newRenderVdom;
<span class="hljs-addition">+       if(this.componentDidUpdate){</span>
<span class="hljs-addition">+           this.componentDidUpdate(this.props,this.state);</span>
<span class="hljs-addition">+       }</span>
    }
}
</code></pre>
<h3 id="t458.3 src\react-dom.js">8.3 src\react-dom.js <a href="#t458.3 src\react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-diff">import {REACT_TEXT,REACT_FORWARD_REF_TYPE} from &apos;./constants&apos;;
import { addEvent } from &apos;./event&apos;;

function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
<span class="hljs-addition">+       if (newDOM._componentDidMount) newDOM._componentDidMount();</span>
    }
}
export function createDOM(vdom) {
  let { type, props,ref } = vdom;
  let dom;
  if(type&amp;&amp;type.$$typeof<span class="hljs-comment">===REACT_FORWARD_REF_TYPE){</span>
    return mountForwardComponent(vdom);
  }else if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
      return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  if(ref) ref.current = dom;
  return dom;
}
function mountForwardComponent(vdom){
    let {type,props,ref} = vdom;
    let renderVdom = type.render(props,ref);
    vdom.oldRenderVdom = renderVdom;
    return createDOM(renderVdom);
}
function mountClassComponent(vdom) {
  let { type, props,ref } = vdom;
  let classInstance = new type(props);
<span class="hljs-addition">+ if(ref) ref.current = classInstance;</span>
<span class="hljs-addition">+ if (classInstance.componentWillMount) classInstance.componentWillMount();</span>
  let renderVdom = classInstance.render();
  classInstance.oldRenderVdom = renderVdom;
  let dom = createDOM(renderVdom);
<span class="hljs-addition">+ if (classInstance.componentDidMount)</span>
<span class="hljs-addition">+   dom.componentDidMount = classInstance.componentDidMount.bind(classInstance);</span>
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
export function findDOM(vdom){
    let {type}= vdom;
    let dom;
    if(typeof type <span class="hljs-comment">=== &apos;function&apos;){</span>
        dom=findDOM(vdom.oldRenderVdom);
    }else{
        dom=vdom.dom;
    }
    return dom;
}
export function compareTwoVdom(parentDOM, oldVdom, newVdom) {
    let oldDOM = findDOM(oldVdom);
    let newDOM = createDOM(newVdom);
    parentDOM.replaceChild(newDOM, oldDOM);
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;
</code></pre>
<h2 id="t469.&#x5B50;&#x7EC4;&#x4EF6;&#x751F;&#x547D;&#x5468;&#x671F;">9.&#x5B50;&#x7EC4;&#x4EF6;&#x751F;&#x547D;&#x5468;&#x671F; <a href="#t469.&#x5B50;&#x7EC4;&#x4EF6;&#x751F;&#x547D;&#x5468;&#x671F;"> # </a></h2>
<p><img src="https://upload-markdown-images.oss-cn-beijing.aliyuncs.com/counterdomdiff_1626412843123.jpg" alt="counterdomdiff_1626412843123"></p>
<h3 id="t479.1 src\index.js">9.1 src\index.js <a href="#t479.1 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span></span>{ <span class="hljs-comment">// &#x4ED6;&#x4F1A;&#x6BD4;&#x8F83;&#x4E24;&#x4E2A;&#x72B6;&#x6001;&#x76F8;&#x7B49;&#x5C31;&#x4E0D;&#x4F1A;&#x5237;&#x65B0;&#x89C6;&#x56FE; PureComponent&#x662F;&#x6D45;&#x6BD4;&#x8F83;</span>
    <span class="hljs-keyword">static</span> defaultProps = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">&apos;&#x73E0;&#x5CF0;&#x67B6;&#x6784;&apos;</span>
    };
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> }
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 1.constructor&apos;</span>)
    }
    componentWillMount() { <span class="hljs-comment">// &#x53D6;&#x672C;&#x5730;&#x7684;&#x6570;&#x636E; &#x540C;&#x6B65;&#x7684;&#x65B9;&#x5F0F;&#xFF1A;&#x91C7;&#x7528;&#x6E32;&#x67D3;&#x4E4B;&#x524D;&#x83B7;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x53EA;&#x6E32;&#x67D3;&#x4E00;&#x6B21;</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 2.componentWillMount&apos;</span>);
    }
    componentDidMount() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 4.componentDidMount&apos;</span>);
    }
    handleClick = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">this</span>.setState({ <span class="hljs-attr">number</span>: <span class="hljs-keyword">this</span>.state.number + <span class="hljs-number">1</span> });
    };
    <span class="hljs-comment">// react&#x53EF;&#x4EE5;shouldComponentUpdate&#x65B9;&#x6CD5;&#x4E2D;&#x4F18;&#x5316; PureComponent &#x53EF;&#x4EE5;&#x5E2E;&#x6211;&#x4EEC;&#x505A;&#x8FD9;&#x4EF6;&#x4E8B;</span>
    shouldComponentUpdate(nextProps, nextState) { <span class="hljs-comment">// &#x4EE3;&#x8868;&#x7684;&#x662F;&#x4E0B;&#x4E00;&#x6B21;&#x7684;&#x5C5E;&#x6027; &#x548C; &#x4E0B;&#x4E00;&#x6B21;&#x7684;&#x72B6;&#x6001;</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 5.shouldComponentUpdate&apos;</span>);
        <span class="hljs-keyword">return</span> nextState.number % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>;
        <span class="hljs-comment">// return nextState.number!==this.state.number; //&#x5982;&#x679C;&#x6B64;&#x51FD;&#x6570;&#x79CD;&#x8FD4;&#x56DE;&#x4E86;false &#x5C31;&#x4E0D;&#x4F1A;&#x8C03;&#x7528;render&#x65B9;&#x6CD5;&#x4E86;</span>
    } <span class="hljs-comment">//&#x4E0D;&#x8981;&#x968F;&#x4FBF;&#x7528;setState &#x53EF;&#x80FD;&#x4F1A;&#x6B7B;&#x5FAA;&#x73AF;</span>
    componentWillUpdate() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 6.componentWillUpdate&apos;</span>);
    }
    componentDidUpdate() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 7.componentDidUpdate&apos;</span>);
    }
    render() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Counter 3.render&apos;</span>);
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{this.state.number}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                {this.state.number === 4 ? null : <span class="hljs-tag">&lt;<span class="hljs-name">ChildCounter</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{this.state.number}</span> /&gt;</span>}
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleClick}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChildCounter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    componentWillUnmount() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos; ChildCounter 6.componentWillUnmount&apos;</span>)
    }
    componentWillMount() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;ChildCounter 1.componentWillMount&apos;</span>)
    }
    render() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;ChildCounter 2.render&apos;</span>)
        <span class="hljs-keyword">return</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {this.props.count}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>)
    }
    componentDidMount() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;ChildCounter 3.componentDidMount&apos;</span>)
    }
    componentWillReceiveProps(newProps) { <span class="hljs-comment">// &#x7B2C;&#x4E00;&#x6B21;&#x4E0D;&#x4F1A;&#x6267;&#x884C;&#xFF0C;&#x4E4B;&#x540E;&#x5C5E;&#x6027;&#x66F4;&#x65B0;&#x65F6;&#x624D;&#x4F1A;&#x6267;&#x884C;</span>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;ChildCounter 4.componentWillReceiveProps&apos;</span>)
    }
    shouldComponentUpdate(nextProps, nextState) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;ChildCounter 5.shouldComponentUpdate&apos;</span>)
        <span class="hljs-keyword">return</span> nextProps.count % <span class="hljs-number">3</span> === <span class="hljs-number">0</span>; <span class="hljs-comment">//&#x5B50;&#x7EC4;&#x4EF6;&#x5224;&#x65AD;&#x63A5;&#x6536;&#x7684;&#x5C5E;&#x6027; &#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x66F4;&#x65B0;&#x6761;&#x4EF6; &#x4E3A;true&#x5219;&#x66F4;&#x65B0;</span>
    }
}
ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));


<span class="hljs-comment">/**
click 1
Counter 1.constructor
Counter 2.componentWillMount
Counter 3.render
ChildCounter 1.componentWillMount
ChildCounter 2.render
ChildCounter 3.componentDidMount
Counter 4.componentDidMount

click 2 
Counter 5.shouldComponentUpdate
click 3
Counter 5.shouldComponentUpdate
Counter 6.componentWillUpdate
Counter 3.render
ChildCounter 4.componentWillReceiveProps
Counter 5.shouldComponentUpdate
Counter 7.componentDidUpdate

click3
Counter 5.shouldComponentUpdate

click4
Counter 5.shouldComponentUpdate
Counter 6.componentWillUpdate
Counter 3.render
ChildCounter 6.componentWillUnmount
Counter 7.componentDidUpdate

click5
Counter 5.shouldComponentUpdate

click6
Counter 5.shouldComponentUpdate
Counter 6.componentWillUpdate
Counter 3.render
ChildCounter 1.componentWillMount
ChildCounter 2.render
ChildCounter 3.componentDidMount
Counter 7.componentDidUpdate

click7
Counter 5.shouldComponentUpdate

click8
Counter 5.shouldComponentUpdate
Counter 6.componentWillUpdate
Counter 3.render
ChildCounter 4.componentWillReceiveProps
Counter 5.shouldComponentUpdate
Counter 7.componentDidUpdate
 */</span>
</code></pre>
<h3 id="t489.2 src\react-dom.js">9.2 src\react-dom.js <a href="#t489.2 src\react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { REACT_TEXT, REACT_FORWARD_REF_TYPE } from &quot;./constants&quot;;</span>
<span class="hljs-addition">+import { addEvent } from &quot;./event&quot;;</span>

function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
        if (newDOM._componentDidMount) newDOM._componentDidMount();
    }
}
export function createDOM(vdom) {
 let { type, props, ref } = vdom;
  let dom;
  if (type &amp;&amp; type.$$typeof <span class="hljs-comment">=== REACT_FORWARD_REF_TYPE) {</span>
    return mountForwardComponent(vdom);
  } else if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
      return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  if (ref) ref.current = dom;
  return dom;
}
function mountForwardComponent(vdom) {
  let { type, props, ref } = vdom;
  let renderVdom = type.render(props, ref);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function mountClassComponent(vdom) {
  let { type, props, ref } = vdom;
  let classInstance = new type(props);
<span class="hljs-addition">+ vdom.classInstance = classInstance;</span>
  if (ref) ref.current = classInstance;
  if (classInstance.componentWillMount) classInstance.componentWillMount();
  let renderVdom = classInstance.render();
  classInstance.oldRenderVdom =  renderVdom;
  let dom = createDOM(renderVdom);
  if (classInstance.componentDidMount)
    dom.componentDidMount = classInstance.componentDidMount.bind(classInstance);
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
export function findDOM(vdom) {
    if (!vdom) return null;
    if (vdom.dom) {//vdom={type:&apos;h1&apos;}
        return vdom.dom;
    } else {
        let renderVdom = vdom.classInstance ? vdom.classInstance.oldRenderVdom : vdom.oldRenderVdom;
        return findDOM(renderVdom);
    }
}
<span class="hljs-addition">+function unMountVdom(vdom) {</span>
<span class="hljs-addition">+    let { type, props, ref } = vdom;</span>
<span class="hljs-addition">+    let currentDOM = findDOM(vdom);//&#x83B7;&#x53D6;&#x6B64;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM</span>
<span class="hljs-addition">+    //vdom&#x53EF;&#x80FD;&#x662F;&#x539F;&#x751F;&#x7EC4;&#x4EF6;span &#x7C7B;&#x7EC4;&#x4EF6; classComponent &#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x51FD;&#x6570;&#x7EC4;&#x4EF6;Function</span>
<span class="hljs-addition">+    if (vdom.classInstance &amp;&amp; vdom.classInstance.componentWillUnmount) {</span>
<span class="hljs-addition">+        vdom.classInstance.componentWillUnmount();</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    if (ref) {</span>
<span class="hljs-addition">+        ref.current = null;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    //&#x5982;&#x679C;&#x6B64;&#x865A;&#x62DF;DOM&#x6709;&#x5B50;&#x8282;&#x70B9;&#x7684;&#x8BDD;&#xFF0C;&#x9012;&#x5F52;&#x5168;&#x90E8;&#x5220;&#x9664;</span>
<span class="hljs-addition">+    if (props.children) {</span>
<span class="hljs-addition">+        //&#x5F97;&#x5230;&#x513F;&#x5B50;&#x7684;&#x6570;&#x7EC4;</span>
<span class="hljs-addition">+        let children = Array.isArray(props.children) ? props.children : [props.children];</span>
<span class="hljs-addition">+        children.forEach(unMountVdom);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    //&#x628A;&#x81EA;&#x5DF1;&#x8FD9;&#x4E2A;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM&#x4ECE;&#x754C;&#x9762;&#x5220;&#x9664;</span>
<span class="hljs-addition">+    if (currentDOM) currentDOM.parentNode.removeChild(currentDOM);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+export function compareTwoVdom(parentDOM, oldVdom, newVdom,nextDOM) {</span>
<span class="hljs-addition">+  if (!oldVdom &amp;&amp; !newVdom) {</span>
<span class="hljs-addition">+    //&#x8001;&#x548C;&#x65B0;&#x90FD;&#x662F;&#x6CA1;&#x6709;</span>
<span class="hljs-addition">+    return;</span>
<span class="hljs-addition">+  } else if (!!oldVdom &amp;&amp; !newVdom) {</span>
<span class="hljs-addition">+    //&#x8001;&#x6709;&#x65B0;&#x6CA1;&#x6709;</span>
<span class="hljs-addition">+    unMountVdom(oldVdom);</span>
<span class="hljs-addition">+  } else if (!oldVdom &amp;&amp; !!newVdom) {</span>
<span class="hljs-addition">+    //&#x8001;&#x6CA1;&#x6709;&#x65B0;&#x7684;&#x6709;</span>
<span class="hljs-addition">+    let newDOM = createDOM(newVdom);</span>
<span class="hljs-addition">+    if (nextDOM) parentDOM.insertBefore(newDOM, nextDOM);</span>
<span class="hljs-addition">+    else parentDOM.appendChild(newDOM);</span>
<span class="hljs-addition">+    if (newDOM.componentDidMount) newDOM.componentDidMount();</span>
<span class="hljs-addition">+    return;</span>
<span class="hljs-addition">+  } else if (!!oldVdom &amp;&amp; !!newVdom &amp;&amp; oldVdom.type !== newVdom.type) {</span>
<span class="hljs-addition">+    //&#x65B0;&#x8001;&#x90FD;&#x6709;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;</span>
<span class="hljs-addition">+    let newDOM = createDOM(newVdom);</span>
<span class="hljs-addition">+    unMountVdom(oldVdom);</span>
<span class="hljs-addition">+    if (newDOM.componentDidMount) newDOM.componentDidMount();</span>
<span class="hljs-addition">+  } else {</span>
<span class="hljs-addition">+    updateElement(oldVdom, newVdom);</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function updateElement(oldVdom, newVdom) {</span>
<span class="hljs-addition">+    if (oldVdom.type === REACT_TEXT &amp;&amp; newVdom.type === REACT_TEXT) {</span>
<span class="hljs-addition">+       let currentDOM = newVdom.dom = findDOM(oldVdom);</span>
<span class="hljs-addition">+       if (oldVdom.props.content !== newVdom.props.content) {</span>
<span class="hljs-addition">+           currentDOM.textContent = newVdom.props.content;</span>
<span class="hljs-addition">+       }</span>
<span class="hljs-addition">+       return;</span>
<span class="hljs-addition">+    }else if (typeof oldVdom.type === &apos;string&apos;) {</span>
<span class="hljs-addition">+        let currentDOM = newVdom.dom = findDOM(oldVdom);</span>
<span class="hljs-addition">+        updateProps(currentDOM, oldVdom.props, newVdom.props);</span>
<span class="hljs-addition">+        updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children);</span>
<span class="hljs-addition">+    } else if (typeof oldVdom.type === &apos;function&apos;) {</span>
<span class="hljs-addition">+        if (oldVdom.type.isReactComponent) {</span>
<span class="hljs-addition">+            newVdom.classInstance = oldVdom.classInstance;</span>
<span class="hljs-addition">+            updateClassComponent(oldVdom, newVdom);</span>
<span class="hljs-addition">+        } else {</span>
<span class="hljs-addition">+            updateFunctionComponent(oldVdom, newVdom);</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function updateFunctionComponent(oldVdom, newVdom) {</span>
<span class="hljs-addition">+    let parentDOM = findDOM(oldVdom).parentNode;</span>
<span class="hljs-addition">+    let { type, props } = newVdom;</span>
<span class="hljs-addition">+    let newRenderVdom = type(props);</span>
<span class="hljs-addition">+    compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, newRenderVdom);</span>
<span class="hljs-addition">+    newVdom.oldRenderVdom = newRenderVdom;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function updateClassComponent(oldVdom, newVdom) {</span>
<span class="hljs-addition">+    let classInstance = newVdom.classInstance = oldVdom.classInstance;</span>
<span class="hljs-addition">+    if (classInstance.componentWillReceiveProps) {</span>
<span class="hljs-addition">+        classInstance.componentWillReceiveProps(newVdom.props);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    classInstance.updater.emitUpdate(newVdom.props);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function updateChildren(parentDOM, oldVChildren, newVChildren) {</span>
<span class="hljs-addition">+    oldVChildren = Array.isArray(oldVChildren) ? oldVChildren : oldVChildren ? [oldVChildren] : [];</span>
<span class="hljs-addition">+    newVChildren = Array.isArray(newVChildren) ? newVChildren : newVChildren ? [newVChildren] : [];</span>
<span class="hljs-addition">+    let maxLength = Math.max(oldVChildren.length, newVChildren.length);</span>
<span class="hljs-addition">+    for (let i = 0; i &lt; maxLength; i++) {</span>
<span class="hljs-addition">+       let nextVdom = oldVChildren.find((item,index)=&gt;index&gt;i&amp;&amp;item&amp;&amp;findDOM(item));</span>
<span class="hljs-addition">+       compareTwoVdom(parentDOM, oldVChildren[i], newVChildren[i],nextVdom&amp;&amp;findDOM(nextVdom));</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;
</code></pre>
<h2 id="t4910.DOM-DIFF&#x7B97;&#x6CD5;">10.DOM-DIFF&#x7B97;&#x6CD5; <a href="#t4910.DOM-DIFF&#x7B97;&#x6CD5;"> # </a></h2>
<ul>
<li>&#x53EA;&#x5BF9;&#x540C;&#x7EA7;&#x8282;&#x70B9;&#x8FDB;&#x884C;&#x5BF9;&#x6BD4;&#xFF0C;&#x5982;&#x679C;DOM&#x8282;&#x70B9;&#x8DE8;&#x5C42;&#x7EA7;&#x79FB;&#x52A8;&#xFF0C;&#x5219;React&#x4E0D;&#x4F1A;&#x590D;&#x7528;</li>
<li>&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684;&#x5143;&#x7D20;&#x4F1A;&#x4EA7;&#x51FA;&#x4E0D;&#x540C;&#x7684;&#x7ED3;&#x6784; &#xFF0C;&#x4F1A;&#x9500;&#x6BC1;&#x8001;&#x7ED3;&#x6784;&#xFF0C;&#x521B;&#x5EFA;&#x65B0;&#x7ED3;&#x6784;</li>
<li>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>key</code>&#x6807;&#x8BC6;&#x79FB;&#x52A8;&#x7684;&#x5143;&#x7D20;</li>
</ul>
<p><img src="https://upload-markdown-images.oss-cn-beijing.aliyuncs.com/domdiff_1626417725773.jpg" alt="domdiff_1626417725773"></p>
<h3 id="t5010.1 src\index.js">10.1 src\index.js <a href="#t5010.1 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = {
            <span class="hljs-attr">list</span>: [<span class="hljs-string">&apos;A&apos;</span>, <span class="hljs-string">&apos;B&apos;</span>, <span class="hljs-string">&apos;C&apos;</span>, <span class="hljs-string">&apos;D&apos;</span>, <span class="hljs-string">&apos;E&apos;</span>, <span class="hljs-string">&apos;F&apos;</span>]
        }
    }
    handleClick = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">this</span>.setState({
            <span class="hljs-attr">list</span>: [<span class="hljs-string">&apos;A&apos;</span>, <span class="hljs-string">&apos;C&apos;</span>, <span class="hljs-string">&apos;E&apos;</span>, <span class="hljs-string">&apos;B&apos;</span>, <span class="hljs-string">&apos;G&apos;</span>]
        });
    };
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.Fragment</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                    {
                        this.state.list.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)
                    }

                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleClick}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">React.Fragment</span>&gt;</span></span>
        )
    }
}
ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
</code></pre>
<h3 id="t5110.2 src\constants.js">10.2 src\constants.js <a href="#t5110.2 src\constants.js"> # </a></h3>
<p>src\constants.js</p>
<pre><code class="lang-diff">export const REACT_TEXT = Symbol(&apos;REACT_TEXT&apos;);
export const REACT_FORWARD_REF_TYPE = Symbol(&apos;react.forward_ref&apos;);
<span class="hljs-addition">+export const REACT_FRAGMENT = Symbol(&apos;react.fragment&apos;)</span>
<span class="hljs-addition">+export const PLACEMENT = &apos;PLACEMENT&apos;;</span>
<span class="hljs-addition">+export const MOVE = &apos;MOVE&apos;;</span>
</code></pre>
<h3 id="t5210.3 src\react.js">10.3 src\react.js <a href="#t5210.3 src\react.js"> # </a></h3>
<p>src\react.js</p>
<pre><code class="lang-diff">import { wrapToVdom } from &quot;./utils&quot;;
import { Component } from &apos;./Component&apos;;
<span class="hljs-addition">+import { REACT_FORWARD_REF_TYPE,REACT_FRAGMENT } from &apos;./constants&apos;;</span>
function createElement(type, config, children) {
  let ref;
  let key;
  if (config) {
    delete config.__source;
    delete config.__self;
    ref = config.ref;
    delete config.ref;
    key = config.key;
    delete config.key;
  }
  let props = { ...config };
  if (arguments.length &gt; 3) {
    props.children = Array.prototype.slice.call(arguments, 2).map(wrapToVdom);
  } else {
    props.children = wrapToVdom(children);
  }
  return {
    type,
    ref,
    key,
    props,
  };
}
function createRef() {
  return { current: null };
}
function forwardRef(render) {
  var elementType = {
    $$typeof: REACT_FORWARD_REF_TYPE,
    render: render
  };
  return elementType;
}
const React = {
  createElement,
  Component,
  createRef,
  forwardRef,
  Fragment: REACT_FRAGMENT
};
export default React;
</code></pre>
<h3 id="t5310.4 src\react-dom.js">10.4 src\react-dom.js <a href="#t5310.4 src\react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { REACT_TEXT, REACT_FORWARD_REF_TYPE, PLACEMENT, MOVE ,REACT_FRAGMENT} from &quot;./constants&quot;;</span>
import { addEvent } from &quot;./event&quot;;
<span class="hljs-addition">+import React from &apos;./react&apos;;</span>
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
        if (newDOM._componentDidMount) newDOM._componentDidMount();
    }
}
export function createDOM(vdom) {
  let { type, props, ref } = vdom;
  let dom;
  if (type &amp;&amp; type.$$typeof <span class="hljs-comment">=== REACT_FORWARD_REF_TYPE) {</span>
    return mountForwardComponent(vdom);
  } else if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
<span class="hljs-addition">+ } else if (oldVdom.type === REACT_FRAGMENT) {</span>
<span class="hljs-addition">+  dom=document.createDocumentFragment();</span>
<span class="hljs-addition">+ }else if (typeof type === &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
     return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
<span class="hljs-addition">+     props.children.mountIndex = 0;</span>
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  if (ref) ref.current = dom;
  return dom;
}

function mountForwardComponent(vdom) {
  let { type, props, ref } = vdom;
  let renderVdom = type.render(props, ref);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function mountClassComponent(vdom) {
  let { type, props, ref } = vdom;
  let classInstance = new type(props);
  vdom.classInstance = classInstance;
  if (ref) ref.current = classInstance;
  if (classInstance.componentWillMount) classInstance.componentWillMount();
  let renderVdom = classInstance.render();
  classInstance.oldRenderVdom  = renderVdom;
  let dom = createDOM(renderVdom);
  if (classInstance.componentDidMount)
    dom.componentDidMount = classInstance.componentDidMount.bind(classInstance);
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
export function findDOM(vdom) {
    if (!vdom) return null;
    if (vdom.dom) {//vdom={type:&apos;h1&apos;}
        return vdom.dom;
    } else {
        let renderVdom = vdom.classInstance ? vdom.classInstance.oldRenderVdom : vdom.oldRenderVdom;
        return findDOM(renderVdom);
    }
}
function unMountVdom(vdom) {
    let { type, props, ref } = vdom;
    let currentDOM = findDOM(vdom);//&#x83B7;&#x53D6;&#x6B64;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM
    //vdom&#x53EF;&#x80FD;&#x662F;&#x539F;&#x751F;&#x7EC4;&#x4EF6;span &#x7C7B;&#x7EC4;&#x4EF6; classComponent &#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x51FD;&#x6570;&#x7EC4;&#x4EF6;Function
    if (vdom.classInstance &amp;&amp; vdom.classInstance.componentWillUnmount) {
        vdom.classInstance.componentWillUnmount();
    }
    if (ref) {
        ref.current = null;
    }
    //&#x5982;&#x679C;&#x6B64;&#x865A;&#x62DF;DOM&#x6709;&#x5B50;&#x8282;&#x70B9;&#x7684;&#x8BDD;&#xFF0C;&#x9012;&#x5F52;&#x5168;&#x90E8;&#x5220;&#x9664;
    if (props.children) {
        //&#x5F97;&#x5230;&#x513F;&#x5B50;&#x7684;&#x6570;&#x7EC4;
        let children = Array.isArray(props.children) ? props.children : [props.children];
        children.forEach(unMountVdom);
    }
    //&#x628A;&#x81EA;&#x5DF1;&#x8FD9;&#x4E2A;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM&#x4ECE;&#x754C;&#x9762;&#x5220;&#x9664;
    if (currentDOM) currentDOM.parentNode.removeChild(currentDOM);
}
export function compareTwoVdom(parentDOM, oldVdom, newVdom, nextDOM) {
  if (!oldVdom &amp;&amp; !newVdom) {
    //&#x8001;&#x548C;&#x65B0;&#x90FD;&#x662F;&#x6CA1;&#x6709;
    return;
  } else if (!!oldVdom &amp;&amp; !newVdom) {
    //&#x8001;&#x6709;&#x65B0;&#x6CA1;&#x6709;
    unMountVdom(oldVdom);
  } else if (!oldVdom &amp;&amp; !!newVdom) {
    //&#x8001;&#x6CA1;&#x6709;&#x65B0;&#x7684;&#x6709;
    let newDOM = createDOM(newVdom);
    if (nextDOM) parentDOM.insertBefore(newDOM, nextDOM);
    else parentDOM.appendChild(newDOM);
    if (newDOM.componentDidMount) newDOM.componentDidMount();
    return;
  } else if (!!oldVdom &amp;&amp; !!newVdom &amp;&amp; oldVdom.type !== newVdom.type) {
    //&#x65B0;&#x8001;&#x90FD;&#x6709;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;
    let newDOM = createDOM(newVdom);
    unMountVdom(oldVdom);
    if (newDOM.componentDidMount) newDOM.componentDidMount();
  } else {
    updateElement(oldVdom, newVdom);
  }
}
function updateElement(oldVdom, newVdom) {
  if (oldVdom.type <span class="hljs-comment">=== REACT_TEXT &amp;&amp; newVdom.type === REACT_TEXT) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    if (oldVdom.props.content !== newVdom.props.content) {
      currentDOM.textContent = newVdom.props.content;
    }
    return;
  } else if (typeof oldVdom.type <span class="hljs-comment">=== &apos;string&apos;) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    updateProps(currentDOM, oldVdom.props, newVdom.props);
    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children);
<span class="hljs-addition">+ } else if (oldVdom.type === REACT_FRAGMENT) {</span>
<span class="hljs-addition">+   dom = document.createDocumentFragment();</span>
<span class="hljs-addition">+ } else if (typeof oldVdom.type === &apos;function&apos;) {</span>
    if (oldVdom.type.isReactComponent) {
      newVdom.classInstance = oldVdom.classInstance;
      updateClassComponent(oldVdom, newVdom);
    } else {
     updateFunctionComponent(oldVdom, newVdom);
    }
  }
}
function updateFunctionComponent(oldVdom, newVdom) {
  let parentDOM = findDOM(oldVdom).parentNode;
  let { type, props } = newVdom;
  let newRenderVdom = type(props);
  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, newRenderVdom);
  newVdom.oldRenderVdom = newRenderVdom;
}
function updateClassComponent(oldVdom, newVdom) {
  let classInstance = newVdom.classInstance = oldVdom.classInstance;
  if (classInstance.componentWillReceiveProps) {
    classInstance.componentWillReceiveProps();
  }
  classInstance.updater.emitUpdate(newVdom.props);
}
function updateChildren(parentDOM, oldVChildren, newVChildren) {
<span class="hljs-addition">+  oldVChildren = Array.isArray(oldVChildren) ? oldVChildren : oldVChildren ? [oldVChildren] : [];</span>
<span class="hljs-addition">+  newVChildren = Array.isArray(newVChildren) ? newVChildren : newVChildren ? [newVChildren] : [];</span>
<span class="hljs-addition">+  let keyedOldMap = {};</span>
<span class="hljs-addition">+  let lastPlacedIndex = 0;</span>
<span class="hljs-addition">+  oldVChildren.forEach((oldVChild, index) =&gt; {</span>
<span class="hljs-addition">+    let oldKey = oldVChild.key ? oldVChild.key : index;</span>
<span class="hljs-addition">+    keyedOldMap[oldKey] = oldVChild;</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+  let patch = [];</span>
<span class="hljs-addition">+  newVChildren.forEach((newVChild, index) =&gt; {</span>
<span class="hljs-addition">+    newVChild.mountIndex = index;</span>
<span class="hljs-addition">+    let newKey = newVChild.key ? newVChild.key : index;</span>
<span class="hljs-addition">+    let oldVChild = keyedOldMap[newKey];</span>
<span class="hljs-addition">+    if (oldVChild) {</span>
<span class="hljs-addition">+      updateElement(oldVChild, newVChild);</span>
<span class="hljs-addition">+      if (oldVChild.mountIndex &lt; lastPlacedIndex) {</span>
<span class="hljs-addition">+        patch.push({</span>
<span class="hljs-addition">+          type: MOVE,</span>
<span class="hljs-addition">+          oldVChild,</span>
<span class="hljs-addition">+          newVChild,</span>
<span class="hljs-addition">+          mountIndex: index</span>
<span class="hljs-addition">+        });</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      delete keyedOldMap[newKey];</span>
<span class="hljs-addition">+      lastPlacedIndex = Math.max(lastPlacedIndex, oldVChild.mountIndex);</span>
<span class="hljs-addition">+    } else {</span>
<span class="hljs-addition">+      patch.push({</span>
<span class="hljs-addition">+        type: PLACEMENT,</span>
<span class="hljs-addition">+        newVChild,</span>
<span class="hljs-addition">+        mountIndex: index</span>
<span class="hljs-addition">+      });</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+  let moveVChild = patch.filter(action =&gt; action.type === MOVE).map(action =&gt; action.oldVChild);</span>
<span class="hljs-addition">+  Object.values(keyedOldMap).concat(moveVChild).forEach((oldVChild) =&gt; {</span>
<span class="hljs-addition">+    let currentDOM = findDOM(oldVChild);</span>
<span class="hljs-addition">+    parentDOM.removeChild(currentDOM);</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+  patch.forEach(action =&gt; {</span>
<span class="hljs-addition">+    let { type, oldVChild, newVChild, mountIndex } = action;</span>
<span class="hljs-addition">+    let childNodes = parentDOM.childNodes;</span>
<span class="hljs-addition">+    if (type === PLACEMENT) {</span>
<span class="hljs-addition">+      let newDOM = createDOM(newVChild);</span>
<span class="hljs-addition">+      let childNode = childNodes[mountIndex];</span>
<span class="hljs-addition">+      if (childNode) {</span>
<span class="hljs-addition">+        parentDOM.insertBefore(newDOM, childNode);</span>
<span class="hljs-addition">+      } else {</span>
<span class="hljs-addition">+        parentDOM.appendChild(newDOM);</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    } else if (type === MOVE) {</span>
<span class="hljs-addition">+      let oldDOM = findDOM(oldVChild);</span>
<span class="hljs-addition">+      let childNode = childNodes[mountIndex];</span>
<span class="hljs-addition">+      if (childNode) {</span>
<span class="hljs-addition">+        parentDOM.insertBefore(oldDOM, childNode);</span>
<span class="hljs-addition">+      } else {</span>
<span class="hljs-addition">+        parentDOM.appendChild(oldDOM);</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  });</span>
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
<span class="hljs-addition">+   childVdom.mountIndex = i;</span>
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;
</code></pre>
<h2 id="t5411.&#x65B0;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;">11.&#x65B0;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F; <a href="#t5411.&#x65B0;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;"> # </a></h2>
<p><img src="https://upload-markdown-images.oss-cn-beijing.aliyuncs.com/react16_1626532331619.jpg" alt="react16_1626532331619"></p>
<h3 id="t5511.1 getDerivedStateFromProps">11.1 getDerivedStateFromProps <a href="#t5511.1 getDerivedStateFromProps"> # </a></h3>
<ul>
<li><code>static getDerivedStateFromProps(props, state)</code> &#x8FD9;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;&#x529F;&#x80FD;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;&#x5C06;&#x4F20;&#x5165;&#x7684;props&#x6620;&#x5C04;&#x5230;state&#x4E0A;&#x9762;</li>
</ul>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span></span>{
    <span class="hljs-keyword">static</span> defaultProps = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">&apos;&#x73E0;&#x5CF0;&#x67B6;&#x6784;&apos;</span>
    };
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> }
    }

    handleClick = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">this</span>.setState({ <span class="hljs-attr">number</span>: <span class="hljs-keyword">this</span>.state.number + <span class="hljs-number">1</span> });
    };

    render() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;3.render&apos;</span>);
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{this.state.number}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ChildCounter</span> <span class="hljs-attr">number</span>=<span class="hljs-string">{this.state.number}</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleClick}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChildCounter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> };
    }
    <span class="hljs-keyword">static</span> getDerivedStateFromProps(nextProps, prevState) {
        <span class="hljs-keyword">const</span> { number } = nextProps;
        <span class="hljs-comment">// &#x5F53;&#x4F20;&#x5165;&#x7684;type&#x53D1;&#x751F;&#x53D8;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x66F4;&#x65B0;state</span>
        <span class="hljs-keyword">if</span> (number % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> { <span class="hljs-attr">number</span>: number * <span class="hljs-number">2</span> };
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> { <span class="hljs-attr">number</span>: number * <span class="hljs-number">3</span> };
        }
    }
    render() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;child-render&apos;</span>, <span class="hljs-keyword">this</span>.state)
        <span class="hljs-keyword">return</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {this.state.number}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>)
    }

}

ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span></span>,
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>)
);
</code></pre>
<h3 id="t5611.2 getSnapshotBeforeUpdate">11.2 getSnapshotBeforeUpdate <a href="#t5611.2 getSnapshotBeforeUpdate"> # </a></h3>
<ul>
<li>getSnapshotBeforeUpdate() &#x88AB;&#x8C03;&#x7528;&#x4E8E;render&#x4E4B;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x8BFB;&#x53D6;&#x4F46;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;DOM&#x7684;&#x65F6;&#x5019;&#x3002;&#x5B83;&#x4F7F;&#x60A8;&#x7684;&#x7EC4;&#x4EF6;&#x53EF;&#x4EE5;&#x5728;&#x53EF;&#x80FD;&#x66F4;&#x6539;&#x4E4B;&#x524D;&#x4ECE;DOM&#x6355;&#x83B7;&#x4E00;&#x4E9B;&#x4FE1;&#x606F;&#xFF08;&#x4F8B;&#x5982;&#x6EDA;&#x52A8;&#x4F4D;&#x7F6E;&#xFF09;&#x3002;&#x6B64;&#x751F;&#x547D;&#x5468;&#x671F;&#x8FD4;&#x56DE;&#x7684;&#x4EFB;&#x4F55;&#x503C;&#x90FD;&#x5C06;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x7ED9;componentDidUpdate()</li>
</ul>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ScrollingList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">messages</span>: [] }
        <span class="hljs-keyword">this</span>.wrapper = React.createRef();
    }

    addMessage() {
        <span class="hljs-keyword">this</span>.setState(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> ({
            <span class="hljs-attr">messages</span>: [<span class="hljs-string">`<span class="hljs-subst">${state.messages.length}</span>`</span>, ...state.messages],
        }))
    }
    componentDidMount() {
        <span class="hljs-keyword">this</span>.timeID = <span class="hljs-built_in">window</span>.setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<span class="hljs-comment">//&#x8BBE;&#x7F6E;&#x5B9A;&#x65F6;&#x5668;</span>
            <span class="hljs-keyword">this</span>.addMessage();
        }, <span class="hljs-number">1000</span>)
    }
    componentWillUnmount() {<span class="hljs-comment">//&#x6E05;&#x9664;&#x5B9A;&#x65F6;&#x5668;</span>
        <span class="hljs-built_in">window</span>.clearInterval(<span class="hljs-keyword">this</span>.timeID);
    }
    getSnapshotBeforeUpdate() {<span class="hljs-comment">//&#x5F88;&#x5173;&#x952E;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x83B7;&#x53D6;&#x5F53;&#x524D;rootNode&#x7684;scrollHeight&#xFF0C;&#x4F20;&#x5230;componentDidUpdate &#x7684;&#x53C2;&#x6570;perScrollHeight</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-attr">prevScrollTop</span>:<span class="hljs-keyword">this</span>.wrapper.current.scrollTop,<span class="hljs-attr">prevScrollHeight</span>:<span class="hljs-keyword">this</span>.wrapper.current.scrollHeight};
    }
    componentDidUpdate(pervProps, pervState, {prevScrollHeight,prevScrollTop}) {
        <span class="hljs-comment">//&#x5F53;&#x524D;&#x5411;&#x4E0A;&#x5377;&#x53BB;&#x7684;&#x9AD8;&#x5EA6;&#x52A0;&#x4E0A;&#x589E;&#x52A0;&#x7684;&#x5185;&#x5BB9;&#x9AD8;&#x5EA6;</span>
        <span class="hljs-keyword">this</span>.wrapper.current.scrollTop = prevScrollTop + (<span class="hljs-keyword">this</span>.wrapper.current.scrollHeight - prevScrollHeight);
    }
    render() {
        <span class="hljs-keyword">let</span> style = {
            <span class="hljs-attr">height</span>: <span class="hljs-string">&apos;100px&apos;</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-string">&apos;200px&apos;</span>,
            <span class="hljs-attr">border</span>: <span class="hljs-string">&apos;1px solid red&apos;</span>,
            <span class="hljs-attr">overflow</span>: <span class="hljs-string">&apos;auto&apos;</span>
        }
        <span class="hljs-comment">//&lt;div key={index}&gt;&#x91CC;&#x4E0D;&#x8981;&#x52A0;&#x7A7A;&#x683C;!</span>
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.wrapper}</span> &gt;</span>
                {this.state.messages.map((message, index) =&gt; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        );
    }
}

ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ScrollingList</span> /&gt;</span></span>,
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>)
);
</code></pre>
<h3 id="t5711.3 &#x5B9E;&#x73B0;">11.3 &#x5B9E;&#x73B0; <a href="#t5711.3 &#x5B9E;&#x73B0;"> # </a></h3>
<h4 id="t5811.3.1  src\Component.js">11.3.1  src\Component.js <a href="#t5811.3.1  src\Component.js"> # </a></h4>
<pre><code class="lang-diff">import { findDOM, compareTwoVdom } from &apos;./react-dom&apos;;
export let updateQueue = {
    isBatchingUpdate: false,
    updaters: [],
    batchUpdate() {//&#x6279;&#x91CF;&#x66F4;&#x65B0;
        for (let updater of updateQueue.updaters) {
            updater.updateComponent();
        }
        updateQueue.isBatchingUpdate = false;
        updateQueue.updaters.length = 0;
    }
}
class Updater {
    constructor(classInstance) {
        this.classInstance = classInstance;
        this.pendingStates = [];
        this.callbacks = [];
    }
    addState(partialState, callback) {
        this.pendingStates.push(partialState);///&#x7B49;&#x5F85;&#x66F4;&#x65B0;&#x7684;&#x6216;&#x8005;&#x8BF4;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x72B6;&#x6001;
        if (typeof callback <span class="hljs-comment">=== &apos;function&apos;)</span>
            this.callbacks.push(callback);//&#x72B6;&#x6001;&#x66F4;&#x65B0;&#x540E;&#x7684;&#x56DE;&#x8C03;
        this.emitUpdate();
    }
    emitUpdate(nextProps) {
        this.nextProps = nextProps;
        if (updateQueue.isBatchingUpdate) {
            updateQueue.updaters.push(this);
        } else {
            this.updateComponent();
        }
    }
    updateComponent() {
        let { classInstance, pendingStates } = this;
        if (this.nextProps || pendingStates.length &gt; 0) {
            shouldUpdate(classInstance, this.nextProps, this.getState());
        }
    }
    getState() {
        let { classInstance, pendingStates } = this;
        let { state } = classInstance;
        pendingStates.forEach((nextState) =&gt; {
            if (typeof nextState <span class="hljs-comment">=== &apos;function&apos;) {</span>
                nextState = nextState(state);
            }
            state = { ...state, ...nextState };
        });
        pendingStates.length = 0;
        return state;
    }
}
function shouldUpdate(classInstance, nextProps, nextState) {
    let willUpdate = true;
    if (classInstance.shouldComponentUpdate
        &amp;&amp; !classInstance.shouldComponentUpdate(nextProps, nextState)) {
        willUpdate = false;
    }
    if (willUpdate &amp;&amp; classInstance.componentWillUpdate) {
        classInstance.componentWillUpdate();
    }
    if (nextProps) {
        classInstance.props = nextProps;
    }
    classInstance.state = nextState;
    if (willUpdate) classInstance.forceUpdate();
}
export class Component {
    static isReactComponent = true;
    constructor(props) {
        this.props = props;
        this.state = {};
        this.updater = new Updater(this);
    }
    setState(partialState, callback) {
        this.updater.addState(partialState, callback);
    }
    forceUpdate() {
        let oldRenderVdom = this.oldRenderVdom;
        let oldDOM = findDOM(oldRenderVdom);
<span class="hljs-addition">+        if (this.constructor.getDerivedStateFromProps) {</span>
<span class="hljs-addition">+            let newState = this.constructor.getDerivedStateFromProps(this.props, this.state);</span>
<span class="hljs-addition">+            if (newState)</span>
<span class="hljs-addition">+                this.state = newState;</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+       let snapshot = this.getSnapshotBeforeUpdate &amp;&amp; this.getSnapshotBeforeUpdate();</span>
        let newRenderVdom = this.render();
        compareTwoVdom(oldDOM.parentNode, oldRenderVdom, newRenderVdom);
        this.oldRenderVdom = newRenderVdom;
        if (this.componentDidUpdate) {
<span class="hljs-addition">+            this.componentDidUpdate(this.props, this.state, snapshot);</span>
        }
    }
}
</code></pre>
<h2 id="t5912. Context(&#x4E0A;&#x4E0B;&#x6587;)">12. Context(&#x4E0A;&#x4E0B;&#x6587;) <a href="#t5912. Context(&#x4E0A;&#x4E0B;&#x6587;)"> # </a></h2>
<ul>
<li>&#x5728;&#x67D0;&#x4E9B;&#x573A;&#x666F;&#x4E0B;&#xFF0C;&#x4F60;&#x60F3;&#x5728;&#x6574;&#x4E2A;&#x7EC4;&#x4EF6;&#x6811;&#x4E2D;&#x4F20;&#x9012;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x5374;&#x4E0D;&#x60F3;&#x624B;&#x52A8;&#x5730;&#x5728;&#x6BCF;&#x4E00;&#x5C42;&#x4F20;&#x9012;&#x5C5E;&#x6027;&#x3002;&#x4F60;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5728; React &#x4E2D;&#x4F7F;&#x7528;&#x5F3A;&#x5927;&#x7684;contextAPI&#x89E3;&#x51B3;&#x4E0A;&#x8FF0;&#x95EE;&#x9898;</li>
<li>&#x5728;&#x4E00;&#x4E2A;&#x5178;&#x578B;&#x7684; React &#x5E94;&#x7528;&#x4E2D;&#xFF0C;&#x6570;&#x636E;&#x662F;&#x901A;&#x8FC7; props &#x5C5E;&#x6027;&#x81EA;&#x4E0A;&#x800C;&#x4E0B;&#xFF08;&#x7531;&#x7236;&#x53CA;&#x5B50;&#xFF09;&#x8FDB;&#x884C;&#x4F20;&#x9012;&#x7684;&#xFF0C;&#x4F46;&#x8FD9;&#x79CD;&#x505A;&#x6CD5;&#x5BF9;&#x4E8E;&#x67D0;&#x4E9B;&#x7C7B;&#x578B;&#x7684;&#x5C5E;&#x6027;&#x800C;&#x8A00;&#x662F;&#x6781;&#x5176;&#x7E41;&#x7410;&#x7684;&#xFF08;&#x4F8B;&#x5982;&#xFF1A;&#x5730;&#x533A;&#x504F;&#x597D;&#xFF0C;UI &#x4E3B;&#x9898;&#xFF09;&#xFF0C;&#x8FD9;&#x4E9B;&#x5C5E;&#x6027;&#x662F;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x8BB8;&#x591A;&#x7EC4;&#x4EF6;&#x90FD;&#x9700;&#x8981;&#x7684;&#x3002;Context &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x5728;&#x7EC4;&#x4EF6;&#x4E4B;&#x95F4;&#x5171;&#x4EAB;&#x6B64;&#x7C7B;&#x503C;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x800C;&#x4E0D;&#x5FC5;&#x663E;&#x5F0F;&#x5730;&#x901A;&#x8FC7;&#x7EC4;&#x4EF6;&#x6811;&#x7684;&#x9010;&#x5C42;&#x4F20;&#x9012; props</li>
</ul>
<p><img src="https://upload-markdown-images.oss-cn-beijing.aliyuncs.com/contextapi_1626532435193.gif" alt="contextapi_1626532435193"></p>
<h3 id="t6012.1 src\index.js">12.1 src\index.js <a href="#t6012.1 src\index.js"> # </a></h3>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-keyword">let</span> ThemeContext = React.createContext(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">let</span> root = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">&apos;#root&apos;</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Header</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span>
                {
                    (value) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> `<span class="hljs-attr">5px</span> <span class="hljs-attr">solid</span> ${<span class="hljs-attr">value.color</span>}`, <span class="hljs-attr">padding:</span> &apos;<span class="hljs-attr">5px</span>&apos; }}&gt;</span>
                            header
                            <span class="hljs-tag">&lt;<span class="hljs-name">Title</span> /&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    )
                }
            <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span></span>
        )
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Title</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span>
                {
                    (value) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> `<span class="hljs-attr">5px</span> <span class="hljs-attr">solid</span> ${<span class="hljs-attr">value.color</span>}` }}&gt;</span>
                            title
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    )
                }
            <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span></span>
        )
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span>
                {
                    (value) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> `<span class="hljs-attr">5px</span> <span class="hljs-attr">solid</span> ${<span class="hljs-attr">value.color</span>}`, <span class="hljs-attr">margin:</span> &apos;<span class="hljs-attr">5px</span>&apos;, <span class="hljs-attr">padding:</span> &apos;<span class="hljs-attr">5px</span>&apos; }}&gt;</span>
                            main
                            <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> /&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    )
                }
            <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span></span>
        )
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Content</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span>
                {
                    (value) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> `<span class="hljs-attr">5px</span> <span class="hljs-attr">solid</span> ${<span class="hljs-attr">value.color</span>}`, <span class="hljs-attr">padding:</span> &apos;<span class="hljs-attr">5px</span>&apos; }}&gt;</span>
                            Content
                            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> value.changeColor(&apos;red&apos;)} style={{ color: &apos;red&apos; }}&gt;&#x7EA2;&#x8272;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> value.changeColor(&apos;green&apos;)} style={{ color: &apos;green&apos; }}&gt;&#x7EFF;&#x8272;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    )
                }
            <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span></span>

        )
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">color</span>: <span class="hljs-string">&apos;red&apos;</span> };
    }
    changeColor = <span class="hljs-function">(<span class="hljs-params">color</span>) =&gt;</span> {
        <span class="hljs-keyword">this</span>.setState({ color });
    }
    render() {
        <span class="hljs-keyword">let</span> contextVal = { <span class="hljs-attr">changeColor</span>: <span class="hljs-keyword">this</span>.changeColor, <span class="hljs-attr">color</span>: <span class="hljs-keyword">this</span>.state.color };
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{contextVal}</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> &apos;<span class="hljs-attr">10px</span>&apos;, <span class="hljs-attr">border:</span> `<span class="hljs-attr">5px</span> <span class="hljs-attr">solid</span> ${<span class="hljs-attr">this.state.color</span>}`, <span class="hljs-attr">padding:</span> &apos;<span class="hljs-attr">5px</span>&apos;, <span class="hljs-attr">width:</span> <span class="hljs-attr">200</span> }}&gt;</span>
                    page
                    <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Main</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>

        )
    }
}
ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Page</span> /&gt;</span></span>, root);
</code></pre>
<h3 id="t6112.2 src\constants.js">12.2 src\constants.js <a href="#t6112.2 src\constants.js"> # </a></h3>
<p>src\constants.js</p>
<pre><code class="lang-diff">export const REACT_TEXT = Symbol(&apos;REACT_TEXT&apos;);
export const REACT_FORWARD_REF_TYPE = Symbol(&apos;react.forward_ref&apos;);

export const PLACEMENT = &apos;PLACEMENT&apos;;
export const MOVE = &apos;MOVE&apos;;

<span class="hljs-addition">+export const REACT_PROVIDER = Symbol(&apos;react.provider&apos;);</span>
<span class="hljs-addition">+export const REACT_CONTEXT = Symbol(&apos;react.context&apos;);</span>
</code></pre>
<h3 id="t6212.3 src\Component.js">12.3 src\Component.js <a href="#t6212.3 src\Component.js"> # </a></h3>
<p>src\Component.js</p>
<pre><code class="lang-diff">import { findDOM, compareTwoVdom } from &apos;./react-dom&apos;;
export let updateQueue = {
    isBatchingUpdate: false,
    updaters: [],
    batchUpdate() {//&#x6279;&#x91CF;&#x66F4;&#x65B0;
        for (let updater of updateQueue.updaters) {
            updater.updateComponent();
        }
        updateQueue.isBatchingUpdate = false;
        updateQueue.updaters.length = 0;
    }
}
class Updater {
    constructor(classInstance) {
        this.classInstance = classInstance;
        this.pendingStates = [];
        this.callbacks = [];
    }
    addState(partialState, callback) {
        this.pendingStates.push(partialState);///&#x7B49;&#x5F85;&#x66F4;&#x65B0;&#x7684;&#x6216;&#x8005;&#x8BF4;&#x7B49;&#x5F85;&#x751F;&#x6548;&#x7684;&#x72B6;&#x6001;
        if (typeof callback <span class="hljs-comment">=== &apos;function&apos;)</span>
            this.callbacks.push(callback);//&#x72B6;&#x6001;&#x66F4;&#x65B0;&#x540E;&#x7684;&#x56DE;&#x8C03;
        this.emitUpdate();
    }
    emitUpdate(nextProps) {
        this.nextProps = nextProps;
        if (updateQueue.isBatchingUpdate) {
            updateQueue.updaters.push(this);
        } else {
            this.updateComponent();
        }
    }
    updateComponent() {
        let { classInstance, pendingStates } = this;
        if (this.nextProps || pendingStates.length &gt; 0) {
            shouldUpdate(classInstance, this.nextProps, this.getState());
        }
    }
    getState() {
        let { classInstance, pendingStates } = this;
        let { state } = classInstance;
        pendingStates.forEach((nextState) =&gt; {
            if (typeof nextState <span class="hljs-comment">=== &apos;function&apos;) {</span>
                nextState = nextState(state);
            }
            state = { ...state, ...nextState };
        });
        pendingStates.length = 0;
        return state;
    }
}
function shouldUpdate(classInstance, nextProps, nextState) {
    let willUpdate = true;
    if (classInstance.shouldComponentUpdate
        &amp;&amp; !classInstance.shouldComponentUpdate(nextProps, nextState)) {
        willUpdate = false;
    }
    if (willUpdate &amp;&amp; classInstance.componentWillUpdate) {
        classInstance.componentWillUpdate();
    }
    if (nextProps) {
        classInstance.props = nextProps;
    }
    classInstance.state = nextState;
    if (willUpdate) classInstance.forceUpdate();
}
export class Component {
    static isReactComponent = true;
    constructor(props) {
        this.props = props;
        this.state = {};
        this.updater = new Updater(this);
    }
    setState(partialState, callback) {
        this.updater.addState(partialState, callback);
    }
    forceUpdate() {
        let oldRenderVdom = this.oldRenderVdom;
        debugger
        let oldDOM = findDOM(oldRenderVdom);
<span class="hljs-addition">+       if (this.constructor.contextType) {</span>
<span class="hljs-addition">+           this.context = this.constructor.contextType._currentValue;</span>
<span class="hljs-addition">+       }</span>
        if (this.constructor.getDerivedStateFromProps) {
            let newState = this.constructor.getDerivedStateFromProps(this.props, this.state);
            if (newState)
                this.state = newState;
        }
        let extraArgs = this.getSnapshotBeforeUpdate &amp;&amp; this.getSnapshotBeforeUpdate();
        let newRenderVdom = this.render();
        compareTwoVdom(oldDOM.parentNode, oldRenderVdom, newRenderVdom);
        this.oldRenderVdom = newRenderVdom;
        if (this.componentDidUpdate) {
            this.componentDidUpdate(this.props, this.state, extraArgs);
        }
    }
}
</code></pre>
<h3 id="t6312.4 src\react.js">12.4 src\react.js <a href="#t6312.4 src\react.js"> # </a></h3>
<p>src\react.js</p>
<pre><code class="lang-diff">import { wrapToVdom } from &quot;./utils&quot;;
import { Component } from &apos;./Component&apos;;
<span class="hljs-addition">+import { REACT_FORWARD_REF_TYPE, REACT_FRAGMENT,REACT_CONTEXT, REACT_PROVIDER } from &apos;./constants&apos;;</span>
function createElement(type, config, children) {
  let ref;
  let key;
  if (config) {
    delete config.__source;
    delete config.__self;
    ref = config.ref;
    delete config.ref;
    key = config.key;
    delete config.key;
  }
  let props = { ...config };
  if (arguments.length &gt; 3) {
    props.children = Array.prototype.slice.call(arguments, 2).map(wrapToVdom);
  } else {
    props.children = wrapToVdom(children);
  }
  return {
    type,
    ref,
    key,
    props,
  };
}
function createRef() {
  return { current: null };
}
function forwardRef(render) {
  var elementType = {
    $$typeof: REACT_FORWARD_REF_TYPE,
    render: render
  };
  return elementType;
}
<span class="hljs-addition">+function createContext() {</span>
<span class="hljs-addition">+  let context = { $$typeof: REACT_CONTEXT };</span>
<span class="hljs-addition">+  context.Provider = {</span>
<span class="hljs-addition">+    $$typeof: REACT_PROVIDER,</span>
<span class="hljs-addition">+    _context: context</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  context.Consumer = {</span>
<span class="hljs-addition">+    $$typeof: REACT_CONTEXT,</span>
<span class="hljs-addition">+    _context: context</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  return context;</span>
<span class="hljs-addition">+}</span>
const React = {
  createElement,
  Component,
  createRef,
  forwardRef,
  Fragment:REACT_FRAGMENT,
<span class="hljs-addition">+ createContext</span>
};
export default React;

</code></pre>
<h3 id="t6412.5 src\react-dom.js">12.5 src\react-dom.js <a href="#t6412.5 src\react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { REACT_TEXT, REACT_FORWARD_REF_TYPE, PLACEMENT, MOVE, REACT_PROVIDER, REACT_CONTEXT,REACT_FRAGMENT } from &quot;./constants&quot;;</span>
import { addEvent } from &quot;./event&quot;;
import React from &apos;./react&apos;;
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
        if (newDOM._componentDidMount) newDOM._componentDidMount();
    }
}
export function createDOM(vdom) {
  let { type, props, ref } = vdom;
  let dom;
<span class="hljs-addition">+ if (type &amp;&amp; type.$$typeof === REACT_PROVIDER) {</span>
<span class="hljs-addition">+   return mountProviderComponent(vdom)</span>
<span class="hljs-addition">+ } else if (type &amp;&amp; type.$$typeof === REACT_CONTEXT) {</span>
<span class="hljs-addition">+   return mountContextComponent(vdom)</span>
<span class="hljs-addition">+ } else if (type &amp;&amp; type.$$typeof === REACT_FORWARD_REF_TYPE) {</span>
    return mountForwardComponent(vdom);
  } else if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  } else if (type <span class="hljs-comment">=== REACT_FRAGMENT) {</span>
    dom = document.createDocumentFragment();
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
       return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      props.children.mountIndex = 0;
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  if (ref) ref.current = dom;
  return dom;
}
<span class="hljs-addition">+function mountProviderComponent(vdom) {</span>
<span class="hljs-addition">+  let { type, props } = vdom;</span>
<span class="hljs-addition">+  let context = type._context;</span>
<span class="hljs-addition">+  context._currentValue = props.value;</span>
<span class="hljs-addition">+  let renderVdom = props.children;</span>
<span class="hljs-addition">+  vdom.oldRenderVdom = renderVdom;</span>
<span class="hljs-addition">+  return createDOM(renderVdom);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function mountContextComponent(vdom) {</span>
<span class="hljs-addition">+  let { type, props } = vdom;</span>
<span class="hljs-addition">+  let context = type._context;</span>
<span class="hljs-addition">+  let renderVdom = props.children(context._currentValue);</span>
<span class="hljs-addition">+  vdom.oldRenderVdom = renderVdom;</span>
<span class="hljs-addition">+  return createDOM(renderVdom);</span>
<span class="hljs-addition">+}</span>
function mountForwardComponent(vdom) {
  let { type, props, ref } = vdom;
  let renderVdom = type.render(props, ref);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function mountClassComponent(vdom) {
  let { type, props, ref } = vdom;
  let classInstance = new type(props);
<span class="hljs-addition">+ if (type.contextType) {</span>
<span class="hljs-addition">+   classInstance.context = type.contextType._currentValue;</span>
<span class="hljs-addition">+ }</span>
  vdom.classInstance = classInstance;
  if (ref) ref.current = classInstance;
  if (classInstance.componentWillMount) classInstance.componentWillMount();
  let renderVdom = classInstance.render();
  classInstance.oldRenderVdom  = renderVdom;
  let dom = createDOM(renderVdom);
  if (classInstance.componentDidMount)
    dom.componentDidMount = classInstance.componentDidMount.bind(classInstance);
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
export function findDOM(vdom) {
    if (!vdom) return null;
    if (vdom.dom) {//vdom={type:&apos;h1&apos;}
        return vdom.dom;
    } else {
        let renderVdom = vdom.classInstance ? vdom.classInstance.oldRenderVdom : vdom.oldRenderVdom;
        return findDOM(renderVdom);
    }
}
function unMountVdom(vdom) {
    let { type, props, ref } = vdom;
    let currentDOM = findDOM(vdom);//&#x83B7;&#x53D6;&#x6B64;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM
    //vdom&#x53EF;&#x80FD;&#x662F;&#x539F;&#x751F;&#x7EC4;&#x4EF6;span &#x7C7B;&#x7EC4;&#x4EF6; classComponent &#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x51FD;&#x6570;&#x7EC4;&#x4EF6;Function
    if (vdom.classInstance &amp;&amp; vdom.classInstance.componentWillUnmount) {
        vdom.classInstance.componentWillUnmount();
    }
    if (ref) {
        ref.current = null;
    }
    //&#x5982;&#x679C;&#x6B64;&#x865A;&#x62DF;DOM&#x6709;&#x5B50;&#x8282;&#x70B9;&#x7684;&#x8BDD;&#xFF0C;&#x9012;&#x5F52;&#x5168;&#x90E8;&#x5220;&#x9664;
    if (props.children) {
        //&#x5F97;&#x5230;&#x513F;&#x5B50;&#x7684;&#x6570;&#x7EC4;
        let children = Array.isArray(props.children) ? props.children : [props.children];
        children.forEach(unMountVdom);
    }
    //&#x628A;&#x81EA;&#x5DF1;&#x8FD9;&#x4E2A;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM&#x4ECE;&#x754C;&#x9762;&#x5220;&#x9664;
    if (currentDOM) currentDOM.parentNode.removeChild(currentDOM);
}
export function compareTwoVdom(parentDOM, oldVdom, newVdom, nextDOM) {
  if (!oldVdom &amp;&amp; !newVdom) {
    //&#x8001;&#x548C;&#x65B0;&#x90FD;&#x662F;&#x6CA1;&#x6709;
    return;
  } else if (!!oldVdom &amp;&amp; !newVdom) {
    //&#x8001;&#x6709;&#x65B0;&#x6CA1;&#x6709;
    unMountVdom(oldVdom);
  } else if (!oldVdom &amp;&amp; !!newVdom) {
    //&#x8001;&#x6CA1;&#x6709;&#x65B0;&#x7684;&#x6709;
    let newDOM = createDOM(newVdom);
    if (nextDOM) parentDOM.insertBefore(newDOM, nextDOM);
    else parentDOM.appendChild(newDOM);
    if (newDOM.componentDidMount) newDOM.componentDidMount();
    return;
  } else if (!!oldVdom &amp;&amp; !!newVdom &amp;&amp; oldVdom.type !== newVdom.type) {
    //&#x65B0;&#x8001;&#x90FD;&#x6709;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;
    let newDOM = createDOM(newVdom);
    unMountVdom(oldVdom);
    if (newDOM.componentDidMount) newDOM.componentDidMount();
  } else {
    updateElement(oldVdom, newVdom);
  }
}
function updateElement(oldVdom, newVdom) {
<span class="hljs-addition">+ if (oldVdom.type.$$typeof === REACT_CONTEXT) {</span>
<span class="hljs-addition">+   updateContextComponent(oldVdom, newVdom);</span>
<span class="hljs-addition">+ } else if (oldVdom.type.$$typeof === REACT_PROVIDER) {</span>
<span class="hljs-addition">+   updateProviderComponent(oldVdom, newVdom);</span>
<span class="hljs-addition">+ } else if (oldVdom.type === REACT_TEXT &amp;&amp; newVdom.type === REACT_TEXT) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    if (oldVdom.props.content !== newVdom.props.content) {
      currentDOM.textContent = newVdom.props.content;
    }
    return;
  } else if (oldVdom.type <span class="hljs-comment">=== REACT_FRAGMENT) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children);
  } else if (typeof oldVdom.type <span class="hljs-comment">=== &apos;string&apos;) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    updateProps(currentDOM, oldVdom.props, newVdom.props);
    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children);
  } else if (typeof oldVdom.type <span class="hljs-comment">=== &apos;function&apos;) {</span>
    if (oldVdom.type.isReactComponent) {
      newVdom.classInstance = oldVdom.classInstance;
      updateClassComponent(oldVdom, newVdom);
    } else {
       updateFunctionComponent(oldVdom, newVdom);
    }
  }
}
<span class="hljs-addition">+function updateProviderComponent(oldVdom, newVdom) {</span>
<span class="hljs-addition">+  let parentDOM = findDOM(oldVdom).parentNode;</span>
<span class="hljs-addition">+  let { type, props } = newVdom;</span>
<span class="hljs-addition">+  let context = type._context;</span>
<span class="hljs-addition">+  context._currentValue = props.value;</span>
<span class="hljs-addition">+  let renderVdom = props.children;</span>
<span class="hljs-addition">+  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, renderVdom);</span>
<span class="hljs-addition">+  newVdom.oldRenderVdom = renderVdom;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function updateContextComponent(oldVdom, newVdom) {</span>
<span class="hljs-addition">+  let parentDOM = findDOM(oldVdom).parentNode;</span>
<span class="hljs-addition">+  let { type, props } = newVdom;</span>
<span class="hljs-addition">+  let context = type._context;</span>
<span class="hljs-addition">+  let renderVdom = props.children(context._currentValue);</span>
<span class="hljs-addition">+  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, renderVdom);</span>
<span class="hljs-addition">+  newVdom.oldRenderVdom = renderVdom;</span>
<span class="hljs-addition">+}</span>
function updateFunctionComponent(oldVdom, newVdom) {
  let parentDOM = findDOM(oldVdom).parentNode;
  let { type, props } = newVdom;
  let newRenderVdom = type(props);
  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, newRenderVdom);
  newVdom.oldRenderVdom = newRenderVdom;
}
function updateClassComponent(oldVdom, newVdom) {
  let classInstance = newVdom.classInstance = oldVdom.classInstance;
  if (classInstance.componentWillReceiveProps) {
    classInstance.componentWillReceiveProps();
  }
  classInstance.updater.emitUpdate(newVdom.props);
}
function updateChildren(parentDOM, oldVChildren, newVChildren) {
  oldVChildren = Array.isArray(oldVChildren) ? oldVChildren : oldVChildren ? [oldVChildren] : [];
  newVChildren = Array.isArray(newVChildren) ? newVChildren : newVChildren ? [newVChildren] : [];
  let keyedOldMap = {};
  let lastPlacedIndex = 0;
  oldVChildren.forEach((oldVChild, index) =&gt; {
    let oldKey = oldVChild.key ? oldVChild.key : index;
    keyedOldMap[oldKey] = oldVChild;
  });
  let patch = [];
  newVChildren.forEach((newVChild, index) =&gt; {
    newVChild.mountIndex = index;
    let newKey = newVChild.key ? newVChild.key : index;
    let oldVChild = keyedOldMap[newKey];
    if (oldVChild) {
      updateElement(oldVChild, newVChild);
      if (oldVChild.mountIndex &lt; lastPlacedIndex) {
        patch.push({
          type: MOVE,
          oldVChild,
          newVChild,
          mount<span class="hljs-comment">Index: index</span>
        });
      }
      delete keyedOldMap[newKey];
      lastPlacedIndex = Math.max(lastPlacedIndex, oldVChild.mountIndex);
    } else {
      patch.push({
        type: PLACEMENT,
        newVChild,
        mount<span class="hljs-comment">Index: index</span>
      });
    }
  });
  let moveVChild = patch.filter(action =&gt; action.type <span class="hljs-comment">=== MOVE).map(action =&gt; action.oldVChild);</span>
  Object.values(keyedOldMap).concat(moveVChild).forEach((oldVChild) =&gt; {
    let currentDOM = findDOM(oldVChild);
    parentDOM.removeChild(currentDOM);
  });
  patch.forEach(action =&gt; {
    let { type, oldVChild, newVChild, mountIndex } = action;
    let childNodes = parentDOM.childNodes;
    if (type <span class="hljs-comment">=== PLACEMENT) {</span>
      let newDOM = createDOM(newVChild);
      let childNode = childNodes[mountIndex];
      if (childNode) {
        parentDOM.insertBefore(newDOM, childNode);
      } else {
        parentDOM.appendChild(newDOM);
      }
    } else if (type <span class="hljs-comment">=== MOVE) {</span>
      let oldDOM = findDOM(oldVChild);
      let childNode = childNodes[mountIndex];
      if (childNode) {
        parentDOM.insertBefore(oldDOM, childNode);
      } else {
        parentDOM.appendChild(oldDOM);
      }
    }
  });
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    childVdom.mountIndex = i;
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;

</code></pre>
<h2 id="t6513. &#x9AD8;&#x9636;&#x7EC4;&#x4EF6;">13. &#x9AD8;&#x9636;&#x7EC4;&#x4EF6; <a href="#t6513. &#x9AD8;&#x9636;&#x7EC4;&#x4EF6;"> # </a></h2>
<ul>
<li>&#x9AD8;&#x9636;&#x7EC4;&#x4EF6;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x7ED9;&#x5B83;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF0C;&#x5B83;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7EC4;&#x4EF6;</li>
<li>&#x9AD8;&#x9636;&#x7EC4;&#x4EF6;&#x7684;&#x4F5C;&#x7528;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x7EC4;&#x4EF6;&#x4E4B;&#x95F4;&#x7684;&#x4EE3;&#x7801;&#x590D;&#x7528;</li>
</ul>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> NewComponent = higherOrderComponent(OldComponent)
</code></pre>
<h3 id="t6613.1 cra&#x652F;&#x6301;&#x88C5;&#x9970;&#x5668;">13.1 cra&#x652F;&#x6301;&#x88C5;&#x9970;&#x5668; <a href="#t6613.1 cra&#x652F;&#x6301;&#x88C5;&#x9970;&#x5668;"> # </a></h3>
<h4 id="t6713.1.1 &#x5B89;&#x88C5;">13.1.1 &#x5B89;&#x88C5; <a href="#t6713.1.1 &#x5B89;&#x88C5;"> # </a></h4>
<pre><code class="lang-js">npm i react-app-rewired customize-cra @babel/plugin-proposal-decorators -D
</code></pre>
<h4 id="t6813.1.2 &#x4FEE;&#x6539;package.json">13.1.2 &#x4FEE;&#x6539;package.json <a href="#t6813.1.2 &#x4FEE;&#x6539;package.json"> # </a></h4>
<pre><code class="lang-json">  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;react-app-rewired start&quot;,
    &quot;build&quot;: &quot;react-app-rewired build&quot;,
    &quot;test&quot;: &quot;react-app-rewired test&quot;,
    &quot;eject&quot;: &quot;react-app-rewired eject&quot;
  }
</code></pre>
<h4 id="t6913.1.3 config-overrides.js">13.1.3 config-overrides.js <a href="#t6913.1.3 config-overrides.js"> # </a></h4>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> {override,addBabelPlugin} = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;customize-cra&apos;</span>);

<span class="hljs-built_in">module</span>.exports = override(
  addBabelPlugin( [
    <span class="hljs-string">&quot;@babel/plugin-proposal-decorators&quot;</span>, { <span class="hljs-string">&quot;legacy&quot;</span>: <span class="hljs-literal">true</span> }
  ])
)
</code></pre>
<h4 id="t7013.1.4 jsconfig.json">13.1.4 jsconfig.json <a href="#t7013.1.4 jsconfig.json"> # </a></h4>
<pre><code class="lang-json">{
  <span class="hljs-attr">&quot;compilerOptions&quot;</span>: {
     <span class="hljs-attr">&quot;experimentalDecorators&quot;</span>: <span class="hljs-literal">true</span>
  }
}
</code></pre>
<h3 id="t7113.2 &#x5C5E;&#x6027;&#x4EE3;&#x7406;">13.2 &#x5C5E;&#x6027;&#x4EE3;&#x7406; <a href="#t7113.2 &#x5C5E;&#x6027;&#x4EE3;&#x7406;"> # </a></h3>
<ul>
<li>&#x57FA;&#x4E8E;&#x5C5E;&#x6027;&#x4EE3;&#x7406;&#xFF1A;&#x64CD;&#x4F5C;&#x7EC4;&#x4EF6;&#x7684;props</li>
</ul>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
<span class="hljs-keyword">const</span> loading = <span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span><span class="hljs-function"><span class="hljs-params">OldComponent</span> =&gt;</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span></span>{
        render(){
            <span class="hljs-keyword">const</span> state = {
                <span class="hljs-attr">show</span>:<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>{
                    <span class="hljs-keyword">let</span> div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&apos;div&apos;</span>);
                    div.innerHTML = <span class="hljs-string">`&lt;p id=&quot;loading&quot; style=&quot;position:absolute;top:100px;z-index:10;background-color:black&quot;&gt;<span class="hljs-subst">${message}</span>&lt;/p&gt;`</span>;
                    <span class="hljs-built_in">document</span>.body.appendChild(div);
                },
                <span class="hljs-attr">hide</span>:<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>{
                    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;loading&apos;</span>).remove();
                }
            }
            <span class="hljs-keyword">return</span>  (
                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">OldComponent</span> {<span class="hljs-attr">...this.props</span>} {<span class="hljs-attr">...state</span>} {<span class="hljs-attr">...</span>{<span class="hljs-attr">...this.props</span>,<span class="hljs-attr">...state</span>}}/&gt;</span></span>
            )
        }
    }
}
@loading(<span class="hljs-string">&apos;&#x6B63;&#x5728;&#x52A0;&#x8F7D;&#x4E2D;&apos;</span>)
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span></span>{
  render(){
     <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>hello<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.props.show}</span>&gt;</span>show<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.props.hide}</span>&gt;</span>hide<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
<span class="hljs-keyword">let</span> LoadingHello  = loading(<span class="hljs-string">&apos;&#x6B63;&#x5728;&#x52A0;&#x8F7D;&apos;</span>)(Hello);

ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoadingHello</span>/&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
</code></pre>
<h3 id="t7213.3 &#x53CD;&#x5411;&#x7EE7;&#x627F;">13.3 &#x53CD;&#x5411;&#x7EE7;&#x627F; <a href="#t7213.3 &#x53CD;&#x5411;&#x7EE7;&#x627F;"> # </a></h3>
<ul>
<li>&#x57FA;&#x4E8E;&#x53CD;&#x5411;&#x7EE7;&#x627F;&#xFF1A;&#x62E6;&#x622A;&#x751F;&#x547D;&#x5468;&#x671F;&#x3001;state&#x3001;&#x6E32;&#x67D3;&#x8FC7;&#x7A0B;</li>
</ul>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Button</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span></span>{
    state = {<span class="hljs-attr">name</span>:<span class="hljs-string">&apos;&#x5F20;&#x4E09;&apos;</span>}
    componentWillMount(){
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Button componentWillMount&apos;</span>);
    }
    componentDidMount(){
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Button componentDidMount&apos;</span>);
    }
    render(){
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;Button render&apos;</span>);
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{this.state.name}</span> <span class="hljs-attr">title</span>=<span class="hljs-string">{this.props.title}/</span>&gt;</span></span>
    }
}
<span class="hljs-keyword">const</span> wrapper = <span class="hljs-function"><span class="hljs-params">OldComponent</span> =&gt;</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OldComponent</span></span>{
        state = {<span class="hljs-attr">number</span>:<span class="hljs-number">0</span>}
        componentWillMount(){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;WrapperButton componentWillMount&apos;</span>);
             <span class="hljs-keyword">super</span>.componentWillMount();
        }
        componentDidMount(){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;WrapperButton componentDidMount&apos;</span>);
             <span class="hljs-keyword">super</span>.componentDidMount();
        }
        handleClick = <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>{
            <span class="hljs-keyword">this</span>.setState({<span class="hljs-attr">number</span>:<span class="hljs-keyword">this</span>.state.number+<span class="hljs-number">1</span>});
        }
        render(){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;WrapperButton render&apos;</span>);
            <span class="hljs-keyword">let</span> renderElement = <span class="hljs-keyword">super</span>.render();
            <span class="hljs-keyword">let</span> newProps = {
                ...renderElement.props,
                ...this.state,
                <span class="hljs-attr">onClick</span>:<span class="hljs-keyword">this</span>.handleClick
            }
            <span class="hljs-keyword">return</span>  React.cloneElement(
                renderElement,
                newProps,
                <span class="hljs-keyword">this</span>.state.number
            );
        }
    }
}
<span class="hljs-keyword">let</span> WrappedButton = wrapper(Button);
ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedButton</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;&#x6807;&#x9898;&quot;</span>/&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
</code></pre>
<p>src\react.js</p>
<pre><code class="lang-diff">import { wrapToVdom } from &quot;./utils&quot;;
import { Component } from &apos;./Component&apos;;
import { REACT_FORWARD_REF_TYPE, REACT_FRAGMENT,REACT_CONTEXT, REACT_PROVIDER } from &apos;./constants&apos;;
function createElement(type, config, children) {
  let ref;
  let key;
  if (config) {
    delete config.__source;
    delete config.__self;
    ref = config.ref;
    delete config.ref;
    key = config.key;
    delete config.key;
  }
  let props = { ...config };
  if (arguments.length &gt; 3) {
    props.children = Array.prototype.slice.call(arguments, 2).map(wrapToVdom);
  } else {
    props.children = wrapToVdom(children);
  }
  return {
    type,
    ref,
    key,
    props,
  };
}
function createRef() {
  return { current: null };
}
function forwardRef(render) {
  var elementType = {
    $$typeof: REACT_FORWARD_REF_TYPE,
    render: render
  };
  return elementType;
}
function createContext() {
  let context = { $$typeof: REACT_CONTEXT };
  context.Provider = {
    $$typeof: REACT_PROVIDER,
    _context: context
  }
  context.Consumer = {
    $$typeof: REACT_CONTEXT,
    _context: context
  }
  return context;
}
<span class="hljs-addition">+function cloneElement(element, newProps, ...newChildren) {</span>
<span class="hljs-addition">+  let oldChildren = element.props &amp;&amp; element.props.children;</span>
<span class="hljs-addition">+  let children = [...(Array.isArray(oldChildren) ? oldChildren : [oldChildren]), ...newChildren]</span>
<span class="hljs-addition">+    .filter(item =&gt; item !== undefined)</span>
<span class="hljs-addition">+    .map(wrapToVdom);</span>
<span class="hljs-addition">+  if (children.length === 1) children = children[0];</span>
<span class="hljs-addition">+  let props = { ...element.props, ...newProps, children };</span>
<span class="hljs-addition">+  return { ...element, props };</span>
<span class="hljs-addition">+}</span>
const React = {
  createElement,
  Component,
  createRef,
  forwardRef,
  Fragment:REACT_FRAGMENT,
  createContext,
<span class="hljs-addition">+ cloneElement</span>
};
export default React;
</code></pre>
<h2 id="t7314. render props">14. render props <a href="#t7314. render props"> # </a></h2>
<ul>
<li><a href="https://zh-hans.reactjs.org/docs/render-props.html">render-props</a></li>
<li><code>render prop</code> &#x662F;&#x6307;&#x4E00;&#x79CD;&#x5728; React &#x7EC4;&#x4EF6;&#x4E4B;&#x95F4;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x503C;&#x4E3A;&#x51FD;&#x6570;&#x7684; prop &#x5171;&#x4EAB;&#x4EE3;&#x7801;&#x7684;&#x7B80;&#x5355;&#x6280;&#x672F;</li>
<li>&#x5177;&#x6709; render prop &#x7684;&#x7EC4;&#x4EF6;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; React &#x5143;&#x7D20;&#x5E76;&#x8C03;&#x7528;&#x5B83;&#x800C;&#x4E0D;&#x662F;&#x5B9E;&#x73B0;&#x81EA;&#x5DF1;&#x7684;&#x6E32;&#x67D3;&#x903B;&#x8F91;</li>
<li>render prop &#x662F;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x544A;&#x77E5;&#x7EC4;&#x4EF6;&#x9700;&#x8981;&#x6E32;&#x67D3;&#x4EC0;&#x4E48;&#x5185;&#x5BB9;&#x7684;&#x51FD;&#x6570; prop</li>
<li>&#x8FD9;&#x4E5F;&#x662F;&#x903B;&#x8F91;&#x590D;&#x7528;&#x7684;&#x4E00;&#x79CD;&#x65B9;&#x5F0F;</li>
</ul>
<h3 id="t7414.1 &#x539F;&#x751F;&#x5B9E;&#x73B0;">14.1 &#x539F;&#x751F;&#x5B9E;&#x73B0; <a href="#t7414.1 &#x539F;&#x751F;&#x5B9E;&#x73B0;"> # </a></h3>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MouseTracker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> };
    }

    handleMouseMove = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-keyword">this</span>.setState({
            <span class="hljs-attr">x</span>: event.clientX,
            <span class="hljs-attr">y</span>: event.clientY
        });
    }

    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onMouseMove</span>=<span class="hljs-string">{this.handleMouseMove}</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#x79FB;&#x52A8;&#x9F20;&#x6807;!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#x5F53;&#x524D;&#x7684;&#x9F20;&#x6807;&#x4F4D;&#x7F6E;&#x662F; ({this.state.x}, {this.state.y})<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        );
    }
}
ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MouseTracker</span> /&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
</code></pre>
<h3 id="t7514.2  children">14.2  children <a href="#t7514.2  children"> # </a></h3>
<ul>
<li>children&#x662F;&#x4E00;&#x4E2A;&#x6E32;&#x67D3;&#x7684;&#x65B9;&#x6CD5;</li>
</ul>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MouseTracker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> };
    }

    handleMouseMove = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-keyword">this</span>.setState({
            <span class="hljs-attr">x</span>: event.clientX,
            <span class="hljs-attr">y</span>: event.clientY
        });
    }

    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onMouseMove</span>=<span class="hljs-string">{this.handleMouseMove}</span>&gt;</span>
                {this.props.children(this.state)}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        );
    }
}
ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MouseTracker</span> &gt;</span>
    {
        (props) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#x79FB;&#x52A8;&#x9F20;&#x6807;!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#x5F53;&#x524D;&#x7684;&#x9F20;&#x6807;&#x4F4D;&#x7F6E;&#x662F; ({props.x}, {props.y})<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )
    }
<span class="hljs-tag">&lt;/<span class="hljs-name">MouseTracker</span> &gt;</span>, document.getElementById(&apos;root&apos;));
</span></code></pre>
<h3 id="t7614.3 render&#x5C5E;&#x6027;">14.3 render&#x5C5E;&#x6027; <a href="#t7614.3 render&#x5C5E;&#x6027;"> # </a></h3>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MouseTracker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> };
    }

    handleMouseMove = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-keyword">this</span>.setState({
            <span class="hljs-attr">x</span>: event.clientX,
            <span class="hljs-attr">y</span>: event.clientY
        });
    }

    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onMouseMove</span>=<span class="hljs-string">{this.handleMouseMove}</span>&gt;</span>
                {this.props.render(this.state)}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        );
    }
}

ReactDOM.render(&lt; MouseTracker render={params =&gt; (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#x79FB;&#x52A8;&#x9F20;&#x6807;!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#x5F53;&#x524D;&#x7684;&#x9F20;&#x6807;&#x4F4D;&#x7F6E;&#x662F; ({params.x}, {params.y})<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
)} /&gt;, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
</code></pre>
<h3 id="t7714.4 HOC">14.4 HOC <a href="#t7714.4 HOC"> # </a></h3>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom&apos;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withTracker</span>(<span class="hljs-params">OldComponent</span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MouseTracker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span></span>{
    <span class="hljs-keyword">constructor</span>(props){
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.state = {<span class="hljs-attr">x</span>:<span class="hljs-number">0</span>,<span class="hljs-attr">y</span>:<span class="hljs-number">0</span>};
    }
    handleMouseMove = <span class="hljs-function">(<span class="hljs-params">event</span>)=&gt;</span>{
        <span class="hljs-keyword">this</span>.setState({
            <span class="hljs-attr">x</span>:event.clientX,
            <span class="hljs-attr">y</span>:event.clientY
        });
    }
    render(){
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onMouseMove</span> = <span class="hljs-string">{this.handleMouseMove}</span>&gt;</span>
               <span class="hljs-tag">&lt;<span class="hljs-name">OldComponent</span> {<span class="hljs-attr">...this.state</span>}/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
    }
 }
}
<span class="hljs-comment">//render</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Show</span>(<span class="hljs-params">props</span>)</span>{
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.Fragment</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#x8BF7;&#x79FB;&#x52A8;&#x9F20;&#x6807;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#x5F53;&#x524D;&#x9F20;&#x6807;&#x7684;&#x4F4D;&#x7F6E;&#x662F;: x:{props.x} y:{props.y}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">React.Fragment</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">let</span> HighShow = withTracker(Show);
ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">HighShow</span>/&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
</code></pre>
<h2 id="t7815.&#x6027;&#x80FD;&#x4F18;&#x5316;">15.&#x6027;&#x80FD;&#x4F18;&#x5316; <a href="#t7815.&#x6027;&#x80FD;&#x4F18;&#x5316;"> # </a></h2>
<h3 id="t7915.1 src\index.js">15.1 src\index.js <a href="#t7915.1 src\index.js"> # </a></h3>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassCounter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">PureComponent</span> </span>{
    render() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;ClassCounter render&apos;</span>);
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>ClassCounter:{this.props.count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    }
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FunctionCounter</span>(<span class="hljs-params">props</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;FunctionCounter render&apos;</span>); <span class="hljs-keyword">debugger</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>FunctionCounter:{props.count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
<span class="hljs-keyword">const</span> MemoFunctionCounter = React.memo(FunctionCounter);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    state = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> }
    amountRef = React.createRef()
    handleClick = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> nextNumber = <span class="hljs-keyword">this</span>.state.number + <span class="hljs-built_in">parseInt</span>(<span class="hljs-keyword">this</span>.amountRef.current.value);
        <span class="hljs-keyword">this</span>.setState({ <span class="hljs-attr">number</span>: nextNumber });
    }
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ClassCounter</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{this.state.number}</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">MemoFunctionCounter</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{this.state.number}</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.amountRef}</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleClick}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
    }
}
ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
</code></pre>
<h3 id="t8015.2 src\constants.js">15.2 src\constants.js <a href="#t8015.2 src\constants.js"> # </a></h3>
<p>src\constants.js</p>
<pre><code class="lang-diff">export const REACT_TEXT = Symbol(&apos;REACT_TEXT&apos;);
export const REACT_FORWARD_REF_TYPE = Symbol(&apos;react.forward_ref&apos;);

export const PLACEMENT = &apos;PLACEMENT&apos;;
export const MOVE = &apos;MOVE&apos;;

export const REACT_CONTEXT = Symbol(&apos;react.context&apos;);
export const REACT_PROVIDER = Symbol(&apos;react.provider&apos;);
<span class="hljs-addition">+export const REACT_MEMO = Symbol(&apos;react.memo&apos;)</span>
</code></pre>
<h3 id="t8115.3 src\utils.js">15.3 src\utils.js <a href="#t8115.3 src\utils.js"> # </a></h3>
<p>src\utils.js</p>
<pre><code class="lang-diff">import { REACT_TEXT } from &quot;./constants&quot;;
export function wrapToVdom(element) {
  return typeof element <span class="hljs-comment">=== &quot;string&quot; || typeof element === &quot;number&quot;</span>
    ? { type: REACT_TEXT, props: { content: element } }
    : element;
}

export function isFunction(obj) {
  return typeof obj <span class="hljs-comment">=== &apos;function&apos;;</span>
}

<span class="hljs-addition">+export function shallowEqual(obj1, obj2) {</span>
<span class="hljs-addition">+  if (obj1 === obj2) {</span>
<span class="hljs-addition">+    return true;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  if (typeof obj1 != &quot;object&quot; || obj1 === null || typeof obj2 != &quot;object&quot; || obj2 === null) {</span>
<span class="hljs-addition">+    return false;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  let keys1 = Object.keys(obj1);</span>
<span class="hljs-addition">+  let keys2 = Object.keys(obj2);</span>
<span class="hljs-addition">+  if (keys1.length !== keys2.length) {</span>
<span class="hljs-addition">+    return false;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  for (let key of keys1) {</span>
<span class="hljs-addition">+    if (!obj2.hasOwnProperty(key) || obj1[key] !== obj2[key]) {</span>
<span class="hljs-addition">+      return false;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  return true;</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t8215.4 src\react.js">15.4 src\react.js <a href="#t8215.4 src\react.js"> # </a></h3>
<p>src\react.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { wrapToVdom, shallowEqual } from &quot;./utils&quot;;</span>
import { Component } from &apos;./Component&apos;;
<span class="hljs-addition">+import { REACT_FORWARD_REF_TYPE,REACT_FRAGMENT, REACT_CONTEXT, REACT_PROVIDER, REACT_MEMO } from &apos;./constants&apos;;</span>
function createElement(type, config, children) {
  let ref;
  let key;
  if (config) {
    delete config.__source;
    delete config.__self;
    ref = config.ref;
    delete config.ref;
    key = config.key;
    delete config.key;
  }
  let props = { ...config };
  if (arguments.length &gt; 3) {
    props.children = Array.prototype.slice.call(arguments, 2).map(wrapToVdom);
  } else {
    props.children = wrapToVdom(children);
  }
  return {
    type,
    ref,
    key,
    props,
  };
}
function createRef() {
  return { current: null };
}
function forwardRef(render) {
  var elementType = {
    $$typeof: REACT_FORWARD_REF_TYPE,
    render: render
  };
  return elementType;
}
function createContext() {
  let context = { $$typeof: REACT_CONTEXT };
  context.Provider = {
    $$typeof: REACT_PROVIDER,
    _context: context
  }
  context.Consumer = {
    $$typeof: REACT_CONTEXT,
    _context: context
  }
  return context;
}
function cloneElement(element, newProps, ...newChildren) {
  let oldChildren = element.props &amp;&amp; element.props.children;
  let children = [...(Array.isArray(oldChildren) ? oldChildren : [oldChildren]), ...newChildren]
    .filter(item =&gt; item !== undefined)
    .map(wrapToVdom);
  if (children.length <span class="hljs-comment">=== 1) children = children[0];</span>
  let props = { ...element.props, ...newProps, children };
  return { ...element, props };
}
<span class="hljs-addition">+class PureComponent extends Component {</span>
<span class="hljs-addition">+  shouldComponentUpdate(newProps, nextState) {</span>
<span class="hljs-addition">+    return !shallowEqual(this.props, newProps) || !shallowEqual(this.state, nextState);</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+function memo(type, compare = shallowEqual) {</span>
<span class="hljs-addition">+  return {</span>
<span class="hljs-addition">+    $$typeof: REACT_MEMO,</span>
<span class="hljs-addition">+    type,</span>
<span class="hljs-addition">+    compare</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+}</span>
const React = {
  createElement,
  Component,
  createRef,
  forwardRef,
  Fragment:REACT_FRAGMENT,
  createContext,
  cloneElement,
  PureComponent,
<span class="hljs-addition">+ memo</span>
};
export default React;
</code></pre>
<h3 id="t8315.5 src\react-dom.js">15.5 src\react-dom.js <a href="#t8315.5 src\react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import { REACT_TEXT, REACT_FORWARD_REF_TYPE, PLACEMENT, MOVE, REACT_FRAGMENT,REACT_PROVIDER, REACT_CONTEXT, REACT_MEMO } from &quot;./constants&quot;;</span>
import { addEvent } from &quot;./event&quot;;
import React from &apos;./react&apos;;
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
        if (newDOM._componentDidMount) newDOM._componentDidMount();
    }
}
export function createDOM(vdom) {
  let { type, props, ref } = vdom;
  let dom;
<span class="hljs-addition">+  if (type &amp;&amp; type.$$typeof === REACT_MEMO) {</span>
<span class="hljs-addition">+    return mountMemoComponent(vdom);</span>
<span class="hljs-addition">+  } else if (type &amp;&amp; type.$$typeof === REACT_PROVIDER) {</span>
    return mountProviderComponent(vdom)
  } else if (type &amp;&amp; type.$$typeof <span class="hljs-comment">=== REACT_CONTEXT) {</span>
    return mountContextComponent(vdom)
  } else if (type &amp;&amp; type.$$typeof <span class="hljs-comment">=== REACT_FORWARD_REF_TYPE) {</span>
    return mountForwardComponent(vdom);
  } else if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  } else if (type <span class="hljs-comment">=== REACT_FRAGMENT) {</span>
    dom = document.createDocumentFragment();
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
       return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      props.children.mountIndex = 0;
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  if (ref) ref.current = dom;
  return dom;
}

<span class="hljs-addition">+function mountMemoComponent(vdom) {</span>
<span class="hljs-addition">+  let { type, props } = vdom;</span>
<span class="hljs-addition">+  let renderVdom = type.type(props);</span>
<span class="hljs-addition">+  vdom.prevProps = props;</span>
<span class="hljs-addition">+  vdom.oldRenderVdom = renderVdom;</span>
<span class="hljs-addition">+  return createDOM(renderVdom);</span>
<span class="hljs-addition">+}</span>
function mountProviderComponent(vdom) {
  let { type, props } = vdom;
  let context = type._context;
  context._currentValue = props.value;
  let renderVdom = props.children;
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function mountContextComponent(vdom) {
  let { type, props } = vdom;
  let context = type._context;
  let renderVdom = props.children(context._currentValue);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function mountForwardComponent(vdom) {
  let { type, props, ref } = vdom;
  let renderVdom = type.render(props, ref);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function mountClassComponent(vdom) {
  let { type, props, ref } = vdom;
  let classInstance = new type(props);
  if (type.contextType) {
    classInstance.context = type.contextType._currentValue;
  }
  vdom.classInstance = classInstance;
  if (ref) ref.current = classInstance;
  if (classInstance.componentWillMount) classInstance.componentWillMount();
  let renderVdom = classInstance.render();
  classInstance.oldRenderVdom  = renderVdom;
  let dom = createDOM(renderVdom);
  if (classInstance.componentDidMount)
    dom.componentDidMount = classInstance.componentDidMount.bind(classInstance);
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
export function findDOM(vdom) {
    if (!vdom) return null;
    if (vdom.dom) {//vdom={type:&apos;h1&apos;}
        return vdom.dom;
    } else {
        let renderVdom = vdom.classInstance ? vdom.classInstance.oldRenderVdom : vdom.oldRenderVdom;
        return findDOM(renderVdom);
    }
}
function unMountVdom(vdom) {
    let { type, props, ref } = vdom;
    let currentDOM = findDOM(vdom);//&#x83B7;&#x53D6;&#x6B64;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM
    //vdom&#x53EF;&#x80FD;&#x662F;&#x539F;&#x751F;&#x7EC4;&#x4EF6;span &#x7C7B;&#x7EC4;&#x4EF6; classComponent &#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x51FD;&#x6570;&#x7EC4;&#x4EF6;Function
    if (vdom.classInstance &amp;&amp; vdom.classInstance.componentWillUnmount) {
        vdom.classInstance.componentWillUnmount();
    }
    if (ref) {
        ref.current = null;
    }
    //&#x5982;&#x679C;&#x6B64;&#x865A;&#x62DF;DOM&#x6709;&#x5B50;&#x8282;&#x70B9;&#x7684;&#x8BDD;&#xFF0C;&#x9012;&#x5F52;&#x5168;&#x90E8;&#x5220;&#x9664;
    if (props.children) {
        //&#x5F97;&#x5230;&#x513F;&#x5B50;&#x7684;&#x6570;&#x7EC4;
        let children = Array.isArray(props.children) ? props.children : [props.children];
        children.forEach(unMountVdom);
    }
    //&#x628A;&#x81EA;&#x5DF1;&#x8FD9;&#x4E2A;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM&#x4ECE;&#x754C;&#x9762;&#x5220;&#x9664;
    if (currentDOM) currentDOM.parentNode.removeChild(currentDOM);
}
export function compareTwoVdom(parentDOM, oldVdom, newVdom, nextDOM) {
  if (!oldVdom &amp;&amp; !newVdom) {
    //&#x8001;&#x548C;&#x65B0;&#x90FD;&#x662F;&#x6CA1;&#x6709;
    return;
  } else if (!!oldVdom &amp;&amp; !newVdom) {
    //&#x8001;&#x6709;&#x65B0;&#x6CA1;&#x6709;
    unMountVdom(oldVdom);
  } else if (!oldVdom &amp;&amp; !!newVdom) {
    //&#x8001;&#x6CA1;&#x6709;&#x65B0;&#x7684;&#x6709;
    let newDOM = createDOM(newVdom);
    if (nextDOM) parentDOM.insertBefore(newDOM, nextDOM);
    else parentDOM.appendChild(newDOM);
    if (newDOM.componentDidMount) newDOM.componentDidMount();
    return;
  } else if (!!oldVdom &amp;&amp; !!newVdom &amp;&amp; oldVdom.type !== newVdom.type) {
    //&#x65B0;&#x8001;&#x90FD;&#x6709;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;
    let newDOM = createDOM(newVdom);
    unMountVdom(oldVdom);
    if (newDOM.componentDidMount) newDOM.componentDidMount();
  } else {
    updateElement(oldVdom, newVdom);
  }
}
function updateElement(oldVdom, newVdom) {
<span class="hljs-addition">+  if (oldVdom.type &amp;&amp; oldVdom.type.$$typeof === REACT_MEMO) {</span>
<span class="hljs-addition">+    updateMemoComponent(oldVdom, newVdom);</span>
  } else if (oldVdom.type.$$typeof <span class="hljs-comment">=== REACT_CONTEXT) {</span>
    updateContextComponent(oldVdom, newVdom);
  } else if (oldVdom.type.$$typeof <span class="hljs-comment">=== REACT_PROVIDER) {</span>
    updateProviderComponent(oldVdom, newVdom);
  } else if (oldVdom.type <span class="hljs-comment">=== REACT_TEXT &amp;&amp; newVdom.type === REACT_TEXT) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    if (oldVdom.props.content !== newVdom.props.content) {
      currentDOM.textContent = newVdom.props.content;
    }
    return;
  }  else if (oldVdom.type <span class="hljs-comment">=== REACT_FRAGMENT) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children);
  }else if (typeof oldVdom.type <span class="hljs-comment">=== &apos;string&apos;) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    updateProps(currentDOM, oldVdom.props, newVdom.props);
    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children);
  } else if (typeof oldVdom.type <span class="hljs-comment">=== &apos;function&apos;) {</span>
    if (oldVdom.type.isReactComponent) {
      newVdom.classInstance = oldVdom.classInstance;
      updateClassComponent(oldVdom, newVdom);
    } else {
      updateFunctionComponent(oldVdom, newVdom);
    }
  }
}
<span class="hljs-addition">+function updateMemoComponent(oldVdom, newVdom) {</span>
<span class="hljs-addition">+  let { type, prevProps } = oldVdom;</span>
<span class="hljs-addition">+  if (!type.compare(prevProps, newVdom.props)) {</span>
<span class="hljs-addition">+    let oldDOM = findDOM(oldVdom);</span>
<span class="hljs-addition">+    let parentDOM = oldDOM.parentNode;</span>
<span class="hljs-addition">+    let { type, props } = newVdom;</span>
<span class="hljs-addition">+    let renderVdom = type.type(props);</span>
<span class="hljs-addition">+    compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, renderVdom);</span>
<span class="hljs-addition">+    newVdom.prevProps = props;</span>
<span class="hljs-addition">+    newVdom.oldRenderVdom = renderVdom;</span>
<span class="hljs-addition">+  } else {</span>
<span class="hljs-addition">+    newVdom.prevProps = prevProps;</span>
<span class="hljs-addition">+    newVdom.oldRenderVdom = oldVdom.oldRenderVdom;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+}</span>
function updateProviderComponent(oldVdom, newVdom) {
  let parentDOM = findDOM(oldVdom).parentNode;
  let { type, props } = newVdom;
  let context = type._context;
  context._currentValue = props.value;
  let renderVdom = props.children;
  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, renderVdom);
  newVdom.oldRenderVdom = renderVdom;
}
function updateContextComponent(oldVdom, newVdom) {
  let parentDOM = findDOM(oldVdom).parentNode;
  let { type, props } = newVdom;
  let context = type._context;
  let renderVdom = props.children(context._currentValue);
  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, renderVdom);
  newVdom.oldRenderVdom = renderVdom;
}
function updateFunctionComponent(oldVdom, newVdom) {
  let parentDOM = findDOM(oldVdom).parentNode;
  let { type, props } = newVdom;
  let newRenderVdom = type(props);
  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, newRenderVdom);
  newVdom.oldRenderVdom = newRenderVdom;
}
function updateClassComponent(oldVdom, newVdom) {
  let classInstance = newVdom.classInstance = oldVdom.classInstance;
  if (classInstance.componentWillReceiveProps) {
    classInstance.componentWillReceiveProps();
  }
  classInstance.updater.emitUpdate(newVdom.props);
}
function updateChildren(parentDOM, oldVChildren, newVChildren) {
  oldVChildren = Array.isArray(oldVChildren) ? oldVChildren : oldVChildren ? [oldVChildren] : [];
  newVChildren = Array.isArray(newVChildren) ? newVChildren : newVChildren ? [newVChildren] : [];
  let keyedOldMap = {};
  let lastPlacedIndex = 0;
  oldVChildren.forEach((oldVChild, index) =&gt; {
    let oldKey = oldVChild.key ? oldVChild.key : index;
    keyedOldMap[oldKey] = oldVChild;
  });
  let patch = [];
  newVChildren.forEach((newVChild, index) =&gt; {
    newVChild.mountIndex = index;
    let newKey = newVChild.key ? newVChild.key : index;
    let oldVChild = keyedOldMap[newKey];
    if (oldVChild) {
      updateElement(oldVChild, newVChild);
      if (oldVChild.mountIndex &lt; lastPlacedIndex) {
        patch.push({
          type: MOVE,
          oldVChild,
          newVChild,
          mount<span class="hljs-comment">Index: index</span>
        });
      }
      delete keyedOldMap[newKey];
      lastPlacedIndex = Math.max(lastPlacedIndex, oldVChild.mountIndex);
    } else {
      patch.push({
        type: PLACEMENT,
        newVChild,
        mount<span class="hljs-comment">Index: index</span>
      });
    }
  });
  let moveVChild = patch.filter(action =&gt; action.type <span class="hljs-comment">=== MOVE).map(action =&gt; action.oldVChild);</span>
  Object.values(keyedOldMap).concat(moveVChild).forEach((oldVChild) =&gt; {
    let currentDOM = findDOM(oldVChild);
    parentDOM.removeChild(currentDOM);
  });
  patch.forEach(action =&gt; {
    let { type, oldVChild, newVChild, mountIndex } = action;
    let childNodes = parentDOM.childNodes;
    if (type <span class="hljs-comment">=== PLACEMENT) {</span>
      let newDOM = createDOM(newVChild);
      let childNode = childNodes[mountIndex];
      if (childNode) {
        parentDOM.insertBefore(newDOM, childNode);
      } else {
        parentDOM.appendChild(newDOM);
      }
    } else if (type <span class="hljs-comment">=== MOVE) {</span>
      let oldDOM = findDOM(oldVChild);
      let childNode = childNodes[mountIndex];
      if (childNode) {
        parentDOM.insertBefore(oldDOM, childNode);
      } else {
        parentDOM.appendChild(oldDOM);
      }
    }
  });
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    childVdom.mountIndex = i;
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
};
export default ReactDOM;

</code></pre>
<h2 id="t8416.Portal">16.Portal <a href="#t8416.Portal"> # </a></h2>
<ul>
<li>React v16&#x589E;&#x52A0;&#x4E86;&#x5BF9;Portal&#x7684;&#x76F4;&#x63A5;&#x652F;&#x6301;</li>
<li>&#x5B83;&#x53EF;&#x4EE5;&#x628A;JSX&#x6E32;&#x67D3;&#x5230;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;DOM&#x8282;&#x70B9;&#x4E2D;</li>
</ul>
<h3 id="t8516.1 src\index.js">16.1 src\index.js <a href="#t8516.1 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./react-dom&apos;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dialog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-keyword">constructor</span>(props) {
        <span class="hljs-keyword">super</span>(props);
        <span class="hljs-keyword">this</span>.node = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&apos;div&apos;</span>);
        <span class="hljs-built_in">document</span>.body.appendChild(<span class="hljs-keyword">this</span>.node);
    }
    render() {
        <span class="hljs-keyword">return</span> ReactDOM.createPortal(
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;dialog&quot;</span>&gt;</span>
                {this.props.children}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
            <span class="hljs-keyword">this</span>.node
        );
    }
    componentWillUnmount() {
        <span class="hljs-built_in">window</span>.document.body.removeChild(<span class="hljs-keyword">this</span>.node);
    }
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    render() {
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Dialog</span>&gt;</span>&#x6A21;&#x6001;&#x7A97;<span class="hljs-tag">&lt;/<span class="hljs-name">Dialog</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
    }
}
ReactDOM.render(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
</code></pre>
<h3 id="t8616.2 src\react-dom.js">16.2 src\react-dom.js <a href="#t8616.2 src\react-dom.js"> # </a></h3>
<p>src\react-dom.js</p>
<pre><code class="lang-diff">import { REACT_TEXT, REACT_FORWARD_REF_TYPE, PLACEMENT, MOVE, REACT_FRAGMENT,REACT_PROVIDER, REACT_CONTEXT, REACT_MEMO } from &quot;./constants&quot;;
import { addEvent } from &quot;./event&quot;;
import React from &apos;./react&apos;;
function render(vdom, parentDOM) {
    let newDOM = createDOM(vdom)
    if (newDOM) {
        parentDOM.appendChild(newDOM);
        if (newDOM._componentDidMount) newDOM._componentDidMount();
    }
}
export function createDOM(vdom) {
  let { type, props, ref } = vdom;
  let dom;
  if (type &amp;&amp; type.$$typeof <span class="hljs-comment">=== REACT_MEMO) {</span>
    return mountMemoComponent(vdom);
  } else if (type &amp;&amp; type.$$typeof <span class="hljs-comment">=== REACT_PROVIDER) {</span>
    return mountProviderComponent(vdom)
  } else if (type &amp;&amp; type.$$typeof <span class="hljs-comment">=== REACT_CONTEXT) {</span>
    return mountContextComponent(vdom)
  } else if (type &amp;&amp; type.$$typeof <span class="hljs-comment">=== REACT_FORWARD_REF_TYPE) {</span>
    return mountForwardComponent(vdom);
  } else if (type <span class="hljs-comment">=== REACT_TEXT) {</span>
    dom = document.createTextNode(props.content);
  }else if (type <span class="hljs-comment">=== REACT_FRAGMENT) {</span>
    dom = document.createDocumentFragment();
  } else if (typeof type <span class="hljs-comment">=== &quot;function&quot;) {</span>
    if (type.isReactComponent) {
      return mountClassComponent(vdom);
    } else {
      return mountFunctionComponent(vdom);
    }
  } else {
    dom = document.createElement(type);
  }
  if (props) {
    updateProps(dom, {}, props);
    if (typeof props.children == &quot;object&quot; &amp;&amp; props.children.type) {
      props.children.mountIndex = 0;
      mount(props.children, dom);
    } else if (Array.isArray(props.children)) {
      reconcileChildren(props.children, dom);
    }
  }
  vdom.dom = dom;
  if (ref) ref.current = dom;
  return dom;
}

function mountMemoComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type.type(props);
  vdom.prevProps = props;
  vdom.oldRenderVdom = renderVdom;
<span class="hljs-addition">+ if (!renderVdom) return null;  </span>
  return createDOM(renderVdom);
}
function mountProviderComponent(vdom) {
  let { type, props } = vdom;
  let context = type._context;
  context._currentValue = props.value;
  let renderVdom = props.children;
  vdom.oldRenderVdom = renderVdom;
<span class="hljs-addition">+ if (!renderVdom) return null;  </span>
  return createDOM(renderVdom);
}
function mountContextComponent(vdom) {
  let { type, props } = vdom;
  let context = type._context;
  let renderVdom = props.children(context._currentValue);
  vdom.oldRenderVdom = renderVdom;
<span class="hljs-addition">+ if (!renderVdom) return null;  </span>
  return createDOM(renderVdom);
}
function mountForwardComponent(vdom) {
  let { type, props, ref } = vdom;
  let renderVdom = type.render(props, ref);
  vdom.oldRenderVdom = renderVdom;
<span class="hljs-addition">+ if (!renderVdom) return null;  </span>
  return createDOM(renderVdom);
}
function mountClassComponent(vdom) {
  let { type, props, ref } = vdom;
  let classInstance = new type(props);
  if (type.contextType) {
    classInstance.context = type.contextType._currentValue;
  }
  vdom.classInstance = classInstance;
  if (ref) ref.current = classInstance;
  if (classInstance.componentWillMount) classInstance.componentWillMount();
  let renderVdom = classInstance.render();
  classInstance.oldRenderVdom  = renderVdom;
<span class="hljs-addition">+ if (!renderVdom) return null;</span>
  let dom = createDOM(renderVdom);
  if (classInstance.componentDidMount)
    dom.componentDidMount = classInstance.componentDidMount.bind(classInstance);
  return dom;
}
function mountFunctionComponent(vdom) {
  let { type, props } = vdom;
  let renderVdom = type(props);
  vdom.oldRenderVdom = renderVdom;
<span class="hljs-addition">+ if (!renderVdom) return null;</span>
  return createDOM(renderVdom);
}
function updateProps(dom, oldProps={}, newProps={}) {
    for (let key in newProps) {
        if (key <span class="hljs-comment">=== &apos;children&apos;) {</span>
            continue;
        } else if (key <span class="hljs-comment">=== &apos;style&apos;) {</span>
            let styleObj = newProps[key];
            for (let attr in styleObj) {
                dom.style[attr] = styleObj[attr];
            }
        } else if (key.startsWith(&apos;on&apos;)) {
            addEvent(dom, key.toLocaleLowerCase(), newProps[key]);
        } else {
            dom[key] = newProps[key];
        }
    }
    for(let key in oldProps){
        if(!newProps.hasOwnProperty(key)){
            dom[key] = null;
        }
    }
}
export function findDOM(vdom) {
    if (!vdom) return null;
    if (vdom.dom) {//vdom={type:&apos;h1&apos;}
        return vdom.dom;
    } else {
        let renderVdom = vdom.classInstance ? vdom.classInstance.oldRenderVdom : vdom.oldRenderVdom;
        return findDOM(renderVdom);
    }
}
function unMountVdom(vdom) {
    let { type, props, ref } = vdom;
    let currentDOM = findDOM(vdom);//&#x83B7;&#x53D6;&#x6B64;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM
    //vdom&#x53EF;&#x80FD;&#x662F;&#x539F;&#x751F;&#x7EC4;&#x4EF6;span &#x7C7B;&#x7EC4;&#x4EF6; classComponent &#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x51FD;&#x6570;&#x7EC4;&#x4EF6;Function
    if (vdom.classInstance &amp;&amp; vdom.classInstance.componentWillUnmount) {
        vdom.classInstance.componentWillUnmount();
    }
    if (ref) {
        ref.current = null;
    }
    //&#x5982;&#x679C;&#x6B64;&#x865A;&#x62DF;DOM&#x6709;&#x5B50;&#x8282;&#x70B9;&#x7684;&#x8BDD;&#xFF0C;&#x9012;&#x5F52;&#x5168;&#x90E8;&#x5220;&#x9664;
    if (props.children) {
        //&#x5F97;&#x5230;&#x513F;&#x5B50;&#x7684;&#x6570;&#x7EC4;
        let children = Array.isArray(props.children) ? props.children : [props.children];
        children.forEach(unMountVdom);
    }
    //&#x628A;&#x81EA;&#x5DF1;&#x8FD9;&#x4E2A;&#x865A;&#x62DF;DOM&#x5BF9;&#x5E94;&#x7684;&#x771F;&#x5B9E;DOM&#x4ECE;&#x754C;&#x9762;&#x5220;&#x9664;
    if (currentDOM) currentDOM.parentNode.removeChild(currentDOM);
}
export function compareTwoVdom(parentDOM, oldVdom, newVdom, nextDOM) {
  if (!oldVdom &amp;&amp; !newVdom) {
    //&#x8001;&#x548C;&#x65B0;&#x90FD;&#x662F;&#x6CA1;&#x6709;
    return;
  } else if (!!oldVdom &amp;&amp; !newVdom) {
    //&#x8001;&#x6709;&#x65B0;&#x6CA1;&#x6709;
    unMountVdom(oldVdom);
  } else if (!oldVdom &amp;&amp; !!newVdom) {
    //&#x8001;&#x6CA1;&#x6709;&#x65B0;&#x7684;&#x6709;
    let newDOM = createDOM(newVdom);
    if (nextDOM) parentDOM.insertBefore(newDOM, nextDOM);
    else parentDOM.appendChild(newDOM);
    if (newDOM.componentDidMount) newDOM.componentDidMount();
    return;
  } else if (!!oldVdom &amp;&amp; !!newVdom &amp;&amp; oldVdom.type !== newVdom.type) {
    //&#x65B0;&#x8001;&#x90FD;&#x6709;&#xFF0C;&#x4F46;&#x7C7B;&#x578B;&#x4E0D;&#x540C;
    let newDOM = createDOM(newVdom);
    unMountVdom(oldVdom);
    if (newDOM.componentDidMount) newDOM.componentDidMount();
  } else {
    updateElement(oldVdom, newVdom);
  }
}
function updateElement(oldVdom, newVdom) {
  if (oldVdom.type &amp;&amp; oldVdom.type.$$typeof <span class="hljs-comment">=== REACT_MEMO) {</span>
    updateMemoComponent(oldVdom, newVdom);
  } else if (oldVdom.type.$$typeof <span class="hljs-comment">=== REACT_CONTEXT) {</span>
    updateContextComponent(oldVdom, newVdom);
  } else if (oldVdom.type.$$typeof <span class="hljs-comment">=== REACT_PROVIDER) {</span>
    updateProviderComponent(oldVdom, newVdom);
  } else if (oldVdom.type <span class="hljs-comment">=== REACT_TEXT &amp;&amp; newVdom.type === REACT_TEXT) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    if (oldVdom.props.content !== newVdom.props.content) {
      currentDOM.textContent = newVdom.props.content;
    }
    return;
  } else if (typeof oldVdom.type <span class="hljs-comment">=== &apos;string&apos;) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    updateProps(currentDOM, oldVdom.props, newVdom.props);
    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children);
  } else if (oldVdom.type <span class="hljs-comment">=== REACT_FRAGMENT) {</span>
    let currentDOM = newVdom.dom = findDOM(oldVdom);
    updateChildren(currentDOM, oldVdom.props.children, newVdom.props.children);
  } else if (typeof oldVdom.type <span class="hljs-comment">=== &apos;function&apos;) {</span>
    if (oldVdom.type.isReactComponent) {
      newVdom.classInstance = oldVdom.classInstance;
      updateClassComponent(oldVdom, newVdom);
    } else {
       updateFunctionComponent(oldVdom, newVdom);
    }
  }
}
function updateMemoComponent(oldVdom, newVdom) {
 let {type,prevProps} = oldVdom;
 let renderVdom=oldVdom.oldRenderVdom;
 if(!type.compare(prevProps,newVdom.props)){
     let currentDOM = findDOM(oldVdom);
     let parentDOM = currentDOM.parentNode;
     let {type,props} = newVdom;
     renderVdom = type.type(props);
     compareTwoVdom(parentDOM,oldVdom.oldRenderVdom,renderVdom);
 }
 newVdom.prevProps = newVdom.props;
 newVdom.oldRenderVdom = renderVdom;
}
function updateProviderComponent(oldVdom, newVdom) {
  let parentDOM = findDOM(oldVdom).parentNode;
  let { type, props } = newVdom;
  let context = type._context;
  context._currentValue = props.value;
  let renderVdom = props.children;
  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, renderVdom);
  newVdom.oldRenderVdom = renderVdom;
}
function updateContextComponent(oldVdom, newVdom) {
  let parentDOM = findDOM(oldVdom).parentNode;
  let { type, props } = newVdom;
  let context = type._context;
  let renderVdom = props.children(context._currentValue);
  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, renderVdom);
  newVdom.oldRenderVdom = renderVdom;
}
function updateFunctionComponent(oldVdom, newVdom) {
  let parentDOM = findDOM(oldVdom).parentNode;
  let { type, props } = newVdom;
  let newRenderVdom = type(props);
  compareTwoVdom(parentDOM, oldVdom.oldRenderVdom, newRenderVdom);
  newVdom.oldRenderVdom = newRenderVdom;
}
function updateClassComponent(oldVdom, newVdom) {
  let classInstance = newVdom.classInstance = oldVdom.classInstance;
  if (classInstance.componentWillReceiveProps) {
    classInstance.componentWillReceiveProps();
  }
  classInstance.updater.emitUpdate(newVdom.props);
}
function updateChildren(parentDOM, oldVChildren, newVChildren) {
  oldVChildren = Array.isArray(oldVChildren) ? oldVChildren : oldVChildren ? [oldVChildren] : [];
  newVChildren = Array.isArray(newVChildren) ? newVChildren : newVChildren ? [newVChildren] : [];
  let keyedOldMap = {};
  let lastPlacedIndex = 0;
  oldVChildren.forEach((oldVChild, index) =&gt; {
    let oldKey = oldVChild.key ? oldVChild.key : index;
    keyedOldMap[oldKey] = oldVChild;
  });
  let patch = [];
  newVChildren.forEach((newVChild, index) =&gt; {
    newVChild.mountIndex = index;
    let newKey = newVChild.key ? newVChild.key : index;
    let oldVChild = keyedOldMap[newKey];
    if (oldVChild) {
      updateElement(oldVChild, newVChild);
      if (oldVChild.mountIndex &lt; lastPlacedIndex) {
        patch.push({
          type: MOVE,
          oldVChild,
          newVChild,
          mount<span class="hljs-comment">Index: index</span>
        });
      }
      delete keyedOldMap[newKey];
      lastPlacedIndex = Math.max(lastPlacedIndex, oldVChild.mountIndex);
    } else {
      patch.push({
        type: PLACEMENT,
        newVChild,
        mount<span class="hljs-comment">Index: index</span>
      });
    }
  });
  let moveVChild = patch.filter(action =&gt; action.type <span class="hljs-comment">=== MOVE).map(action =&gt; action.oldVChild);</span>
  Object.values(keyedOldMap).concat(moveVChild).forEach((oldVChild) =&gt; {
    let currentDOM = findDOM(oldVChild);
    parentDOM.removeChild(currentDOM);
  });
  patch.forEach(action =&gt; {
    let { type, oldVChild, newVChild, mountIndex } = action;
    let childNodes = parentDOM.childNodes;
    if (type <span class="hljs-comment">=== PLACEMENT) {</span>
      let newDOM = createDOM(newVChild);
      let childNode = childNodes[mountIndex];
      if (childNode) {
        parentDOM.insertBefore(newDOM, childNode);
      } else {
        parentDOM.appendChild(newDOM);
      }
    } else if (type <span class="hljs-comment">=== MOVE) {</span>
      let oldDOM = findDOM(oldVChild);
      let childNode = childNodes[mountIndex];
      if (childNode) {
        parentDOM.insertBefore(oldDOM, childNode);
      } else {
        parentDOM.appendChild(oldDOM);
      }
    }
  });
}
function reconcileChildren(childrenVdom, parentDOM) {
  for (let i = 0; i &lt; childrenVdom.length; i++) {
    let childVdom = childrenVdom[i];
    childVdom.mountIndex = i;
    mount(childVdom, parentDOM);
  }
}
const ReactDOM = {
  render,
  createPortal:render
};
export default ReactDOM;

</code></pre>
<p><a href="git@gitee.com:zhufengpeixun/zhufengreact.git">zhufengreact</a></p>

    </div>
</div>
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog"
    aria-labelledby="loginModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                    aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="loginModalLabel">请登录</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="username" class="control-label">姓名:</label>
                        <input type="text" class="form-control" id="username" placeholder="珠峰架构VIP会员系统用户名">
                    </div>
                    <div class="form-group">
                        <label for="password" class="control-label">密码:</label>
                        <input type="text" class="form-control" id="password" placeholder="珠峰架构VIP会员系统密码">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                    data-dismiss="modal">登录</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script>
$('.warpper .page-toc ul ul li a').on('click',function(){
  $('.warpper .page-toc ul ul li a').removeClass('my-active')
  $(this).addClass('my-active')
})
$('.logo').on('mouseenter',function(){
  $('.nav').height('450px');
})
$('.nav').on('mouseleave',function(){
  $('.nav').height('80px');
})
$('.logo').on('click',function(){
  $('.nav').css('display','none');
 $('.warpper').css('padding','0px');
})
</script>
</body>
</html>
